<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<!-- saved from url=(0059)file:///C:/users/ethanb~1/appdata/local/temp/tmptt_iom.html -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">


<title>C:\Users\Ethan Breit\AppData\Roaming\Emacs\Western\10\Science\Raytracer\print_ready_compilation.c</title>
<style>
.highlight .hll { background-color: #ffffcc }
.highlight .c { color: #408080; font-style: italic } /* Comment */
.highlight .err { border: 1px solid #FF0000 } /* Error */
.highlight .k { color: #008000; font-weight: bold } /* Keyword */
.highlight .o { color: #666666 } /* Operator */
.highlight .ch { color: #408080; font-style: italic } /* Comment.Hashbang */
.highlight .cm { color: #408080; font-style: italic } /* Comment.Multiline */
.highlight .cp { color: #BC7A00 } /* Comment.Preproc */
.highlight .cpf { color: #408080; font-style: italic } /* Comment.PreprocFile */
.highlight .c1 { color: #408080; font-style: italic } /* Comment.Single */
.highlight .cs { color: #408080; font-style: italic } /* Comment.Special */
.highlight .gd { color: #A00000 } /* Generic.Deleted */
.highlight .ge { font-style: italic } /* Generic.Emph */
.highlight .gr { color: #FF0000 } /* Generic.Error */
.highlight .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.highlight .gi { color: #00A000 } /* Generic.Inserted */
.highlight .go { color: #888888 } /* Generic.Output */
.highlight .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.highlight .gs { font-weight: bold } /* Generic.Strong */
.highlight .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.highlight .gt { color: #0044DD } /* Generic.Traceback */
.highlight .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.highlight .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.highlight .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.highlight .kp { color: #008000 } /* Keyword.Pseudo */
.highlight .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.highlight .kt { color: #B00040 } /* Keyword.Type */
.highlight .m { color: #666666 } /* Literal.Number */
.highlight .s { color: #BA2121 } /* Literal.String */
.highlight .na { color: #7D9029 } /* Name.Attribute */
.highlight .nb { color: #008000 } /* Name.Builtin */
.highlight .nc { color: #0000FF; font-weight: bold } /* Name.Class */
.highlight .no { color: #880000 } /* Name.Constant */
.highlight .nd { color: #AA22FF } /* Name.Decorator */
.highlight .ni { color: #999999; font-weight: bold } /* Name.Entity */
.highlight .ne { color: #D2413A; font-weight: bold } /* Name.Exception */
.highlight .nf { color: #0000FF } /* Name.Function */
.highlight .nl { color: #A0A000 } /* Name.Label */
.highlight .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.highlight .nt { color: #008000; font-weight: bold } /* Name.Tag */
.highlight .nv { color: #19177C } /* Name.Variable */
.highlight .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.highlight .w { color: #bbbbbb } /* Text.Whitespace */
.highlight .mb { color: #666666 } /* Literal.Number.Bin */
.highlight .mf { color: #666666 } /* Literal.Number.Float */
.highlight .mh { color: #666666 } /* Literal.Number.Hex */
.highlight .mi { color: #666666 } /* Literal.Number.Integer */
.highlight .mo { color: #666666 } /* Literal.Number.Oct */
.highlight .sa { color: #BA2121 } /* Literal.String.Affix */
.highlight .sb { color: #BA2121 } /* Literal.String.Backtick */
.highlight .sc { color: #BA2121 } /* Literal.String.Char */
.highlight .dl { color: #BA2121 } /* Literal.String.Delimiter */
.highlight .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.highlight .s2 { color: #BA2121 } /* Literal.String.Double */
.highlight .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
.highlight .sh { color: #BA2121 } /* Literal.String.Heredoc */
.highlight .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
.highlight .sx { color: #008000 } /* Literal.String.Other */
.highlight .sr { color: #BB6688 } /* Literal.String.Regex */
.highlight .s1 { color: #BA2121 } /* Literal.String.Single */
.highlight .ss { color: #19177C } /* Literal.String.Symbol */
.highlight .bp { color: #008000 } /* Name.Builtin.Pseudo */
.highlight .fm { color: #0000FF } /* Name.Function.Magic */
.highlight .vc { color: #19177C } /* Name.Variable.Class */
.highlight .vg { color: #19177C } /* Name.Variable.Global */
.highlight .vi { color: #19177C } /* Name.Variable.Instance */
.highlight .vm { color: #19177C } /* Name.Variable.Magic */
.highlight .il { color: #666666 } /* Literal.Number.Integer.Long */
.highlight * { font-family: monospace; }
.highlight { font-size: 90%; }
.highlight { line-height: normal; }
.highlight .err { border: none !important }
</style>
</head>
<body onload="window.print();">
<div class="highlight"><pre><span></span><span class="lineno">   1 </span><span class="cm">/***********/</span>
<span class="lineno">   2 </span><span class="cm">/* scene.h */</span>
<span class="lineno">   3 </span><span class="cm">/***********/</span>
<span class="lineno">   4 </span>
<span class="lineno">   5 </span><span class="cp">#pragma once</span>
<span class="lineno">   6 </span><span class="cp">#include</span> <span class="cpf">&lt;vec.h&gt;</span><span class="cp"></span>
<span class="lineno">   7 </span><span class="c1">//typedef struct{} sphere;</span>
<span class="lineno">   8 </span><span class="k">struct</span> <span class="n">sphere</span><span class="p">;</span>
<span class="lineno">   9 </span><span class="k">struct</span> <span class="n">plane</span><span class="p">;</span>
<span class="lineno">  10 </span><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_rt_ctx</span> <span class="n">raytracer_context</span><span class="p">;</span>
<span class="lineno">  11 </span>
<span class="lineno">  12 </span><span class="k">typedef</span> <span class="nf">W_ALIGN</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="k">struct</span>
<span class="lineno">  13 </span><span class="p">{</span>
<span class="lineno">  14 </span>    <span class="n">vec4</span>  <span class="n">colour</span><span class="p">;</span>
<span class="lineno">  15 </span>
<span class="lineno">  16 </span>    <span class="kt">float</span> <span class="n">reflectivity</span><span class="p">;</span>
<span class="lineno">  17 </span>
<span class="lineno">  18 </span>    <span class="c1">//TODO: add more.</span>
<span class="lineno">  19 </span><span class="p">}</span> <span class="n">U_ALIGN</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="n">material</span><span class="p">;</span>
<span class="lineno">  20 </span>
<span class="lineno">  21 </span><span class="cm">/*typedef struct</span>
<span class="lineno">  22 </span><span class="cm">{</span>
<span class="lineno">  23 </span><span class="cm">    vec3 max;</span>
<span class="lineno">  24 </span><span class="cm">    vec3 min;</span>
<span class="lineno">  25 </span><span class="cm">} AABB;</span>
<span class="lineno">  26 </span><span class="cm">*/</span>
<span class="lineno">  27 </span><span class="k">typedef</span> <span class="nf">W_ALIGN</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span> <span class="k">struct</span>
<span class="lineno">  28 </span><span class="p">{</span>
<span class="lineno">  29 </span>    <span class="n">mat4</span> <span class="n">model</span><span class="p">;</span>
<span class="lineno">  30 </span>
<span class="lineno">  31 </span>    <span class="n">vec4</span> <span class="n">max</span><span class="p">;</span>
<span class="lineno">  32 </span>    <span class="n">vec4</span> <span class="n">min</span><span class="p">;</span>
<span class="lineno">  33 </span>
<span class="lineno">  34 </span>    <span class="kt">int</span> <span class="n">index_offset</span><span class="p">;</span>
<span class="lineno">  35 </span>    <span class="kt">int</span> <span class="n">num_indices</span><span class="p">;</span>
<span class="lineno">  36 </span>
<span class="lineno">  37 </span>    <span class="kt">int</span> <span class="n">material_index</span><span class="p">;</span>
<span class="lineno">  38 </span><span class="p">}</span> <span class="n">U_ALIGN</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span> <span class="n">mesh</span><span class="p">;</span>
<span class="lineno">  39 </span>
<span class="lineno">  40 </span><span class="k">typedef</span> <span class="k">struct</span>
<span class="lineno">  41 </span><span class="p">{</span>
<span class="lineno">  42 </span>
<span class="lineno">  43 </span>    <span class="n">mat4</span> <span class="n">camera_world_matrix</span><span class="p">;</span>
<span class="lineno">  44 </span>
<span class="lineno">  45 </span>    <span class="c1">//Materials</span>
<span class="lineno">  46 </span>    <span class="n">material</span><span class="o">*</span> <span class="n">materials</span><span class="p">;</span>
<span class="lineno">  47 </span>    <span class="n">cl_mem</span> <span class="n">cl_material_buffer</span><span class="p">;</span>
<span class="lineno">  48 </span>    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_materials</span><span class="p">;</span>
<span class="lineno">  49 </span>    <span class="kt">bool</span> <span class="n">materials_changed</span><span class="p">;</span>
<span class="lineno">  50 </span>    <span class="c1">//Primatives</span>
<span class="lineno">  51 </span>
<span class="lineno">  52 </span>    <span class="c1">//Spheres</span>
<span class="lineno">  53 </span>    <span class="n">sphere</span><span class="o">*</span> <span class="n">spheres</span><span class="p">;</span>
<span class="lineno">  54 </span>    <span class="n">cl_mem</span> <span class="n">cl_sphere_buffer</span><span class="p">;</span>
<span class="lineno">  55 </span>    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_spheres</span><span class="p">;</span> <span class="c1">//NOTE: must be constant.</span>
<span class="lineno">  56 </span>    <span class="kt">bool</span> <span class="n">spheres_changed</span><span class="p">;</span>
<span class="lineno">  57 </span>    <span class="c1">//Planes</span>
<span class="lineno">  58 </span>    <span class="n">plane</span><span class="o">*</span> <span class="n">planes</span><span class="p">;</span>
<span class="lineno">  59 </span>    <span class="n">cl_mem</span> <span class="n">cl_plane_buffer</span><span class="p">;</span>
<span class="lineno">  60 </span>    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_planes</span><span class="p">;</span> <span class="c1">//NOTE: must be constant.</span>
<span class="lineno">  61 </span>    <span class="kt">bool</span> <span class="n">planes_changed</span><span class="p">;</span>
<span class="lineno">  62 </span>
<span class="lineno">  63 </span>    <span class="c1">//Meshes</span>
<span class="lineno">  64 </span>    <span class="n">mesh</span><span class="o">*</span> <span class="n">meshes</span><span class="p">;</span> <span class="c1">//All vertex data is stored contiguously</span>
<span class="lineno">  65 </span>    <span class="n">cl_mem</span> <span class="n">cl_mesh_buffer</span><span class="p">;</span>
<span class="lineno">  66 </span>    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_meshes</span><span class="p">;</span>
<span class="lineno">  67 </span>    <span class="kt">bool</span> <span class="n">meshes_changed</span><span class="p">;</span>
<span class="lineno">  68 </span>
<span class="lineno">  69 </span>
<span class="lineno">  70 </span>    <span class="c1">//NOTE: we could store vertices, normals, and texcoords contiguously as 1 buffer.</span>
<span class="lineno">  71 </span>    <span class="n">vec3</span><span class="o">*</span> <span class="n">mesh_verts</span><span class="p">;</span>
<span class="lineno">  72 </span>    <span class="n">cl_mem</span> <span class="n">cl_mesh_vert_buffer</span><span class="p">;</span>
<span class="lineno">  73 </span>    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_mesh_verts</span><span class="p">;</span> <span class="c1">//NOTE: must be constant.</span>
<span class="lineno">  74 </span>
<span class="lineno">  75 </span>    <span class="n">vec3</span><span class="o">*</span> <span class="n">mesh_nrmls</span><span class="p">;</span>
<span class="lineno">  76 </span>    <span class="n">cl_mem</span> <span class="n">cl_mesh_nrml_buffer</span><span class="p">;</span>
<span class="lineno">  77 </span>    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_mesh_nrmls</span><span class="p">;</span> <span class="c1">//NOTE: must be constant.</span>
<span class="lineno">  78 </span>
<span class="lineno">  79 </span>    <span class="n">vec2</span><span class="o">*</span> <span class="n">mesh_texcoords</span><span class="p">;</span>
<span class="lineno">  80 </span>    <span class="n">cl_mem</span> <span class="n">cl_mesh_texcoord_buffer</span><span class="p">;</span>
<span class="lineno">  81 </span>    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_mesh_texcoords</span><span class="p">;</span> <span class="c1">//NOTE: must be constant.</span>
<span class="lineno">  82 </span>
<span class="lineno">  83 </span>    <span class="n">ivec3</span><span class="o">*</span> <span class="n">mesh_indices</span><span class="p">;</span>
<span class="lineno">  84 </span>    <span class="n">cl_mem</span> <span class="n">cl_mesh_index_buffer</span><span class="p">;</span>
<span class="lineno">  85 </span>    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_mesh_indices</span><span class="p">;</span> <span class="c1">//NOTE: must be constant.</span>
<span class="lineno">  86 </span>
<span class="lineno">  87 </span><span class="p">}</span> <span class="n">scene</span><span class="p">;</span>
<span class="lineno">  88 </span>
<span class="lineno">  89 </span>
<span class="lineno">  90 </span><span class="kt">void</span> <span class="nf">scene_resource_push</span><span class="p">(</span><span class="n">raytracer_context</span><span class="o">*</span><span class="p">);</span>
<span class="lineno">  91 </span><span class="kt">void</span> <span class="nf">scene_init_resources</span><span class="p">(</span><span class="n">raytracer_context</span><span class="o">*</span><span class="p">);</span>
<span class="lineno">  92 </span>
<span class="lineno">  93 </span>
<span class="lineno">  94 </span><span class="cm">/***********/</span>
<span class="lineno">  95 </span><span class="cm">/* win32.h */</span>
<span class="lineno">  96 </span><span class="cm">/***********/</span>
<span class="lineno">  97 </span>
<span class="lineno">  98 </span><span class="cp">#pragma once</span>
<span class="lineno">  99 </span><span class="cp">#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp"></span>
<span class="lineno"> 100 </span><span class="cp">#include</span> <span class="cpf">&lt;stdbool.h&gt;</span><span class="cp"></span>
<span class="lineno"> 101 </span><span class="cp">#include</span> <span class="cpf">&lt;os_abs.h&gt;</span><span class="cp"></span>
<span class="lineno"> 102 </span>
<span class="lineno"> 103 </span><span class="k">typedef</span> <span class="k">struct</span>
<span class="lineno"> 104 </span><span class="p">{</span>
<span class="lineno"> 105 </span>    <span class="n">HINSTANCE</span> <span class="n">instance</span><span class="p">;</span>
<span class="lineno"> 106 </span>    <span class="kt">int</span>       <span class="n">nCmdShow</span><span class="p">;</span>
<span class="lineno"> 107 </span>    <span class="n">WNDCLASSEX</span> <span class="n">wc</span><span class="p">;</span>
<span class="lineno"> 108 </span>    <span class="n">HWND</span>     <span class="n">win</span><span class="p">;</span>
<span class="lineno"> 109 </span>
<span class="lineno"> 110 </span>    <span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">;</span>
<span class="lineno"> 111 </span>
<span class="lineno"> 112 </span>    <span class="n">BITMAPINFO</span> <span class="n">bitmap_info</span><span class="p">;</span>
<span class="lineno"> 113 </span>    <span class="kt">void</span><span class="o">*</span>      <span class="n">bitmap_memory</span><span class="p">;</span>
<span class="lineno"> 114 </span>
<span class="lineno"> 115 </span>    <span class="c1">// HDC        render_device_context;</span>
<span class="lineno"> 116 </span>
<span class="lineno"> 117 </span>    <span class="kt">bool</span>       <span class="n">shouldRun</span><span class="p">;</span>
<span class="lineno"> 118 </span>    <span class="c1">//Bitbuffer</span>
<span class="lineno"> 119 </span><span class="p">}</span> <span class="n">win32_context</span><span class="p">;</span>
<span class="lineno"> 120 </span>
<span class="lineno"> 121 </span>
<span class="lineno"> 122 </span><span class="n">os_abs</span> <span class="nf">init_win32_abs</span><span class="p">();</span>
<span class="lineno"> 123 </span>
<span class="lineno"> 124 </span><span class="kt">void</span> <span class="nf">win32_start_thread</span><span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">func</span><span class="p">)(</span><span class="kt">void</span><span class="o">*</span><span class="p">),</span> <span class="kt">void</span><span class="o">*</span> <span class="n">data</span><span class="p">);</span>
<span class="lineno"> 125 </span>
<span class="lineno"> 126 </span><span class="c1">//void create_win32_window();</span>
<span class="lineno"> 127 </span><span class="kt">void</span> <span class="nf">win32_start</span><span class="p">();</span>
<span class="lineno"> 128 </span><span class="kt">void</span> <span class="nf">win32_loop</span><span class="p">();</span>
<span class="lineno"> 129 </span>
<span class="lineno"> 130 </span><span class="kt">void</span> <span class="nf">win32_update</span><span class="p">();</span>
<span class="lineno"> 131 </span>
<span class="lineno"> 132 </span><span class="kt">void</span> <span class="nf">win32_sleep</span><span class="p">(</span><span class="kt">int</span><span class="p">);</span>
<span class="lineno"> 133 </span>
<span class="lineno"> 134 </span><span class="kt">void</span><span class="o">*</span> <span class="nf">win32_get_bitmap_memory</span><span class="p">();</span>
<span class="lineno"> 135 </span>
<span class="lineno"> 136 </span><span class="kt">int</span> <span class="nf">win32_get_time_mili</span><span class="p">();</span>
<span class="lineno"> 137 </span>
<span class="lineno"> 138 </span><span class="kt">int</span> <span class="nf">win32_get_width</span><span class="p">();</span>
<span class="lineno"> 139 </span><span class="kt">int</span> <span class="nf">win32_get_height</span><span class="p">();</span>
<span class="lineno"> 140 </span>
<span class="lineno"> 141 </span><span class="cm">/*************/</span>
<span class="lineno"> 142 </span><span class="cm">/* startup.h */</span>
<span class="lineno"> 143 </span><span class="cm">/*************/</span>
<span class="lineno"> 144 </span>
<span class="lineno"> 145 </span><span class="cp">#pragma once</span>
<span class="lineno"> 146 </span>
<span class="lineno"> 147 </span><span class="kt">int</span> <span class="nf">startup</span><span class="p">();</span>
<span class="lineno"> 148 </span><span class="kt">void</span> <span class="nf">loop_exit</span><span class="p">();</span>
<span class="lineno"> 149 </span><span class="kt">void</span> <span class="nf">loop_pause</span><span class="p">();</span>
<span class="lineno"> 150 </span>
<span class="lineno"> 151 </span><span class="cm">/**********/</span>
<span class="lineno"> 152 </span><span class="cm">/* geom.h */</span>
<span class="lineno"> 153 </span><span class="cm">/**********/</span>
<span class="lineno"> 154 </span>
<span class="lineno"> 155 </span><span class="cp">#pragma once</span>
<span class="lineno"> 156 </span><span class="cp">#include</span> <span class="cpf">&lt;stdbool.h&gt;</span><span class="cp"></span>
<span class="lineno"> 157 </span>
<span class="lineno"> 158 </span><span class="k">typedef</span> <span class="kt">int</span>   <span class="n">ivec3</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span> <span class="c1">//1 int padding</span>
<span class="lineno"> 159 </span><span class="k">typedef</span> <span class="kt">float</span> <span class="n">vec2</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="lineno"> 160 </span><span class="k">typedef</span> <span class="kt">float</span> <span class="n">vec3</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span> <span class="c1">//1 float padding</span>
<span class="lineno"> 161 </span><span class="k">typedef</span> <span class="kt">float</span> <span class="n">vec4</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
<span class="lineno"> 162 </span><span class="k">typedef</span> <span class="kt">float</span> <span class="n">mat4</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
<span class="lineno"> 163 </span>
<span class="lineno"> 164 </span><span class="cm">/*******/</span>
<span class="lineno"> 165 </span><span class="cm">/* Ray */</span>
<span class="lineno"> 166 </span><span class="cm">/*******/</span>
<span class="lineno"> 167 </span><span class="k">typedef</span> <span class="k">struct</span> <span class="n">ray</span>
<span class="lineno"> 168 </span><span class="p">{</span>
<span class="lineno"> 169 </span>    <span class="n">vec3</span> <span class="n">orig</span><span class="p">;</span>
<span class="lineno"> 170 </span>    <span class="n">vec3</span> <span class="n">dir</span><span class="p">;</span>
<span class="lineno"> 171 </span>    <span class="c1">//float t_min, t_max;</span>
<span class="lineno"> 172 </span><span class="p">}</span> <span class="n">ray</span><span class="p">;</span>
<span class="lineno"> 173 </span>
<span class="lineno"> 174 </span>
<span class="lineno"> 175 </span><span class="cm">/**********/</span>
<span class="lineno"> 176 </span><span class="cm">/* Sphere */</span>
<span class="lineno"> 177 </span><span class="cm">/**********/</span>
<span class="lineno"> 178 </span>
<span class="lineno"> 179 </span><span class="c1">//NOTE:  less memory efficient but aligns with opencl</span>
<span class="lineno"> 180 </span><span class="k">typedef</span> <span class="nf">W_ALIGN</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="k">struct</span> <span class="n">sphere</span>
<span class="lineno"> 181 </span><span class="p">{</span>
<span class="lineno"> 182 </span>    <span class="n">vec4</span> <span class="n">pos</span><span class="p">;</span> <span class="c1">//GPU stores all vec3s as vec4s in memory so we need the padding.</span>
<span class="lineno"> 183 </span>
<span class="lineno"> 184 </span>    <span class="kt">float</span> <span class="n">radius</span><span class="p">;</span>
<span class="lineno"> 185 </span>    <span class="kt">int</span> <span class="n">material_index</span><span class="p">;</span>
<span class="lineno"> 186 </span>
<span class="lineno"> 187 </span><span class="p">}</span> <span class="n">U_ALIGN</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="n">sphere</span><span class="p">;</span>
<span class="lineno"> 188 </span>
<span class="lineno"> 189 </span>
<span class="lineno"> 190 </span><span class="kt">float</span> <span class="nf">does_collide_sphere</span><span class="p">(</span><span class="n">sphere</span><span class="p">,</span> <span class="n">ray</span><span class="p">);</span>
<span class="lineno"> 191 </span>
<span class="lineno"> 192 </span>
<span class="lineno"> 193 </span><span class="cm">/*********/</span>
<span class="lineno"> 194 </span><span class="cm">/* Plane */</span>
<span class="lineno"> 195 </span><span class="cm">/*********/</span>
<span class="lineno"> 196 </span>
<span class="lineno"> 197 </span><span class="k">typedef</span> <span class="nf">W_ALIGN</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="k">struct</span> <span class="n">plane</span> <span class="c1">// bytes</span>
<span class="lineno"> 198 </span><span class="p">{</span>
<span class="lineno"> 199 </span>    <span class="n">vec4</span> <span class="n">pos</span><span class="p">;</span> <span class="c1">//12</span>
<span class="lineno"> 200 </span>    <span class="c1">//float test;</span>
<span class="lineno"> 201 </span>
<span class="lineno"> 202 </span>    <span class="n">vec4</span> <span class="n">norm</span><span class="p">;</span>
<span class="lineno"> 203 </span>    <span class="c1">//float test2;</span>
<span class="lineno"> 204 </span>
<span class="lineno"> 205 </span><span class="c1">//32</span>
<span class="lineno"> 206 </span>    <span class="kt">int</span> <span class="n">material_index</span><span class="p">;</span>
<span class="lineno"> 207 </span><span class="p">}</span> <span class="n">U_ALIGN</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="n">plane</span><span class="p">;</span>
<span class="lineno"> 208 </span><span class="kt">float</span> <span class="nf">does_collide_plane</span><span class="p">(</span><span class="n">plane</span><span class="p">,</span> <span class="n">ray</span><span class="p">);</span>
<span class="lineno"> 209 </span>
<span class="lineno"> 210 </span><span class="n">ray</span> <span class="nf">generate_ray</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="kt">int</span> <span class="n">height</span><span class="p">,</span> <span class="kt">float</span> <span class="n">fov</span><span class="p">);</span>
<span class="lineno"> 211 </span><span class="kt">float</span><span class="o">*</span> <span class="nf">matvec_mul</span><span class="p">(</span><span class="n">mat4</span> <span class="n">m</span><span class="p">,</span> <span class="n">vec4</span> <span class="n">v</span><span class="p">);</span>
<span class="lineno"> 212 </span>
<span class="lineno"> 213 </span><span class="cm">/**********************/</span>
<span class="lineno"> 214 </span><span class="cm">/* irradiance_cache.h */</span>
<span class="lineno"> 215 </span><span class="cm">/**********************/</span>
<span class="lineno"> 216 </span>
<span class="lineno"> 217 </span><span class="cm">/******************************************/</span>
<span class="lineno"> 218 </span><span class="cm">/* NOTE: Irradiance Caching is Incomplete */</span>
<span class="lineno"> 219 </span><span class="cm">/******************************************/</span>
<span class="lineno"> 220 </span>
<span class="lineno"> 221 </span><span class="cp">#pragma once</span>
<span class="lineno"> 222 </span><span class="cp">#include</span> <span class="cpf">&lt;stdint.h&gt;</span><span class="cp"></span>
<span class="lineno"> 223 </span>
<span class="lineno"> 224 </span><span class="cp">#define NUM_MIPMAPS 4 </span><span class="c1">//NOTE: 1080/(2^4) != integer</span>
<span class="lineno"> 225 </span>
<span class="lineno"> 226 </span><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_rt_ctx</span> <span class="n">raytracer_context</span><span class="p">;</span>
<span class="lineno"> 227 </span>
<span class="lineno"> 228 </span><span class="c1">//    0 = 000: x-, y-, z-</span>
<span class="lineno"> 229 </span><span class="c1">//    1 = 001: x-, y-, z+</span>
<span class="lineno"> 230 </span><span class="c1">//    2 = 010: x-, y+, z-</span>
<span class="lineno"> 231 </span><span class="c1">//    3 = 011: x-, y+, z+</span>
<span class="lineno"> 232 </span><span class="c1">//    4 = 100: x+, y-, z-</span>
<span class="lineno"> 233 </span><span class="c1">//    5 = 101: x+, y-, z+</span>
<span class="lineno"> 234 </span><span class="c1">//    6 = 110: x+, y+, z-</span>
<span class="lineno"> 235 </span><span class="c1">//    7 = 111: x+, y+, z+</span>
<span class="lineno"> 236 </span>
<span class="lineno"> 237 </span><span class="k">typedef</span> <span class="k">struct</span>
<span class="lineno"> 238 </span><span class="p">{</span>
<span class="lineno"> 239 </span>    <span class="n">vec3</span> <span class="n">point</span><span class="p">;</span>
<span class="lineno"> 240 </span>    <span class="n">vec3</span> <span class="n">normal</span><span class="p">;</span>
<span class="lineno"> 241 </span>
<span class="lineno"> 242 </span>    <span class="kt">float</span> <span class="n">rad</span><span class="p">;</span>
<span class="lineno"> 243 </span>
<span class="lineno"> 244 </span>    <span class="n">vec3</span> <span class="n">col</span><span class="p">;</span>
<span class="lineno"> 245 </span>
<span class="lineno"> 246 </span>    <span class="n">vec3</span> <span class="n">gpos</span><span class="p">;</span>
<span class="lineno"> 247 </span>    <span class="n">vec3</span> <span class="n">gdir</span><span class="p">;</span>
<span class="lineno"> 248 </span><span class="p">}</span> <span class="n">ic_ir_value</span><span class="p">;</span>
<span class="lineno"> 249 </span>
<span class="lineno"> 250 </span><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_ic_octree_node</span> <span class="n">ic_octree_node</span><span class="p">;</span>
<span class="lineno"> 251 </span>
<span class="lineno"> 252 </span><span class="k">struct</span> <span class="n">_ic_octree_node</span>
<span class="lineno"> 253 </span><span class="p">{</span>
<span class="lineno"> 254 </span>    <span class="kt">bool</span> <span class="n">leaf</span><span class="p">;</span>
<span class="lineno"> 255 </span>    <span class="kt">bool</span> <span class="n">active</span><span class="p">;</span>
<span class="lineno"> 256 </span>
<span class="lineno"> 257 </span>    <span class="k">union</span>
<span class="lineno"> 258 </span>    <span class="p">{</span>
<span class="lineno"> 259 </span>        <span class="k">struct</span>
<span class="lineno"> 260 </span>        <span class="p">{</span>
<span class="lineno"> 261 </span>            <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">buffer_offset</span><span class="p">;</span>
<span class="lineno"> 262 </span>            <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_elems</span><span class="p">;</span>
<span class="lineno"> 263 </span>        <span class="p">}</span> <span class="n">leaf</span><span class="p">;</span>
<span class="lineno"> 264 </span>        <span class="k">struct</span>
<span class="lineno"> 265 </span>        <span class="p">{</span>
<span class="lineno"> 266 </span>
<span class="lineno"> 267 </span>            <span class="n">ic_octree_node</span><span class="o">*</span> <span class="n">children</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
<span class="lineno"> 268 </span>        <span class="p">}</span> <span class="n">branch</span><span class="p">;</span>
<span class="lineno"> 269 </span>    <span class="p">}</span> <span class="n">data</span><span class="p">;</span>
<span class="lineno"> 270 </span>    <span class="n">vec3</span> <span class="n">min</span><span class="p">;</span>
<span class="lineno"> 271 </span>    <span class="n">vec3</span> <span class="n">max</span><span class="p">;</span>
<span class="lineno"> 272 </span><span class="p">};</span>
<span class="lineno"> 273 </span>
<span class="lineno"> 274 </span><span class="k">typedef</span> <span class="k">struct</span>
<span class="lineno"> 275 </span><span class="p">{</span>
<span class="lineno"> 276 </span>    <span class="n">ic_octree_node</span><span class="o">*</span> <span class="n">root</span><span class="p">;</span>
<span class="lineno"> 277 </span>    <span class="kt">int</span> <span class="n">node_count</span><span class="p">;</span>
<span class="lineno"> 278 </span>    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">width</span><span class="p">;</span>
<span class="lineno"> 279 </span>    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_depth</span><span class="p">;</span>
<span class="lineno"> 280 </span><span class="p">}</span> <span class="n">ic_octree</span><span class="p">;</span>
<span class="lineno"> 281 </span>
<span class="lineno"> 282 </span><span class="k">typedef</span> <span class="k">struct</span>
<span class="lineno"> 283 </span><span class="p">{</span>
<span class="lineno"> 284 </span>    <span class="c1">//vec4* texture;</span>
<span class="lineno"> 285 </span>    <span class="n">cl_mem</span> <span class="n">cl_image_ref</span><span class="p">;</span>
<span class="lineno"> 286 </span>    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">;</span>
<span class="lineno"> 287 </span><span class="p">}</span>  <span class="n">ic_mipmap_gb</span><span class="p">;</span>
<span class="lineno"> 288 </span>
<span class="lineno"> 289 </span><span class="k">typedef</span> <span class="k">struct</span>
<span class="lineno"> 290 </span><span class="p">{</span>
<span class="lineno"> 291 </span>    <span class="c1">//float* texture;</span>
<span class="lineno"> 292 </span>    <span class="n">cl_mem</span> <span class="n">cl_image_ref</span><span class="p">;</span>
<span class="lineno"> 293 </span>    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">;</span>
<span class="lineno"> 294 </span><span class="p">}</span>  <span class="n">ic_mipmap_f</span><span class="p">;</span>
<span class="lineno"> 295 </span>
<span class="lineno"> 296 </span><span class="k">typedef</span> <span class="k">struct</span>
<span class="lineno"> 297 </span><span class="p">{</span>
<span class="lineno"> 298 </span>
<span class="lineno"> 299 </span>    <span class="n">cl_image_format</span> <span class="n">cl_standard_format</span><span class="p">;</span>
<span class="lineno"> 300 </span>    <span class="n">cl_image_desc</span>   <span class="n">cl_standard_descriptor</span><span class="p">;</span>
<span class="lineno"> 301 </span>    <span class="n">ic_octree</span>       <span class="n">octree</span><span class="p">;</span>
<span class="lineno"> 302 </span>    <span class="n">ic_ir_value</span><span class="o">*</span>    <span class="n">ir_buf</span><span class="p">;</span>
<span class="lineno"> 303 </span>    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ir_buf_size</span><span class="p">;</span>
<span class="lineno"> 304 </span>    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ir_buf_current_offset</span><span class="p">;</span>
<span class="lineno"> 305 </span><span class="p">}</span>  <span class="n">ic_context</span><span class="p">;</span>
<span class="lineno"> 306 </span>
<span class="lineno"> 307 </span><span class="kt">void</span> <span class="nf">ic_init</span><span class="p">(</span><span class="n">raytracer_context</span><span class="o">*</span><span class="p">);</span>
<span class="lineno"> 308 </span><span class="kt">void</span> <span class="nf">ic_screenspace</span><span class="p">(</span><span class="n">raytracer_context</span><span class="o">*</span><span class="p">);</span>
<span class="lineno"> 309 </span><span class="kt">void</span> <span class="nf">ic_octree_init_branch</span><span class="p">(</span><span class="n">ic_octree_node</span><span class="o">*</span><span class="p">);</span>
<span class="lineno"> 310 </span><span class="kt">void</span> <span class="nf">ic_octree_insert</span><span class="p">(</span><span class="n">ic_context</span><span class="o">*</span><span class="p">,</span> <span class="n">vec3</span> <span class="n">point</span><span class="p">,</span> <span class="n">vec3</span> <span class="n">normal</span><span class="p">);</span>
<span class="lineno"> 311 </span>
<span class="lineno"> 312 </span>
<span class="lineno"> 313 </span>
<span class="lineno"> 314 </span><span class="cm">/************/</span>
<span class="lineno"> 315 </span><span class="cm">/* loader.h */</span>
<span class="lineno"> 316 </span><span class="cm">/************/</span>
<span class="lineno"> 317 </span><span class="cp">#pragma once</span>
<span class="lineno"> 318 </span><span class="cp">#include</span> <span class="cpf">&lt;scene.h&gt;</span><span class="cp"></span>
<span class="lineno"> 319 </span>
<span class="lineno"> 320 </span><span class="n">scene</span><span class="o">*</span> <span class="nf">load_scene_json</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">data</span><span class="p">);</span>
<span class="lineno"> 321 </span><span class="n">scene</span><span class="o">*</span> <span class="nf">load_scene_json_url</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">url</span><span class="p">);</span>
<span class="lineno"> 322 </span>
<span class="lineno"> 323 </span>
<span class="lineno"> 324 </span>
<span class="lineno"> 325 </span><span class="cm">/************/</span>
<span class="lineno"> 326 </span><span class="cm">/* os_abs.h */</span>
<span class="lineno"> 327 </span><span class="cm">/************/</span>
<span class="lineno"> 328 </span>
<span class="lineno"> 329 </span><span class="cp">#pragma once</span>
<span class="lineno"> 330 </span>
<span class="lineno"> 331 </span><span class="k">typedef</span> <span class="k">struct</span>
<span class="lineno"> 332 </span><span class="p">{</span>
<span class="lineno"> 333 </span>    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">start_func</span><span class="p">)();</span>
<span class="lineno"> 334 </span>    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">loop_start_func</span><span class="p">)();</span>
<span class="lineno"> 335 </span>    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">update_func</span><span class="p">)();</span>
<span class="lineno"> 336 </span>    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">sleep_func</span><span class="p">)(</span><span class="kt">int</span><span class="p">);</span>
<span class="lineno"> 337 </span>    <span class="kt">void</span><span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">get_bitmap_memory_func</span><span class="p">)();</span>
<span class="lineno"> 338 </span>    <span class="kt">int</span>  <span class="p">(</span><span class="o">*</span><span class="n">get_time_mili_func</span><span class="p">)();</span>
<span class="lineno"> 339 </span>    <span class="kt">int</span>  <span class="p">(</span><span class="o">*</span><span class="n">get_width_func</span><span class="p">)();</span>
<span class="lineno"> 340 </span>    <span class="kt">int</span>  <span class="p">(</span><span class="o">*</span><span class="n">get_height_func</span><span class="p">)();</span>
<span class="lineno"> 341 </span>    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">start_thread_func</span><span class="p">)(</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">func</span><span class="p">)(</span><span class="kt">void</span><span class="o">*</span><span class="p">),</span> <span class="kt">void</span><span class="o">*</span> <span class="n">data</span><span class="p">);</span>
<span class="lineno"> 342 </span><span class="p">}</span> <span class="n">os_abs</span><span class="p">;</span>
<span class="lineno"> 343 </span>
<span class="lineno"> 344 </span><span class="kt">void</span> <span class="nf">os_start</span><span class="p">(</span><span class="n">os_abs</span><span class="p">);</span>
<span class="lineno"> 345 </span><span class="kt">void</span> <span class="nf">os_loop_start</span><span class="p">(</span><span class="n">os_abs</span><span class="p">);</span>
<span class="lineno"> 346 </span><span class="kt">void</span> <span class="nf">os_update</span><span class="p">(</span><span class="n">os_abs</span><span class="p">);</span>
<span class="lineno"> 347 </span><span class="kt">void</span> <span class="nf">os_sleep</span><span class="p">(</span><span class="n">os_abs</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="lineno"> 348 </span><span class="kt">void</span><span class="o">*</span> <span class="nf">os_get_bitmap_memory</span><span class="p">(</span><span class="n">os_abs</span><span class="p">);</span>
<span class="lineno"> 349 </span><span class="kt">int</span> <span class="nf">os_get_time_mili</span><span class="p">(</span><span class="n">os_abs</span><span class="p">);</span>
<span class="lineno"> 350 </span><span class="kt">int</span> <span class="nf">os_get_width</span><span class="p">(</span><span class="n">os_abs</span><span class="p">);</span>
<span class="lineno"> 351 </span><span class="kt">int</span> <span class="nf">os_get_height</span><span class="p">(</span><span class="n">os_abs</span><span class="p">);</span>
<span class="lineno"> 352 </span><span class="kt">void</span> <span class="nf">os_start_thread</span><span class="p">(</span><span class="n">os_abs</span><span class="p">,</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">func</span><span class="p">)(</span><span class="kt">void</span><span class="o">*</span><span class="p">),</span> <span class="kt">void</span><span class="o">*</span> <span class="n">data</span><span class="p">);</span>
<span class="lineno"> 353 </span>
<span class="lineno"> 354 </span>
<span class="lineno"> 355 </span>
<span class="lineno"> 356 </span><span class="cm">/**************/</span>
<span class="lineno"> 357 </span><span class="cm">/* parallel.h */</span>
<span class="lineno"> 358 </span><span class="cm">/**************/</span>
<span class="lineno"> 359 </span><span class="cp">#pragma once</span>
<span class="lineno"> 360 </span><span class="cp">#include</span> <span class="cpf">&lt;CL/opencl.h&gt;</span><span class="cp"></span>
<span class="lineno"> 361 </span><span class="cp">#include</span> <span class="cpf">&lt;geom.h&gt;</span><span class="cp"></span>
<span class="lineno"> 362 </span><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_rt_ctx</span> <span class="n">raytracer_context</span><span class="p">;</span>
<span class="lineno"> 363 </span>
<span class="lineno"> 364 </span><span class="k">typedef</span> <span class="k">struct</span>
<span class="lineno"> 365 </span><span class="p">{</span>
<span class="lineno"> 366 </span>    <span class="n">cl_platform_id</span> <span class="n">platform_id</span><span class="p">;</span>
<span class="lineno"> 367 </span>    <span class="n">cl_device_id</span> <span class="n">device_id</span><span class="p">;</span>             <span class="c1">// compute device id</span>
<span class="lineno"> 368 </span>    <span class="n">cl_context</span> <span class="n">context</span><span class="p">;</span>                 <span class="c1">// compute context</span>
<span class="lineno"> 369 </span>    <span class="n">cl_command_queue</span> <span class="n">commands</span><span class="p">;</span>          <span class="c1">// compute command queue</span>
<span class="lineno"> 370 </span>
<span class="lineno"> 371 </span><span class="p">}</span> <span class="n">rcl_ctx</span><span class="p">;</span>
<span class="lineno"> 372 </span>
<span class="lineno"> 373 </span><span class="k">typedef</span> <span class="k">struct</span>
<span class="lineno"> 374 </span><span class="p">{</span>
<span class="lineno"> 375 </span>    <span class="n">cl_program</span> <span class="n">program</span><span class="p">;</span>
<span class="lineno"> 376 </span>    <span class="n">cl_kernel</span><span class="o">*</span> <span class="n">raw_kernels</span><span class="p">;</span> <span class="c1">//NOTE: not a good solution</span>
<span class="lineno"> 377 </span>    <span class="kt">char</span><span class="o">*</span>      <span class="n">raw_data</span><span class="p">;</span>
<span class="lineno"> 378 </span>
<span class="lineno"> 379 </span><span class="p">}</span> <span class="n">rcl_program</span><span class="p">;</span>
<span class="lineno"> 380 </span>
<span class="lineno"> 381 </span><span class="kt">void</span> <span class="nf">cl_info</span><span class="p">();</span>
<span class="lineno"> 382 </span><span class="kt">void</span> <span class="nf">create_context</span><span class="p">(</span><span class="n">rcl_ctx</span><span class="o">*</span> <span class="n">context</span><span class="p">);</span>
<span class="lineno"> 383 </span><span class="kt">void</span> <span class="nf">load_program_raw</span><span class="p">(</span><span class="n">rcl_ctx</span><span class="o">*</span> <span class="n">ctx</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">data</span><span class="p">,</span> <span class="kt">char</span><span class="o">**</span> <span class="n">kernels</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_kernels</span><span class="p">,</span>
<span class="lineno"> 384 </span>                      <span class="n">rcl_program</span><span class="o">*</span> <span class="n">program</span><span class="p">,</span> <span class="kt">char</span><span class="o">**</span> <span class="n">macros</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_macros</span><span class="p">);</span>
<span class="lineno"> 385 </span><span class="kt">void</span> <span class="nf">load_program_url</span><span class="p">(</span><span class="n">rcl_ctx</span><span class="o">*</span> <span class="n">ctx</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">url</span><span class="p">,</span>  <span class="kt">char</span><span class="o">**</span> <span class="n">kernels</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_kernels</span><span class="p">,</span>
<span class="lineno"> 386 </span>                      <span class="n">rcl_program</span><span class="o">*</span> <span class="n">program</span><span class="p">,</span> <span class="kt">char</span><span class="o">**</span> <span class="n">macros</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_macros</span><span class="p">);</span>
<span class="lineno"> 387 </span><span class="kt">void</span> <span class="nf">test_sphere_raytracer</span><span class="p">(</span><span class="n">rcl_ctx</span><span class="o">*</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">rcl_program</span><span class="o">*</span> <span class="n">program</span><span class="p">,</span>
<span class="lineno"> 388 </span>                           <span class="n">sphere</span><span class="o">*</span> <span class="n">spheres</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num_spheres</span><span class="p">,</span>
<span class="lineno"> 389 </span>                           <span class="kt">uint32_t</span><span class="o">*</span> <span class="n">bitmap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="kt">int</span> <span class="n">height</span><span class="p">);</span>
<span class="lineno"> 390 </span><span class="n">cl_mem</span> <span class="nf">gen_rgb_image</span><span class="p">(</span><span class="n">raytracer_context</span><span class="o">*</span> <span class="n">rctx</span><span class="p">,</span>
<span class="lineno"> 391 </span>                     <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">width</span><span class="p">,</span>
<span class="lineno"> 392 </span>                     <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">height</span><span class="p">);</span>
<span class="lineno"> 393 </span><span class="n">cl_mem</span> <span class="nf">gen_grayscale_buffer</span><span class="p">(</span><span class="n">raytracer_context</span><span class="o">*</span> <span class="n">rctx</span><span class="p">,</span>
<span class="lineno"> 394 </span>                            <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">width</span><span class="p">,</span>
<span class="lineno"> 395 </span>                            <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">height</span><span class="p">);</span>
<span class="lineno"> 396 </span><span class="n">cl_mem</span> <span class="nf">gen_1d_image</span><span class="p">(</span><span class="n">raytracer_context</span><span class="o">*</span> <span class="n">rctx</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">t</span><span class="p">,</span> <span class="kt">void</span><span class="o">*</span> <span class="n">ptr</span><span class="p">);</span>
<span class="lineno"> 397 </span><span class="kt">void</span> <span class="nf">retrieve_buf</span><span class="p">(</span><span class="n">raytracer_context</span><span class="o">*</span> <span class="n">rctx</span><span class="p">,</span> <span class="n">cl_mem</span> <span class="n">g_buf</span><span class="p">,</span> <span class="kt">void</span><span class="o">*</span> <span class="n">c_buf</span><span class="p">,</span> <span class="kt">size_t</span><span class="p">);</span>
<span class="lineno"> 398 </span>
<span class="lineno"> 399 </span><span class="kt">void</span> <span class="nf">zero_buffer_img</span><span class="p">(</span><span class="n">raytracer_context</span><span class="o">*</span> <span class="n">rctx</span><span class="p">,</span> <span class="n">cl_mem</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">element</span><span class="p">,</span>
<span class="lineno"> 400 </span>                 <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">width</span><span class="p">,</span>
<span class="lineno"> 401 </span>                 <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">height</span><span class="p">);</span>
<span class="lineno"> 402 </span><span class="kt">void</span> <span class="nf">zero_buffer</span><span class="p">(</span><span class="n">raytracer_context</span><span class="o">*</span> <span class="n">rctx</span><span class="p">,</span> <span class="n">cl_mem</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">);</span>
<span class="lineno"> 403 </span><span class="kt">size_t</span> <span class="nf">get_workgroup_size</span><span class="p">(</span><span class="n">raytracer_context</span><span class="o">*</span> <span class="n">rctx</span><span class="p">,</span> <span class="n">cl_kernel</span> <span class="n">kernel</span><span class="p">);</span>
<span class="lineno"> 404 </span>
<span class="lineno"> 405 </span><span class="cm">/***************/</span>
<span class="lineno"> 406 </span><span class="cm">/* raytracer.h */</span>
<span class="lineno"> 407 </span><span class="cm">/***************/</span>
<span class="lineno"> 408 </span><span class="cp">#pragma once</span>
<span class="lineno"> 409 </span><span class="cp">#include</span> <span class="cpf">&lt;stdint.h&gt;</span><span class="cp"></span>
<span class="lineno"> 410 </span><span class="cp">#include</span> <span class="cpf">&lt;parallel.h&gt;</span><span class="cp"></span>
<span class="lineno"> 411 </span><span class="cp">#include</span> <span class="cpf">&lt;CL/opencl.h&gt;</span><span class="cp"></span>
<span class="lineno"> 412 </span><span class="cp">#include</span> <span class="cpf">&lt;scene.h&gt;</span><span class="cp"></span>
<span class="lineno"> 413 </span><span class="cp">#include</span> <span class="cpf">&lt;irradiance_cache.h&gt;</span><span class="cp"></span>
<span class="lineno"> 414 </span>
<span class="lineno"> 415 </span><span class="c1">//Cheap, quick, and dirty way of managing kernels.</span>
<span class="lineno"> 416 </span><span class="cp">#define KERNELS {"cast_ray_test", "generate_rays", "path_trace",    \</span>
<span class="lineno"> 417 </span><span class="cp">                 "buffer_average", "f_buffer_average", "f_buffer_to_byte_buffer", \</span>
<span class="lineno"> 418 </span><span class="cp">                 "ic_screen_textures", "generate_discontinuity",        \</span>
<span class="lineno"> 419 </span><span class="cp">                 "float_average", "mip_single_upsample", "mip_upsample", \</span>
<span class="lineno"> 420 </span><span class="cp">                 "mip_upsample_scaled", "mip_single_upsample_scaled", "mip_reduce", \</span>
<span class="lineno"> 421 </span><span class="cp">                 "blit_float_to_output", "blit_float3_to_output"}</span>
<span class="lineno"> 422 </span><span class="cp">#define NUM_KERNELS 16</span>
<span class="lineno"> 423 </span><span class="cp">#define RAY_CAST_KRNL_INDX 0</span>
<span class="lineno"> 424 </span><span class="cp">#define RAY_BUFFER_KRNL_INDX 1</span>
<span class="lineno"> 425 </span><span class="cp">#define PATH_TRACE_KRNL_INDX 2</span>
<span class="lineno"> 426 </span><span class="cp">#define BUFFER_AVG_KRNL_INDX 3</span>
<span class="lineno"> 427 </span><span class="cp">#define F_BUFFER_AVG_KRNL_INDX 4</span>
<span class="lineno"> 428 </span><span class="cp">#define F_BUF_TO_BYTE_BUF_KRNL_INDX 5</span>
<span class="lineno"> 429 </span><span class="cp">#define IC_SCREEN_TEX_KRNL_INDX 6</span>
<span class="lineno"> 430 </span><span class="cp">#define IC_GEN_DISC_KRNL_INDX 7</span>
<span class="lineno"> 431 </span><span class="cp">#define IC_FLOAT_AVG_KRNL_INDX 8</span>
<span class="lineno"> 432 </span><span class="cp">#define IC_MIP_S_UPSAMPLE_KRNL_INDX 9</span>
<span class="lineno"> 433 </span><span class="cp">#define IC_MIP_UPSAMPLE_KRNL_INDX 10</span>
<span class="lineno"> 434 </span><span class="cp">#define IC_MIP_UPSAMPLE_SCALED_KRNL_INDX 11</span>
<span class="lineno"> 435 </span><span class="cp">#define IC_MIP_S_UPSAMPLE_SCALED_KRNL_INDX 12</span>
<span class="lineno"> 436 </span><span class="cp">#define IC_MIP_REDUCE_KRNL_INDX 13</span>
<span class="lineno"> 437 </span><span class="cp">#define BLIT_FLOAT_OUTPUT_INDX 14</span>
<span class="lineno"> 438 </span><span class="cp">#define BLIT_FLOAT3_OUTPUT_INDX 15</span>
<span class="lineno"> 439 </span>
<span class="lineno"> 440 </span>
<span class="lineno"> 441 </span><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_rt_ctx</span> <span class="n">raytracer_context</span><span class="p">;</span>
<span class="lineno"> 442 </span>
<span class="lineno"> 443 </span><span class="k">struct</span> <span class="n">_rt_ctx</span>
<span class="lineno"> 444 </span><span class="p">{</span>
<span class="lineno"> 445 </span>    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">;</span>
<span class="lineno"> 446 </span>
<span class="lineno"> 447 </span>    <span class="kt">float</span><span class="o">*</span> <span class="n">ray_buffer</span><span class="p">;</span>
<span class="lineno"> 448 </span>    <span class="n">vec4</span><span class="o">*</span>  <span class="n">path_output_buffer</span><span class="p">;</span>
<span class="lineno"> 449 </span>    <span class="kt">uint32_t</span><span class="o">*</span> <span class="n">output_buffer</span><span class="p">;</span>
<span class="lineno"> 450 </span>    <span class="c1">//uint32_t* fresh_frame_buffer;</span>
<span class="lineno"> 451 </span>
<span class="lineno"> 452 </span>    <span class="n">scene</span><span class="o">*</span> <span class="n">stat_scene</span><span class="p">;</span>
<span class="lineno"> 453 </span>    <span class="n">ic_context</span><span class="o">*</span> <span class="n">ic_ctx</span><span class="p">;</span>
<span class="lineno"> 454 </span>
<span class="lineno"> 455 </span>
<span class="lineno"> 456 </span>    <span class="c1">//TODO: seperate into contexts for each integrator.</span>
<span class="lineno"> 457 </span>    <span class="c1">//Path tracing only</span>
<span class="lineno"> 458 </span>
<span class="lineno"> 459 </span>    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_samples</span><span class="p">;</span>
<span class="lineno"> 460 </span>    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">current_sample</span><span class="p">;</span>
<span class="lineno"> 461 </span>    <span class="kt">bool</span> <span class="n">render_complete</span><span class="p">;</span>
<span class="lineno"> 462 </span>
<span class="lineno"> 463 </span>    <span class="c1">//CL</span>
<span class="lineno"> 464 </span>    <span class="n">rcl_ctx</span><span class="o">*</span> <span class="n">rcl</span><span class="p">;</span>
<span class="lineno"> 465 </span>    <span class="n">rcl_program</span><span class="o">*</span> <span class="n">program</span><span class="p">;</span>
<span class="lineno"> 466 </span>
<span class="lineno"> 467 </span>    <span class="n">cl_mem</span> <span class="n">cl_ray_buffer</span><span class="p">;</span>
<span class="lineno"> 468 </span>    <span class="n">cl_mem</span> <span class="n">cl_output_buffer</span><span class="p">;</span>
<span class="lineno"> 469 </span>    <span class="n">cl_mem</span> <span class="n">cl_path_output_buffer</span><span class="p">;</span>
<span class="lineno"> 470 </span>    <span class="n">cl_mem</span> <span class="n">cl_path_fresh_frame_buffer</span><span class="p">;</span> <span class="c1">//Only exists on GPU</span>
<span class="lineno"> 471 </span>
<span class="lineno"> 472 </span><span class="p">};</span>
<span class="lineno"> 473 </span>
<span class="lineno"> 474 </span><span class="n">raytracer_context</span><span class="o">*</span> <span class="nf">raytracer_init</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">height</span><span class="p">,</span>
<span class="lineno"> 475 </span>                                  <span class="kt">uint32_t</span><span class="o">*</span> <span class="n">output_buffer</span><span class="p">,</span> <span class="n">rcl_ctx</span><span class="o">*</span> <span class="n">ctx</span><span class="p">);</span>
<span class="lineno"> 476 </span><span class="kt">void</span> <span class="nf">raytracer_prepass</span><span class="p">(</span><span class="n">raytracer_context</span><span class="o">*</span><span class="p">);</span>
<span class="lineno"> 477 </span><span class="kt">void</span> <span class="nf">raytracer_render</span><span class="p">(</span><span class="n">raytracer_context</span><span class="o">*</span><span class="p">);</span>
<span class="lineno"> 478 </span><span class="kt">void</span> <span class="nf">raytracer_refined_render</span><span class="p">(</span><span class="n">raytracer_context</span><span class="o">*</span><span class="p">);</span>
<span class="lineno"> 479 </span><span class="kt">void</span> <span class="nf">_raytracer_gen_ray_buffer</span><span class="p">(</span><span class="n">raytracer_context</span><span class="o">*</span><span class="p">);</span>
<span class="lineno"> 480 </span><span class="kt">void</span> <span class="nf">_raytracer_path_trace</span><span class="p">(</span><span class="n">raytracer_context</span><span class="o">*</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="p">);</span>
<span class="lineno"> 481 </span><span class="kt">void</span> <span class="nf">_raytracer_average_buffers</span><span class="p">(</span><span class="n">raytracer_context</span><span class="o">*</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="p">);</span> <span class="c1">//NOTE: DEPRECATED</span>
<span class="lineno"> 482 </span><span class="kt">void</span> <span class="nf">_raytracer_push_path</span><span class="p">(</span><span class="n">raytracer_context</span><span class="o">*</span><span class="p">);</span>
<span class="lineno"> 483 </span><span class="kt">void</span> <span class="nf">_raytracer_cast_rays</span><span class="p">(</span><span class="n">raytracer_context</span><span class="o">*</span><span class="p">);</span> <span class="c1">//NOTE: DEPRECATED</span>
<span class="lineno"> 484 </span>
<span class="lineno"> 485 </span><span class="cm">/***********/</span>
<span class="lineno"> 486 </span><span class="cm">/* debug.c */</span>
<span class="lineno"> 487 </span><span class="cm">/***********/</span>
<span class="lineno"> 488 </span>
<span class="lineno"> 489 </span><span class="cp">#ifdef _MEM_DEBUG</span>
<span class="lineno"> 490 </span><span class="kt">void</span><span class="o">*</span> <span class="nf">_debug_memcpy</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">dest</span><span class="p">,</span> <span class="kt">void</span><span class="o">*</span> <span class="n">from</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">line</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">func</span><span class="p">)</span>
<span class="lineno"> 491 </span><span class="p">{</span>
<span class="lineno"> 492 </span>    <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">-"</span><span class="p">);</span>
<span class="lineno"> 493 </span>    <span class="n">memcpy</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
<span class="lineno"> 494 </span>    <span class="n">printf</span><span class="p">(</span><span class="s">"- memcpy at %i, %s, %p[%li]</span><span class="se">\n\n</span><span class="s">"</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
<span class="lineno"> 495 </span>    <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
<span class="lineno"> 496 </span>    <span class="k">return</span> <span class="n">dest</span><span class="p">;</span>
<span class="lineno"> 497 </span><span class="p">}</span>
<span class="lineno"> 498 </span><span class="kt">void</span><span class="o">*</span> <span class="nf">_debug_malloc</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">line</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">func</span><span class="p">)</span>
<span class="lineno"> 499 </span><span class="p">{</span>
<span class="lineno"> 500 </span>    <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">-"</span><span class="p">);</span>
<span class="lineno"> 501 </span>    <span class="kt">void</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
<span class="lineno"> 502 </span>    <span class="n">printf</span><span class="p">(</span><span class="s">"- Allocation at %i, %s, %p[%li]</span><span class="se">\n\n</span><span class="s">"</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
<span class="lineno"> 503 </span>    <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
<span class="lineno"> 504 </span>    <span class="k">return</span> <span class="n">p</span><span class="p">;</span>
<span class="lineno"> 505 </span><span class="p">}</span>
<span class="lineno"> 506 </span>
<span class="lineno"> 507 </span><span class="kt">void</span> <span class="nf">_debug_free</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">ptr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">line</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">func</span><span class="p">)</span>
<span class="lineno"> 508 </span><span class="p">{</span>
<span class="lineno"> 509 </span>    <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">-"</span><span class="p">);</span>
<span class="lineno"> 510 </span>    <span class="n">free</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
<span class="lineno"> 511 </span>    <span class="n">printf</span><span class="p">(</span><span class="s">"- Free at %i, %s, %p</span><span class="se">\n\n</span><span class="s">"</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">ptr</span><span class="p">);</span>
<span class="lineno"> 512 </span>    <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
<span class="lineno"> 513 </span><span class="p">}</span>
<span class="lineno"> 514 </span>
<span class="lineno"> 515 </span>
<span class="lineno"> 516 </span><span class="cp">#define malloc(X) _debug_malloc( X, __LINE__, __FUNCTION__)</span>
<span class="lineno"> 517 </span><span class="cp">#define free(X) _debug_free( X, __LINE__, __FUNCTION__)</span>
<span class="lineno"> 518 </span><span class="cp">#define memcpy(X, Y, Z) _debug_memcpy( X, Y, Z, __LINE__, __FUNCTION__)</span>
<span class="lineno"> 519 </span>
<span class="lineno"> 520 </span><span class="cp">#endif</span>
<span class="lineno"> 521 </span>
<span class="lineno"> 522 </span><span class="cp">#ifdef WIN32</span>
<span class="lineno"> 523 </span><span class="cp">#define _FILE_SEP '\\'</span>
<span class="lineno"> 524 </span><span class="cp">#else</span>
<span class="lineno"> 525 </span><span class="cp">#define _FILE_SEP '/'</span>
<span class="lineno"> 526 </span><span class="cp">#endif</span>
<span class="lineno"> 527 </span>
<span class="lineno"> 528 </span><span class="cp">#define __FILENAME__ (strrchr(__FILE__, _FILE_SEP) ? strrchr(__FILE__, _FILE_SEP) + 1 : __FILE__)</span>
<span class="lineno"> 529 </span>
<span class="lineno"> 530 </span>
<span class="lineno"> 531 </span><span class="c1">//TODO: replace all errors with this.</span>
<span class="lineno"> 532 </span><span class="cp">#define ASRT_CL(m)                                                                            \</span>
<span class="lineno"> 533 </span><span class="cp">    if(err!=CL_SUCCESS)                                                                       \</span>
<span class="lineno"> 534 </span><span class="cp">    {                                                                                         \</span>
<span class="lineno"> 535 </span><span class="cp">        fprintf(stderr, "ERROR: %s. (code: %i, line: %i, file:%s)\nPRESS ENTER TO EXIT\n", \</span>
<span class="lineno"> 536 </span><span class="cp">            m, err, __LINE__, __FILENAME__);                            \</span>
<span class="lineno"> 537 </span><span class="cp">        fflush(stderr);                                                 \</span>
<span class="lineno"> 538 </span><span class="cp">        while(1){char c; scanf("%c",&amp;c); exit(1);}                      \</span>
<span class="lineno"> 539 </span><span class="cp">    }</span>
<span class="lineno"> 540 </span>
<span class="lineno"> 541 </span><span class="cm">/**********/</span>
<span class="lineno"> 542 </span><span class="cm">/* geom.c */</span>
<span class="lineno"> 543 </span><span class="cm">/**********/</span>
<span class="lineno"> 544 </span><span class="cp">#include</span> <span class="cpf">&lt;geom.h&gt;</span><span class="cp"></span>
<span class="lineno"> 545 </span><span class="cp">#define DEBUG_PRINT_VEC3(n, v) printf(n ": (%f, %f, %f)\n", v[0], v[1], v[2])</span>
<span class="lineno"> 546 </span>
<span class="lineno"> 547 </span>
<span class="lineno"> 548 </span><span class="kr">inline</span> <span class="kt">bool</span> <span class="nf">solve_quadratic</span><span class="p">(</span><span class="kt">float</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="n">b</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="n">x0</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="n">x1</span><span class="p">)</span>
<span class="lineno"> 549 </span><span class="p">{</span>
<span class="lineno"> 550 </span>    <span class="kt">float</span> <span class="n">discr</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">b</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">b</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">c</span><span class="p">);</span>
<span class="lineno"> 551 </span>
<span class="lineno"> 552 </span>    <span class="k">if</span> <span class="p">(</span><span class="n">discr</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="lineno"> 553 </span>    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">discr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno"> 554 </span>        <span class="p">(</span><span class="o">*</span><span class="n">x0</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">x1</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">b</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">);</span>
<span class="lineno"> 555 </span>    <span class="p">}</span>
<span class="lineno"> 556 </span>    <span class="k">else</span> <span class="p">{</span>
<span class="lineno"> 557 </span>        <span class="kt">float</span> <span class="n">q</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">b</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span>
<span class="lineno"> 558 </span>            <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">b</span> <span class="o">+</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">discr</span><span class="p">))</span> <span class="o">:</span>
<span class="lineno"> 559 </span>            <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">b</span> <span class="o">-</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">discr</span><span class="p">));</span>
<span class="lineno"> 560 </span>        <span class="o">*</span><span class="n">x0</span> <span class="o">=</span> <span class="n">q</span> <span class="o">/</span> <span class="o">*</span><span class="n">a</span><span class="p">;</span>
<span class="lineno"> 561 </span>        <span class="o">*</span><span class="n">x1</span> <span class="o">=</span> <span class="o">*</span><span class="n">c</span> <span class="o">/</span> <span class="n">q</span><span class="p">;</span>
<span class="lineno"> 562 </span>    <span class="p">}</span>
<span class="lineno"> 563 </span>
<span class="lineno"> 564 </span>    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="lineno"> 565 </span><span class="p">}</span>
<span class="lineno"> 566 </span>
<span class="lineno"> 567 </span><span class="kt">float</span><span class="o">*</span> <span class="nf">matvec_mul</span><span class="p">(</span><span class="n">mat4</span> <span class="n">m</span><span class="p">,</span> <span class="n">vec4</span> <span class="n">v</span><span class="p">)</span>
<span class="lineno"> 568 </span><span class="p">{</span>
<span class="lineno"> 569 </span>    <span class="kt">float</span><span class="o">*</span> <span class="n">out_float</span> <span class="o">=</span> <span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">vec4</span><span class="p">));</span>
<span class="lineno"> 570 </span>
<span class="lineno"> 571 </span>    <span class="n">out_float</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="o">+</span><span class="mi">0</span><span class="o">*</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="o">+</span><span class="mi">1</span><span class="o">*</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">v</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
<span class="lineno"> 572 </span>    <span class="n">out_float</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="o">+</span><span class="mi">0</span><span class="o">*</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="o">+</span><span class="mi">1</span><span class="o">*</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">v</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
<span class="lineno"> 573 </span>    <span class="n">out_float</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="mi">0</span><span class="o">*</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">m</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="o">*</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">m</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">m</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">v</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
<span class="lineno"> 574 </span>    <span class="n">out_float</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="mi">3</span><span class="o">+</span><span class="mi">0</span><span class="o">*</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">m</span><span class="p">[</span><span class="mi">3</span><span class="o">+</span><span class="mi">1</span><span class="o">*</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">m</span><span class="p">[</span><span class="mi">3</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">m</span><span class="p">[</span><span class="mi">3</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">v</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
<span class="lineno"> 575 </span>
<span class="lineno"> 576 </span>    <span class="k">return</span> <span class="n">out_float</span><span class="p">;</span>
<span class="lineno"> 577 </span><span class="p">}</span>
<span class="lineno"> 578 </span>
<span class="lineno"> 579 </span><span class="kt">void</span> <span class="nf">swap_float</span><span class="p">(</span><span class="kt">float</span> <span class="o">*</span><span class="n">f1</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="n">f2</span><span class="p">)</span>
<span class="lineno"> 580 </span><span class="p">{</span>
<span class="lineno"> 581 </span>    <span class="kt">float</span> <span class="n">temp</span> <span class="o">=</span> <span class="o">*</span><span class="n">f2</span><span class="p">;</span>
<span class="lineno"> 582 </span>    <span class="o">*</span><span class="n">f2</span> <span class="o">=</span> <span class="o">*</span><span class="n">f1</span><span class="p">;</span>
<span class="lineno"> 583 </span>    <span class="o">*</span><span class="n">f1</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>
<span class="lineno"> 584 </span><span class="p">}</span>
<span class="lineno"> 585 </span>
<span class="lineno"> 586 </span><span class="kr">inline</span> <span class="kt">float</span> <span class="nf">does_collide_sphere</span><span class="p">(</span><span class="n">sphere</span> <span class="n">s</span><span class="p">,</span> <span class="n">ray</span> <span class="n">r</span><span class="p">)</span>
<span class="lineno"> 587 </span><span class="p">{</span>
<span class="lineno"> 588 </span>    <span class="kt">float</span> <span class="n">t0</span><span class="p">,</span> <span class="n">t1</span><span class="p">;</span> <span class="c1">// solutions for t if the ray intersects</span>
<span class="lineno"> 589 </span>
<span class="lineno"> 590 </span>
<span class="lineno"> 591 </span>    <span class="n">vec3</span> <span class="n">L</span><span class="p">;</span>
<span class="lineno"> 592 </span>    <span class="n">xv_sub</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">r</span><span class="p">.</span><span class="n">orig</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">pos</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
<span class="lineno"> 593 </span>
<span class="lineno"> 594 </span>
<span class="lineno"> 595 </span>    <span class="kt">float</span> <span class="n">a</span> <span class="o">=</span> <span class="mf">1.0f</span><span class="p">;</span> <span class="c1">//NOTE: we always normalize the direction vector.</span>
<span class="lineno"> 596 </span>    <span class="kt">float</span> <span class="n">b</span> <span class="o">=</span> <span class="n">xv3_dot</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">dir</span><span class="p">,</span> <span class="n">L</span><span class="p">)</span> <span class="o">*</span> <span class="mf">2.0f</span><span class="p">;</span>
<span class="lineno"> 597 </span>    <span class="kt">float</span> <span class="n">c</span> <span class="o">=</span> <span class="n">xv3_dot</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">L</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">radius</span><span class="o">*</span><span class="n">s</span><span class="p">.</span><span class="n">radius</span><span class="p">);</span> <span class="c1">//NOTE: square can be optimized out.</span>
<span class="lineno"> 598 </span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">solve_quadratic</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">b</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t1</span><span class="p">))</span> <span class="k">return</span> <span class="o">-</span><span class="mf">1.0f</span><span class="p">;</span>
<span class="lineno"> 599 </span>
<span class="lineno"> 600 </span>    <span class="k">if</span> <span class="p">(</span><span class="n">t0</span> <span class="o">&gt;</span> <span class="n">t1</span><span class="p">)</span> <span class="n">swap_float</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t1</span><span class="p">);</span>
<span class="lineno"> 601 </span>
<span class="lineno"> 602 </span>    <span class="k">if</span> <span class="p">(</span><span class="n">t0</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno"> 603 </span>        <span class="n">t0</span> <span class="o">=</span> <span class="n">t1</span><span class="p">;</span> <span class="c1">// if t0 is negative, use t1 instead</span>
<span class="lineno"> 604 </span>        <span class="k">if</span> <span class="p">(</span><span class="n">t0</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mf">1.0f</span><span class="p">;</span> <span class="c1">// both t0 and t1 are negative</span>
<span class="lineno"> 605 </span>    <span class="p">}</span>
<span class="lineno"> 606 </span>
<span class="lineno"> 607 </span>    <span class="k">return</span> <span class="n">t0</span><span class="p">;</span>
<span class="lineno"> 608 </span><span class="p">}</span>
<span class="lineno"> 609 </span>
<span class="lineno"> 610 </span><span class="kr">inline</span> <span class="kt">float</span> <span class="nf">does_collide_plane</span><span class="p">(</span><span class="n">plane</span> <span class="n">p</span><span class="p">,</span> <span class="n">ray</span> <span class="n">r</span><span class="p">)</span>
<span class="lineno"> 611 </span><span class="p">{</span>
<span class="lineno"> 612 </span>    <span class="kt">float</span> <span class="n">denom</span> <span class="o">=</span> <span class="n">xv_dot3</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">dir</span><span class="p">,</span> <span class="n">p</span><span class="p">.</span><span class="n">norm</span><span class="p">);</span>
<span class="lineno"> 613 </span>    <span class="k">if</span> <span class="p">(</span><span class="n">denom</span> <span class="o">&gt;</span> <span class="mf">1e-6</span><span class="p">)</span>
<span class="lineno"> 614 </span>    <span class="p">{</span>
<span class="lineno"> 615 </span>        <span class="n">vec3</span> <span class="n">l</span><span class="p">;</span>
<span class="lineno"> 616 </span>        <span class="n">xv_sub</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">p</span><span class="p">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">r</span><span class="p">.</span><span class="n">orig</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
<span class="lineno"> 617 </span>        <span class="kt">float</span> <span class="n">t</span> <span class="o">=</span> <span class="n">xv_dot3</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">p</span><span class="p">.</span><span class="n">norm</span><span class="p">)</span> <span class="o">/</span> <span class="n">denom</span><span class="p">;</span>
<span class="lineno"> 618 </span>        <span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
<span class="lineno"> 619 </span>            <span class="k">return</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">;</span>
<span class="lineno"> 620 </span>        <span class="k">return</span> <span class="n">t</span><span class="p">;</span>
<span class="lineno"> 621 </span>    <span class="p">}</span>
<span class="lineno"> 622 </span>    <span class="k">return</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">;</span>
<span class="lineno"> 623 </span><span class="p">}</span>
<span class="lineno"> 624 </span>
<span class="lineno"> 625 </span><span class="n">ray</span> <span class="nf">generate_ray</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="kt">int</span> <span class="n">height</span><span class="p">,</span> <span class="kt">float</span> <span class="n">fov</span><span class="p">)</span>
<span class="lineno"> 626 </span><span class="p">{</span>
<span class="lineno"> 627 </span>    <span class="n">ray</span> <span class="n">r</span><span class="p">;</span>
<span class="lineno"> 628 </span>
<span class="lineno"> 629 </span>    <span class="c1">//Simplified</span>
<span class="lineno"> 630 </span>    <span class="cm">/* float ndc_x =((float)x+0.5)/width; */</span>
<span class="lineno"> 631 </span>    <span class="cm">/* float ndc_y =((float)x+0.5)/height; */</span>
<span class="lineno"> 632 </span>    <span class="cm">/* float screen_x = 2 ∗ ndc_x − 1; */</span>
<span class="lineno"> 633 </span>    <span class="cm">/* float screen_y = 1 − 2 ∗ ndc_y; */</span>
<span class="lineno"> 634 </span>    <span class="cm">/* float aspect_ratio = width/height; */</span>
<span class="lineno"> 635 </span>    <span class="cm">/* float cam_x =(2∗screen_x−1) * tan(fov / 2 * M_PI / 180) ∗ aspect_ratio; */</span>
<span class="lineno"> 636 </span>    <span class="cm">/* float cam_y = (1−2∗screen_y) * tan(fov / 2 * M_PI / 180); */</span>
<span class="lineno"> 637 </span>
<span class="lineno"> 638 </span>    <span class="kt">float</span> <span class="n">aspect_ratio</span> <span class="o">=</span> <span class="n">width</span> <span class="o">/</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">height</span><span class="p">;</span> <span class="c1">// assuming width &gt; height</span>
<span class="lineno"> 639 </span>    <span class="kt">float</span> <span class="n">cam_x</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(((</span><span class="kt">float</span><span class="p">)</span><span class="n">x</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">/</span> <span class="n">width</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">tan</span><span class="p">(</span><span class="n">fov</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">M_PI</span> <span class="o">/</span> <span class="mi">180</span><span class="p">)</span> <span class="o">*</span> <span class="n">aspect_ratio</span><span class="p">;</span>
<span class="lineno"> 640 </span>    <span class="kt">float</span> <span class="n">cam_y</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(((</span><span class="kt">float</span><span class="p">)</span><span class="n">y</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">/</span> <span class="n">height</span><span class="p">))</span> <span class="o">*</span> <span class="n">tan</span><span class="p">(</span><span class="n">fov</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">M_PI</span> <span class="o">/</span> <span class="mi">180</span><span class="p">);</span>
<span class="lineno"> 641 </span>
<span class="lineno"> 642 </span>
<span class="lineno"> 643 </span>    <span class="n">xv3_zero</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">orig</span><span class="p">);</span>
<span class="lineno"> 644 </span>    <span class="n">vec3</span> <span class="n">v1</span> <span class="o">=</span> <span class="p">{</span><span class="n">cam_x</span><span class="p">,</span> <span class="n">cam_y</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">};</span>
<span class="lineno"> 645 </span>    <span class="n">xv_sub</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">dir</span><span class="p">,</span> <span class="n">v1</span><span class="p">,</span> <span class="n">r</span><span class="p">.</span><span class="n">orig</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
<span class="lineno"> 646 </span>    <span class="n">xv_normeq</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">dir</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
<span class="lineno"> 647 </span>
<span class="lineno"> 648 </span>    <span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="lineno"> 649 </span><span class="p">}</span>
<span class="lineno"> 650 </span>
<span class="lineno"> 651 </span><span class="cm">/**********************/</span>
<span class="lineno"> 652 </span><span class="cm">/* irradiance_cache.c */</span>
<span class="lineno"> 653 </span><span class="cm">/**********************/</span>
<span class="lineno"> 654 </span>
<span class="lineno"> 655 </span><span class="cm">/******************************************/</span>
<span class="lineno"> 656 </span><span class="cm">/* NOTE: Irradiance Caching is Incomplete */</span>
<span class="lineno"> 657 </span><span class="cm">/******************************************/</span>
<span class="lineno"> 658 </span>
<span class="lineno"> 659 </span><span class="cp">#include</span> <span class="cpf">&lt;irradiance_cache.h&gt;</span><span class="cp"></span>
<span class="lineno"> 660 </span><span class="cp">#include</span> <span class="cpf">&lt;raytracer.h&gt;</span><span class="cp"></span>
<span class="lineno"> 661 </span><span class="cp">#include</span> <span class="cpf">&lt;parallel.h&gt;</span><span class="cp"></span>
<span class="lineno"> 662 </span>
<span class="lineno"> 663 </span><span class="cp">#ifdef WIN32</span>
<span class="lineno"> 664 </span><span class="cp">#define alloca _alloca</span>
<span class="lineno"> 665 </span><span class="cp">#endif</span>
<span class="lineno"> 666 </span><span class="kt">void</span> <span class="nf">ic_init</span><span class="p">(</span><span class="n">raytracer_context</span><span class="o">*</span> <span class="n">rctx</span><span class="p">)</span>
<span class="lineno"> 667 </span><span class="p">{</span>
<span class="lineno"> 668 </span>    <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">ic_ctx</span><span class="o">-&gt;</span><span class="n">cl_standard_format</span><span class="p">.</span><span class="n">image_channel_order</span>     <span class="o">=</span> <span class="n">CL_RGBA</span><span class="p">;</span>
<span class="lineno"> 669 </span>    <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">ic_ctx</span><span class="o">-&gt;</span><span class="n">cl_standard_format</span><span class="p">.</span><span class="n">image_channel_data_type</span> <span class="o">=</span> <span class="n">CL_FLOAT</span><span class="p">;</span>
<span class="lineno"> 670 </span>
<span class="lineno"> 671 </span>    <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">ic_ctx</span><span class="o">-&gt;</span><span class="n">cl_standard_descriptor</span><span class="p">.</span><span class="n">image_type</span> <span class="o">=</span> <span class="n">CL_MEM_OBJECT_IMAGE2D</span><span class="p">;</span>
<span class="lineno"> 672 </span>    <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">ic_ctx</span><span class="o">-&gt;</span><span class="n">cl_standard_descriptor</span><span class="p">.</span><span class="n">image_width</span> <span class="o">=</span> <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
<span class="lineno"> 673 </span>    <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">ic_ctx</span><span class="o">-&gt;</span><span class="n">cl_standard_descriptor</span><span class="p">.</span><span class="n">image_height</span> <span class="o">=</span> <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
<span class="lineno"> 674 </span>    <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">ic_ctx</span><span class="o">-&gt;</span><span class="n">cl_standard_descriptor</span><span class="p">.</span><span class="n">image_depth</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno"> 675 </span>    <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">ic_ctx</span><span class="o">-&gt;</span><span class="n">cl_standard_descriptor</span><span class="p">.</span><span class="n">image_array_size</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno"> 676 </span>    <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">ic_ctx</span><span class="o">-&gt;</span><span class="n">cl_standard_descriptor</span><span class="p">.</span><span class="n">image_row_pitch</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno"> 677 </span>    <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">ic_ctx</span><span class="o">-&gt;</span><span class="n">cl_standard_descriptor</span><span class="p">.</span><span class="n">num_mip_levels</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno"> 678 </span>    <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">ic_ctx</span><span class="o">-&gt;</span><span class="n">cl_standard_descriptor</span><span class="p">.</span><span class="n">num_samples</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno"> 679 </span>    <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">ic_ctx</span><span class="o">-&gt;</span><span class="n">cl_standard_descriptor</span><span class="p">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="lineno"> 680 </span>
<span class="lineno"> 681 </span>    <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">ic_ctx</span><span class="o">-&gt;</span><span class="n">octree</span><span class="p">.</span><span class="n">node_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">//root</span>
<span class="lineno"> 682 </span>    <span class="c1">//TODO: add as parameter</span>
<span class="lineno"> 683 </span>    <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">ic_ctx</span><span class="o">-&gt;</span><span class="n">octree</span><span class="p">.</span><span class="n">max_depth</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>  <span class="c1">//arbitrary</span>
<span class="lineno"> 684 </span>    <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">ic_ctx</span><span class="o">-&gt;</span><span class="n">octree</span><span class="p">.</span><span class="n">width</span>     <span class="o">=</span> <span class="mi">15</span><span class="p">;</span> <span class="c1">//arbitrary</span>
<span class="lineno"> 685 </span>
<span class="lineno"> 686 </span>    <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">ic_ctx</span><span class="o">-&gt;</span><span class="n">octree</span><span class="p">.</span><span class="n">root</span> <span class="o">=</span> <span class="p">(</span><span class="n">ic_octree_node</span><span class="o">*</span><span class="p">)</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">ic_octree_node</span><span class="p">));</span>
<span class="lineno"> 687 </span>    <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">ic_ctx</span><span class="o">-&gt;</span><span class="n">octree</span><span class="p">.</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">min</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="o">-</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">ic_ctx</span><span class="o">-&gt;</span><span class="n">octree</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
<span class="lineno"> 688 </span>    <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">ic_ctx</span><span class="o">-&gt;</span><span class="n">octree</span><span class="p">.</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">min</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="o">-</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">ic_ctx</span><span class="o">-&gt;</span><span class="n">octree</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
<span class="lineno"> 689 </span>    <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">ic_ctx</span><span class="o">-&gt;</span><span class="n">octree</span><span class="p">.</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">min</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="o">-</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">ic_ctx</span><span class="o">-&gt;</span><span class="n">octree</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
<span class="lineno"> 690 </span>    <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">ic_ctx</span><span class="o">-&gt;</span><span class="n">octree</span><span class="p">.</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span> <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">ic_ctx</span><span class="o">-&gt;</span><span class="n">octree</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
<span class="lineno"> 691 </span>    <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">ic_ctx</span><span class="o">-&gt;</span><span class="n">octree</span><span class="p">.</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span> <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">ic_ctx</span><span class="o">-&gt;</span><span class="n">octree</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
<span class="lineno"> 692 </span>    <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">ic_ctx</span><span class="o">-&gt;</span><span class="n">octree</span><span class="p">.</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span> <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">ic_ctx</span><span class="o">-&gt;</span><span class="n">octree</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
<span class="lineno"> 693 </span>    <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">ic_ctx</span><span class="o">-&gt;</span><span class="n">octree</span><span class="p">.</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">leaf</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="lineno"> 694 </span>    <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">ic_ctx</span><span class="o">-&gt;</span><span class="n">octree</span><span class="p">.</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="lineno"> 695 </span><span class="p">}</span>
<span class="lineno"> 696 </span>
<span class="lineno"> 697 </span><span class="kt">void</span> <span class="nf">ic_octree_init_leaf</span><span class="p">(</span><span class="n">ic_octree_node</span><span class="o">*</span> <span class="n">node</span><span class="p">,</span> <span class="n">ic_octree_node</span><span class="o">*</span> <span class="n">parent</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">)</span>
<span class="lineno"> 698 </span><span class="p">{</span>
<span class="lineno"> 699 </span>    <span class="kt">float</span> <span class="n">xhalf</span> <span class="o">=</span> <span class="p">(</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">min</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>
<span class="lineno"> 700 </span>    <span class="kt">float</span> <span class="n">yhalf</span> <span class="o">=</span> <span class="p">(</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">min</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>
<span class="lineno"> 701 </span>    <span class="kt">float</span> <span class="n">zhalf</span> <span class="o">=</span> <span class="p">(</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">min</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>
<span class="lineno"> 702 </span>    <span class="n">node</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="lineno"> 703 </span>
<span class="lineno"> 704 </span>    <span class="n">node</span><span class="o">-&gt;</span><span class="n">leaf</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="lineno"> 705 </span>    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="lineno"> 706 </span>        <span class="n">node</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">branch</span><span class="p">.</span><span class="n">children</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="lineno"> 707 </span>    <span class="n">node</span><span class="o">-&gt;</span><span class="n">min</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">min</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span> <span class="p">(</span><span class="n">i</span><span class="o">&amp;</span><span class="mi">4</span><span class="p">)</span> <span class="o">?</span> <span class="nl">xhalf</span> <span class="p">:</span> <span class="mi">0</span><span class="p">);</span>
<span class="lineno"> 708 </span>    <span class="n">node</span><span class="o">-&gt;</span><span class="n">min</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">min</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span> <span class="p">(</span><span class="n">i</span><span class="o">&amp;</span><span class="mi">2</span><span class="p">)</span> <span class="o">?</span> <span class="nl">yhalf</span> <span class="p">:</span> <span class="mi">0</span><span class="p">);</span>
<span class="lineno"> 709 </span>    <span class="n">node</span><span class="o">-&gt;</span><span class="n">min</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">min</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span> <span class="p">(</span><span class="n">i</span><span class="o">&amp;</span><span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="nl">zhalf</span> <span class="p">:</span> <span class="mi">0</span><span class="p">);</span>
<span class="lineno"> 710 </span>    <span class="n">node</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">i</span><span class="o">&amp;</span><span class="mi">4</span><span class="p">)</span> <span class="o">?</span> <span class="nl">xhalf</span> <span class="p">:</span> <span class="mi">0</span><span class="p">);</span>
<span class="lineno"> 711 </span>    <span class="n">node</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">i</span><span class="o">&amp;</span><span class="mi">2</span><span class="p">)</span> <span class="o">?</span> <span class="nl">yhalf</span> <span class="p">:</span> <span class="mi">0</span><span class="p">);</span>
<span class="lineno"> 712 </span>    <span class="n">node</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">i</span><span class="o">&amp;</span><span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="nl">zhalf</span> <span class="p">:</span> <span class="mi">0</span><span class="p">);</span>
<span class="lineno"> 713 </span><span class="p">}</span>
<span class="lineno"> 714 </span>
<span class="lineno"> 715 </span><span class="kt">void</span> <span class="nf">ic_octree_make_branch</span><span class="p">(</span><span class="n">ic_octree</span><span class="o">*</span> <span class="n">tree</span><span class="p">,</span> <span class="n">ic_octree_node</span><span class="o">*</span> <span class="n">node</span><span class="p">)</span>
<span class="lineno"> 716 </span><span class="p">{</span>
<span class="lineno"> 717 </span>
<span class="lineno"> 718 </span>    <span class="n">node</span><span class="o">-&gt;</span><span class="n">leaf</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="lineno"> 719 </span>    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="lineno"> 720 </span>    <span class="p">{</span>
<span class="lineno"> 721 </span>        <span class="n">node</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">branch</span><span class="p">.</span><span class="n">children</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">ic_octree_node</span><span class="p">));</span>
<span class="lineno"> 722 </span>        <span class="n">ic_octree_init_leaf</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">branch</span><span class="p">.</span><span class="n">children</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">node</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
<span class="lineno"> 723 </span>        <span class="n">tree</span><span class="o">-&gt;</span><span class="n">node_count</span><span class="o">++</span><span class="p">;</span>
<span class="lineno"> 724 </span>    <span class="p">}</span>
<span class="lineno"> 725 </span><span class="p">}</span>
<span class="lineno"> 726 </span>
<span class="lineno"> 727 </span><span class="c1">//TODO: test if points are the same</span>
<span class="lineno"> 728 </span><span class="kt">void</span> <span class="nf">_ic_octree_rec_resolve</span><span class="p">(</span><span class="n">ic_context</span><span class="o">*</span> <span class="n">ictx</span><span class="p">,</span> <span class="n">ic_octree_node</span><span class="o">*</span> <span class="n">leaf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">node1</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">node2</span><span class="p">,</span>
<span class="lineno"> 729 </span>                            <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">depth</span><span class="p">)</span>
<span class="lineno"> 730 </span><span class="p">{</span>
<span class="lineno"> 731 </span>    <span class="k">if</span><span class="p">(</span><span class="n">depth</span> <span class="o">&gt;</span> <span class="n">ictx</span><span class="o">-&gt;</span><span class="n">octree</span><span class="p">.</span><span class="n">max_depth</span><span class="p">)</span>
<span class="lineno"> 732 </span>    <span class="p">{</span>
<span class="lineno"> 733 </span>        <span class="c1">//TODO: just group buffers together</span>
<span class="lineno"> 734 </span>        <span class="n">printf</span><span class="p">(</span><span class="s">"ERROR: octree reached max depth when trying to resolve collision. (INCOMPLETE)</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="lineno"> 735 </span>        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="lineno"> 736 </span>    <span class="p">}</span>
<span class="lineno"> 737 </span>    <span class="n">vec3</span> <span class="n">mid_point</span><span class="p">;</span>
<span class="lineno"> 738 </span>    <span class="n">xv_sub</span><span class="p">(</span><span class="n">mid_point</span><span class="p">,</span> <span class="n">leaf</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">,</span> <span class="n">leaf</span><span class="o">-&gt;</span><span class="n">min</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
<span class="lineno"> 739 </span>    <span class="n">xv_divieq</span><span class="p">(</span><span class="n">mid_point</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
<span class="lineno"> 740 </span>    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i1</span> <span class="o">=</span>
<span class="lineno"> 741 </span>        <span class="p">((</span><span class="n">mid_point</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">ir_buf</span><span class="p">[</span><span class="n">node1</span><span class="p">].</span><span class="n">point</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">)</span> <span class="o">|</span>
<span class="lineno"> 742 </span>        <span class="p">((</span><span class="n">mid_point</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">ir_buf</span><span class="p">[</span><span class="n">node1</span><span class="p">].</span><span class="n">point</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
<span class="lineno"> 743 </span>        <span class="p">((</span><span class="n">mid_point</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">&lt;</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">ir_buf</span><span class="p">[</span><span class="n">node1</span><span class="p">].</span><span class="n">point</span><span class="p">[</span><span class="mi">2</span><span class="p">]));</span>
<span class="lineno"> 744 </span>    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i2</span> <span class="o">=</span>
<span class="lineno"> 745 </span>        <span class="p">((</span><span class="n">mid_point</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">ir_buf</span><span class="p">[</span><span class="n">node2</span><span class="p">].</span><span class="n">point</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">)</span> <span class="o">|</span>
<span class="lineno"> 746 </span>        <span class="p">((</span><span class="n">mid_point</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">ir_buf</span><span class="p">[</span><span class="n">node2</span><span class="p">].</span><span class="n">point</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
<span class="lineno"> 747 </span>        <span class="p">((</span><span class="n">mid_point</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">&lt;</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">ir_buf</span><span class="p">[</span><span class="n">node2</span><span class="p">].</span><span class="n">point</span><span class="p">[</span><span class="mi">2</span><span class="p">]));</span>
<span class="lineno"> 748 </span>    <span class="n">ic_octree_make_branch</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">octree</span><span class="p">,</span> <span class="n">leaf</span><span class="p">);</span>
<span class="lineno"> 749 </span>    <span class="k">if</span><span class="p">(</span><span class="n">i1</span><span class="o">==</span><span class="n">i2</span><span class="p">)</span>
<span class="lineno"> 750 </span>        <span class="n">_ic_octree_rec_resolve</span><span class="p">(</span><span class="n">ictx</span><span class="p">,</span> <span class="n">leaf</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">branch</span><span class="p">.</span><span class="n">children</span><span class="p">[</span><span class="n">i1</span><span class="p">],</span> <span class="n">node1</span><span class="p">,</span> <span class="n">node2</span><span class="p">,</span> <span class="n">depth</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
<span class="lineno"> 751 </span>    <span class="k">else</span>
<span class="lineno"> 752 </span>    <span class="p">{</span> <span class="c1">//happiness</span>
<span class="lineno"> 753 </span>        <span class="n">leaf</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">branch</span><span class="p">.</span><span class="n">children</span><span class="p">[</span><span class="n">i1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">leaf</span><span class="p">.</span><span class="n">buffer_offset</span> <span class="o">=</span> <span class="n">node1</span><span class="p">;</span>
<span class="lineno"> 754 </span>        <span class="n">leaf</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">branch</span><span class="p">.</span><span class="n">children</span><span class="p">[</span><span class="n">i1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">leaf</span><span class="p">.</span><span class="n">num_elems</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="lineno"> 755 </span>        <span class="n">leaf</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">branch</span><span class="p">.</span><span class="n">children</span><span class="p">[</span><span class="n">i2</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">leaf</span><span class="p">.</span><span class="n">buffer_offset</span> <span class="o">=</span> <span class="n">node2</span><span class="p">;</span>
<span class="lineno"> 756 </span>        <span class="n">leaf</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">branch</span><span class="p">.</span><span class="n">children</span><span class="p">[</span><span class="n">i2</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">leaf</span><span class="p">.</span><span class="n">num_elems</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="lineno"> 757 </span>    <span class="p">}</span>
<span class="lineno"> 758 </span><span class="p">}</span>
<span class="lineno"> 759 </span>
<span class="lineno"> 760 </span><span class="kt">void</span> <span class="nf">_ic_octree_rec_insert</span><span class="p">(</span><span class="n">ic_context</span><span class="o">*</span> <span class="n">ictx</span><span class="p">,</span> <span class="n">ic_octree_node</span><span class="o">*</span> <span class="n">node</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">v_ptr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">depth</span><span class="p">)</span>
<span class="lineno"> 761 </span><span class="p">{</span>
<span class="lineno"> 762 </span>    <span class="k">if</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">leaf</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span>
<span class="lineno"> 763 </span>    <span class="p">{</span>
<span class="lineno"> 764 </span>        <span class="n">node</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="lineno"> 765 </span>        <span class="n">node</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">leaf</span><span class="p">.</span><span class="n">buffer_offset</span> <span class="o">=</span> <span class="n">v_ptr</span><span class="p">;</span>
<span class="lineno"> 766 </span>        <span class="n">node</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">leaf</span><span class="p">.</span><span class="n">num_elems</span>     <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">//TODO: add suport for more than 1.</span>
<span class="lineno"> 767 </span>        <span class="k">return</span><span class="p">;</span>
<span class="lineno"> 768 </span>    <span class="p">}</span>
<span class="lineno"> 769 </span>    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">leaf</span><span class="p">)</span>
<span class="lineno"> 770 </span>    <span class="p">{</span>
<span class="lineno"> 771 </span>        <span class="c1">//resolve</span>
<span class="lineno"> 772 </span>        <span class="n">_ic_octree_rec_resolve</span><span class="p">(</span><span class="n">ictx</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">v_ptr</span><span class="p">,</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">leaf</span><span class="p">.</span><span class="n">buffer_offset</span><span class="p">,</span> <span class="n">depth</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
<span class="lineno"> 773 </span>    <span class="p">}</span>
<span class="lineno"> 774 </span>    <span class="k">else</span>
<span class="lineno"> 775 </span>    <span class="p">{</span>
<span class="lineno"> 776 </span>        <span class="n">ic_octree_node</span><span class="o">*</span> <span class="n">new_node</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">branch</span><span class="p">.</span><span class="n">children</span><span class="p">[</span>
<span class="lineno"> 777 </span>            <span class="p">((</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">ir_buf</span><span class="p">[</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">leaf</span><span class="p">.</span><span class="n">buffer_offset</span><span class="p">].</span><span class="n">point</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">ir_buf</span><span class="p">[</span><span class="n">v_ptr</span><span class="p">].</span><span class="n">point</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">)</span> <span class="o">|</span>
<span class="lineno"> 778 </span>            <span class="p">((</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">ir_buf</span><span class="p">[</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">leaf</span><span class="p">.</span><span class="n">buffer_offset</span><span class="p">].</span><span class="n">point</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">ir_buf</span><span class="p">[</span><span class="n">v_ptr</span><span class="p">].</span><span class="n">point</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
<span class="lineno"> 779 </span>            <span class="p">((</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">ir_buf</span><span class="p">[</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">leaf</span><span class="p">.</span><span class="n">buffer_offset</span><span class="p">].</span><span class="n">point</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">&lt;</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">ir_buf</span><span class="p">[</span><span class="n">v_ptr</span><span class="p">].</span><span class="n">point</span><span class="p">[</span><span class="mi">2</span><span class="p">]))];</span>
<span class="lineno"> 780 </span>        <span class="n">_ic_octree_rec_insert</span><span class="p">(</span><span class="n">ictx</span><span class="p">,</span> <span class="n">new_node</span><span class="p">,</span> <span class="n">v_ptr</span><span class="p">,</span> <span class="n">depth</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
<span class="lineno"> 781 </span>    <span class="p">}</span>
<span class="lineno"> 782 </span><span class="p">}</span>
<span class="lineno"> 783 </span>
<span class="lineno"> 784 </span><span class="kt">void</span> <span class="nf">ic_octree_insert</span><span class="p">(</span><span class="n">ic_context</span><span class="o">*</span> <span class="n">ictx</span><span class="p">,</span> <span class="n">vec3</span> <span class="n">point</span><span class="p">,</span> <span class="n">vec3</span> <span class="n">normal</span><span class="p">)</span>
<span class="lineno"> 785 </span><span class="p">{</span>
<span class="lineno"> 786 </span>    <span class="k">if</span><span class="p">(</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">ir_buf_current_offset</span><span class="o">==</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">ir_buf_size</span><span class="p">)</span> <span class="c1">//TODO: dynamically resize or do something else</span>
<span class="lineno"> 787 </span>    <span class="p">{</span>
<span class="lineno"> 788 </span>        <span class="n">printf</span><span class="p">(</span><span class="s">"ERROR: irradiance buffer is full!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="lineno"> 789 </span>        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="lineno"> 790 </span>    <span class="p">}</span>
<span class="lineno"> 791 </span>    <span class="n">ic_ir_value</span> <span class="n">irradiance_value</span><span class="p">;</span> <span class="c1">//TODO: EVALUATE THIS</span>
<span class="lineno"> 792 </span>    <span class="n">ictx</span><span class="o">-&gt;</span><span class="n">ir_buf</span><span class="p">[</span><span class="n">ictx</span><span class="o">-&gt;</span><span class="n">ir_buf_current_offset</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">irradiance_value</span><span class="p">;</span>
<span class="lineno"> 793 </span>    <span class="n">_ic_octree_rec_insert</span><span class="p">(</span><span class="n">ictx</span><span class="p">,</span> <span class="n">ictx</span><span class="o">-&gt;</span><span class="n">octree</span><span class="p">.</span><span class="n">root</span><span class="p">,</span> <span class="n">ictx</span><span class="o">-&gt;</span><span class="n">ir_buf_current_offset</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="lineno"> 794 </span><span class="p">}</span>
<span class="lineno"> 795 </span>
<span class="lineno"> 796 </span><span class="c1">//NOTE: outBuffer is only bools but using char for safety accross compilers.</span>
<span class="lineno"> 797 </span><span class="c1">//      Also assuming that buf is grayscale</span>
<span class="lineno"> 798 </span><span class="kt">void</span> <span class="nf">dither</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span> <span class="n">buf</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">height</span><span class="p">)</span>
<span class="lineno"> 799 </span><span class="p">{</span>
<span class="lineno"> 800 </span>    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">height</span><span class="p">;</span> <span class="n">y</span><span class="o">++</span> <span class="p">)</span>
<span class="lineno"> 801 </span>    <span class="p">{</span>
<span class="lineno"> 802 </span>        <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">width</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span> <span class="p">)</span>
<span class="lineno"> 803 </span>        <span class="p">{</span>
<span class="lineno"> 804 </span>            <span class="kt">float</span> <span class="n">oldpixel</span>  <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="n">y</span><span class="o">*</span><span class="n">width</span><span class="p">];</span>
<span class="lineno"> 805 </span>            <span class="kt">float</span> <span class="n">newpixel</span>  <span class="o">=</span> <span class="n">oldpixel</span><span class="o">&gt;</span><span class="mf">0.5f</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno"> 806 </span>            <span class="n">buf</span><span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="n">y</span><span class="o">*</span><span class="n">width</span><span class="p">]</span>  <span class="o">=</span> <span class="n">newpixel</span><span class="p">;</span>
<span class="lineno"> 807 </span>            <span class="kt">float</span> <span class="n">err</span> <span class="o">=</span> <span class="n">oldpixel</span> <span class="o">-</span> <span class="n">newpixel</span><span class="p">;</span>
<span class="lineno"> 808 </span>
<span class="lineno"> 809 </span>            <span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">x</span> <span class="o">!=</span> <span class="p">(</span><span class="n">width</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">x</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">y</span> <span class="o">!=</span> <span class="p">(</span><span class="n">height</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="p">)</span>
<span class="lineno"> 810 </span>            <span class="p">{</span>
<span class="lineno"> 811 </span>                <span class="n">buf</span><span class="p">[(</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">y</span>  <span class="p">)</span><span class="o">*</span><span class="n">width</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[(</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">y</span>  <span class="p">)</span><span class="o">*</span><span class="n">width</span><span class="p">]</span> <span class="o">+</span> <span class="n">err</span>  <span class="o">*</span> <span class="p">(</span><span class="mf">7.f</span> <span class="o">/</span> <span class="mf">16.f</span><span class="p">);</span>
<span class="lineno"> 812 </span>                <span class="n">buf</span><span class="p">[(</span><span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">y</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">width</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[(</span><span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">y</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">width</span><span class="p">]</span> <span class="o">+</span> <span class="n">err</span>  <span class="o">*</span> <span class="p">(</span><span class="mf">3.f</span> <span class="o">/</span> <span class="mf">16.f</span><span class="p">);</span>
<span class="lineno"> 813 </span>                <span class="n">buf</span><span class="p">[(</span><span class="n">x</span>  <span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">y</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">width</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[(</span><span class="n">x</span>  <span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">y</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">width</span><span class="p">]</span> <span class="o">+</span> <span class="n">err</span>  <span class="o">*</span> <span class="p">(</span><span class="mf">5.f</span> <span class="o">/</span> <span class="mf">16.f</span><span class="p">);</span>
<span class="lineno"> 814 </span>                <span class="n">buf</span><span class="p">[(</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">y</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">width</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[(</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">y</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">width</span><span class="p">]</span> <span class="o">+</span> <span class="n">err</span>  <span class="o">*</span> <span class="p">(</span><span class="mf">1.f</span> <span class="o">/</span> <span class="mf">16.f</span><span class="p">);</span>
<span class="lineno"> 815 </span>            <span class="p">}</span>
<span class="lineno"> 816 </span>        <span class="p">}</span>
<span class="lineno"> 817 </span>    <span class="p">}</span>
<span class="lineno"> 818 </span><span class="p">}</span>
<span class="lineno"> 819 </span>
<span class="lineno"> 820 </span>
<span class="lineno"> 821 </span><span class="kt">void</span> <span class="nf">get_geom_maps</span><span class="p">(</span><span class="n">raytracer_context</span><span class="o">*</span> <span class="n">rctx</span><span class="p">,</span> <span class="n">cl_mem</span> <span class="n">positions</span><span class="p">,</span> <span class="n">cl_mem</span> <span class="n">normals</span><span class="p">)</span>
<span class="lineno"> 822 </span><span class="p">{</span>
<span class="lineno"> 823 </span>    <span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
<span class="lineno"> 824 </span>
<span class="lineno"> 825 </span>    <span class="n">cl_kernel</span> <span class="n">kernel</span> <span class="o">=</span> <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">program</span><span class="o">-&gt;</span><span class="n">raw_kernels</span><span class="p">[</span><span class="n">IC_SCREEN_TEX_KRNL_INDX</span><span class="p">];</span>
<span class="lineno"> 826 </span>
<span class="lineno"> 827 </span>    <span class="kt">float</span> <span class="n">zeroed</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">};</span>
<span class="lineno"> 828 </span>    <span class="kt">float</span><span class="o">*</span> <span class="n">result</span> <span class="o">=</span> <span class="n">matvec_mul</span><span class="p">(</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">stat_scene</span><span class="o">-&gt;</span><span class="n">camera_world_matrix</span><span class="p">,</span> <span class="n">zeroed</span><span class="p">);</span>
<span class="lineno"> 829 </span>
<span class="lineno"> 830 </span>    <span class="c1">//SO MANY ARGUEMENTS</span>
<span class="lineno"> 831 </span>    <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cl_mem</span><span class="p">),</span>  <span class="o">&amp;</span><span class="n">positions</span><span class="p">);</span>
<span class="lineno"> 832 </span>    <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cl_mem</span><span class="p">),</span>  <span class="o">&amp;</span><span class="n">normals</span><span class="p">);</span>
<span class="lineno"> 833 </span>    <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span>     <span class="o">&amp;</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">);</span>
<span class="lineno"> 834 </span>    <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span>     <span class="o">&amp;</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">);</span>
<span class="lineno"> 835 </span>    <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cl_mem</span><span class="p">),</span>  <span class="o">&amp;</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">cl_ray_buffer</span><span class="p">);</span>
<span class="lineno"> 836 </span>    <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">vec4</span><span class="p">),</span>    <span class="n">result</span><span class="p">);</span>
<span class="lineno"> 837 </span>    <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cl_mem</span><span class="p">),</span>  <span class="o">&amp;</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">stat_scene</span><span class="o">-&gt;</span><span class="n">cl_material_buffer</span><span class="p">);</span>
<span class="lineno"> 838 </span>    <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cl_mem</span><span class="p">),</span>  <span class="o">&amp;</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">stat_scene</span><span class="o">-&gt;</span><span class="n">cl_sphere_buffer</span><span class="p">);</span>
<span class="lineno"> 839 </span>    <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cl_mem</span><span class="p">),</span>  <span class="o">&amp;</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">stat_scene</span><span class="o">-&gt;</span><span class="n">cl_plane_buffer</span><span class="p">);</span>
<span class="lineno"> 840 </span>    <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cl_mem</span><span class="p">),</span>  <span class="o">&amp;</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">stat_scene</span><span class="o">-&gt;</span><span class="n">cl_mesh_buffer</span><span class="p">);</span>
<span class="lineno"> 841 </span>    <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cl_mem</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">stat_scene</span><span class="o">-&gt;</span><span class="n">cl_mesh_index_buffer</span><span class="p">);</span>
<span class="lineno"> 842 </span>    <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cl_mem</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">stat_scene</span><span class="o">-&gt;</span><span class="n">cl_mesh_vert_buffer</span><span class="p">);</span>
<span class="lineno"> 843 </span>    <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cl_mem</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">stat_scene</span><span class="o">-&gt;</span><span class="n">cl_mesh_nrml_buffer</span><span class="p">);</span>
<span class="lineno"> 844 </span>
<span class="lineno"> 845 </span>    <span class="kt">size_t</span> <span class="n">global</span> <span class="o">=</span> <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">width</span><span class="o">*</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
<span class="lineno"> 846 </span>    <span class="kt">size_t</span> <span class="n">local</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno"> 847 </span>    <span class="n">err</span> <span class="o">=</span> <span class="n">clGetKernelWorkGroupInfo</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">rcl</span><span class="o">-&gt;</span><span class="n">device_id</span><span class="p">,</span> <span class="n">CL_KERNEL_WORK_GROUP_SIZE</span><span class="p">,</span>
<span class="lineno"> 848 </span>                                   <span class="k">sizeof</span><span class="p">(</span><span class="n">local</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">local</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="lineno"> 849 </span>    <span class="n">ASRT_CL</span><span class="p">(</span><span class="s">"Failed to Retrieve Kernel Work Group Info"</span><span class="p">);</span>
<span class="lineno"> 850 </span>
<span class="lineno"> 851 </span>    <span class="n">err</span> <span class="o">=</span> <span class="n">clEnqueueNDRangeKernel</span><span class="p">(</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">rcl</span><span class="o">-&gt;</span><span class="n">commands</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">global</span><span class="p">,</span>
<span class="lineno"> 852 </span>                                 <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="lineno"> 853 </span>    <span class="n">ASRT_CL</span><span class="p">(</span><span class="s">"Failed to Enqueue kernel IC_SCREEN_TEX"</span><span class="p">);</span>
<span class="lineno"> 854 </span>
<span class="lineno"> 855 </span>    <span class="c1">//Wait for completion</span>
<span class="lineno"> 856 </span>    <span class="n">err</span> <span class="o">=</span> <span class="n">clFinish</span><span class="p">(</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">rcl</span><span class="o">-&gt;</span><span class="n">commands</span><span class="p">);</span>
<span class="lineno"> 857 </span>    <span class="n">ASRT_CL</span><span class="p">(</span><span class="s">"Something happened while waiting for kernel to finish"</span><span class="p">);</span>
<span class="lineno"> 858 </span><span class="p">}</span>
<span class="lineno"> 859 </span>
<span class="lineno"> 860 </span><span class="kt">void</span> <span class="nf">gen_mipmap_chain_gb</span><span class="p">(</span><span class="n">raytracer_context</span><span class="o">*</span> <span class="n">rctx</span><span class="p">,</span> <span class="n">cl_mem</span> <span class="n">texture</span><span class="p">,</span>
<span class="lineno"> 861 </span>                         <span class="n">ic_mipmap_gb</span><span class="o">*</span> <span class="n">mipmaps</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num_mipmaps</span><span class="p">)</span>
<span class="lineno"> 862 </span><span class="p">{</span>
<span class="lineno"> 863 </span>    <span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
<span class="lineno"> 864 </span>    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">width</span>  <span class="o">=</span> <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
<span class="lineno"> 865 </span>    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">height</span> <span class="o">=</span> <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
<span class="lineno"> 866 </span>    <span class="n">cl_kernel</span> <span class="n">kernel</span> <span class="o">=</span> <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">program</span><span class="o">-&gt;</span><span class="n">raw_kernels</span><span class="p">[</span><span class="n">IC_MIP_REDUCE_KRNL_INDX</span><span class="p">];</span>
<span class="lineno"> 867 </span>    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_mipmaps</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="lineno"> 868 </span>    <span class="p">{</span>
<span class="lineno"> 869 </span>        <span class="n">mipmaps</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">width</span>  <span class="o">=</span> <span class="n">width</span><span class="p">;</span>
<span class="lineno"> 870 </span>        <span class="n">mipmaps</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">height</span> <span class="o">=</span> <span class="n">height</span><span class="p">;</span>
<span class="lineno"> 871 </span>
<span class="lineno"> 872 </span>        <span class="k">if</span><span class="p">(</span><span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
<span class="lineno"> 873 </span>        <span class="p">{</span>
<span class="lineno"> 874 </span>            <span class="n">mipmaps</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">cl_image_ref</span> <span class="o">=</span> <span class="n">texture</span><span class="p">;</span>
<span class="lineno"> 875 </span>
<span class="lineno"> 876 </span>            <span class="n">height</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
<span class="lineno"> 877 </span>            <span class="n">width</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
<span class="lineno"> 878 </span>            <span class="k">continue</span><span class="p">;</span>
<span class="lineno"> 879 </span>        <span class="p">}</span>
<span class="lineno"> 880 </span>
<span class="lineno"> 881 </span>        <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cl_mem</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">mipmaps</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">cl_image_ref</span><span class="p">);</span>
<span class="lineno"> 882 </span>        <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cl_mem</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">mipmaps</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cl_image_ref</span><span class="p">);</span>
<span class="lineno"> 883 </span>        <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span>    <span class="o">&amp;</span><span class="n">width</span><span class="p">);</span>
<span class="lineno"> 884 </span>        <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span>    <span class="o">&amp;</span><span class="n">height</span><span class="p">);</span>
<span class="lineno"> 885 </span>
<span class="lineno"> 886 </span>        <span class="kt">size_t</span> <span class="n">global</span> <span class="o">=</span> <span class="n">width</span><span class="o">*</span><span class="n">height</span><span class="p">;</span>
<span class="lineno"> 887 </span>        <span class="kt">size_t</span> <span class="n">local</span> <span class="o">=</span> <span class="n">get_workgroup_size</span><span class="p">(</span><span class="n">rctx</span><span class="p">,</span> <span class="n">kernel</span><span class="p">);</span>
<span class="lineno"> 888 </span>
<span class="lineno"> 889 </span>        <span class="n">err</span> <span class="o">=</span> <span class="n">clEnqueueNDRangeKernel</span><span class="p">(</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">rcl</span><span class="o">-&gt;</span><span class="n">commands</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
<span class="lineno"> 890 </span>                                     <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">global</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="lineno"> 891 </span>        <span class="n">ASRT_CL</span><span class="p">(</span><span class="s">"Failed to Enqueue kernel IC_MIP_REDUCE"</span><span class="p">);</span>
<span class="lineno"> 892 </span>
<span class="lineno"> 893 </span>        <span class="n">height</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
<span class="lineno"> 894 </span>        <span class="n">width</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
<span class="lineno"> 895 </span>        <span class="c1">//Wait for completion before doing next mip</span>
<span class="lineno"> 896 </span>        <span class="n">err</span> <span class="o">=</span> <span class="n">clFinish</span><span class="p">(</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">rcl</span><span class="o">-&gt;</span><span class="n">commands</span><span class="p">);</span>
<span class="lineno"> 897 </span>        <span class="n">ASRT_CL</span><span class="p">(</span><span class="s">"Something happened while waiting for kernel to finish"</span><span class="p">);</span>
<span class="lineno"> 898 </span>    <span class="p">}</span>
<span class="lineno"> 899 </span><span class="p">}</span>
<span class="lineno"> 900 </span>
<span class="lineno"> 901 </span><span class="kt">void</span> <span class="nf">upsample_mipmaps_f</span><span class="p">(</span><span class="n">raytracer_context</span><span class="o">*</span> <span class="n">rctx</span><span class="p">,</span> <span class="n">cl_mem</span> <span class="n">texture</span><span class="p">,</span>
<span class="lineno"> 902 </span>                        <span class="n">ic_mipmap_f</span><span class="o">*</span> <span class="n">mipmaps</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num_mipmaps</span><span class="p">)</span>
<span class="lineno"> 903 </span><span class="p">{</span>
<span class="lineno"> 904 </span>    <span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
<span class="lineno"> 905 </span>
<span class="lineno"> 906 </span>    <span class="n">cl_mem</span><span class="o">*</span> <span class="n">full_maps</span> <span class="o">=</span> <span class="p">(</span><span class="n">cl_mem</span><span class="o">*</span><span class="p">)</span> <span class="n">alloca</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">cl_mem</span><span class="p">)</span><span class="o">*</span><span class="n">num_mipmaps</span><span class="p">);</span>
<span class="lineno"> 907 </span>    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_mipmaps</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="lineno"> 908 </span>    <span class="p">{</span>
<span class="lineno"> 909 </span>        <span class="n">full_maps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">gen_grayscale_buffer</span><span class="p">(</span><span class="n">rctx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="lineno"> 910 </span>    <span class="p">}</span>
<span class="lineno"> 911 </span>    <span class="n">full_maps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">texture</span><span class="p">;</span>
<span class="lineno"> 912 </span>    <span class="p">{</span> <span class="c1">//Upsample</span>
<span class="lineno"> 913 </span>        <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_mipmaps</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="c1">//First one is already at proper resolution</span>
<span class="lineno"> 914 </span>        <span class="p">{</span>
<span class="lineno"> 915 </span>            <span class="n">cl_kernel</span> <span class="n">kernel</span> <span class="o">=</span> <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">program</span><span class="o">-&gt;</span><span class="n">raw_kernels</span><span class="p">[</span><span class="n">IC_MIP_S_UPSAMPLE_SCALED_KRNL_INDX</span><span class="p">];</span>
<span class="lineno"> 916 </span>
<span class="lineno"> 917 </span>            <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cl_mem</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">mipmaps</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cl_image_ref</span><span class="p">);</span>
<span class="lineno"> 918 </span>            <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cl_mem</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">full_maps</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span> <span class="c1">//NOTE: need to generate this for the function</span>
<span class="lineno"> 919 </span>            <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span>    <span class="o">&amp;</span><span class="n">i</span><span class="p">);</span>
<span class="lineno"> 920 </span>            <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span>    <span class="o">&amp;</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">);</span>
<span class="lineno"> 921 </span>            <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span>    <span class="o">&amp;</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">);</span>
<span class="lineno"> 922 </span>
<span class="lineno"> 923 </span>            <span class="kt">size_t</span> <span class="n">global</span> <span class="o">=</span> <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">width</span><span class="o">*</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
<span class="lineno"> 924 </span>            <span class="kt">size_t</span> <span class="n">local</span> <span class="o">=</span> <span class="n">get_workgroup_size</span><span class="p">(</span><span class="n">rctx</span><span class="p">,</span> <span class="n">kernel</span><span class="p">);</span>
<span class="lineno"> 925 </span>
<span class="lineno"> 926 </span>            <span class="n">err</span> <span class="o">=</span> <span class="n">clEnqueueNDRangeKernel</span><span class="p">(</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">rcl</span><span class="o">-&gt;</span><span class="n">commands</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
<span class="lineno"> 927 </span>                                         <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">global</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="lineno"> 928 </span>            <span class="n">ASRT_CL</span><span class="p">(</span><span class="s">"Failed to Enqueue kernel IC_MIP_S_UPSAMPLE_SCALED"</span><span class="p">);</span>
<span class="lineno"> 929 </span>
<span class="lineno"> 930 </span>        <span class="p">}</span>
<span class="lineno"> 931 </span>        <span class="n">err</span> <span class="o">=</span> <span class="n">clFinish</span><span class="p">(</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">rcl</span><span class="o">-&gt;</span><span class="n">commands</span><span class="p">);</span>
<span class="lineno"> 932 </span>        <span class="n">ASRT_CL</span><span class="p">(</span><span class="s">"Something happened while waiting for kernel to finish"</span><span class="p">);</span>
<span class="lineno"> 933 </span>    <span class="p">}</span>
<span class="lineno"> 934 </span>    <span class="n">printf</span><span class="p">(</span><span class="s">"Upsampled Discontinuity Mipmaps</span><span class="se">\n</span><span class="s">Averaging Upsampled Discontinuity Mipmaps</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="lineno"> 935 </span>
<span class="lineno"> 936 </span>    <span class="p">{</span> <span class="c1">//Average</span>
<span class="lineno"> 937 </span>        <span class="kt">int</span> <span class="n">total</span> <span class="o">=</span> <span class="n">num_mipmaps</span><span class="p">;</span>
<span class="lineno"> 938 </span>        <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_mipmaps</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="c1">//First one is already at proper resolution</span>
<span class="lineno"> 939 </span>        <span class="p">{</span>
<span class="lineno"> 940 </span>            <span class="n">cl_kernel</span> <span class="n">kernel</span> <span class="o">=</span> <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">program</span><span class="o">-&gt;</span><span class="n">raw_kernels</span><span class="p">[</span><span class="n">IC_FLOAT_AVG_KRNL_INDX</span><span class="p">];</span>
<span class="lineno"> 941 </span>
<span class="lineno"> 942 </span>            <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cl_mem</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">full_maps</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="lineno"> 943 </span>            <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cl_mem</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">texture</span><span class="p">);</span>
<span class="lineno"> 944 </span>            <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span>    <span class="o">&amp;</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">);</span>
<span class="lineno"> 945 </span>            <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span>    <span class="o">&amp;</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">);</span>
<span class="lineno"> 946 </span>            <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span>    <span class="o">&amp;</span><span class="n">total</span><span class="p">);</span>
<span class="lineno"> 947 </span>
<span class="lineno"> 948 </span>            <span class="kt">size_t</span> <span class="n">global</span> <span class="o">=</span> <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">width</span><span class="o">*</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
<span class="lineno"> 949 </span>            <span class="kt">size_t</span> <span class="n">local</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno"> 950 </span>            <span class="n">err</span> <span class="o">=</span> <span class="n">clGetKernelWorkGroupInfo</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">rcl</span><span class="o">-&gt;</span><span class="n">device_id</span><span class="p">,</span> <span class="n">CL_KERNEL_WORK_GROUP_SIZE</span><span class="p">,</span>
<span class="lineno"> 951 </span>                                           <span class="k">sizeof</span><span class="p">(</span><span class="n">local</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">local</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="lineno"> 952 </span>            <span class="n">ASRT_CL</span><span class="p">(</span><span class="s">"Failed to Retrieve Kernel Work Group Info"</span><span class="p">);</span>
<span class="lineno"> 953 </span>
<span class="lineno"> 954 </span>            <span class="n">err</span> <span class="o">=</span> <span class="n">clEnqueueNDRangeKernel</span><span class="p">(</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">rcl</span><span class="o">-&gt;</span><span class="n">commands</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
<span class="lineno"> 955 </span>                                         <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">global</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="lineno"> 956 </span>            <span class="n">ASRT_CL</span><span class="p">(</span><span class="s">"Failed to Enqueue kernel IC_FLOAT_AVG"</span><span class="p">);</span>
<span class="lineno"> 957 </span>
<span class="lineno"> 958 </span>            <span class="n">err</span> <span class="o">=</span> <span class="n">clFinish</span><span class="p">(</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">rcl</span><span class="o">-&gt;</span><span class="n">commands</span><span class="p">);</span>
<span class="lineno"> 959 </span>            <span class="n">ASRT_CL</span><span class="p">(</span><span class="s">"Something happened while waiting for kernel to finish"</span><span class="p">);</span>
<span class="lineno"> 960 </span>        <span class="p">}</span>
<span class="lineno"> 961 </span>    <span class="p">}</span>
<span class="lineno"> 962 </span>    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_mipmaps</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="lineno"> 963 </span>    <span class="p">{</span>
<span class="lineno"> 964 </span>        <span class="n">err</span> <span class="o">=</span> <span class="n">clReleaseMemObject</span><span class="p">(</span><span class="n">full_maps</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="lineno"> 965 </span>        <span class="n">ASRT_CL</span><span class="p">(</span><span class="s">"Failed to cleanup fullsize mipmaps"</span><span class="p">);</span>
<span class="lineno"> 966 </span>    <span class="p">}</span>
<span class="lineno"> 967 </span><span class="p">}</span>
<span class="lineno"> 968 </span>
<span class="lineno"> 969 </span><span class="kt">void</span> <span class="nf">gen_discontinuity_maps</span><span class="p">(</span><span class="n">raytracer_context</span><span class="o">*</span> <span class="n">rctx</span><span class="p">,</span> <span class="n">ic_mipmap_gb</span><span class="o">*</span> <span class="n">pos_mipmaps</span><span class="p">,</span>
<span class="lineno"> 970 </span>                            <span class="n">ic_mipmap_gb</span><span class="o">*</span> <span class="n">nrm_mipmaps</span><span class="p">,</span> <span class="n">ic_mipmap_f</span><span class="o">*</span> <span class="n">disc_mipmaps</span><span class="p">,</span>
<span class="lineno"> 971 </span>                            <span class="kt">int</span> <span class="n">num_mipmaps</span><span class="p">)</span>
<span class="lineno"> 972 </span><span class="p">{</span>
<span class="lineno"> 973 </span>    <span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
<span class="lineno"> 974 </span>    <span class="c1">//TODO: tune k and intensity</span>
<span class="lineno"> 975 </span>    <span class="k">const</span> <span class="kt">float</span> <span class="n">k</span> <span class="o">=</span> <span class="mf">1.6f</span><span class="p">;</span>
<span class="lineno"> 976 </span>    <span class="k">const</span> <span class="kt">float</span> <span class="n">intensity</span> <span class="o">=</span> <span class="mf">0.02f</span><span class="p">;</span>
<span class="lineno"> 977 </span>    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_mipmaps</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="lineno"> 978 </span>    <span class="p">{</span>
<span class="lineno"> 979 </span>        <span class="n">cl_kernel</span> <span class="n">kernel</span> <span class="o">=</span> <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">program</span><span class="o">-&gt;</span><span class="n">raw_kernels</span><span class="p">[</span><span class="n">IC_GEN_DISC_KRNL_INDX</span><span class="p">];</span>
<span class="lineno"> 980 </span>        <span class="n">disc_mipmaps</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">width</span>  <span class="o">=</span> <span class="n">pos_mipmaps</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">width</span><span class="p">;</span>
<span class="lineno"> 981 </span>        <span class="n">disc_mipmaps</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">height</span> <span class="o">=</span> <span class="n">pos_mipmaps</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">height</span><span class="p">;</span>
<span class="lineno"> 982 </span>
<span class="lineno"> 983 </span>        <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cl_mem</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">pos_mipmaps</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cl_image_ref</span><span class="p">);</span>
<span class="lineno"> 984 </span>
<span class="lineno"> 985 </span>
<span class="lineno"> 986 </span>        <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cl_mem</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">nrm_mipmaps</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cl_image_ref</span><span class="p">);</span>
<span class="lineno"> 987 </span>        <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cl_mem</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">disc_mipmaps</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cl_image_ref</span><span class="p">);</span>
<span class="lineno"> 988 </span>        <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">),</span>  <span class="o">&amp;</span><span class="n">k</span><span class="p">);</span>
<span class="lineno"> 989 </span>        <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">),</span>  <span class="o">&amp;</span><span class="n">intensity</span><span class="p">);</span>
<span class="lineno"> 990 </span>        <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span>    <span class="o">&amp;</span><span class="n">pos_mipmaps</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">width</span><span class="p">);</span>
<span class="lineno"> 991 </span>        <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span>    <span class="o">&amp;</span><span class="n">pos_mipmaps</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">height</span><span class="p">);</span>
<span class="lineno"> 992 </span>
<span class="lineno"> 993 </span>        <span class="kt">size_t</span> <span class="n">global</span> <span class="o">=</span> <span class="n">pos_mipmaps</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">width</span><span class="o">*</span><span class="n">pos_mipmaps</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">height</span><span class="p">;</span>
<span class="lineno"> 994 </span>        <span class="kt">size_t</span> <span class="n">local</span> <span class="o">=</span> <span class="n">get_workgroup_size</span><span class="p">(</span><span class="n">rctx</span><span class="p">,</span> <span class="n">kernel</span><span class="p">);</span>
<span class="lineno"> 995 </span>
<span class="lineno"> 996 </span>        <span class="n">err</span> <span class="o">=</span> <span class="n">clEnqueueNDRangeKernel</span><span class="p">(</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">rcl</span><span class="o">-&gt;</span><span class="n">commands</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
<span class="lineno"> 997 </span>                                     <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">global</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="lineno"> 998 </span>        <span class="n">ASRT_CL</span><span class="p">(</span><span class="s">"Failed to Enqueue kernel IC_GEN_DISC"</span><span class="p">);</span>
<span class="lineno"> 999 </span>
<span class="lineno">1000 </span>    <span class="p">}</span>
<span class="lineno">1001 </span>    <span class="n">err</span> <span class="o">=</span> <span class="n">clFinish</span><span class="p">(</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">rcl</span><span class="o">-&gt;</span><span class="n">commands</span><span class="p">);</span>
<span class="lineno">1002 </span>    <span class="n">ASRT_CL</span><span class="p">(</span><span class="s">"Something happened while waiting for kernel to finish"</span><span class="p">);</span>
<span class="lineno">1003 </span><span class="p">}</span>
<span class="lineno">1004 </span>
<span class="lineno">1005 </span><span class="kt">void</span> <span class="nf">ic_screenspace</span><span class="p">(</span><span class="n">raytracer_context</span><span class="o">*</span> <span class="n">rctx</span><span class="p">)</span>
<span class="lineno">1006 </span><span class="p">{</span>
<span class="lineno">1007 </span>    <span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
<span class="lineno">1008 </span>
<span class="lineno">1009 </span>
<span class="lineno">1010 </span>    <span class="n">vec4</span><span class="o">*</span>   <span class="n">pos_tex</span> <span class="o">=</span> <span class="p">(</span><span class="n">vec4</span><span class="o">*</span><span class="p">)</span> <span class="n">malloc</span><span class="p">(</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">width</span><span class="o">*</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">height</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">vec4</span><span class="p">));</span>
<span class="lineno">1011 </span>    <span class="n">vec4</span><span class="o">*</span>   <span class="n">nrm_tex</span> <span class="o">=</span> <span class="p">(</span><span class="n">vec4</span><span class="o">*</span><span class="p">)</span> <span class="n">malloc</span><span class="p">(</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">width</span><span class="o">*</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">height</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">vec4</span><span class="p">));</span>
<span class="lineno">1012 </span>    <span class="kt">float</span><span class="o">*</span>  <span class="n">c_fin_disc_map</span> <span class="o">=</span> <span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="p">)</span> <span class="n">malloc</span><span class="p">(</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">width</span><span class="o">*</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">height</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span>
<span class="lineno">1013 </span>
<span class="lineno">1014 </span>    <span class="n">ic_mipmap_gb</span> <span class="n">pos_mipmaps</span> <span class="p">[</span><span class="n">NUM_MIPMAPS</span><span class="p">];</span> <span class="c1">//A lot of buffers</span>
<span class="lineno">1015 </span>    <span class="n">ic_mipmap_gb</span> <span class="n">nrm_mipmaps</span> <span class="p">[</span><span class="n">NUM_MIPMAPS</span><span class="p">];</span>
<span class="lineno">1016 </span>    <span class="n">ic_mipmap_f</span>  <span class="n">disc_mipmaps</span><span class="p">[</span><span class="n">NUM_MIPMAPS</span><span class="p">];</span>
<span class="lineno">1017 </span>    <span class="n">cl_mem</span>       <span class="n">fin_disc_map</span><span class="p">;</span>
<span class="lineno">1018 </span>    <span class="c1">//OpenCL</span>
<span class="lineno">1019 </span>    <span class="n">cl_mem</span> <span class="n">cl_pos_tex</span><span class="p">;</span>
<span class="lineno">1020 </span>    <span class="n">cl_mem</span> <span class="n">cl_nrm_tex</span><span class="p">;</span>
<span class="lineno">1021 </span>    <span class="n">cl_image_desc</span> <span class="n">cl_mipmap_descriptor</span> <span class="o">=</span> <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">ic_ctx</span><span class="o">-&gt;</span><span class="n">cl_standard_descriptor</span><span class="p">;</span>
<span class="lineno">1022 </span>
<span class="lineno">1023 </span>    <span class="p">{</span> <span class="c1">//OpenCL Init</span>
<span class="lineno">1024 </span>        <span class="n">cl_pos_tex</span> <span class="o">=</span> <span class="n">gen_rgb_image</span><span class="p">(</span><span class="n">rctx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
<span class="lineno">1025 </span>        <span class="n">cl_nrm_tex</span> <span class="o">=</span> <span class="n">gen_rgb_image</span><span class="p">(</span><span class="n">rctx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
<span class="lineno">1026 </span>
<span class="lineno">1027 </span>        <span class="n">fin_disc_map</span> <span class="o">=</span> <span class="n">gen_grayscale_buffer</span><span class="p">(</span><span class="n">rctx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
<span class="lineno">1028 </span>        <span class="n">zero_buffer_img</span><span class="p">(</span><span class="n">rctx</span><span class="p">,</span> <span class="n">fin_disc_map</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="lineno">1029 </span>
<span class="lineno">1030 </span>
<span class="lineno">1031 </span>        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">width</span>  <span class="o">=</span> <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span>
<span class="lineno">1032 </span>                     <span class="n">height</span> <span class="o">=</span> <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
<span class="lineno">1033 </span>        <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_MIPMAPS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="lineno">1034 </span>        <span class="p">{</span>
<span class="lineno">1035 </span>            <span class="k">if</span><span class="p">(</span><span class="n">i</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span>
<span class="lineno">1036 </span>            <span class="p">{</span>
<span class="lineno">1037 </span>                <span class="n">pos_mipmaps</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cl_image_ref</span> <span class="o">=</span> <span class="n">gen_rgb_image</span><span class="p">(</span><span class="n">rctx</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">);</span>
<span class="lineno">1038 </span>                <span class="n">nrm_mipmaps</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cl_image_ref</span> <span class="o">=</span> <span class="n">gen_rgb_image</span><span class="p">(</span><span class="n">rctx</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">);</span>
<span class="lineno">1039 </span>            <span class="p">}</span>
<span class="lineno">1040 </span>            <span class="n">disc_mipmaps</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cl_image_ref</span> <span class="o">=</span> <span class="n">gen_grayscale_buffer</span><span class="p">(</span><span class="n">rctx</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">);</span>
<span class="lineno">1041 </span>
<span class="lineno">1042 </span>            <span class="n">width</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
<span class="lineno">1043 </span>            <span class="n">height</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
<span class="lineno">1044 </span>        <span class="p">}</span>
<span class="lineno">1045 </span>    <span class="p">}</span>
<span class="lineno">1046 </span>    <span class="n">printf</span><span class="p">(</span><span class="s">"Initialised Irradiance Cache Screenspace Buffers</span><span class="se">\n</span><span class="s">Getting Screenspace Geometry Data</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="lineno">1047 </span>    <span class="n">get_geom_maps</span><span class="p">(</span><span class="n">rctx</span><span class="p">,</span> <span class="n">cl_pos_tex</span><span class="p">,</span> <span class="n">cl_nrm_tex</span><span class="p">);</span>
<span class="lineno">1048 </span>    <span class="n">printf</span><span class="p">(</span><span class="s">"Got Screenspace Geometry Data</span><span class="se">\n</span><span class="s">Generating MipMaps</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="lineno">1049 </span>    <span class="n">gen_mipmap_chain_gb</span><span class="p">(</span><span class="n">rctx</span><span class="p">,</span> <span class="n">cl_pos_tex</span><span class="p">,</span>
<span class="lineno">1050 </span>                        <span class="n">pos_mipmaps</span><span class="p">,</span> <span class="n">NUM_MIPMAPS</span><span class="p">);</span>
<span class="lineno">1051 </span>    <span class="n">gen_mipmap_chain_gb</span><span class="p">(</span><span class="n">rctx</span><span class="p">,</span> <span class="n">cl_nrm_tex</span><span class="p">,</span>
<span class="lineno">1052 </span>                        <span class="n">nrm_mipmaps</span><span class="p">,</span> <span class="n">NUM_MIPMAPS</span><span class="p">);</span>
<span class="lineno">1053 </span>    <span class="n">printf</span><span class="p">(</span><span class="s">"Generated MipMaps</span><span class="se">\n</span><span class="s">Generating Discontinuity Map for each Mip</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="lineno">1054 </span>    <span class="n">gen_discontinuity_maps</span><span class="p">(</span><span class="n">rctx</span><span class="p">,</span> <span class="n">pos_mipmaps</span><span class="p">,</span> <span class="n">nrm_mipmaps</span><span class="p">,</span> <span class="n">disc_mipmaps</span><span class="p">,</span> <span class="n">NUM_MIPMAPS</span><span class="p">);</span>
<span class="lineno">1055 </span>    <span class="n">printf</span><span class="p">(</span><span class="s">"Generated Discontinuity Map for each Mip</span><span class="se">\n</span><span class="s">Upsampling Discontinuity Mipmaps</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="lineno">1056 </span>    <span class="n">upsample_mipmaps_f</span><span class="p">(</span><span class="n">rctx</span><span class="p">,</span> <span class="n">fin_disc_map</span><span class="p">,</span> <span class="n">disc_mipmaps</span><span class="p">,</span> <span class="n">NUM_MIPMAPS</span><span class="p">);</span>
<span class="lineno">1057 </span>    <span class="n">printf</span><span class="p">(</span><span class="s">"Averaged Upsampled Discontinuity Mipmaps</span><span class="se">\n</span><span class="s">Retrieving Discontinuity Data</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="lineno">1058 </span>    <span class="n">retrieve_buf</span><span class="p">(</span><span class="n">rctx</span><span class="p">,</span> <span class="n">fin_disc_map</span><span class="p">,</span> <span class="n">c_fin_disc_map</span><span class="p">,</span>
<span class="lineno">1059 </span>                 <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">width</span><span class="o">*</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">height</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span>
<span class="lineno">1060 </span>    <span class="n">retrieve_image</span><span class="p">(</span><span class="n">rctx</span><span class="p">,</span> <span class="n">cl_pos_tex</span><span class="p">,</span> <span class="n">pos_tex</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="lineno">1061 </span>    <span class="n">retrieve_image</span><span class="p">(</span><span class="n">rctx</span><span class="p">,</span> <span class="n">cl_pos_tex</span><span class="p">,</span> <span class="n">pos_tex</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="lineno">1062 </span>
<span class="lineno">1063 </span>    <span class="n">printf</span><span class="p">(</span><span class="s">"Retrieved Discontinuity Data</span><span class="se">\n</span><span class="s">Dithering Discontinuity Map</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="lineno">1064 </span>    <span class="c1">//NOTE: read buffer is blocking so we don't need clFinish</span>
<span class="lineno">1065 </span>    <span class="n">dither</span><span class="p">(</span><span class="n">c_fin_disc_map</span><span class="p">,</span> <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">);</span>
<span class="lineno">1066 </span>    <span class="n">err</span> <span class="o">=</span> <span class="n">clEnqueueWriteBuffer</span><span class="p">(</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">rcl</span><span class="o">-&gt;</span><span class="n">commands</span><span class="p">,</span> <span class="n">fin_disc_map</span><span class="p">,</span>
<span class="lineno">1067 </span>                               <span class="n">CL_TRUE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
<span class="lineno">1068 </span>                               <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">width</span><span class="o">*</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">height</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">),</span>
<span class="lineno">1069 </span>                                   <span class="n">c_fin_disc_map</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="lineno">1070 </span>    <span class="n">ASRT_CL</span><span class="p">(</span><span class="s">"Failed to write dithered discontinuity map"</span><span class="p">);</span>
<span class="lineno">1071 </span>
<span class="lineno">1072 </span>
<span class="lineno">1073 </span>    <span class="c1">//INSERT</span>
<span class="lineno">1074 </span>    <span class="n">cl_kernel</span> <span class="n">kernel</span> <span class="o">=</span> <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">program</span><span class="o">-&gt;</span><span class="n">raw_kernels</span><span class="p">[</span><span class="n">BLIT_FLOAT_OUTPUT_INDX</span><span class="p">];</span>
<span class="lineno">1075 </span>
<span class="lineno">1076 </span>    <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cl_mem</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">cl_output_buffer</span><span class="p">);</span>
<span class="lineno">1077 </span>    <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cl_mem</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">fin_disc_map</span><span class="p">);</span>
<span class="lineno">1078 </span>    <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span>    <span class="o">&amp;</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">);</span>
<span class="lineno">1079 </span>    <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span>    <span class="o">&amp;</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">);</span>
<span class="lineno">1080 </span>
<span class="lineno">1081 </span>    <span class="kt">size_t</span> <span class="n">global</span> <span class="o">=</span> <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">width</span><span class="o">*</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
<span class="lineno">1082 </span>    <span class="kt">size_t</span> <span class="n">local</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno">1083 </span>    <span class="n">err</span> <span class="o">=</span> <span class="n">clGetKernelWorkGroupInfo</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">rcl</span><span class="o">-&gt;</span><span class="n">device_id</span><span class="p">,</span> <span class="n">CL_KERNEL_WORK_GROUP_SIZE</span><span class="p">,</span>
<span class="lineno">1084 </span>                                   <span class="k">sizeof</span><span class="p">(</span><span class="n">local</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">local</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="lineno">1085 </span>    <span class="n">ASRT_CL</span><span class="p">(</span><span class="s">"Failed to Retrieve Kernel Work Group Info"</span><span class="p">);</span>
<span class="lineno">1086 </span>
<span class="lineno">1087 </span>    <span class="n">err</span> <span class="o">=</span> <span class="n">clEnqueueNDRangeKernel</span><span class="p">(</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">rcl</span><span class="o">-&gt;</span><span class="n">commands</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
<span class="lineno">1088 </span>                                 <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">global</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="lineno">1089 </span>    <span class="n">ASRT_CL</span><span class="p">(</span><span class="s">"Failed to Enqueue kernel BLIT_FLOAT_OUTPUT_INDX"</span><span class="p">);</span>
<span class="lineno">1090 </span>
<span class="lineno">1091 </span>    <span class="n">clFinish</span><span class="p">(</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">rcl</span><span class="o">-&gt;</span><span class="n">commands</span><span class="p">);</span>
<span class="lineno">1092 </span>
<span class="lineno">1093 </span>    <span class="n">err</span> <span class="o">=</span> <span class="n">clEnqueueReadBuffer</span><span class="p">(</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">rcl</span><span class="o">-&gt;</span><span class="n">commands</span><span class="p">,</span> <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">cl_output_buffer</span><span class="p">,</span> <span class="n">CL_TRUE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
<span class="lineno">1094 </span>                              <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">width</span><span class="o">*</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">height</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span> <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">output_buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">);</span>
<span class="lineno">1095 </span>    <span class="n">ASRT_CL</span><span class="p">(</span><span class="s">"Failed to Read Output Buffer"</span><span class="p">);</span>
<span class="lineno">1096 </span>    <span class="n">printf</span><span class="p">(</span><span class="s">"test!!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="lineno">1097 </span>
<span class="lineno">1098 </span>
<span class="lineno">1099 </span><span class="p">}</span>
<span class="lineno">1100 </span>
<span class="lineno">1101 </span>
<span class="lineno">1102 </span>
<span class="lineno">1103 </span>
<span class="lineno">1104 </span><span class="cm">/************/</span>
<span class="lineno">1105 </span><span class="cm">/* loader.c */</span>
<span class="lineno">1106 </span><span class="cm">/************/</span>
<span class="lineno">1107 </span><span class="cp">#include</span> <span class="cpf">&lt;loader.h&gt;</span><span class="cp"></span>
<span class="lineno">1108 </span><span class="cp">#include</span> <span class="cpf">&lt;parson.h&gt;</span><span class="cp"></span>
<span class="lineno">1109 </span><span class="cp">#include</span> <span class="cpf">&lt;vec.h&gt;</span><span class="cp"></span>
<span class="lineno">1110 </span><span class="cp">#include</span> <span class="cpf">&lt;float.h&gt;</span><span class="cp"></span>
<span class="lineno">1111 </span><span class="cp">#include</span> <span class="cpf">&lt;tinyobj_loader_c.h&gt;</span><span class="cp"></span>
<span class="lineno">1112 </span><span class="cp">#include</span> <span class="cpf">&lt;assert.h&gt;</span><span class="cp"></span>
<span class="lineno">1113 </span>
<span class="lineno">1114 </span>
<span class="lineno">1115 </span>
<span class="lineno">1116 </span><span class="cp">#ifndef WIN32</span>
<span class="lineno">1117 </span><span class="cp">#include</span> <span class="cpf">&lt;libproc.h&gt;</span><span class="cp"></span>
<span class="lineno">1118 </span><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp"></span>
<span class="lineno">1119 </span>
<span class="lineno">1120 </span><span class="cp">#define FILE_SEP '/'</span>
<span class="lineno">1121 </span>
<span class="lineno">1122 </span><span class="kt">char</span><span class="o">*</span> <span class="nf">_get_os_pid_bin_path</span><span class="p">()</span>
<span class="lineno">1123 </span><span class="p">{</span>
<span class="lineno">1124 </span>    <span class="k">static</span> <span class="kt">bool</span> <span class="n">initialised</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="lineno">1125 </span>    <span class="k">static</span> <span class="kt">char</span> <span class="n">path</span><span class="p">[</span><span class="n">PROC_PIDPATHINFO_MAXSIZE</span><span class="p">];</span>
<span class="lineno">1126 </span>    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">initialised</span><span class="p">)</span>
<span class="lineno">1127 </span>    <span class="p">{</span>
<span class="lineno">1128 </span>        <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
<span class="lineno">1129 </span>        <span class="kt">pid_t</span> <span class="n">pid</span><span class="p">;</span>
<span class="lineno">1130 </span>        <span class="kt">char</span> <span class="n">path</span><span class="p">[</span><span class="n">PROC_PIDPATHINFO_MAXSIZE</span><span class="p">];</span>
<span class="lineno">1131 </span>
<span class="lineno">1132 </span>        <span class="n">pid</span> <span class="o">=</span> <span class="n">getpid</span><span class="p">();</span>
<span class="lineno">1133 </span>        <span class="n">ret</span> <span class="o">=</span> <span class="n">proc_pidpath</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">path</span><span class="p">));</span>
<span class="lineno">1134 </span>
<span class="lineno">1135 </span>        <span class="k">if</span><span class="p">(</span><span class="n">ret</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
<span class="lineno">1136 </span>        <span class="p">{</span>
<span class="lineno">1137 </span>            <span class="n">printf</span><span class="p">(</span><span class="s">"Error: couldn't get bin path.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="lineno">1138 </span>            <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="lineno">1139 </span>        <span class="p">}</span>
<span class="lineno">1140 </span>    <span class="p">}</span>
<span class="lineno">1141 </span>    <span class="k">return</span> <span class="n">path</span><span class="p">;</span>
<span class="lineno">1142 </span><span class="p">}</span>
<span class="lineno">1143 </span><span class="cp">#else</span>
<span class="lineno">1144 </span><span class="cp">#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp"></span>
<span class="lineno">1145 </span><span class="cp">#define FILE_SEP '\\'</span>
<span class="lineno">1146 </span>
<span class="lineno">1147 </span><span class="kt">char</span><span class="o">*</span> <span class="nf">_get_os_pid_bin_path</span><span class="p">()</span>
<span class="lineno">1148 </span><span class="p">{</span>
<span class="lineno">1149 </span>    <span class="k">static</span> <span class="kt">bool</span> <span class="n">initialised</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="lineno">1150 </span>    <span class="k">static</span> <span class="kt">char</span> <span class="n">path</span><span class="p">[</span><span class="mi">260</span><span class="p">];</span>
<span class="lineno">1151 </span>    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">initialised</span><span class="p">)</span>
<span class="lineno">1152 </span>    <span class="p">{</span>
<span class="lineno">1153 </span>        <span class="n">HMODULE</span> <span class="n">hModule</span> <span class="o">=</span> <span class="n">GetModuleHandleW</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
<span class="lineno">1154 </span>
<span class="lineno">1155 </span>        <span class="n">WCHAR</span> <span class="n">tpath</span><span class="p">[</span><span class="mi">260</span><span class="p">];</span>
<span class="lineno">1156 </span>        <span class="n">GetModuleFileNameW</span><span class="p">(</span><span class="n">hModule</span><span class="p">,</span> <span class="n">tpath</span><span class="p">,</span> <span class="mi">260</span><span class="p">);</span>
<span class="lineno">1157 </span>
<span class="lineno">1158 </span>        <span class="kt">char</span> <span class="n">DefChar</span> <span class="o">=</span> <span class="sc">' '</span><span class="p">;</span>
<span class="lineno">1159 </span>        <span class="n">WideCharToMultiByte</span><span class="p">(</span><span class="n">CP_ACP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tpath</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="mi">260</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">DefChar</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="lineno">1160 </span>
<span class="lineno">1161 </span>        <span class="o">*</span><span class="p">(</span><span class="n">strrchr</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">FILE_SEP</span><span class="p">))</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span> <span class="c1">//get last occurence;</span>
<span class="lineno">1162 </span>
<span class="lineno">1163 </span>    <span class="p">}</span>
<span class="lineno">1164 </span>    <span class="k">return</span> <span class="n">path</span><span class="p">;</span>
<span class="lineno">1165 </span><span class="p">}</span>
<span class="lineno">1166 </span><span class="cp">#endif</span>
<span class="lineno">1167 </span>
<span class="lineno">1168 </span><span class="kt">char</span><span class="o">*</span> <span class="nf">load_file</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">url</span><span class="p">,</span> <span class="kt">long</span> <span class="o">*</span><span class="n">ret_length</span><span class="p">)</span>
<span class="lineno">1169 </span><span class="p">{</span>
<span class="lineno">1170 </span>    <span class="kt">char</span> <span class="n">real_url</span><span class="p">[</span><span class="mi">260</span><span class="p">];</span>
<span class="lineno">1171 </span>    <span class="n">sprintf</span><span class="p">(</span><span class="n">real_url</span><span class="p">,</span> <span class="s">"%s%cres%c%s"</span><span class="p">,</span> <span class="n">_get_os_pid_bin_path</span><span class="p">(),</span> <span class="n">FILE_SEP</span><span class="p">,</span> <span class="n">FILE_SEP</span><span class="p">,</span> <span class="n">url</span><span class="p">);</span>
<span class="lineno">1172 </span>
<span class="lineno">1173 </span>    <span class="kt">char</span> <span class="o">*</span> <span class="n">buffer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno">1174 </span>    <span class="kt">long</span> <span class="n">length</span><span class="p">;</span>
<span class="lineno">1175 </span>    <span class="kt">FILE</span> <span class="o">*</span> <span class="n">f</span> <span class="o">=</span> <span class="n">fopen</span> <span class="p">(</span><span class="n">real_url</span><span class="p">,</span> <span class="s">"rb"</span><span class="p">);</span>
<span class="lineno">1176 </span>
<span class="lineno">1177 </span>    <span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="lineno">1178 </span>    <span class="p">{</span>
<span class="lineno">1179 </span>        <span class="n">fseek</span> <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SEEK_END</span><span class="p">);</span>
<span class="lineno">1180 </span>        <span class="n">length</span> <span class="o">=</span> <span class="n">ftell</span> <span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
<span class="lineno">1181 </span>        <span class="n">fseek</span> <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SEEK_SET</span><span class="p">);</span>
<span class="lineno">1182 </span>        <span class="n">buffer</span> <span class="o">=</span> <span class="n">malloc</span> <span class="p">(</span><span class="n">length</span><span class="p">);</span>
<span class="lineno">1183 </span>        <span class="k">if</span> <span class="p">(</span><span class="n">buffer</span><span class="p">)</span>
<span class="lineno">1184 </span>        <span class="p">{</span>
<span class="lineno">1185 </span>            <span class="n">fread</span> <span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">f</span><span class="p">);</span>
<span class="lineno">1186 </span>        <span class="p">}</span>
<span class="lineno">1187 </span>        <span class="n">fclose</span> <span class="p">(</span><span class="n">f</span><span class="p">);</span>
<span class="lineno">1188 </span>    <span class="p">}</span>
<span class="lineno">1189 </span>    <span class="k">if</span> <span class="p">(</span><span class="n">buffer</span><span class="p">)</span>
<span class="lineno">1190 </span>    <span class="p">{</span>
<span class="lineno">1191 </span>        <span class="n">buffer</span><span class="p">[</span><span class="n">length</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
<span class="lineno">1192 </span>
<span class="lineno">1193 </span>        <span class="o">*</span><span class="n">ret_length</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>
<span class="lineno">1194 </span>        <span class="k">return</span> <span class="n">buffer</span><span class="p">;</span>
<span class="lineno">1195 </span>    <span class="p">}</span>
<span class="lineno">1196 </span>    <span class="k">else</span>
<span class="lineno">1197 </span>    <span class="p">{</span>
<span class="lineno">1198 </span>        <span class="n">printf</span><span class="p">(</span><span class="s">"Error: Couldn't load file '%s'.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">real_url</span><span class="p">);</span>
<span class="lineno">1199 </span>        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="lineno">1200 </span>    <span class="p">}</span>
<span class="lineno">1201 </span><span class="p">}</span>
<span class="lineno">1202 </span>
<span class="lineno">1203 </span>
<span class="lineno">1204 </span><span class="c1">//Linked List for Mesh loading</span>
<span class="lineno">1205 </span><span class="k">struct</span> <span class="n">obj_list_elem</span>
<span class="lineno">1206 </span><span class="p">{</span>
<span class="lineno">1207 </span>    <span class="k">struct</span> <span class="n">obj_list_elem</span><span class="o">*</span> <span class="n">next</span><span class="p">;</span>
<span class="lineno">1208 </span>    <span class="n">tinyobj_attrib_t</span> <span class="n">attrib</span><span class="p">;</span>
<span class="lineno">1209 </span>    <span class="n">tinyobj_shape_t</span><span class="o">*</span> <span class="n">shapes</span><span class="p">;</span>
<span class="lineno">1210 </span>    <span class="kt">size_t</span> <span class="n">num_shapes</span><span class="p">;</span>
<span class="lineno">1211 </span>    <span class="kt">int</span> <span class="n">mat_index</span><span class="p">;</span>
<span class="lineno">1212 </span>    <span class="n">mat4</span> <span class="n">model_mat</span><span class="p">;</span>
<span class="lineno">1213 </span><span class="p">};</span>
<span class="lineno">1214 </span>
<span class="lineno">1215 </span><span class="kt">void</span> <span class="nf">obj_pre_load</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">data</span><span class="p">,</span> <span class="kt">long</span> <span class="n">data_len</span><span class="p">,</span> <span class="k">struct</span> <span class="n">obj_list_elem</span><span class="o">*</span> <span class="n">elem</span><span class="p">,</span>
<span class="lineno">1216 </span>                  <span class="kt">int</span><span class="o">*</span> <span class="n">num_meshes</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="o">*</span> <span class="n">num_indices</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="o">*</span> <span class="n">num_vertices</span><span class="p">,</span>
<span class="lineno">1217 </span>                  <span class="kt">unsigned</span> <span class="kt">int</span><span class="o">*</span> <span class="n">num_normals</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="o">*</span> <span class="n">num_texcoords</span><span class="p">)</span>
<span class="lineno">1218 </span><span class="p">{</span>
<span class="lineno">1219 </span>
<span class="lineno">1220 </span>    <span class="n">tinyobj_material_t</span><span class="o">*</span> <span class="n">materials</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="c1">//NOTE: UNUSED</span>
<span class="lineno">1221 </span>    <span class="kt">size_t</span> <span class="n">num_materials</span><span class="p">;</span>                 <span class="c1">//NOTE: UNUSED</span>
<span class="lineno">1222 </span>
<span class="lineno">1223 </span>
<span class="lineno">1224 </span>    <span class="p">{</span>
<span class="lineno">1225 </span>        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">TINYOBJ_FLAG_TRIANGULATE</span><span class="p">;</span>
<span class="lineno">1226 </span>        <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">tinyobj_parse_obj</span><span class="p">(</span><span class="o">&amp;</span><span class="n">elem</span><span class="o">-&gt;</span><span class="n">attrib</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">elem</span><span class="o">-&gt;</span><span class="n">shapes</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">elem</span><span class="o">-&gt;</span><span class="n">num_shapes</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">materials</span><span class="p">,</span>
<span class="lineno">1227 </span>                                    <span class="o">&amp;</span><span class="n">num_materials</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">data_len</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="lineno">1228 </span>        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">TINYOBJ_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">1229 </span>            <span class="n">printf</span><span class="p">(</span><span class="s">"Error: Couldn't parse mesh.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="lineno">1230 </span>            <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="lineno">1231 </span>        <span class="p">}</span>
<span class="lineno">1232 </span>    <span class="p">}</span>
<span class="lineno">1233 </span>
<span class="lineno">1234 </span>    <span class="o">*</span><span class="n">num_vertices</span>  <span class="o">+=</span> <span class="n">elem</span><span class="o">-&gt;</span><span class="n">attrib</span><span class="p">.</span><span class="n">num_vertices</span><span class="p">;</span>
<span class="lineno">1235 </span>    <span class="o">*</span><span class="n">num_normals</span>   <span class="o">+=</span> <span class="n">elem</span><span class="o">-&gt;</span><span class="n">attrib</span><span class="p">.</span><span class="n">num_normals</span><span class="p">;</span>
<span class="lineno">1236 </span>    <span class="o">*</span><span class="n">num_texcoords</span> <span class="o">+=</span> <span class="n">elem</span><span class="o">-&gt;</span><span class="n">attrib</span><span class="p">.</span><span class="n">num_texcoords</span><span class="p">;</span>
<span class="lineno">1237 </span>    <span class="o">*</span><span class="n">num_meshes</span>    <span class="o">+=</span> <span class="n">elem</span><span class="o">-&gt;</span><span class="n">num_shapes</span><span class="p">;</span>
<span class="lineno">1238 </span>    <span class="c1">//tinyobjloader has dumb variable names: attrib.num_faces =  num_vertices+num_faces</span>
<span class="lineno">1239 </span>    <span class="o">*</span><span class="n">num_indices</span>   <span class="o">+=</span> <span class="n">elem</span><span class="o">-&gt;</span><span class="n">attrib</span><span class="p">.</span><span class="n">num_faces</span><span class="p">;</span>
<span class="lineno">1240 </span><span class="p">}</span>
<span class="lineno">1241 </span>
<span class="lineno">1242 </span>
<span class="lineno">1243 </span>
<span class="lineno">1244 </span><span class="kt">void</span> <span class="nf">load_obj</span><span class="p">(</span><span class="k">struct</span> <span class="n">obj_list_elem</span> <span class="n">elem</span><span class="p">,</span> <span class="kt">int</span><span class="o">*</span> <span class="n">mesh_offset</span><span class="p">,</span> <span class="kt">int</span><span class="o">*</span> <span class="n">vert_offset</span><span class="p">,</span> <span class="kt">int</span><span class="o">*</span> <span class="n">nrml_offset</span><span class="p">,</span>
<span class="lineno">1245 </span>                      <span class="kt">int</span><span class="o">*</span> <span class="n">texcoord_offset</span><span class="p">,</span> <span class="kt">int</span><span class="o">*</span> <span class="n">index_offset</span><span class="p">,</span> <span class="n">scene</span><span class="o">*</span> <span class="n">out_scene</span><span class="p">)</span>
<span class="lineno">1246 </span><span class="p">{</span>
<span class="lineno">1247 </span>    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">elem</span><span class="p">.</span><span class="n">num_shapes</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="lineno">1248 </span>    <span class="p">{</span>
<span class="lineno">1249 </span>        <span class="n">tinyobj_shape_t</span> <span class="n">shape</span> <span class="o">=</span> <span class="n">elem</span><span class="p">.</span><span class="n">shapes</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="lineno">1250 </span>
<span class="lineno">1251 </span>        <span class="c1">//Get mesh and increment offset.</span>
<span class="lineno">1252 </span>        <span class="n">mesh</span><span class="o">*</span> <span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="n">out_scene</span><span class="o">-&gt;</span><span class="n">meshes</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="o">*</span><span class="n">mesh_offset</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
<span class="lineno">1253 </span>
<span class="lineno">1254 </span>        <span class="n">m</span><span class="o">-&gt;</span><span class="n">min</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">min</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">min</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span>  <span class="n">FLT_MAX</span><span class="p">;</span>
<span class="lineno">1255 </span>        <span class="n">m</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">FLT_MAX</span><span class="p">;</span>
<span class="lineno">1256 </span>
<span class="lineno">1257 </span>        <span class="n">memcpy</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">,</span> <span class="n">elem</span><span class="p">.</span><span class="n">model_mat</span><span class="p">,</span> <span class="mi">4</span><span class="o">*</span><span class="mi">4</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span>
<span class="lineno">1258 </span>
<span class="lineno">1259 </span>        <span class="n">m</span><span class="o">-&gt;</span><span class="n">index_offset</span> <span class="o">=</span> <span class="o">*</span><span class="n">index_offset</span><span class="p">;</span>
<span class="lineno">1260 </span>        <span class="n">m</span><span class="o">-&gt;</span><span class="n">num_indices</span>  <span class="o">=</span>  <span class="n">shape</span><span class="p">.</span><span class="n">length</span><span class="o">*</span><span class="mi">3</span><span class="p">;</span>
<span class="lineno">1261 </span>        <span class="n">m</span><span class="o">-&gt;</span><span class="n">material_index</span>    <span class="o">=</span>  <span class="n">elem</span><span class="p">.</span><span class="n">mat_index</span><span class="p">;</span>
<span class="lineno">1262 </span>
<span class="lineno">1263 </span>        <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">f</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">f</span> <span class="o">&lt;</span> <span class="n">shape</span><span class="p">.</span><span class="n">length</span><span class="p">;</span> <span class="n">f</span><span class="o">++</span><span class="p">)</span>
<span class="lineno">1264 </span>        <span class="p">{</span>
<span class="lineno">1265 </span>            <span class="c1">//TODO: don't do this error check for each iteration</span>
<span class="lineno">1266 </span>            <span class="k">if</span><span class="p">(</span><span class="n">elem</span><span class="p">.</span><span class="n">attrib</span><span class="p">.</span><span class="n">face_num_verts</span><span class="p">[</span><span class="n">f</span><span class="o">+</span><span class="n">shape</span><span class="p">.</span><span class="n">face_offset</span><span class="p">]</span><span class="o">!=</span><span class="mi">3</span><span class="p">)</span>
<span class="lineno">1267 </span>            <span class="p">{</span>
<span class="lineno">1268 </span>                <span class="c1">//This should never get called because the mesh gets triangulated when loaded.</span>
<span class="lineno">1269 </span>                <span class="n">printf</span><span class="p">(</span><span class="s">"Error: the obj loader only supports triangulated meshes!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="lineno">1270 </span>                <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="lineno">1271 </span>            <span class="p">}</span>
<span class="lineno">1272 </span>            <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="lineno">1273 </span>            <span class="p">{</span>
<span class="lineno">1274 </span>                <span class="n">tinyobj_vertex_index_t</span> <span class="n">face_index</span> <span class="o">=</span> <span class="n">elem</span><span class="p">.</span><span class="n">attrib</span><span class="p">.</span><span class="n">faces</span><span class="p">[(</span><span class="n">f</span><span class="o">+</span><span class="n">shape</span><span class="p">.</span><span class="n">face_offset</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="n">i</span><span class="p">];</span>
<span class="lineno">1275 </span>
<span class="lineno">1276 </span>                <span class="n">vec3</span> <span class="n">vertex</span><span class="p">;</span>
<span class="lineno">1277 </span>                <span class="n">vertex</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">elem</span><span class="p">.</span><span class="n">attrib</span><span class="p">.</span><span class="n">vertices</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">face_index</span><span class="p">.</span><span class="n">v_idx</span><span class="o">+</span><span class="mi">0</span><span class="p">];</span>
<span class="lineno">1278 </span>                <span class="n">vertex</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">elem</span><span class="p">.</span><span class="n">attrib</span><span class="p">.</span><span class="n">vertices</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">face_index</span><span class="p">.</span><span class="n">v_idx</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
<span class="lineno">1279 </span>                <span class="n">vertex</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">elem</span><span class="p">.</span><span class="n">attrib</span><span class="p">.</span><span class="n">vertices</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">face_index</span><span class="p">.</span><span class="n">v_idx</span><span class="o">+</span><span class="mi">2</span><span class="p">];</span>
<span class="lineno">1280 </span>
<span class="lineno">1281 </span>                <span class="n">m</span><span class="o">-&gt;</span><span class="n">min</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">vertex</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">min</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">?</span> <span class="n">vertex</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">:</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">min</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="c1">//X min</span>
<span class="lineno">1282 </span>                <span class="n">m</span><span class="o">-&gt;</span><span class="n">min</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">vertex</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">min</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">?</span> <span class="n">vertex</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">min</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span> <span class="c1">//Y min</span>
<span class="lineno">1283 </span>                <span class="n">m</span><span class="o">-&gt;</span><span class="n">min</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">vertex</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">min</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">?</span> <span class="n">vertex</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">:</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">min</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span> <span class="c1">//Z min</span>
<span class="lineno">1284 </span>
<span class="lineno">1285 </span>                <span class="n">m</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">vertex</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">?</span> <span class="n">vertex</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">:</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="c1">//X max</span>
<span class="lineno">1286 </span>                <span class="n">m</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">vertex</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">?</span> <span class="n">vertex</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span> <span class="c1">//Y max</span>
<span class="lineno">1287 </span>                <span class="n">m</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">vertex</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">?</span> <span class="n">vertex</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">:</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span> <span class="c1">//Z max</span>
<span class="lineno">1288 </span>
<span class="lineno">1289 </span>                <span class="n">ivec3</span> <span class="n">index</span><span class="p">;</span>
<span class="lineno">1290 </span>                <span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">vert_offset</span><span class="p">)</span><span class="o">+</span><span class="n">face_index</span><span class="p">.</span><span class="n">v_idx</span><span class="p">;</span>
<span class="lineno">1291 </span>                <span class="n">index</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">nrml_offset</span><span class="p">)</span><span class="o">+</span><span class="n">face_index</span><span class="p">.</span><span class="n">vn_idx</span><span class="p">;</span>
<span class="lineno">1292 </span>                <span class="n">index</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">texcoord_offset</span><span class="p">)</span><span class="o">+</span><span class="n">face_index</span><span class="p">.</span><span class="n">vt_idx</span><span class="p">;</span>
<span class="lineno">1293 </span>                <span class="n">out_scene</span><span class="o">-&gt;</span><span class="n">mesh_indices</span><span class="p">[(</span><span class="o">*</span><span class="n">index_offset</span><span class="p">)][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="lineno">1294 </span>                <span class="n">out_scene</span><span class="o">-&gt;</span><span class="n">mesh_indices</span><span class="p">[(</span><span class="o">*</span><span class="n">index_offset</span><span class="p">)][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">index</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="lineno">1295 </span>                <span class="n">out_scene</span><span class="o">-&gt;</span><span class="n">mesh_indices</span><span class="p">[(</span><span class="o">*</span><span class="n">index_offset</span><span class="p">)][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">index</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="lineno">1296 </span>
<span class="lineno">1297 </span>                <span class="c1">//xv3_cpy(out_scene-&gt;mesh_indices + (*index_offset), index);</span>
<span class="lineno">1298 </span>                <span class="p">(</span><span class="o">*</span><span class="n">index_offset</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
<span class="lineno">1299 </span>            <span class="p">}</span>
<span class="lineno">1300 </span>        <span class="p">}</span>
<span class="lineno">1301 </span>    <span class="p">}</span>
<span class="lineno">1302 </span>
<span class="lineno">1303 </span>    <span class="c1">//GPU MEMORY ALIGNMENT FUN</span>
<span class="lineno">1304 </span>    <span class="c1">//NOTE: this is done because the gpu stores all vec3s 4 floats for memory alignment</span>
<span class="lineno">1305 </span>    <span class="c1">//      and it is actually faster if they are aligned like this even</span>
<span class="lineno">1306 </span>    <span class="c1">//      though it wastes more memory.</span>
<span class="lineno">1307 </span>    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">elem</span><span class="p">.</span><span class="n">attrib</span><span class="p">.</span><span class="n">num_vertices</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="lineno">1308 </span>    <span class="p">{</span>
<span class="lineno">1309 </span>
<span class="lineno">1310 </span>        <span class="n">memcpy</span><span class="p">(</span><span class="n">out_scene</span><span class="o">-&gt;</span><span class="n">mesh_verts</span> <span class="o">+</span> <span class="p">(</span><span class="o">*</span><span class="n">vert_offset</span><span class="p">),</span>
<span class="lineno">1311 </span>               <span class="n">elem</span><span class="p">.</span><span class="n">attrib</span><span class="p">.</span><span class="n">vertices</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="p">,</span>
<span class="lineno">1312 </span>               <span class="k">sizeof</span><span class="p">(</span><span class="n">vec3</span><span class="p">));</span>
<span class="lineno">1313 </span>        <span class="p">(</span><span class="o">*</span><span class="n">vert_offset</span><span class="p">)</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
<span class="lineno">1314 </span>    <span class="p">}</span>
<span class="lineno">1315 </span>    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">elem</span><span class="p">.</span><span class="n">attrib</span><span class="p">.</span><span class="n">num_normals</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="lineno">1316 </span>    <span class="p">{</span>
<span class="lineno">1317 </span>        <span class="n">memcpy</span><span class="p">(</span><span class="n">out_scene</span><span class="o">-&gt;</span><span class="n">mesh_nrmls</span> <span class="o">+</span> <span class="p">(</span><span class="o">*</span><span class="n">nrml_offset</span><span class="p">),</span>
<span class="lineno">1318 </span>               <span class="n">elem</span><span class="p">.</span><span class="n">attrib</span><span class="p">.</span><span class="n">normals</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="p">,</span>
<span class="lineno">1319 </span>               <span class="k">sizeof</span><span class="p">(</span><span class="n">vec3</span><span class="p">));</span>
<span class="lineno">1320 </span>        <span class="p">(</span><span class="o">*</span><span class="n">nrml_offset</span><span class="p">)</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
<span class="lineno">1321 </span>    <span class="p">}</span>
<span class="lineno">1322 </span>    <span class="c1">//NOTE: the texcoords are already aligned because they only have 2 elements.</span>
<span class="lineno">1323 </span>    <span class="n">memcpy</span><span class="p">(</span><span class="n">out_scene</span><span class="o">-&gt;</span><span class="n">mesh_texcoords</span> <span class="o">+</span> <span class="p">(</span><span class="o">*</span><span class="n">texcoord_offset</span><span class="p">),</span> <span class="n">elem</span><span class="p">.</span><span class="n">attrib</span><span class="p">.</span><span class="n">texcoords</span><span class="p">,</span>
<span class="lineno">1324 </span>           <span class="n">elem</span><span class="p">.</span><span class="n">attrib</span><span class="p">.</span><span class="n">num_texcoords</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">vec2</span><span class="p">));</span>
<span class="lineno">1325 </span>    <span class="p">(</span><span class="o">*</span><span class="n">texcoord_offset</span><span class="p">)</span> <span class="o">+=</span> <span class="n">elem</span><span class="p">.</span><span class="n">attrib</span><span class="p">.</span><span class="n">num_texcoords</span><span class="p">;</span>
<span class="lineno">1326 </span><span class="p">}</span>
<span class="lineno">1327 </span>
<span class="lineno">1328 </span><span class="n">scene</span><span class="o">*</span> <span class="nf">load_scene_json</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">json</span><span class="p">)</span>
<span class="lineno">1329 </span><span class="p">{</span>
<span class="lineno">1330 </span>    <span class="n">printf</span><span class="p">(</span><span class="s">"Beginning scene loading...</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="lineno">1331 </span>    <span class="n">scene</span><span class="o">*</span> <span class="n">out_scene</span> <span class="o">=</span> <span class="p">(</span><span class="n">scene</span><span class="o">*</span><span class="p">)</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">scene</span><span class="p">));</span>
<span class="lineno">1332 </span>    <span class="n">JSON_Value</span> <span class="o">*</span><span class="n">root_value</span><span class="p">;</span>
<span class="lineno">1333 </span>    <span class="n">JSON_Object</span> <span class="o">*</span><span class="n">root_object</span><span class="p">;</span>
<span class="lineno">1334 </span>    <span class="n">root_value</span> <span class="o">=</span> <span class="n">json_parse_string</span><span class="p">(</span><span class="n">json</span><span class="p">);</span>
<span class="lineno">1335 </span>    <span class="n">root_object</span> <span class="o">=</span> <span class="n">json_value_get_object</span><span class="p">(</span><span class="n">root_value</span><span class="p">);</span>
<span class="lineno">1336 </span>
<span class="lineno">1337 </span>
<span class="lineno">1338 </span>    <span class="c1">//Name</span>
<span class="lineno">1339 </span>    <span class="p">{</span>
<span class="lineno">1340 </span>        <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span> <span class="o">=</span> <span class="n">json_object_get_string</span><span class="p">(</span><span class="n">root_object</span><span class="p">,</span> <span class="s">"name"</span><span class="p">);</span>
<span class="lineno">1341 </span>        <span class="n">printf</span><span class="p">(</span><span class="s">"Scene name: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<span class="lineno">1342 </span>    <span class="p">}</span>
<span class="lineno">1343 </span>
<span class="lineno">1344 </span>    <span class="c1">//Version</span>
<span class="lineno">1345 </span>    <span class="p">{</span><span class="c1">//TODO: do something with this.</span>
<span class="lineno">1346 </span>        <span class="kt">int</span> <span class="n">major</span>  <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">json_object_dotget_number</span><span class="p">(</span><span class="n">root_object</span><span class="p">,</span> <span class="s">"version.major"</span><span class="p">);</span>
<span class="lineno">1347 </span>        <span class="kt">int</span> <span class="n">minor</span>  <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">json_object_dotget_number</span><span class="p">(</span><span class="n">root_object</span><span class="p">,</span> <span class="s">"version.major"</span><span class="p">);</span>
<span class="lineno">1348 </span>        <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">type</span> <span class="o">=</span>      <span class="n">json_object_dotget_string</span><span class="p">(</span><span class="n">root_object</span><span class="p">,</span> <span class="s">"version.type"</span><span class="p">);</span>
<span class="lineno">1349 </span>    <span class="p">}</span>
<span class="lineno">1350 </span>
<span class="lineno">1351 </span>    <span class="c1">//Materials</span>
<span class="lineno">1352 </span>    <span class="p">{</span>
<span class="lineno">1353 </span>        <span class="n">JSON_Array</span><span class="o">*</span> <span class="n">material_array</span> <span class="o">=</span> <span class="n">json_object_get_array</span><span class="p">(</span><span class="n">root_object</span><span class="p">,</span> <span class="s">"materials"</span><span class="p">);</span>
<span class="lineno">1354 </span>        <span class="n">out_scene</span><span class="o">-&gt;</span><span class="n">num_materials</span>   <span class="o">=</span> <span class="n">json_array_get_count</span><span class="p">(</span><span class="n">material_array</span><span class="p">);</span>
<span class="lineno">1355 </span>        <span class="n">out_scene</span><span class="o">-&gt;</span><span class="n">materials</span> <span class="o">=</span> <span class="p">(</span><span class="n">material</span><span class="o">*</span><span class="p">)</span> <span class="n">malloc</span><span class="p">(</span><span class="n">out_scene</span><span class="o">-&gt;</span><span class="n">num_materials</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">material</span><span class="p">));</span>
<span class="lineno">1356 </span>        <span class="n">assert</span><span class="p">(</span><span class="n">out_scene</span><span class="o">-&gt;</span><span class="n">num_materials</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">);</span>
<span class="lineno">1357 </span>        <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">out_scene</span><span class="o">-&gt;</span><span class="n">num_materials</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="lineno">1358 </span>        <span class="p">{</span>
<span class="lineno">1359 </span>            <span class="n">JSON_Object</span><span class="o">*</span> <span class="n">mat</span> <span class="o">=</span> <span class="n">json_array_get_object</span><span class="p">(</span><span class="n">material_array</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
<span class="lineno">1360 </span>            <span class="n">xv_x</span><span class="p">(</span><span class="n">out_scene</span><span class="o">-&gt;</span><span class="n">materials</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">colour</span><span class="p">)</span> <span class="o">=</span> <span class="n">json_object_get_number</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="s">"r"</span><span class="p">);</span>
<span class="lineno">1361 </span>            <span class="n">xv_y</span><span class="p">(</span><span class="n">out_scene</span><span class="o">-&gt;</span><span class="n">materials</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">colour</span><span class="p">)</span> <span class="o">=</span> <span class="n">json_object_get_number</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="s">"g"</span><span class="p">);</span>
<span class="lineno">1362 </span>            <span class="n">xv_z</span><span class="p">(</span><span class="n">out_scene</span><span class="o">-&gt;</span><span class="n">materials</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">colour</span><span class="p">)</span> <span class="o">=</span> <span class="n">json_object_get_number</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="s">"b"</span><span class="p">);</span>
<span class="lineno">1363 </span>            <span class="n">out_scene</span><span class="o">-&gt;</span><span class="n">materials</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">reflectivity</span> <span class="o">=</span> <span class="n">json_object_get_number</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="s">"reflectivity"</span><span class="p">);</span>
<span class="lineno">1364 </span>        <span class="p">}</span>
<span class="lineno">1365 </span>        <span class="n">printf</span><span class="p">(</span><span class="s">"Materials: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">out_scene</span><span class="o">-&gt;</span><span class="n">num_materials</span><span class="p">);</span>
<span class="lineno">1366 </span>    <span class="p">}</span>
<span class="lineno">1367 </span>
<span class="lineno">1368 </span>    <span class="c1">//Primitives</span>
<span class="lineno">1369 </span>    <span class="p">{</span>
<span class="lineno">1370 </span>
<span class="lineno">1371 </span>        <span class="n">JSON_Object</span><span class="o">*</span> <span class="n">primitive_object</span> <span class="o">=</span> <span class="n">json_object_get_object</span><span class="p">(</span><span class="n">root_object</span><span class="p">,</span> <span class="s">"primitives"</span><span class="p">);</span>
<span class="lineno">1372 </span>
<span class="lineno">1373 </span>        <span class="c1">//Spheres</span>
<span class="lineno">1374 </span>        <span class="p">{</span>
<span class="lineno">1375 </span>            <span class="n">JSON_Array</span><span class="o">*</span> <span class="n">sphere_array</span> <span class="o">=</span> <span class="n">json_object_get_array</span><span class="p">(</span><span class="n">primitive_object</span><span class="p">,</span> <span class="s">"spheres"</span><span class="p">);</span>
<span class="lineno">1376 </span>            <span class="kt">int</span> <span class="n">num_spheres</span> <span class="o">=</span> <span class="n">json_array_get_count</span><span class="p">(</span><span class="n">sphere_array</span><span class="p">);</span>
<span class="lineno">1377 </span>
<span class="lineno">1378 </span>            <span class="n">out_scene</span><span class="o">-&gt;</span><span class="n">spheres</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">sphere</span><span class="p">)</span><span class="o">*</span><span class="n">num_spheres</span><span class="p">);</span>
<span class="lineno">1379 </span>            <span class="n">out_scene</span><span class="o">-&gt;</span><span class="n">num_spheres</span> <span class="o">=</span> <span class="n">num_spheres</span><span class="p">;</span>
<span class="lineno">1380 </span>
<span class="lineno">1381 </span>            <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_spheres</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="lineno">1382 </span>            <span class="p">{</span>
<span class="lineno">1383 </span>                <span class="n">JSON_Object</span><span class="o">*</span> <span class="n">sphere</span> <span class="o">=</span> <span class="n">json_array_get_object</span><span class="p">(</span><span class="n">sphere_array</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
<span class="lineno">1384 </span>                <span class="n">out_scene</span><span class="o">-&gt;</span><span class="n">spheres</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">json_object_get_number</span><span class="p">(</span><span class="n">sphere</span><span class="p">,</span> <span class="s">"x"</span><span class="p">);</span>
<span class="lineno">1385 </span>                <span class="n">out_scene</span><span class="o">-&gt;</span><span class="n">spheres</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">json_object_get_number</span><span class="p">(</span><span class="n">sphere</span><span class="p">,</span> <span class="s">"y"</span><span class="p">);</span>
<span class="lineno">1386 </span>                <span class="n">out_scene</span><span class="o">-&gt;</span><span class="n">spheres</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">json_object_get_number</span><span class="p">(</span><span class="n">sphere</span><span class="p">,</span> <span class="s">"z"</span><span class="p">);</span>
<span class="lineno">1387 </span>                <span class="n">out_scene</span><span class="o">-&gt;</span><span class="n">spheres</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">radius</span> <span class="o">=</span> <span class="n">json_object_get_number</span><span class="p">(</span><span class="n">sphere</span><span class="p">,</span> <span class="s">"radius"</span><span class="p">);</span>
<span class="lineno">1388 </span>                <span class="n">out_scene</span><span class="o">-&gt;</span><span class="n">spheres</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">material_index</span> <span class="o">=</span> <span class="n">json_object_get_number</span><span class="p">(</span><span class="n">sphere</span><span class="p">,</span> <span class="s">"mat_index"</span><span class="p">);</span>
<span class="lineno">1389 </span>            <span class="p">}</span>
<span class="lineno">1390 </span>            <span class="n">printf</span><span class="p">(</span><span class="s">"Spheres: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">out_scene</span><span class="o">-&gt;</span><span class="n">num_spheres</span><span class="p">);</span>
<span class="lineno">1391 </span>        <span class="p">}</span>
<span class="lineno">1392 </span>
<span class="lineno">1393 </span>        <span class="c1">//Planes</span>
<span class="lineno">1394 </span>        <span class="p">{</span>
<span class="lineno">1395 </span>            <span class="n">JSON_Array</span><span class="o">*</span> <span class="n">plane_array</span> <span class="o">=</span> <span class="n">json_object_get_array</span><span class="p">(</span><span class="n">primitive_object</span><span class="p">,</span> <span class="s">"planes"</span><span class="p">);</span>
<span class="lineno">1396 </span>            <span class="kt">int</span> <span class="n">num_planes</span> <span class="o">=</span> <span class="n">json_array_get_count</span><span class="p">(</span><span class="n">plane_array</span><span class="p">);</span>
<span class="lineno">1397 </span>
<span class="lineno">1398 </span>            <span class="n">out_scene</span><span class="o">-&gt;</span><span class="n">planes</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">plane</span><span class="p">)</span><span class="o">*</span><span class="n">num_planes</span><span class="p">);</span>
<span class="lineno">1399 </span>            <span class="n">out_scene</span><span class="o">-&gt;</span><span class="n">num_planes</span> <span class="o">=</span> <span class="n">num_planes</span><span class="p">;</span>
<span class="lineno">1400 </span>
<span class="lineno">1401 </span>            <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_planes</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="lineno">1402 </span>            <span class="p">{</span>
<span class="lineno">1403 </span>                <span class="n">JSON_Object</span><span class="o">*</span> <span class="n">plane</span> <span class="o">=</span> <span class="n">json_array_get_object</span><span class="p">(</span><span class="n">plane_array</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
<span class="lineno">1404 </span>                <span class="n">out_scene</span><span class="o">-&gt;</span><span class="n">planes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">json_object_get_number</span><span class="p">(</span><span class="n">plane</span><span class="p">,</span> <span class="s">"x"</span><span class="p">);</span>
<span class="lineno">1405 </span>                <span class="n">out_scene</span><span class="o">-&gt;</span><span class="n">planes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">json_object_get_number</span><span class="p">(</span><span class="n">plane</span><span class="p">,</span> <span class="s">"y"</span><span class="p">);</span>
<span class="lineno">1406 </span>                <span class="n">out_scene</span><span class="o">-&gt;</span><span class="n">planes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">json_object_get_number</span><span class="p">(</span><span class="n">plane</span><span class="p">,</span> <span class="s">"z"</span><span class="p">);</span>
<span class="lineno">1407 </span>                <span class="n">out_scene</span><span class="o">-&gt;</span><span class="n">planes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">norm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">json_object_get_number</span><span class="p">(</span><span class="n">plane</span><span class="p">,</span> <span class="s">"nx"</span><span class="p">);</span>
<span class="lineno">1408 </span>                <span class="n">out_scene</span><span class="o">-&gt;</span><span class="n">planes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">norm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">json_object_get_number</span><span class="p">(</span><span class="n">plane</span><span class="p">,</span> <span class="s">"ny"</span><span class="p">);</span>
<span class="lineno">1409 </span>                <span class="n">out_scene</span><span class="o">-&gt;</span><span class="n">planes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">norm</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">json_object_get_number</span><span class="p">(</span><span class="n">plane</span><span class="p">,</span> <span class="s">"nz"</span><span class="p">);</span>
<span class="lineno">1410 </span>
<span class="lineno">1411 </span>                <span class="n">out_scene</span><span class="o">-&gt;</span><span class="n">planes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">material_index</span> <span class="o">=</span> <span class="n">json_object_get_number</span><span class="p">(</span><span class="n">plane</span><span class="p">,</span> <span class="s">"mat_index"</span><span class="p">);</span>
<span class="lineno">1412 </span>            <span class="p">}</span>
<span class="lineno">1413 </span>            <span class="n">printf</span><span class="p">(</span><span class="s">"Planes: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">out_scene</span><span class="o">-&gt;</span><span class="n">num_planes</span><span class="p">);</span>
<span class="lineno">1414 </span>        <span class="p">}</span>
<span class="lineno">1415 </span>
<span class="lineno">1416 </span>    <span class="p">}</span>
<span class="lineno">1417 </span>
<span class="lineno">1418 </span>
<span class="lineno">1419 </span>    <span class="c1">//Meshes</span>
<span class="lineno">1420 </span>    <span class="p">{</span>
<span class="lineno">1421 </span>        <span class="n">JSON_Array</span><span class="o">*</span> <span class="n">mesh_array</span> <span class="o">=</span> <span class="n">json_object_get_array</span><span class="p">(</span><span class="n">root_object</span><span class="p">,</span> <span class="s">"meshes"</span><span class="p">);</span>
<span class="lineno">1422 </span>
<span class="lineno">1423 </span>        <span class="kt">int</span> <span class="n">num_meshes</span> <span class="o">=</span> <span class="n">json_array_get_count</span><span class="p">(</span><span class="n">mesh_array</span><span class="p">);</span>
<span class="lineno">1424 </span>
<span class="lineno">1425 </span>        <span class="n">out_scene</span><span class="o">-&gt;</span><span class="n">num_meshes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno">1426 </span>        <span class="n">out_scene</span><span class="o">-&gt;</span><span class="n">num_mesh_verts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno">1427 </span>        <span class="n">out_scene</span><span class="o">-&gt;</span><span class="n">num_mesh_nrmls</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno">1428 </span>        <span class="n">out_scene</span><span class="o">-&gt;</span><span class="n">num_mesh_texcoords</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno">1429 </span>        <span class="n">out_scene</span><span class="o">-&gt;</span><span class="n">num_mesh_indices</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno">1430 </span>
<span class="lineno">1431 </span>
<span class="lineno">1432 </span>        <span class="k">struct</span> <span class="n">obj_list_elem</span><span class="o">*</span> <span class="n">first</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">obj_list_elem</span><span class="o">*</span><span class="p">)</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">obj_list_elem</span><span class="p">));</span>
<span class="lineno">1433 </span>        <span class="k">struct</span> <span class="n">obj_list_elem</span><span class="o">*</span> <span class="n">current</span> <span class="o">=</span> <span class="n">first</span><span class="p">;</span>
<span class="lineno">1434 </span>
<span class="lineno">1435 </span>        <span class="c1">//Pre evaluation</span>
<span class="lineno">1436 </span>        <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_meshes</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="lineno">1437 </span>        <span class="p">{</span>
<span class="lineno">1438 </span>            <span class="n">JSON_Object</span><span class="o">*</span> <span class="n">mesh</span> <span class="o">=</span> <span class="n">json_array_get_object</span><span class="p">(</span><span class="n">mesh_array</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
<span class="lineno">1439 </span>            <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">url</span> <span class="o">=</span> <span class="n">json_object_get_string</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="s">"url"</span><span class="p">);</span>
<span class="lineno">1440 </span>            <span class="kt">long</span> <span class="n">length</span><span class="p">;</span>
<span class="lineno">1441 </span>            <span class="kt">char</span><span class="o">*</span> <span class="n">data</span> <span class="o">=</span> <span class="n">load_file</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">length</span><span class="p">);</span>
<span class="lineno">1442 </span>            <span class="n">obj_pre_load</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">current</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">out_scene</span><span class="o">-&gt;</span><span class="n">num_meshes</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">out_scene</span><span class="o">-&gt;</span><span class="n">num_mesh_indices</span><span class="p">,</span>
<span class="lineno">1443 </span>                         <span class="o">&amp;</span><span class="n">out_scene</span><span class="o">-&gt;</span><span class="n">num_mesh_verts</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">out_scene</span><span class="o">-&gt;</span><span class="n">num_mesh_nrmls</span><span class="p">,</span>
<span class="lineno">1444 </span>                         <span class="o">&amp;</span><span class="n">out_scene</span><span class="o">-&gt;</span><span class="n">num_mesh_texcoords</span><span class="p">);</span>
<span class="lineno">1445 </span>            <span class="n">current</span><span class="o">-&gt;</span><span class="n">mat_index</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">json_object_get_number</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="s">"mat_index"</span><span class="p">);</span>
<span class="lineno">1446 </span>            <span class="c1">//mat4 model_mat;</span>
<span class="lineno">1447 </span>            <span class="p">{</span>
<span class="lineno">1448 </span>                <span class="c1">//xm4_identity(model_mat);</span>
<span class="lineno">1449 </span>                <span class="n">mat4</span> <span class="n">translation_mat</span><span class="p">;</span>
<span class="lineno">1450 </span>                <span class="n">xm4_translatev</span><span class="p">(</span><span class="n">translation_mat</span><span class="p">,</span>
<span class="lineno">1451 </span>                               <span class="n">json_object_get_number</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="s">"px"</span><span class="p">),</span>
<span class="lineno">1452 </span>                               <span class="n">json_object_get_number</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="s">"py"</span><span class="p">),</span>
<span class="lineno">1453 </span>                               <span class="n">json_object_get_number</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="s">"pz"</span><span class="p">));</span>
<span class="lineno">1454 </span>                <span class="n">mat4</span> <span class="n">scale_mat</span><span class="p">;</span>
<span class="lineno">1455 </span>                <span class="n">xm4_scalev</span><span class="p">(</span><span class="n">scale_mat</span><span class="p">,</span>
<span class="lineno">1456 </span>                           <span class="n">json_object_get_number</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="s">"sx"</span><span class="p">),</span>
<span class="lineno">1457 </span>                           <span class="n">json_object_get_number</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="s">"sy"</span><span class="p">),</span>
<span class="lineno">1458 </span>                           <span class="n">json_object_get_number</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="s">"sz"</span><span class="p">));</span>
<span class="lineno">1459 </span>                <span class="c1">//TODO: add rotation.</span>
<span class="lineno">1460 </span>                <span class="n">xm4_mul</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">model_mat</span><span class="p">,</span> <span class="n">translation_mat</span><span class="p">,</span> <span class="n">scale_mat</span><span class="p">);</span>
<span class="lineno">1461 </span>            <span class="p">}</span>
<span class="lineno">1462 </span>            <span class="n">free</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
<span class="lineno">1463 </span>
<span class="lineno">1464 </span>            <span class="k">if</span><span class="p">(</span><span class="n">i</span><span class="o">!=</span><span class="n">num_meshes</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="c1">//messy but it works</span>
<span class="lineno">1465 </span>            <span class="p">{</span>
<span class="lineno">1466 </span>                <span class="n">current</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">obj_list_elem</span><span class="o">*</span><span class="p">)</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">obj_list_elem</span><span class="p">));</span>
<span class="lineno">1467 </span>                <span class="n">current</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
<span class="lineno">1468 </span>            <span class="p">}</span>
<span class="lineno">1469 </span>            <span class="n">current</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="lineno">1470 </span>        <span class="p">}</span>
<span class="lineno">1471 </span>
<span class="lineno">1472 </span>        <span class="c1">//Allocation</span>
<span class="lineno">1473 </span>        <span class="n">out_scene</span><span class="o">-&gt;</span><span class="n">meshes</span>          <span class="o">=</span> <span class="p">(</span><span class="n">mesh</span><span class="o">*</span><span class="p">)</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">mesh</span><span class="p">)</span><span class="o">*</span><span class="n">out_scene</span><span class="o">-&gt;</span><span class="n">num_meshes</span><span class="p">);</span>
<span class="lineno">1474 </span>        <span class="n">out_scene</span><span class="o">-&gt;</span><span class="n">mesh_verts</span>      <span class="o">=</span> <span class="p">(</span><span class="n">vec3</span><span class="o">*</span><span class="p">)</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">vec3</span><span class="p">)</span><span class="o">*</span><span class="n">out_scene</span><span class="o">-&gt;</span><span class="n">num_mesh_verts</span><span class="p">);</span>
<span class="lineno">1475 </span>        <span class="n">out_scene</span><span class="o">-&gt;</span><span class="n">mesh_nrmls</span>      <span class="o">=</span> <span class="p">(</span><span class="n">vec3</span><span class="o">*</span><span class="p">)</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">vec3</span><span class="p">)</span><span class="o">*</span><span class="n">out_scene</span><span class="o">-&gt;</span><span class="n">num_mesh_nrmls</span><span class="p">);</span>
<span class="lineno">1476 </span>        <span class="n">out_scene</span><span class="o">-&gt;</span><span class="n">mesh_texcoords</span>  <span class="o">=</span> <span class="p">(</span><span class="n">vec2</span><span class="o">*</span><span class="p">)</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">vec2</span><span class="p">)</span><span class="o">*</span><span class="n">out_scene</span><span class="o">-&gt;</span><span class="n">num_mesh_texcoords</span><span class="p">);</span>
<span class="lineno">1477 </span>        <span class="n">out_scene</span><span class="o">-&gt;</span><span class="n">mesh_indices</span>    <span class="o">=</span> <span class="p">(</span><span class="n">ivec3</span><span class="o">*</span><span class="p">)</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">ivec3</span><span class="p">)</span><span class="o">*</span><span class="n">out_scene</span><span class="o">-&gt;</span><span class="n">num_mesh_indices</span><span class="p">);</span>
<span class="lineno">1478 </span>
<span class="lineno">1479 </span>        <span class="n">assert</span><span class="p">(</span><span class="n">out_scene</span><span class="o">-&gt;</span><span class="n">meshes</span><span class="o">!=</span><span class="nb">NULL</span><span class="p">);</span>
<span class="lineno">1480 </span>        <span class="n">assert</span><span class="p">(</span><span class="n">out_scene</span><span class="o">-&gt;</span><span class="n">mesh_verts</span><span class="o">!=</span><span class="nb">NULL</span><span class="p">);</span>
<span class="lineno">1481 </span>        <span class="n">assert</span><span class="p">(</span><span class="n">out_scene</span><span class="o">-&gt;</span><span class="n">mesh_nrmls</span><span class="o">!=</span><span class="nb">NULL</span><span class="p">);</span>
<span class="lineno">1482 </span>        <span class="n">assert</span><span class="p">(</span><span class="n">out_scene</span><span class="o">-&gt;</span><span class="n">mesh_texcoords</span><span class="o">!=</span><span class="nb">NULL</span><span class="p">);</span>
<span class="lineno">1483 </span>        <span class="n">assert</span><span class="p">(</span><span class="n">out_scene</span><span class="o">-&gt;</span><span class="n">mesh_indices</span><span class="o">!=</span><span class="nb">NULL</span><span class="p">);</span>
<span class="lineno">1484 </span>
<span class="lineno">1485 </span>        <span class="c1">//Parsing and Assignment</span>
<span class="lineno">1486 </span>        <span class="kt">int</span> <span class="n">mesh_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno">1487 </span>        <span class="kt">int</span> <span class="n">vert_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno">1488 </span>        <span class="kt">int</span> <span class="n">nrml_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno">1489 </span>        <span class="kt">int</span> <span class="n">texcoord_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno">1490 </span>        <span class="kt">int</span> <span class="n">index_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno">1491 </span>
<span class="lineno">1492 </span>
<span class="lineno">1493 </span>        <span class="n">current</span> <span class="o">=</span> <span class="n">first</span><span class="p">;</span>
<span class="lineno">1494 </span>        <span class="k">while</span><span class="p">(</span><span class="n">current</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">num_meshes</span><span class="p">)</span>
<span class="lineno">1495 </span>        <span class="p">{</span>
<span class="lineno">1496 </span>
<span class="lineno">1497 </span>            <span class="n">load_obj</span><span class="p">(</span><span class="o">*</span><span class="n">current</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mesh_offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vert_offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nrml_offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">texcoord_offset</span><span class="p">,</span>
<span class="lineno">1498 </span>                     <span class="o">&amp;</span><span class="n">index_offset</span><span class="p">,</span> <span class="n">out_scene</span><span class="p">);</span>
<span class="lineno">1499 </span>
<span class="lineno">1500 </span>            <span class="n">current</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
<span class="lineno">1501 </span>        <span class="p">}</span>
<span class="lineno">1502 </span>        <span class="n">printf</span><span class="p">(</span><span class="s">"%i and %i</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">vert_offset</span><span class="p">,</span> <span class="n">out_scene</span><span class="o">-&gt;</span><span class="n">num_mesh_verts</span><span class="p">);</span>
<span class="lineno">1503 </span>        <span class="n">assert</span><span class="p">(</span><span class="n">mesh_offset</span><span class="o">==</span><span class="n">out_scene</span><span class="o">-&gt;</span><span class="n">num_meshes</span><span class="p">);</span>
<span class="lineno">1504 </span>        <span class="n">assert</span><span class="p">(</span><span class="n">vert_offset</span><span class="o">==</span><span class="n">out_scene</span><span class="o">-&gt;</span><span class="n">num_mesh_verts</span><span class="p">);</span>
<span class="lineno">1505 </span>        <span class="n">assert</span><span class="p">(</span><span class="n">nrml_offset</span><span class="o">==</span><span class="n">out_scene</span><span class="o">-&gt;</span><span class="n">num_mesh_nrmls</span><span class="p">);</span>
<span class="lineno">1506 </span>        <span class="n">assert</span><span class="p">(</span><span class="n">texcoord_offset</span><span class="o">==</span><span class="n">out_scene</span><span class="o">-&gt;</span><span class="n">num_mesh_texcoords</span><span class="p">);</span>
<span class="lineno">1507 </span>
<span class="lineno">1508 </span>        <span class="n">assert</span><span class="p">(</span><span class="n">index_offset</span><span class="o">==</span><span class="n">out_scene</span><span class="o">-&gt;</span><span class="n">num_mesh_indices</span><span class="p">);</span>
<span class="lineno">1509 </span>
<span class="lineno">1510 </span>        <span class="n">printf</span><span class="p">(</span><span class="s">"Meshes: %d</span><span class="se">\n</span><span class="s">Vertices: %d</span><span class="se">\n</span><span class="s">Indices: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
<span class="lineno">1511 </span>               <span class="n">out_scene</span><span class="o">-&gt;</span><span class="n">num_meshes</span><span class="p">,</span> <span class="n">out_scene</span><span class="o">-&gt;</span><span class="n">num_mesh_verts</span><span class="p">,</span> <span class="n">out_scene</span><span class="o">-&gt;</span><span class="n">num_mesh_indices</span><span class="p">);</span>
<span class="lineno">1512 </span>
<span class="lineno">1513 </span>    <span class="p">}</span>
<span class="lineno">1514 </span>
<span class="lineno">1515 </span>    <span class="n">out_scene</span><span class="o">-&gt;</span><span class="n">materials_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="lineno">1516 </span>    <span class="n">out_scene</span><span class="o">-&gt;</span><span class="n">spheres_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="lineno">1517 </span>    <span class="n">out_scene</span><span class="o">-&gt;</span><span class="n">planes_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="lineno">1518 </span>    <span class="n">out_scene</span><span class="o">-&gt;</span><span class="n">meshes_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="lineno">1519 </span>
<span class="lineno">1520 </span>
<span class="lineno">1521 </span>    <span class="n">printf</span><span class="p">(</span><span class="s">"Finshed scene loading.</span><span class="se">\n\n</span><span class="s">"</span><span class="p">);</span>
<span class="lineno">1522 </span>
<span class="lineno">1523 </span>    <span class="n">json_value_free</span><span class="p">(</span><span class="n">root_value</span><span class="p">);</span>
<span class="lineno">1524 </span>    <span class="k">return</span> <span class="n">out_scene</span><span class="p">;</span>
<span class="lineno">1525 </span><span class="p">}</span>
<span class="lineno">1526 </span>
<span class="lineno">1527 </span>
<span class="lineno">1528 </span><span class="n">scene</span><span class="o">*</span> <span class="nf">load_scene_json_url</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">url</span><span class="p">)</span>
<span class="lineno">1529 </span><span class="p">{</span>
<span class="lineno">1530 </span>    <span class="kt">long</span> <span class="n">variable_doesnt_matter</span><span class="p">;</span>
<span class="lineno">1531 </span>
<span class="lineno">1532 </span>    <span class="k">return</span> <span class="n">load_scene_json</span><span class="p">(</span> <span class="n">load_file</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">variable_doesnt_matter</span><span class="p">)</span> <span class="p">);</span> <span class="c1">//TODO: put data</span>
<span class="lineno">1533 </span><span class="p">}</span>
<span class="lineno">1534 </span>
<span class="lineno">1535 </span>
<span class="lineno">1536 </span><span class="cm">/************/</span>
<span class="lineno">1537 </span><span class="cm">/* os_abs.c */</span>
<span class="lineno">1538 </span><span class="cm">/************/</span>
<span class="lineno">1539 </span><span class="cp">#include</span> <span class="cpf">&lt;os_abs.h&gt;</span><span class="cp"></span>
<span class="lineno">1540 </span>
<span class="lineno">1541 </span><span class="kt">void</span> <span class="nf">os_start</span><span class="p">(</span><span class="n">os_abs</span> <span class="n">abs</span><span class="p">)</span>
<span class="lineno">1542 </span><span class="p">{</span>
<span class="lineno">1543 </span>    <span class="p">(</span><span class="o">*</span><span class="n">abs</span><span class="p">.</span><span class="n">start_func</span><span class="p">)();</span>
<span class="lineno">1544 </span><span class="p">}</span>
<span class="lineno">1545 </span>
<span class="lineno">1546 </span><span class="kt">void</span> <span class="nf">os_loop_start</span><span class="p">(</span><span class="n">os_abs</span> <span class="n">abs</span><span class="p">)</span>
<span class="lineno">1547 </span><span class="p">{</span>
<span class="lineno">1548 </span>    <span class="p">(</span><span class="o">*</span><span class="n">abs</span><span class="p">.</span><span class="n">loop_start_func</span><span class="p">)();</span>
<span class="lineno">1549 </span><span class="p">}</span>
<span class="lineno">1550 </span>
<span class="lineno">1551 </span><span class="kt">void</span> <span class="nf">os_update</span><span class="p">(</span><span class="n">os_abs</span> <span class="n">abs</span><span class="p">)</span>
<span class="lineno">1552 </span><span class="p">{</span>
<span class="lineno">1553 </span>    <span class="p">(</span><span class="o">*</span><span class="n">abs</span><span class="p">.</span><span class="n">update_func</span><span class="p">)();</span>
<span class="lineno">1554 </span><span class="p">}</span>
<span class="lineno">1555 </span>
<span class="lineno">1556 </span><span class="kt">void</span> <span class="nf">os_sleep</span><span class="p">(</span><span class="n">os_abs</span> <span class="n">abs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num</span><span class="p">)</span>
<span class="lineno">1557 </span><span class="p">{</span>
<span class="lineno">1558 </span>    <span class="p">(</span><span class="o">*</span><span class="n">abs</span><span class="p">.</span><span class="n">sleep_func</span><span class="p">)(</span><span class="n">num</span><span class="p">);</span>
<span class="lineno">1559 </span><span class="p">}</span>
<span class="lineno">1560 </span>
<span class="lineno">1561 </span><span class="kt">void</span><span class="o">*</span> <span class="nf">os_get_bitmap_memory</span><span class="p">(</span><span class="n">os_abs</span> <span class="n">abs</span><span class="p">)</span>
<span class="lineno">1562 </span><span class="p">{</span>
<span class="lineno">1563 </span>    <span class="k">return</span> <span class="p">(</span><span class="o">*</span><span class="n">abs</span><span class="p">.</span><span class="n">get_bitmap_memory_func</span><span class="p">)();</span>
<span class="lineno">1564 </span><span class="p">}</span>
<span class="lineno">1565 </span>
<span class="lineno">1566 </span><span class="kt">int</span> <span class="nf">os_get_time_mili</span><span class="p">(</span><span class="n">os_abs</span> <span class="n">abs</span><span class="p">)</span>
<span class="lineno">1567 </span><span class="p">{</span>
<span class="lineno">1568 </span>    <span class="k">return</span> <span class="p">(</span><span class="o">*</span><span class="n">abs</span><span class="p">.</span><span class="n">get_time_mili_func</span><span class="p">)();</span>
<span class="lineno">1569 </span><span class="p">}</span>
<span class="lineno">1570 </span>
<span class="lineno">1571 </span><span class="kt">int</span> <span class="nf">os_get_width</span><span class="p">(</span><span class="n">os_abs</span> <span class="n">abs</span><span class="p">)</span>
<span class="lineno">1572 </span><span class="p">{</span>
<span class="lineno">1573 </span>    <span class="k">return</span> <span class="p">(</span><span class="o">*</span><span class="n">abs</span><span class="p">.</span><span class="n">get_width_func</span><span class="p">)();</span>
<span class="lineno">1574 </span><span class="p">}</span>
<span class="lineno">1575 </span>
<span class="lineno">1576 </span><span class="kt">int</span> <span class="nf">os_get_height</span><span class="p">(</span><span class="n">os_abs</span> <span class="n">abs</span><span class="p">)</span>
<span class="lineno">1577 </span><span class="p">{</span>
<span class="lineno">1578 </span>    <span class="k">return</span> <span class="p">(</span><span class="o">*</span><span class="n">abs</span><span class="p">.</span><span class="n">get_height_func</span><span class="p">)();</span>
<span class="lineno">1579 </span><span class="p">}</span>
<span class="lineno">1580 </span>
<span class="lineno">1581 </span><span class="kt">void</span> <span class="nf">os_start_thread</span><span class="p">(</span><span class="n">os_abs</span> <span class="n">abs</span><span class="p">,</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">func</span><span class="p">)(</span><span class="kt">void</span><span class="o">*</span><span class="p">),</span> <span class="kt">void</span><span class="o">*</span> <span class="n">data</span><span class="p">)</span>
<span class="lineno">1582 </span><span class="p">{</span>
<span class="lineno">1583 </span>    <span class="p">(</span><span class="o">*</span><span class="n">abs</span><span class="p">.</span><span class="n">start_thread_func</span><span class="p">)(</span><span class="n">func</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<span class="lineno">1584 </span><span class="p">}</span>
<span class="lineno">1585 </span>
<span class="lineno">1586 </span><span class="cm">/**************/</span>
<span class="lineno">1587 </span><span class="cm">/* parallel.c */</span>
<span class="lineno">1588 </span><span class="cm">/**************/</span>
<span class="lineno">1589 </span><span class="cp">#include</span> <span class="cpf">&lt;CL/opencl.h&gt;</span><span class="cp"></span>
<span class="lineno">1590 </span><span class="cp">#include</span> <span class="cpf">&lt;raytracer.h&gt;</span><span class="cp"></span>
<span class="lineno">1591 </span><span class="c1">//Parallel util.</span>
<span class="lineno">1592 </span>
<span class="lineno">1593 </span><span class="kt">void</span> <span class="nf">cl_info</span><span class="p">()</span>
<span class="lineno">1594 </span><span class="p">{</span>
<span class="lineno">1595 </span>
<span class="lineno">1596 </span>    <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
<span class="lineno">1597 </span>    <span class="kt">char</span><span class="o">*</span> <span class="n">value</span><span class="p">;</span>
<span class="lineno">1598 </span>    <span class="kt">size_t</span> <span class="n">valueSize</span><span class="p">;</span>
<span class="lineno">1599 </span>    <span class="n">cl_uint</span> <span class="n">platformCount</span><span class="p">;</span>
<span class="lineno">1600 </span>    <span class="n">cl_platform_id</span><span class="o">*</span> <span class="n">platforms</span><span class="p">;</span>
<span class="lineno">1601 </span>    <span class="n">cl_uint</span> <span class="n">deviceCount</span><span class="p">;</span>
<span class="lineno">1602 </span>    <span class="n">cl_device_id</span><span class="o">*</span> <span class="n">devices</span><span class="p">;</span>
<span class="lineno">1603 </span>    <span class="n">cl_uint</span> <span class="n">maxComputeUnits</span><span class="p">;</span>
<span class="lineno">1604 </span>
<span class="lineno">1605 </span>    <span class="c1">// get all platforms</span>
<span class="lineno">1606 </span>    <span class="n">clGetPlatformIDs</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">platformCount</span><span class="p">);</span>
<span class="lineno">1607 </span>    <span class="n">platforms</span> <span class="o">=</span> <span class="p">(</span><span class="n">cl_platform_id</span><span class="o">*</span><span class="p">)</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">cl_platform_id</span><span class="p">)</span> <span class="o">*</span> <span class="n">platformCount</span><span class="p">);</span>
<span class="lineno">1608 </span>    <span class="n">clGetPlatformIDs</span><span class="p">(</span><span class="n">platformCount</span><span class="p">,</span> <span class="n">platforms</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="lineno">1609 </span>
<span class="lineno">1610 </span>    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">platformCount</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">1611 </span>
<span class="lineno">1612 </span>        <span class="c1">// get all devices</span>
<span class="lineno">1613 </span>        <span class="n">clGetDeviceIDs</span><span class="p">(</span><span class="n">platforms</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">CL_DEVICE_TYPE_ALL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">deviceCount</span><span class="p">);</span>
<span class="lineno">1614 </span>        <span class="n">devices</span> <span class="o">=</span> <span class="p">(</span><span class="n">cl_device_id</span><span class="o">*</span><span class="p">)</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">cl_device_id</span><span class="p">)</span> <span class="o">*</span> <span class="n">deviceCount</span><span class="p">);</span>
<span class="lineno">1615 </span>        <span class="n">clGetDeviceIDs</span><span class="p">(</span><span class="n">platforms</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">CL_DEVICE_TYPE_ALL</span><span class="p">,</span> <span class="n">deviceCount</span><span class="p">,</span> <span class="n">devices</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="lineno">1616 </span>
<span class="lineno">1617 </span>        <span class="c1">// for each device print critical attributes</span>
<span class="lineno">1618 </span>        <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">deviceCount</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">1619 </span>
<span class="lineno">1620 </span>            <span class="c1">// print device name</span>
<span class="lineno">1621 </span>            <span class="n">clGetDeviceInfo</span><span class="p">(</span><span class="n">devices</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">CL_DEVICE_NAME</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">valueSize</span><span class="p">);</span>
<span class="lineno">1622 </span>            <span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span> <span class="n">malloc</span><span class="p">(</span><span class="n">valueSize</span><span class="p">);</span>
<span class="lineno">1623 </span>            <span class="n">clGetDeviceInfo</span><span class="p">(</span><span class="n">devices</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">CL_DEVICE_NAME</span><span class="p">,</span> <span class="n">valueSize</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="lineno">1624 </span>            <span class="n">printf</span><span class="p">(</span><span class="s">"%i.%d. Device: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="lineno">1625 </span>            <span class="n">free</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
<span class="lineno">1626 </span>
<span class="lineno">1627 </span>            <span class="c1">// print hardware device version</span>
<span class="lineno">1628 </span>            <span class="n">clGetDeviceInfo</span><span class="p">(</span><span class="n">devices</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">CL_DEVICE_VERSION</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">valueSize</span><span class="p">);</span>
<span class="lineno">1629 </span>            <span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span> <span class="n">malloc</span><span class="p">(</span><span class="n">valueSize</span><span class="p">);</span>
<span class="lineno">1630 </span>            <span class="n">clGetDeviceInfo</span><span class="p">(</span><span class="n">devices</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">CL_DEVICE_VERSION</span><span class="p">,</span> <span class="n">valueSize</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="lineno">1631 </span>            <span class="n">printf</span><span class="p">(</span><span class="s">" %i.%d.%d Hardware version: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="lineno">1632 </span>            <span class="n">free</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
<span class="lineno">1633 </span>
<span class="lineno">1634 </span>            <span class="c1">// print software driver version</span>
<span class="lineno">1635 </span>            <span class="n">clGetDeviceInfo</span><span class="p">(</span><span class="n">devices</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">CL_DRIVER_VERSION</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">valueSize</span><span class="p">);</span>
<span class="lineno">1636 </span>            <span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span> <span class="n">malloc</span><span class="p">(</span><span class="n">valueSize</span><span class="p">);</span>
<span class="lineno">1637 </span>            <span class="n">clGetDeviceInfo</span><span class="p">(</span><span class="n">devices</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">CL_DRIVER_VERSION</span><span class="p">,</span> <span class="n">valueSize</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="lineno">1638 </span>            <span class="n">printf</span><span class="p">(</span><span class="s">" %i.%d.%d Software version: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="lineno">1639 </span>            <span class="n">free</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
<span class="lineno">1640 </span>
<span class="lineno">1641 </span>            <span class="c1">// print c version supported by compiler for device</span>
<span class="lineno">1642 </span>            <span class="n">clGetDeviceInfo</span><span class="p">(</span><span class="n">devices</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">CL_DEVICE_OPENCL_C_VERSION</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">valueSize</span><span class="p">);</span>
<span class="lineno">1643 </span>            <span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span> <span class="n">malloc</span><span class="p">(</span><span class="n">valueSize</span><span class="p">);</span>
<span class="lineno">1644 </span>            <span class="n">clGetDeviceInfo</span><span class="p">(</span><span class="n">devices</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">CL_DEVICE_OPENCL_C_VERSION</span><span class="p">,</span> <span class="n">valueSize</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="lineno">1645 </span>            <span class="n">printf</span><span class="p">(</span><span class="s">" %i.%d.%d OpenCL C version: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="lineno">1646 </span>            <span class="n">free</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
<span class="lineno">1647 </span>
<span class="lineno">1648 </span>            <span class="c1">// print parallel compute units</span>
<span class="lineno">1649 </span>            <span class="n">clGetDeviceInfo</span><span class="p">(</span><span class="n">devices</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">CL_DEVICE_MAX_COMPUTE_UNITS</span><span class="p">,</span>
<span class="lineno">1650 </span>                    <span class="k">sizeof</span><span class="p">(</span><span class="n">maxComputeUnits</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">maxComputeUnits</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="lineno">1651 </span>            <span class="n">printf</span><span class="p">(</span><span class="s">" %i.%d.%d Parallel compute units: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>  <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">maxComputeUnits</span><span class="p">);</span>
<span class="lineno">1652 </span>
<span class="lineno">1653 </span>        <span class="p">}</span>
<span class="lineno">1654 </span>
<span class="lineno">1655 </span>        <span class="n">free</span><span class="p">(</span><span class="n">devices</span><span class="p">);</span>
<span class="lineno">1656 </span>
<span class="lineno">1657 </span>    <span class="p">}</span>
<span class="lineno">1658 </span>    <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="lineno">1659 </span>    <span class="n">free</span><span class="p">(</span><span class="n">platforms</span><span class="p">);</span>
<span class="lineno">1660 </span>    <span class="k">return</span><span class="p">;</span>
<span class="lineno">1661 </span><span class="p">}</span>
<span class="lineno">1662 </span><span class="kt">void</span> <span class="nf">pfn_notify</span> <span class="p">(</span>
<span class="lineno">1663 </span>    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">errinfo</span><span class="p">,</span>
<span class="lineno">1664 </span>    <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">private_info</span><span class="p">,</span>
<span class="lineno">1665 </span>    <span class="kt">size_t</span> <span class="n">cb</span><span class="p">,</span>
<span class="lineno">1666 </span>    <span class="kt">void</span> <span class="o">*</span><span class="n">user_data</span><span class="p">)</span>
<span class="lineno">1667 </span><span class="p">{</span>
<span class="lineno">1668 </span>    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"</span><span class="se">\n</span><span class="s">--</span><span class="se">\n</span><span class="s">OpenCL ERROR: %s</span><span class="se">\n</span><span class="s">--</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">errinfo</span><span class="p">);</span>
<span class="lineno">1669 </span>    <span class="n">fflush</span><span class="p">(</span><span class="n">stderr</span><span class="p">);</span>
<span class="lineno">1670 </span><span class="p">}</span>
<span class="lineno">1671 </span><span class="kt">void</span> <span class="nf">create_context</span><span class="p">(</span><span class="n">rcl_ctx</span><span class="o">*</span> <span class="n">ctx</span><span class="p">)</span>
<span class="lineno">1672 </span><span class="p">{</span>
<span class="lineno">1673 </span>    <span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">CL_SUCCESS</span><span class="p">;</span>
<span class="lineno">1674 </span>
<span class="lineno">1675 </span>
<span class="lineno">1676 </span>    <span class="kt">int</span> <span class="n">num_of_platforms</span><span class="p">;</span>
<span class="lineno">1677 </span>
<span class="lineno">1678 </span>    <span class="k">if</span> <span class="p">(</span><span class="n">clGetPlatformIDs</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">num_of_platforms</span><span class="p">)</span> <span class="o">!=</span> <span class="n">CL_SUCCESS</span><span class="p">)</span>
<span class="lineno">1679 </span>    <span class="p">{</span>
<span class="lineno">1680 </span>        <span class="n">printf</span><span class="p">(</span><span class="s">"Error: Unable to get platform_id</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="lineno">1681 </span>        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="lineno">1682 </span>    <span class="p">}</span>
<span class="lineno">1683 </span>    <span class="n">cl_platform_id</span> <span class="o">*</span><span class="n">platform_ids</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">num_of_platforms</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">cl_platform_id</span><span class="p">));</span>
<span class="lineno">1684 </span>    <span class="k">if</span> <span class="p">(</span><span class="n">clGetPlatformIDs</span><span class="p">(</span><span class="n">num_of_platforms</span><span class="p">,</span> <span class="n">platform_ids</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">!=</span> <span class="n">CL_SUCCESS</span><span class="p">)</span>
<span class="lineno">1685 </span>    <span class="p">{</span>
<span class="lineno">1686 </span>        <span class="n">printf</span><span class="p">(</span><span class="s">"Error: Unable to get platform_id</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="lineno">1687 </span>        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="lineno">1688 </span>    <span class="p">}</span>
<span class="lineno">1689 </span>    <span class="kt">bool</span> <span class="n">found</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="lineno">1690 </span>    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">num_of_platforms</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="lineno">1691 </span>        <span class="k">if</span><span class="p">(</span><span class="n">clGetDeviceIDs</span><span class="p">(</span><span class="n">platform_ids</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">CL_DEVICE_TYPE_GPU</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">device_id</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">==</span> <span class="n">CL_SUCCESS</span><span class="p">)</span>
<span class="lineno">1692 </span>        <span class="p">{</span>
<span class="lineno">1693 </span>            <span class="n">found</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="lineno">1694 </span>            <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">platform_id</span> <span class="o">=</span> <span class="n">platform_ids</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="lineno">1695 </span>
<span class="lineno">1696 </span>            <span class="k">break</span><span class="p">;</span>
<span class="lineno">1697 </span>        <span class="p">}</span>
<span class="lineno">1698 </span>    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="p">){</span>
<span class="lineno">1699 </span>        <span class="n">printf</span><span class="p">(</span><span class="s">"Error: Unable to get a GPU device_id</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="lineno">1700 </span>        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="lineno">1701 </span>    <span class="p">}</span>
<span class="lineno">1702 </span>
<span class="lineno">1703 </span>
<span class="lineno">1704 </span>    <span class="c1">// Create a compute context</span>
<span class="lineno">1705 </span>    <span class="c1">//</span>
<span class="lineno">1706 </span>    <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">context</span> <span class="o">=</span> <span class="n">clCreateContext</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">device_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pfn_notify</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
<span class="lineno">1707 </span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">)</span>
<span class="lineno">1708 </span>    <span class="p">{</span>
<span class="lineno">1709 </span>        <span class="n">printf</span><span class="p">(</span><span class="s">"Error: Failed to create a compute context!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="lineno">1710 </span>        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="lineno">1711 </span>    <span class="p">}</span>
<span class="lineno">1712 </span>
<span class="lineno">1713 </span>    <span class="c1">// Create a command commands</span>
<span class="lineno">1714 </span>    <span class="c1">//</span>
<span class="lineno">1715 </span>    <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">commands</span> <span class="o">=</span> <span class="n">clCreateCommandQueue</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">device_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
<span class="lineno">1716 </span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">commands</span><span class="p">)</span>
<span class="lineno">1717 </span>    <span class="p">{</span>
<span class="lineno">1718 </span>        <span class="n">printf</span><span class="p">(</span><span class="s">"Error: Failed to create a command commands!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="lineno">1719 </span>        <span class="k">return</span><span class="p">;</span>
<span class="lineno">1720 </span>    <span class="p">}</span>
<span class="lineno">1721 </span>    <span class="n">ASRT_CL</span><span class="p">(</span><span class="s">"Failed to Initialise OpenCL"</span><span class="p">);</span>
<span class="lineno">1722 </span>
<span class="lineno">1723 </span>
<span class="lineno">1724 </span><span class="p">}</span>
<span class="lineno">1725 </span>
<span class="lineno">1726 </span><span class="n">cl_mem</span> <span class="nf">gen_rgb_image</span><span class="p">(</span><span class="n">raytracer_context</span><span class="o">*</span> <span class="n">rctx</span><span class="p">,</span>
<span class="lineno">1727 </span>                     <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">width</span><span class="p">,</span>
<span class="lineno">1728 </span>                     <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">height</span><span class="p">)</span>
<span class="lineno">1729 </span><span class="p">{</span>
<span class="lineno">1730 </span>    <span class="n">cl_image_desc</span> <span class="n">cl_standard_descriptor</span><span class="p">;</span>
<span class="lineno">1731 </span>    <span class="n">cl_image_format</span>     <span class="n">cl_standard_format</span><span class="p">;</span>
<span class="lineno">1732 </span>    <span class="n">cl_standard_format</span><span class="p">.</span><span class="n">image_channel_order</span>     <span class="o">=</span> <span class="n">CL_RGBA</span><span class="p">;</span>
<span class="lineno">1733 </span>    <span class="n">cl_standard_format</span><span class="p">.</span><span class="n">image_channel_data_type</span> <span class="o">=</span> <span class="n">CL_FLOAT</span><span class="p">;</span>
<span class="lineno">1734 </span>
<span class="lineno">1735 </span>    <span class="n">cl_standard_descriptor</span><span class="p">.</span><span class="n">image_type</span> <span class="o">=</span> <span class="n">CL_MEM_OBJECT_IMAGE2D</span><span class="p">;</span>
<span class="lineno">1736 </span>    <span class="n">cl_standard_descriptor</span><span class="p">.</span><span class="n">image_width</span> <span class="o">=</span> <span class="n">width</span><span class="o">==</span><span class="mi">0</span>  <span class="o">?</span> <span class="n">rctx</span><span class="o">-&gt;</span><span class="nl">width</span>  <span class="p">:</span> <span class="n">width</span><span class="p">;</span>
<span class="lineno">1737 </span>    <span class="n">cl_standard_descriptor</span><span class="p">.</span><span class="n">image_height</span> <span class="o">=</span> <span class="n">height</span><span class="o">==</span><span class="mi">0</span> <span class="o">?</span> <span class="n">rctx</span><span class="o">-&gt;</span><span class="nl">height</span> <span class="p">:</span> <span class="n">height</span><span class="p">;</span>
<span class="lineno">1738 </span>    <span class="n">cl_standard_descriptor</span><span class="p">.</span><span class="n">image_depth</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno">1739 </span>    <span class="n">cl_standard_descriptor</span><span class="p">.</span><span class="n">image_array_size</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno">1740 </span>    <span class="n">cl_standard_descriptor</span><span class="p">.</span><span class="n">image_row_pitch</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno">1741 </span>    <span class="n">cl_standard_descriptor</span><span class="p">.</span><span class="n">num_mip_levels</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno">1742 </span>    <span class="n">cl_standard_descriptor</span><span class="p">.</span><span class="n">num_samples</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno">1743 </span>    <span class="n">cl_standard_descriptor</span><span class="p">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="lineno">1744 </span>
<span class="lineno">1745 </span>    <span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
<span class="lineno">1746 </span>
<span class="lineno">1747 </span>    <span class="n">cl_mem</span> <span class="n">img</span> <span class="o">=</span> <span class="n">clCreateImage</span><span class="p">(</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">rcl</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">,</span>
<span class="lineno">1748 </span>                                <span class="n">CL_MEM_READ_WRITE</span><span class="p">,</span>
<span class="lineno">1749 </span>                                <span class="o">&amp;</span><span class="n">cl_standard_format</span><span class="p">,</span>
<span class="lineno">1750 </span>                               <span class="o">&amp;</span><span class="n">cl_standard_descriptor</span><span class="p">,</span>
<span class="lineno">1751 </span>                                <span class="nb">NULL</span><span class="p">,</span>
<span class="lineno">1752 </span>                                <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
<span class="lineno">1753 </span>    <span class="n">ASRT_CL</span><span class="p">(</span><span class="s">"Couldn't Create OpenCL Texture"</span><span class="p">);</span>
<span class="lineno">1754 </span>    <span class="k">return</span> <span class="n">img</span><span class="p">;</span>
<span class="lineno">1755 </span><span class="p">}</span>
<span class="lineno">1756 </span><span class="n">cl_mem</span> <span class="nf">gen_1d_image</span><span class="p">(</span><span class="n">raytracer_context</span><span class="o">*</span> <span class="n">rctx</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">t</span><span class="p">,</span> <span class="kt">void</span><span class="o">*</span> <span class="n">ptr</span><span class="p">)</span>
<span class="lineno">1757 </span><span class="p">{</span>
<span class="lineno">1758 </span>
<span class="lineno">1759 </span>    <span class="n">cl_image_desc</span> <span class="n">cl_standard_descriptor</span><span class="p">;</span>
<span class="lineno">1760 </span>    <span class="n">cl_image_format</span>     <span class="n">cl_standard_format</span><span class="p">;</span>
<span class="lineno">1761 </span>    <span class="n">cl_standard_format</span><span class="p">.</span><span class="n">image_channel_order</span>     <span class="o">=</span> <span class="n">CL_RGBA</span><span class="p">;</span>
<span class="lineno">1762 </span>    <span class="n">cl_standard_format</span><span class="p">.</span><span class="n">image_channel_data_type</span> <span class="o">=</span> <span class="n">CL_FLOAT</span><span class="p">;</span>
<span class="lineno">1763 </span>
<span class="lineno">1764 </span>    <span class="n">cl_standard_descriptor</span><span class="p">.</span><span class="n">image_type</span> <span class="o">=</span> <span class="n">CL_MEM_OBJECT_IMAGE1D</span><span class="p">;</span>
<span class="lineno">1765 </span>    <span class="n">cl_standard_descriptor</span><span class="p">.</span><span class="n">image_width</span> <span class="o">=</span> <span class="n">t</span><span class="o">/</span><span class="mi">4</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="n">t</span><span class="o">/</span><span class="mi">4</span><span class="p">;</span>
<span class="lineno">1766 </span>    <span class="n">cl_standard_descriptor</span><span class="p">.</span><span class="n">image_height</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno">1767 </span>    <span class="n">cl_standard_descriptor</span><span class="p">.</span><span class="n">image_depth</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno">1768 </span>    <span class="n">cl_standard_descriptor</span><span class="p">.</span><span class="n">image_array_size</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno">1769 </span>    <span class="n">cl_standard_descriptor</span><span class="p">.</span><span class="n">image_row_pitch</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno">1770 </span>    <span class="n">cl_standard_descriptor</span><span class="p">.</span><span class="n">num_mip_levels</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno">1771 </span>    <span class="n">cl_standard_descriptor</span><span class="p">.</span><span class="n">num_samples</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno">1772 </span>    <span class="n">cl_standard_descriptor</span><span class="p">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="lineno">1773 </span>
<span class="lineno">1774 </span>    <span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
<span class="lineno">1775 </span>
<span class="lineno">1776 </span>
<span class="lineno">1777 </span>    <span class="n">cl_mem</span> <span class="n">img</span> <span class="o">=</span> <span class="n">clCreateImage</span><span class="p">(</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">rcl</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">,</span>
<span class="lineno">1778 </span>                               <span class="n">CL_MEM_READ_WRITE</span> <span class="o">|</span> <span class="p">(</span><span class="cm">/*ptr == NULL ? 0 :*/</span> <span class="n">CL_MEM_COPY_HOST_PTR</span><span class="p">),</span>
<span class="lineno">1779 </span>                               <span class="o">&amp;</span><span class="n">cl_standard_format</span><span class="p">,</span>
<span class="lineno">1780 </span>                               <span class="o">&amp;</span><span class="n">cl_standard_descriptor</span><span class="p">,</span>
<span class="lineno">1781 </span>                               <span class="n">ptr</span><span class="p">,</span>
<span class="lineno">1782 </span>                               <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
<span class="lineno">1783 </span>    <span class="n">ASRT_CL</span><span class="p">(</span><span class="s">"Couldn't Create OpenCL Texture"</span><span class="p">);</span>
<span class="lineno">1784 </span>    <span class="k">return</span> <span class="n">img</span><span class="p">;</span>
<span class="lineno">1785 </span><span class="p">}</span>
<span class="lineno">1786 </span><span class="n">cl_mem</span> <span class="nf">gen_grayscale_buffer</span><span class="p">(</span><span class="n">raytracer_context</span><span class="o">*</span> <span class="n">rctx</span><span class="p">,</span>
<span class="lineno">1787 </span>                            <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">width</span><span class="p">,</span>
<span class="lineno">1788 </span>                            <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">height</span><span class="p">)</span>
<span class="lineno">1789 </span><span class="p">{</span>
<span class="lineno">1790 </span>    <span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
<span class="lineno">1791 </span>
<span class="lineno">1792 </span>    <span class="n">cl_mem</span> <span class="n">buf</span> <span class="o">=</span> <span class="n">clCreateBuffer</span><span class="p">(</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">rcl</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">,</span> <span class="n">CL_MEM_READ_WRITE</span><span class="p">,</span>
<span class="lineno">1793 </span>                                 <span class="p">(</span><span class="n">width</span><span class="o">==</span><span class="mi">0</span>  <span class="o">?</span> <span class="n">rctx</span><span class="o">-&gt;</span><span class="nl">width</span>  <span class="p">:</span> <span class="n">width</span><span class="p">)</span><span class="o">*</span>
<span class="lineno">1794 </span>                                 <span class="p">(</span><span class="n">height</span><span class="o">==</span><span class="mi">0</span> <span class="o">?</span> <span class="n">rctx</span><span class="o">-&gt;</span><span class="nl">height</span> <span class="p">:</span> <span class="n">height</span><span class="p">)</span><span class="o">*</span>
<span class="lineno">1795 </span>                                 <span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">),</span>
<span class="lineno">1796 </span>                                 <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
<span class="lineno">1797 </span>    <span class="n">ASRT_CL</span><span class="p">(</span><span class="s">"Couldn't Create OpenCL Float Buffer Image"</span><span class="p">);</span>
<span class="lineno">1798 </span>    <span class="k">return</span> <span class="n">buf</span><span class="p">;</span>
<span class="lineno">1799 </span><span class="p">}</span>
<span class="lineno">1800 </span>
<span class="lineno">1801 </span><span class="kt">void</span> <span class="nf">retrieve_image</span><span class="p">(</span><span class="n">raytracer_context</span><span class="o">*</span> <span class="n">rctx</span><span class="p">,</span> <span class="n">cl_mem</span> <span class="n">g_buf</span><span class="p">,</span> <span class="kt">void</span><span class="o">*</span> <span class="n">c_buf</span><span class="p">,</span>
<span class="lineno">1802 </span>                    <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">width</span><span class="p">,</span>
<span class="lineno">1803 </span>                    <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">height</span><span class="p">)</span>
<span class="lineno">1804 </span><span class="p">{</span>
<span class="lineno">1805 </span>    <span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
<span class="lineno">1806 </span>    <span class="kt">size_t</span> <span class="n">origin</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">};</span>
<span class="lineno">1807 </span>    <span class="kt">size_t</span> <span class="n">region</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{(</span><span class="n">width</span><span class="o">==</span><span class="mi">0</span> <span class="o">?</span> <span class="n">rctx</span><span class="o">-&gt;</span><span class="nl">width</span> <span class="p">:</span> <span class="n">width</span><span class="p">),</span>
<span class="lineno">1808 </span>                        <span class="p">(</span><span class="n">height</span><span class="o">==</span><span class="mi">0</span> <span class="o">?</span> <span class="n">rctx</span><span class="o">-&gt;</span><span class="nl">height</span> <span class="p">:</span> <span class="n">height</span><span class="p">),</span>
<span class="lineno">1809 </span>                        <span class="mi">1</span><span class="p">};</span>
<span class="lineno">1810 </span>    <span class="n">err</span> <span class="o">=</span> <span class="n">clEnqueueReadImage</span> <span class="p">(</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">rcl</span><span class="o">-&gt;</span><span class="n">commands</span><span class="p">,</span>
<span class="lineno">1811 </span>                              <span class="n">g_buf</span><span class="p">,</span>
<span class="lineno">1812 </span>                              <span class="n">CL_TRUE</span><span class="p">,</span>
<span class="lineno">1813 </span>                              <span class="n">origin</span><span class="p">,</span>
<span class="lineno">1814 </span>                              <span class="n">region</span><span class="p">,</span>
<span class="lineno">1815 </span>                              <span class="mi">0</span><span class="p">,</span>
<span class="lineno">1816 </span>                              <span class="mi">0</span><span class="p">,</span>
<span class="lineno">1817 </span>                              <span class="n">c_buf</span><span class="p">,</span>
<span class="lineno">1818 </span>                              <span class="mi">0</span><span class="p">,</span>
<span class="lineno">1819 </span>                              <span class="mi">0</span><span class="p">,</span>
<span class="lineno">1820 </span>                              <span class="nb">NULL</span><span class="p">);</span>
<span class="lineno">1821 </span>    <span class="n">ASRT_CL</span><span class="p">(</span><span class="s">"Failed to retrieve Opencl Image"</span><span class="p">);</span>
<span class="lineno">1822 </span><span class="p">}</span>
<span class="lineno">1823 </span>
<span class="lineno">1824 </span><span class="kt">void</span> <span class="nf">retrieve_buf</span><span class="p">(</span><span class="n">raytracer_context</span><span class="o">*</span> <span class="n">rctx</span><span class="p">,</span> <span class="n">cl_mem</span> <span class="n">g_buf</span><span class="p">,</span> <span class="kt">void</span><span class="o">*</span> <span class="n">c_buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="lineno">1825 </span><span class="p">{</span>
<span class="lineno">1826 </span>    <span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
<span class="lineno">1827 </span>    <span class="n">err</span> <span class="o">=</span> <span class="n">clEnqueueReadBuffer</span><span class="p">(</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">rcl</span><span class="o">-&gt;</span><span class="n">commands</span><span class="p">,</span> <span class="n">g_buf</span><span class="p">,</span> <span class="n">CL_TRUE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
<span class="lineno">1828 </span>                              <span class="n">size</span><span class="p">,</span> <span class="n">c_buf</span><span class="p">,</span>
<span class="lineno">1829 </span>                              <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">);</span>
<span class="lineno">1830 </span>    <span class="n">ASRT_CL</span><span class="p">(</span><span class="s">"Failed to retrieve Opencl Buffer"</span><span class="p">);</span>
<span class="lineno">1831 </span><span class="p">}</span>
<span class="lineno">1832 </span>
<span class="lineno">1833 </span><span class="kt">void</span> <span class="nf">zero_buffer</span><span class="p">(</span><span class="n">raytracer_context</span><span class="o">*</span> <span class="n">rctx</span><span class="p">,</span> <span class="n">cl_mem</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="lineno">1834 </span><span class="p">{</span>
<span class="lineno">1835 </span>    <span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
<span class="lineno">1836 </span>    <span class="kt">char</span> <span class="n">pattern</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno">1837 </span>    <span class="n">err</span> <span class="o">=</span>  <span class="n">clEnqueueFillBuffer</span> <span class="p">(</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">rcl</span><span class="o">-&gt;</span><span class="n">commands</span><span class="p">,</span>
<span class="lineno">1838 </span>                                <span class="n">buf</span><span class="p">,</span>
<span class="lineno">1839 </span>                                <span class="o">&amp;</span><span class="n">pattern</span><span class="p">,</span> <span class="mi">1</span> <span class="p">,</span><span class="mi">0</span><span class="p">,</span>
<span class="lineno">1840 </span>                                <span class="n">size</span><span class="p">,</span>
<span class="lineno">1841 </span>                                <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="lineno">1842 </span>    <span class="n">ASRT_CL</span><span class="p">(</span><span class="s">"Couldn't Zero OpenCL Buffer"</span><span class="p">);</span>
<span class="lineno">1843 </span><span class="p">}</span>
<span class="lineno">1844 </span><span class="kt">void</span> <span class="nf">zero_buffer_img</span><span class="p">(</span><span class="n">raytracer_context</span><span class="o">*</span> <span class="n">rctx</span><span class="p">,</span> <span class="n">cl_mem</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">element</span><span class="p">,</span>
<span class="lineno">1845 </span>                 <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">width</span><span class="p">,</span>
<span class="lineno">1846 </span>                 <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">height</span><span class="p">)</span>
<span class="lineno">1847 </span><span class="p">{</span>
<span class="lineno">1848 </span>    <span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
<span class="lineno">1849 </span>
<span class="lineno">1850 </span>    <span class="kt">char</span> <span class="n">pattern</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno">1851 </span>    <span class="n">err</span> <span class="o">=</span>  <span class="n">clEnqueueFillBuffer</span> <span class="p">(</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">rcl</span><span class="o">-&gt;</span><span class="n">commands</span><span class="p">,</span>
<span class="lineno">1852 </span>                                <span class="n">buf</span><span class="p">,</span>
<span class="lineno">1853 </span>                                <span class="o">&amp;</span><span class="n">pattern</span><span class="p">,</span> <span class="mi">1</span> <span class="p">,</span><span class="mi">0</span><span class="p">,</span>
<span class="lineno">1854 </span>                                <span class="p">(</span><span class="n">width</span><span class="o">==</span><span class="mi">0</span>  <span class="o">?</span> <span class="n">rctx</span><span class="o">-&gt;</span><span class="nl">width</span>  <span class="p">:</span> <span class="n">width</span><span class="p">)</span><span class="o">*</span>
<span class="lineno">1855 </span>                                <span class="p">(</span><span class="n">height</span><span class="o">==</span><span class="mi">0</span> <span class="o">?</span> <span class="n">rctx</span><span class="o">-&gt;</span><span class="nl">height</span> <span class="p">:</span> <span class="n">height</span><span class="p">)</span><span class="o">*</span>
<span class="lineno">1856 </span>                                <span class="n">element</span><span class="p">,</span>
<span class="lineno">1857 </span>                                <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="lineno">1858 </span>    <span class="n">ASRT_CL</span><span class="p">(</span><span class="s">"Couldn't Zero OpenCL Buffer"</span><span class="p">);</span>
<span class="lineno">1859 </span><span class="p">}</span>
<span class="lineno">1860 </span><span class="kt">size_t</span> <span class="nf">get_workgroup_size</span><span class="p">(</span><span class="n">raytracer_context</span><span class="o">*</span> <span class="n">rctx</span><span class="p">,</span> <span class="n">cl_kernel</span> <span class="n">kernel</span><span class="p">)</span>
<span class="lineno">1861 </span><span class="p">{</span>
<span class="lineno">1862 </span>    <span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
<span class="lineno">1863 </span>    <span class="kt">size_t</span> <span class="n">local</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno">1864 </span>    <span class="n">err</span> <span class="o">=</span> <span class="n">clGetKernelWorkGroupInfo</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">rcl</span><span class="o">-&gt;</span><span class="n">device_id</span><span class="p">,</span>
<span class="lineno">1865 </span>                                   <span class="n">CL_KERNEL_WORK_GROUP_SIZE</span><span class="p">,</span>
<span class="lineno">1866 </span>                                   <span class="k">sizeof</span><span class="p">(</span><span class="n">local</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">local</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="lineno">1867 </span>    <span class="n">ASRT_CL</span><span class="p">(</span><span class="s">"Failed to Retrieve Kernel Work Group Info"</span><span class="p">);</span>
<span class="lineno">1868 </span>    <span class="k">return</span> <span class="n">local</span><span class="p">;</span>
<span class="lineno">1869 </span><span class="p">}</span>
<span class="lineno">1870 </span>
<span class="lineno">1871 </span>
<span class="lineno">1872 </span><span class="kt">void</span> <span class="nf">load_program_raw</span><span class="p">(</span><span class="n">rcl_ctx</span><span class="o">*</span> <span class="n">ctx</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">data</span><span class="p">,</span>
<span class="lineno">1873 </span>                     <span class="kt">char</span><span class="o">**</span> <span class="n">kernels</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_kernels</span><span class="p">,</span>
<span class="lineno">1874 </span>                      <span class="n">rcl_program</span><span class="o">*</span> <span class="n">program</span><span class="p">,</span> <span class="kt">char</span><span class="o">**</span> <span class="n">macros</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_macros</span><span class="p">)</span>
<span class="lineno">1875 </span><span class="p">{</span>
<span class="lineno">1876 </span>    <span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
<span class="lineno">1877 </span>
<span class="lineno">1878 </span>    <span class="kt">char</span><span class="o">*</span> <span class="n">fin_data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span> <span class="n">malloc</span><span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">data</span><span class="p">));</span>
<span class="lineno">1879 </span>    <span class="n">strcpy</span><span class="p">(</span><span class="n">fin_data</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<span class="lineno">1880 </span>
<span class="lineno">1881 </span>    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_macros</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="lineno">1882 </span>    <span class="p">{</span>
<span class="lineno">1883 </span>        <span class="kt">int</span> <span class="n">length</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">macros</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="lineno">1884 </span>        <span class="kt">char</span><span class="o">*</span> <span class="n">buf</span>  <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span> <span class="n">malloc</span><span class="p">(</span><span class="n">length</span><span class="o">+</span><span class="n">strlen</span><span class="p">(</span><span class="n">fin_data</span><span class="p">)</span><span class="o">+</span><span class="mi">3</span><span class="p">);</span>
<span class="lineno">1885 </span>        <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">"%s</span><span class="se">\n</span><span class="s">%s</span><span class="se">\0</span><span class="s">"</span><span class="p">,</span> <span class="n">macros</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">fin_data</span><span class="p">);</span>
<span class="lineno">1886 </span>        <span class="n">free</span><span class="p">(</span><span class="n">fin_data</span><span class="p">);</span>
<span class="lineno">1887 </span>        <span class="n">fin_data</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
<span class="lineno">1888 </span>    <span class="p">}</span>
<span class="lineno">1889 </span>
<span class="lineno">1890 </span>    <span class="n">program</span><span class="o">-&gt;</span><span class="n">program</span> <span class="o">=</span> <span class="n">clCreateProgramWithSource</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">fin_data</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
<span class="lineno">1891 </span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">program</span><span class="o">-&gt;</span><span class="n">program</span><span class="p">)</span>
<span class="lineno">1892 </span>    <span class="p">{</span>
<span class="lineno">1893 </span>        <span class="n">printf</span><span class="p">(</span><span class="s">"Error: Failed to create compute program!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="lineno">1894 </span>        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="lineno">1895 </span>    <span class="p">}</span>
<span class="lineno">1896 </span>
<span class="lineno">1897 </span>    <span class="c1">// Build the program executable</span>
<span class="lineno">1898 </span>    <span class="c1">//</span>
<span class="lineno">1899 </span>    <span class="n">err</span> <span class="o">=</span> <span class="n">clBuildProgram</span><span class="p">(</span><span class="n">program</span><span class="o">-&gt;</span><span class="n">program</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="lineno">1900 </span>    <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="n">CL_SUCCESS</span><span class="p">)</span>
<span class="lineno">1901 </span>    <span class="p">{</span>
<span class="lineno">1902 </span>        <span class="kt">size_t</span> <span class="n">len</span><span class="p">;</span>
<span class="lineno">1903 </span>        <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">2048</span><span class="o">*</span><span class="mi">256</span><span class="p">];</span>
<span class="lineno">1904 </span>        <span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'!'</span><span class="p">;</span>
<span class="lineno">1905 </span>        <span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
<span class="lineno">1906 </span>
<span class="lineno">1907 </span>
<span class="lineno">1908 </span>        <span class="n">printf</span><span class="p">(</span><span class="s">"Error: Failed to build program executable!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="lineno">1909 </span>        <span class="n">printf</span><span class="p">(</span><span class="s">"KERNEL:</span><span class="se">\n</span><span class="s"> %s</span><span class="se">\n</span><span class="s">program done</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">fin_data</span><span class="p">);</span>
<span class="lineno">1910 </span>        <span class="kt">int</span> <span class="n">n_err</span> <span class="o">=</span> <span class="n">clGetProgramBuildInfo</span><span class="p">(</span><span class="n">program</span><span class="o">-&gt;</span><span class="n">program</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">device_id</span><span class="p">,</span> <span class="n">CL_PROGRAM_BUILD_LOG</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">),</span> <span class="n">buffer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
<span class="lineno">1911 </span>        <span class="k">if</span><span class="p">(</span><span class="n">n_err</span> <span class="o">!=</span> <span class="n">CL_SUCCESS</span><span class="p">)</span>
<span class="lineno">1912 </span>        <span class="p">{</span>
<span class="lineno">1913 </span>            <span class="n">printf</span><span class="p">(</span><span class="s">"The error had an error, I hate this. err:%i</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">n_err</span><span class="p">);</span>
<span class="lineno">1914 </span>        <span class="p">}</span>
<span class="lineno">1915 </span>        <span class="n">printf</span><span class="p">(</span><span class="s">"err code:%i</span><span class="se">\n</span><span class="s"> %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>
<span class="lineno">1916 </span>        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="lineno">1917 </span>    <span class="p">}</span>
<span class="lineno">1918 </span>
<span class="lineno">1919 </span>    <span class="n">program</span><span class="o">-&gt;</span><span class="n">raw_kernels</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">cl_kernel</span><span class="p">)</span><span class="o">*</span><span class="n">num_kernels</span><span class="p">);</span>
<span class="lineno">1920 </span>    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_kernels</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="lineno">1921 </span>    <span class="p">{</span>
<span class="lineno">1922 </span>        <span class="c1">// Create the compute kernel in the program we wish to run</span>
<span class="lineno">1923 </span>        <span class="c1">//</span>
<span class="lineno">1924 </span>
<span class="lineno">1925 </span>        <span class="n">program</span><span class="o">-&gt;</span><span class="n">raw_kernels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">clCreateKernel</span><span class="p">(</span><span class="n">program</span><span class="o">-&gt;</span><span class="n">program</span><span class="p">,</span> <span class="n">kernels</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
<span class="lineno">1926 </span>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">program</span><span class="o">-&gt;</span><span class="n">raw_kernels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">||</span> <span class="n">err</span> <span class="o">!=</span> <span class="n">CL_SUCCESS</span><span class="p">)</span>
<span class="lineno">1927 </span>        <span class="p">{</span>
<span class="lineno">1928 </span>            <span class="n">printf</span><span class="p">(</span><span class="s">"Error: Failed to create compute kernel! %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">kernels</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="lineno">1929 </span>            <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="lineno">1930 </span>        <span class="p">}</span>
<span class="lineno">1931 </span>
<span class="lineno">1932 </span>    <span class="p">}</span>
<span class="lineno">1933 </span>
<span class="lineno">1934 </span>    <span class="n">program</span><span class="o">-&gt;</span><span class="n">raw_data</span> <span class="o">=</span> <span class="n">fin_data</span><span class="p">;</span>
<span class="lineno">1935 </span>
<span class="lineno">1936 </span><span class="p">}</span>
<span class="lineno">1937 </span>
<span class="lineno">1938 </span><span class="kt">void</span> <span class="nf">load_program_url</span><span class="p">(</span><span class="n">rcl_ctx</span><span class="o">*</span> <span class="n">ctx</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">url</span><span class="p">,</span>
<span class="lineno">1939 </span>                     <span class="kt">char</span><span class="o">**</span> <span class="n">kernels</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_kernels</span><span class="p">,</span>
<span class="lineno">1940 </span>                      <span class="n">rcl_program</span><span class="o">*</span> <span class="n">program</span><span class="p">,</span> <span class="kt">char</span><span class="o">**</span> <span class="n">macros</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_macros</span><span class="p">)</span>
<span class="lineno">1941 </span><span class="p">{</span>
<span class="lineno">1942 </span>    <span class="kt">char</span> <span class="o">*</span> <span class="n">buffer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno">1943 </span>    <span class="kt">long</span> <span class="n">length</span><span class="p">;</span>
<span class="lineno">1944 </span>    <span class="kt">FILE</span> <span class="o">*</span> <span class="n">f</span> <span class="o">=</span> <span class="n">fopen</span> <span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="s">"rb"</span><span class="p">);</span>
<span class="lineno">1945 </span>
<span class="lineno">1946 </span>    <span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="lineno">1947 </span>    <span class="p">{</span>
<span class="lineno">1948 </span>        <span class="n">fseek</span> <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SEEK_END</span><span class="p">);</span>
<span class="lineno">1949 </span>        <span class="n">length</span> <span class="o">=</span> <span class="n">ftell</span> <span class="p">(</span><span class="n">f</span><span class="p">);</span>
<span class="lineno">1950 </span>        <span class="n">fseek</span> <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SEEK_SET</span><span class="p">);</span>
<span class="lineno">1951 </span>        <span class="n">buffer</span> <span class="o">=</span> <span class="n">malloc</span> <span class="p">(</span><span class="n">length</span><span class="o">+</span><span class="mi">2</span><span class="p">);</span>
<span class="lineno">1952 </span>        <span class="k">if</span> <span class="p">(</span><span class="n">buffer</span><span class="p">)</span>
<span class="lineno">1953 </span>        <span class="p">{</span>
<span class="lineno">1954 </span>            <span class="n">fread</span> <span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">f</span><span class="p">);</span>
<span class="lineno">1955 </span>        <span class="p">}</span>
<span class="lineno">1956 </span>        <span class="n">fclose</span> <span class="p">(</span><span class="n">f</span><span class="p">);</span>
<span class="lineno">1957 </span>    <span class="p">}</span>
<span class="lineno">1958 </span>    <span class="k">if</span> <span class="p">(</span><span class="n">buffer</span><span class="p">)</span>
<span class="lineno">1959 </span>    <span class="p">{</span>
<span class="lineno">1960 </span>        <span class="n">buffer</span><span class="p">[</span><span class="n">length</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
<span class="lineno">1961 </span>
<span class="lineno">1962 </span>        <span class="n">load_program_raw</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">kernels</span><span class="p">,</span> <span class="n">num_kernels</span><span class="p">,</span> <span class="n">program</span><span class="p">,</span>
<span class="lineno">1963 </span>                         <span class="n">macros</span><span class="p">,</span> <span class="n">num_macros</span><span class="p">);</span>
<span class="lineno">1964 </span>    <span class="p">}</span>
<span class="lineno">1965 </span>
<span class="lineno">1966 </span><span class="p">}</span>
<span class="lineno">1967 </span>
<span class="lineno">1968 </span><span class="c1">//NOTE: old</span>
<span class="lineno">1969 </span><span class="kt">void</span> <span class="nf">test_sphere_raytracer</span><span class="p">(</span><span class="n">rcl_ctx</span><span class="o">*</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">rcl_program</span><span class="o">*</span> <span class="n">program</span><span class="p">,</span>
<span class="lineno">1970 </span>        <span class="n">sphere</span><span class="o">*</span> <span class="n">spheres</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num_spheres</span><span class="p">,</span>
<span class="lineno">1971 </span>        <span class="kt">uint32_t</span><span class="o">*</span> <span class="n">bitmap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="kt">int</span> <span class="n">height</span><span class="p">)</span>
<span class="lineno">1972 </span><span class="p">{</span>
<span class="lineno">1973 </span>    <span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
<span class="lineno">1974 </span>
<span class="lineno">1975 </span>    <span class="k">static</span> <span class="n">cl_mem</span> <span class="n">tex</span><span class="p">;</span>
<span class="lineno">1976 </span>    <span class="k">static</span> <span class="n">cl_mem</span> <span class="n">s_buf</span><span class="p">;</span>
<span class="lineno">1977 </span>    <span class="k">static</span> <span class="kt">bool</span> <span class="n">init</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span> <span class="c1">//temporary</span>
<span class="lineno">1978 </span>
<span class="lineno">1979 </span>    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">init</span><span class="p">)</span>
<span class="lineno">1980 </span>    <span class="p">{</span>
<span class="lineno">1981 </span>        <span class="c1">//New Texture</span>
<span class="lineno">1982 </span>        <span class="n">tex</span> <span class="o">=</span> <span class="n">clCreateBuffer</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">,</span> <span class="n">CL_MEM_WRITE_ONLY</span><span class="p">,</span>
<span class="lineno">1983 </span>                                    <span class="n">width</span><span class="o">*</span><span class="n">height</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
<span class="lineno">1984 </span>
<span class="lineno">1985 </span>        <span class="c1">//Spheres</span>
<span class="lineno">1986 </span>        <span class="n">s_buf</span> <span class="o">=</span> <span class="n">clCreateBuffer</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">,</span> <span class="n">CL_MEM_READ_ONLY</span> <span class="o">|</span> <span class="n">CL_MEM_COPY_HOST_PTR</span><span class="p">,</span>
<span class="lineno">1987 </span>                               <span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="o">*</span><span class="mi">4</span><span class="o">*</span><span class="n">num_spheres</span><span class="p">,</span> <span class="n">spheres</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
<span class="lineno">1988 </span>        <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="n">CL_SUCCESS</span><span class="p">)</span>
<span class="lineno">1989 </span>        <span class="p">{</span>
<span class="lineno">1990 </span>            <span class="n">printf</span><span class="p">(</span><span class="s">"Error: Failed to create Sphere Buffer! %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
<span class="lineno">1991 </span>            <span class="k">return</span><span class="p">;</span>
<span class="lineno">1992 </span>        <span class="p">}</span>
<span class="lineno">1993 </span>        <span class="n">init</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="lineno">1994 </span>    <span class="p">}</span>
<span class="lineno">1995 </span>    <span class="k">else</span>
<span class="lineno">1996 </span>    <span class="p">{</span>
<span class="lineno">1997 </span>        <span class="n">clEnqueueWriteBuffer</span> <span class="p">(</span>    <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">commands</span><span class="p">,</span>
<span class="lineno">1998 </span>                                <span class="n">s_buf</span><span class="p">,</span>
<span class="lineno">1999 </span>                                <span class="n">CL_TRUE</span><span class="p">,</span>
<span class="lineno">2000 </span>                                <span class="mi">0</span><span class="p">,</span>
<span class="lineno">2001 </span>                                <span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="o">*</span><span class="mi">4</span><span class="o">*</span><span class="n">num_spheres</span><span class="p">,</span>
<span class="lineno">2002 </span>                                <span class="n">spheres</span><span class="p">,</span>
<span class="lineno">2003 </span>                                <span class="mi">0</span><span class="p">,</span>
<span class="lineno">2004 </span>                                <span class="nb">NULL</span><span class="p">,</span>
<span class="lineno">2005 </span>                                <span class="nb">NULL</span><span class="p">);</span>
<span class="lineno">2006 </span>    <span class="p">}</span>
<span class="lineno">2007 </span>
<span class="lineno">2008 </span>
<span class="lineno">2009 </span>
<span class="lineno">2010 </span>    <span class="n">cl_kernel</span> <span class="n">kernel</span> <span class="o">=</span> <span class="n">program</span><span class="o">-&gt;</span><span class="n">raw_kernels</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="c1">//just use the first one</span>
<span class="lineno">2011 </span>
<span class="lineno">2012 </span>    <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cl_mem</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">tex</span><span class="p">);</span>
<span class="lineno">2013 </span>    <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cl_mem</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">s_buf</span><span class="p">);</span>
<span class="lineno">2014 </span>    <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">width</span><span class="p">);</span>
<span class="lineno">2015 </span>    <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">height</span><span class="p">);</span>
<span class="lineno">2016 </span>
<span class="lineno">2017 </span>
<span class="lineno">2018 </span>    <span class="kt">size_t</span> <span class="n">global</span><span class="p">;</span>
<span class="lineno">2019 </span>    <span class="kt">size_t</span> <span class="n">local</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno">2020 </span>
<span class="lineno">2021 </span>    <span class="n">err</span> <span class="o">=</span> <span class="n">clGetKernelWorkGroupInfo</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">device_id</span><span class="p">,</span> <span class="n">CL_KERNEL_WORK_GROUP_SIZE</span><span class="p">,</span>
<span class="lineno">2022 </span>        <span class="k">sizeof</span><span class="p">(</span><span class="n">local</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">local</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="lineno">2023 </span>    <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="n">CL_SUCCESS</span><span class="p">)</span>
<span class="lineno">2024 </span>    <span class="p">{</span>
<span class="lineno">2025 </span>        <span class="n">printf</span><span class="p">(</span><span class="s">"Error: Failed to retrieve kernel work group info! %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
<span class="lineno">2026 </span>        <span class="k">return</span><span class="p">;</span>
<span class="lineno">2027 </span>    <span class="p">}</span>
<span class="lineno">2028 </span>
<span class="lineno">2029 </span>    <span class="c1">// Execute the kernel over the entire range of our 1d input data set</span>
<span class="lineno">2030 </span>    <span class="c1">// using the maximum number of work group items for this device</span>
<span class="lineno">2031 </span>    <span class="c1">//</span>
<span class="lineno">2032 </span>    <span class="c1">//printf("STARTING\n");</span>
<span class="lineno">2033 </span>    <span class="n">global</span> <span class="o">=</span>  <span class="n">width</span><span class="o">*</span><span class="n">height</span><span class="p">;</span>
<span class="lineno">2034 </span>    <span class="n">err</span> <span class="o">=</span> <span class="n">clEnqueueNDRangeKernel</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">commands</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">global</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="lineno">2035 </span>    <span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
<span class="lineno">2036 </span>    <span class="p">{</span>
<span class="lineno">2037 </span>        <span class="n">printf</span><span class="p">(</span><span class="s">"Error: Failed to execute kernel! %i</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">err</span><span class="p">);</span>
<span class="lineno">2038 </span>        <span class="k">return</span><span class="p">;</span>
<span class="lineno">2039 </span>    <span class="p">}</span>
<span class="lineno">2040 </span>
<span class="lineno">2041 </span>
<span class="lineno">2042 </span>    <span class="n">clFinish</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">commands</span><span class="p">);</span>
<span class="lineno">2043 </span>    <span class="c1">//printf("STOPPING\n");</span>
<span class="lineno">2044 </span>
<span class="lineno">2045 </span>    <span class="n">err</span> <span class="o">=</span> <span class="n">clEnqueueReadBuffer</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">commands</span><span class="p">,</span> <span class="n">tex</span><span class="p">,</span> <span class="n">CL_TRUE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">width</span><span class="o">*</span><span class="n">height</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="n">bitmap</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">);</span>
<span class="lineno">2046 </span>    <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="n">CL_SUCCESS</span><span class="p">)</span>
<span class="lineno">2047 </span>    <span class="p">{</span>
<span class="lineno">2048 </span>        <span class="n">printf</span><span class="p">(</span><span class="s">"Error: Failed to read output array! %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
<span class="lineno">2049 </span>        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="lineno">2050 </span>    <span class="p">}</span>
<span class="lineno">2051 </span><span class="p">}</span>
<span class="lineno">2052 </span>
<span class="lineno">2053 </span><span class="cm">/***************/</span>
<span class="lineno">2054 </span><span class="cm">/* raytracer.c */</span>
<span class="lineno">2055 </span><span class="cm">/***************/</span>
<span class="lineno">2056 </span>
<span class="lineno">2057 </span><span class="cp">#include</span> <span class="cpf">&lt;raytracer.h&gt;</span><span class="cp"></span>
<span class="lineno">2058 </span><span class="cp">#include</span> <span class="cpf">&lt;parallel.h&gt;</span><span class="cp"></span>
<span class="lineno">2059 </span>
<span class="lineno">2060 </span><span class="c1">//binary resources</span>
<span class="lineno">2061 </span><span class="cp">#include</span> <span class="cpf">&lt;test.cl.h&gt; //test kernel</span><span class="cp"></span>
<span class="lineno">2062 </span>
<span class="lineno">2063 </span>
<span class="lineno">2064 </span>
<span class="lineno">2065 </span><span class="c1">//NOTE: we are assuming the output buffer will be the right size</span>
<span class="lineno">2066 </span><span class="n">raytracer_context</span><span class="o">*</span> <span class="nf">raytracer_init</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">height</span><span class="p">,</span>
<span class="lineno">2067 </span>                                      <span class="kt">uint32_t</span><span class="o">*</span> <span class="n">output_buffer</span><span class="p">,</span> <span class="n">rcl_ctx</span><span class="o">*</span> <span class="n">rcl</span><span class="p">)</span>
<span class="lineno">2068 </span><span class="p">{</span>
<span class="lineno">2069 </span>    <span class="n">raytracer_context</span><span class="o">*</span> <span class="n">rctx</span> <span class="o">=</span> <span class="p">(</span><span class="n">raytracer_context</span><span class="o">*</span><span class="p">)</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">raytracer_context</span><span class="p">));</span>
<span class="lineno">2070 </span>    <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">width</span>  <span class="o">=</span> <span class="n">width</span><span class="p">;</span>
<span class="lineno">2071 </span>    <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">height</span><span class="p">;</span>
<span class="lineno">2072 </span>    <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">ray_buffer</span> <span class="o">=</span> <span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="p">)</span> <span class="n">malloc</span><span class="p">(</span><span class="n">width</span> <span class="o">*</span> <span class="n">height</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="p">);</span>
<span class="lineno">2073 </span>    <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">output_buffer</span> <span class="o">=</span> <span class="n">output_buffer</span><span class="p">;</span>
<span class="lineno">2074 </span>    <span class="c1">//rctx-&gt;fresh_buffer = (uint32_t*) malloc(width * height * sizeof(uint32_t));</span>
<span class="lineno">2075 </span>    <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">rcl</span> <span class="o">=</span> <span class="n">rcl</span><span class="p">;</span>
<span class="lineno">2076 </span>    <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">program</span> <span class="o">=</span> <span class="p">(</span><span class="n">rcl_program</span><span class="o">*</span><span class="p">)</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">rcl_program</span><span class="p">));</span>
<span class="lineno">2077 </span>    <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">ic_ctx</span> <span class="o">=</span> <span class="p">(</span><span class="n">ic_context</span><span class="o">*</span><span class="p">)</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">ic_context</span><span class="p">));</span>
<span class="lineno">2078 </span>    <span class="c1">//ic_init(rctx);</span>
<span class="lineno">2079 </span>    <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">render_complete</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="lineno">2080 </span>    <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">num_samples</span>     <span class="o">=</span> <span class="mi">64</span><span class="p">;</span> <span class="c1">//NOTE: arbitrary default</span>
<span class="lineno">2081 </span>    <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">current_sample</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno">2082 </span>
<span class="lineno">2083 </span>    <span class="k">return</span> <span class="n">rctx</span><span class="p">;</span>
<span class="lineno">2084 </span><span class="p">}</span>
<span class="lineno">2085 </span>
<span class="lineno">2086 </span><span class="kt">void</span> <span class="nf">raytracer_cl_prepass</span><span class="p">(</span><span class="n">raytracer_context</span><span class="o">*</span> <span class="n">rctx</span><span class="p">)</span>
<span class="lineno">2087 </span><span class="p">{</span>
<span class="lineno">2088 </span>    <span class="c1">//CL init</span>
<span class="lineno">2089 </span>    <span class="n">printf</span><span class="p">(</span><span class="s">"Building Scene Kernels...</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="lineno">2090 </span>
<span class="lineno">2091 </span>    <span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">CL_SUCCESS</span><span class="p">;</span>
<span class="lineno">2092 </span>
<span class="lineno">2093 </span>    <span class="c1">//Kernels</span>
<span class="lineno">2094 </span>    <span class="kt">char</span><span class="o">*</span> <span class="n">kernels</span><span class="p">[]</span> <span class="o">=</span> <span class="n">KERNELS</span><span class="p">;</span>
<span class="lineno">2095 </span>
<span class="lineno">2096 </span>    <span class="c1">//Macros</span>
<span class="lineno">2097 </span>    <span class="kt">char</span> <span class="n">sphere_macro</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
<span class="lineno">2098 </span>    <span class="n">sprintf</span><span class="p">(</span><span class="n">sphere_macro</span><span class="p">,</span> <span class="s">"#define SCENE_NUM_SPHERES %i"</span><span class="p">,</span> <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">stat_scene</span><span class="o">-&gt;</span><span class="n">num_spheres</span><span class="p">);</span>
<span class="lineno">2099 </span>    <span class="kt">char</span> <span class="n">plane_macro</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
<span class="lineno">2100 </span>    <span class="n">sprintf</span><span class="p">(</span><span class="n">plane_macro</span><span class="p">,</span> <span class="s">"#define SCENE_NUM_PLANES %i"</span><span class="p">,</span> <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">stat_scene</span><span class="o">-&gt;</span><span class="n">num_planes</span><span class="p">);</span>
<span class="lineno">2101 </span>    <span class="kt">char</span> <span class="n">index_macro</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
<span class="lineno">2102 </span>    <span class="n">sprintf</span><span class="p">(</span><span class="n">index_macro</span><span class="p">,</span> <span class="s">"#define SCENE_NUM_INDICES %i"</span><span class="p">,</span> <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">stat_scene</span><span class="o">-&gt;</span><span class="n">num_mesh_indices</span><span class="p">);</span>
<span class="lineno">2103 </span>    <span class="kt">char</span> <span class="n">mesh_macro</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
<span class="lineno">2104 </span>    <span class="n">sprintf</span><span class="p">(</span><span class="n">mesh_macro</span><span class="p">,</span> <span class="s">"#define SCENE_NUM_MESHES %i"</span><span class="p">,</span> <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">stat_scene</span><span class="o">-&gt;</span><span class="n">num_meshes</span><span class="p">);</span>
<span class="lineno">2105 </span>    <span class="kt">char</span> <span class="n">material_macro</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
<span class="lineno">2106 </span>    <span class="n">sprintf</span><span class="p">(</span><span class="n">material_macro</span><span class="p">,</span> <span class="s">"#define SCENE_NUM_MATERIALS %i"</span><span class="p">,</span> <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">stat_scene</span><span class="o">-&gt;</span><span class="n">num_materials</span><span class="p">);</span>
<span class="lineno">2107 </span>    <span class="kt">char</span><span class="o">*</span> <span class="n">macros</span><span class="p">[]</span>  <span class="o">=</span> <span class="p">{</span><span class="n">sphere_macro</span><span class="p">,</span> <span class="n">plane_macro</span><span class="p">,</span> <span class="n">mesh_macro</span><span class="p">,</span> <span class="n">index_macro</span><span class="p">,</span> <span class="n">material_macro</span><span class="p">};</span>
<span class="lineno">2108 </span>
<span class="lineno">2109 </span>    <span class="p">{</span>
<span class="lineno">2110 </span>
<span class="lineno">2111 </span>        <span class="n">load_program_raw</span><span class="p">(</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">rcl</span><span class="p">,</span>
<span class="lineno">2112 </span>                         <span class="n">all_kernels_cl</span><span class="p">,</span> <span class="c1">//NOTE: Binary resource</span>
<span class="lineno">2113 </span>                         <span class="n">kernels</span><span class="p">,</span> <span class="n">NUM_KERNELS</span><span class="p">,</span> <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">program</span><span class="p">,</span>
<span class="lineno">2114 </span>                         <span class="n">macros</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
<span class="lineno">2115 </span>    <span class="p">}</span>
<span class="lineno">2116 </span>    <span class="c1">//Buffers</span>
<span class="lineno">2117 </span>    <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">cl_ray_buffer</span> <span class="o">=</span> <span class="n">clCreateBuffer</span><span class="p">(</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">rcl</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">,</span>
<span class="lineno">2118 </span>                                         <span class="n">CL_MEM_READ_WRITE</span> <span class="o">|</span> <span class="n">CL_MEM_COPY_HOST_PTR</span><span class="p">,</span>
<span class="lineno">2119 </span>                                         <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">width</span><span class="o">*</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">height</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="p">,</span>
<span class="lineno">2120 </span>                                         <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">ray_buffer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
<span class="lineno">2121 </span>    <span class="n">ASRT_CL</span><span class="p">(</span><span class="s">"Error Creating OpenCL Ray Buffer."</span><span class="p">);</span>
<span class="lineno">2122 </span>    <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">cl_path_output_buffer</span> <span class="o">=</span> <span class="n">clCreateBuffer</span><span class="p">(</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">rcl</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">,</span>
<span class="lineno">2123 </span>                                         <span class="n">CL_MEM_READ_WRITE</span><span class="p">,</span>
<span class="lineno">2124 </span>                                         <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">width</span><span class="o">*</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">height</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">vec4</span><span class="p">),</span>
<span class="lineno">2125 </span>                                         <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
<span class="lineno">2126 </span>    <span class="n">ASRT_CL</span><span class="p">(</span><span class="s">"Error Creating OpenCL Path Tracer Output Buffer."</span><span class="p">);</span>
<span class="lineno">2127 </span>
<span class="lineno">2128 </span>    <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">cl_output_buffer</span> <span class="o">=</span> <span class="n">clCreateBuffer</span><span class="p">(</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">rcl</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">,</span> <span class="n">CL_MEM_READ_WRITE</span><span class="p">,</span>
<span class="lineno">2129 </span>                                            <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">width</span><span class="o">*</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">height</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
<span class="lineno">2130 </span>    <span class="n">ASRT_CL</span><span class="p">(</span><span class="s">"Error Creating OpenCL Output Buffer."</span><span class="p">);</span>
<span class="lineno">2131 </span>
<span class="lineno">2132 </span>    <span class="c1">//TODO: all output buffers and frame buffers should be images.</span>
<span class="lineno">2133 </span>    <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">cl_path_fresh_frame_buffer</span> <span class="o">=</span> <span class="n">clCreateBuffer</span><span class="p">(</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">rcl</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">,</span> <span class="n">CL_MEM_READ_WRITE</span><span class="p">,</span>
<span class="lineno">2134 </span>                                                 <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">width</span><span class="o">*</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">height</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">vec4</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
<span class="lineno">2135 </span>    <span class="n">ASRT_CL</span><span class="p">(</span><span class="s">"Error Creating OpenCL Fresh Frame Buffer."</span><span class="p">);</span>
<span class="lineno">2136 </span>
<span class="lineno">2137 </span>    <span class="n">printf</span><span class="p">(</span><span class="s">"Pushing Scene Resources.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="lineno">2138 </span>    <span class="n">scene_init_resources</span><span class="p">(</span><span class="n">rctx</span><span class="p">);</span>
<span class="lineno">2139 </span>
<span class="lineno">2140 </span>    <span class="n">printf</span><span class="p">(</span><span class="s">"Built Scene Kernels.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="lineno">2141 </span><span class="p">}</span>
<span class="lineno">2142 </span>
<span class="lineno">2143 </span><span class="kt">void</span> <span class="nf">raytracer_prepass</span><span class="p">(</span><span class="n">raytracer_context</span><span class="o">*</span> <span class="n">rctx</span><span class="p">)</span>
<span class="lineno">2144 </span><span class="p">{</span>
<span class="lineno">2145 </span>    <span class="n">printf</span><span class="p">(</span><span class="s">"Starting Raytracer Prepass.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="lineno">2146 </span>
<span class="lineno">2147 </span>
<span class="lineno">2148 </span>    <span class="n">raytracer_cl_prepass</span><span class="p">(</span><span class="n">rctx</span><span class="p">);</span>
<span class="lineno">2149 </span>
<span class="lineno">2150 </span>
<span class="lineno">2151 </span>    <span class="n">printf</span><span class="p">(</span><span class="s">"Finished Raytracer Prepass.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="lineno">2152 </span>
<span class="lineno">2153 </span><span class="p">}</span> <span class="c1">//TODO: implement</span>
<span class="lineno">2154 </span><span class="kt">void</span> <span class="nf">raytracer_render</span><span class="p">(</span><span class="n">raytracer_context</span><span class="o">*</span> <span class="n">rctx</span><span class="p">)</span>
<span class="lineno">2155 </span><span class="p">{</span>
<span class="lineno">2156 </span>    <span class="n">_raytracer_gen_ray_buffer</span><span class="p">(</span><span class="n">rctx</span><span class="p">);</span>
<span class="lineno">2157 </span>
<span class="lineno">2158 </span>    <span class="n">_raytracer_cast_rays</span><span class="p">(</span><span class="n">rctx</span><span class="p">);</span>
<span class="lineno">2159 </span><span class="p">}</span>
<span class="lineno">2160 </span>
<span class="lineno">2161 </span><span class="c1">//#define JANK_SAMPLES 32</span>
<span class="lineno">2162 </span><span class="kt">void</span> <span class="nf">raytracer_refined_render</span><span class="p">(</span><span class="n">raytracer_context</span><span class="o">*</span> <span class="n">rctx</span><span class="p">)</span>
<span class="lineno">2163 </span><span class="p">{</span>
<span class="lineno">2164 </span>    <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">current_sample</span><span class="o">++</span><span class="p">;</span>
<span class="lineno">2165 </span>    <span class="k">if</span><span class="p">(</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">current_sample</span><span class="o">&gt;</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">num_samples</span><span class="p">)</span>
<span class="lineno">2166 </span>    <span class="p">{</span>
<span class="lineno">2167 </span>        <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">render_complete</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="lineno">2168 </span>        <span class="k">return</span><span class="p">;</span>
<span class="lineno">2169 </span>    <span class="p">}</span>
<span class="lineno">2170 </span>    <span class="n">_raytracer_gen_ray_buffer</span><span class="p">(</span><span class="n">rctx</span><span class="p">);</span>
<span class="lineno">2171 </span>
<span class="lineno">2172 </span>    <span class="n">_raytracer_path_trace</span><span class="p">(</span><span class="n">rctx</span><span class="p">,</span> <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">current_sample</span><span class="p">);</span>
<span class="lineno">2173 </span>
<span class="lineno">2174 </span>    <span class="k">if</span><span class="p">(</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">current_sample</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="c1">//really terrible place for path tracer initialization...</span>
<span class="lineno">2175 </span>    <span class="p">{</span>
<span class="lineno">2176 </span>        <span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
<span class="lineno">2177 </span>        <span class="kt">char</span> <span class="n">pattern</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno">2178 </span>        <span class="n">err</span> <span class="o">=</span> <span class="n">clEnqueueCopyBuffer</span> <span class="p">(</span>    <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">rcl</span><span class="o">-&gt;</span><span class="n">commands</span><span class="p">,</span>
<span class="lineno">2179 </span>                                    <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">cl_path_fresh_frame_buffer</span><span class="p">,</span>
<span class="lineno">2180 </span>                                    <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">cl_path_output_buffer</span><span class="p">,</span>
<span class="lineno">2181 </span>                                    <span class="mi">0</span><span class="p">,</span>
<span class="lineno">2182 </span>                                    <span class="mi">0</span><span class="p">,</span>
<span class="lineno">2183 </span>                                    <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">width</span><span class="o">*</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">height</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">vec4</span><span class="p">),</span>
<span class="lineno">2184 </span>                                    <span class="mi">0</span><span class="p">,</span>
<span class="lineno">2185 </span>                                    <span class="mi">0</span><span class="p">,</span>
<span class="lineno">2186 </span>                                    <span class="nb">NULL</span><span class="p">);</span>
<span class="lineno">2187 </span>        <span class="n">ASRT_CL</span><span class="p">(</span><span class="s">"Error copying OpenCL Output Buffer"</span><span class="p">);</span>
<span class="lineno">2188 </span>
<span class="lineno">2189 </span>        <span class="n">err</span> <span class="o">=</span> <span class="n">clFinish</span><span class="p">(</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">rcl</span><span class="o">-&gt;</span><span class="n">commands</span><span class="p">);</span>
<span class="lineno">2190 </span>        <span class="n">ASRT_CL</span><span class="p">(</span><span class="s">"Something happened while waiting for copy to finish"</span><span class="p">);</span>
<span class="lineno">2191 </span>    <span class="p">}</span>
<span class="lineno">2192 </span>
<span class="lineno">2193 </span>    <span class="n">_raytracer_average_buffers</span><span class="p">(</span><span class="n">rctx</span><span class="p">,</span> <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">current_sample</span><span class="p">);</span>
<span class="lineno">2194 </span>    <span class="n">_raytracer_push_path</span><span class="p">(</span><span class="n">rctx</span><span class="p">);</span>
<span class="lineno">2195 </span>
<span class="lineno">2196 </span><span class="p">}</span>
<span class="lineno">2197 </span>
<span class="lineno">2198 </span><span class="kt">void</span> <span class="nf">_raytracer_gen_ray_buffer</span><span class="p">(</span><span class="n">raytracer_context</span><span class="o">*</span> <span class="n">rctx</span><span class="p">)</span>
<span class="lineno">2199 </span><span class="p">{</span>
<span class="lineno">2200 </span>    <span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
<span class="lineno">2201 </span>
<span class="lineno">2202 </span>    <span class="n">cl_kernel</span> <span class="n">kernel</span> <span class="o">=</span> <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">program</span><span class="o">-&gt;</span><span class="n">raw_kernels</span><span class="p">[</span><span class="n">RAY_BUFFER_KRNL_INDX</span><span class="p">];</span>
<span class="lineno">2203 </span>    <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cl_mem</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">cl_ray_buffer</span><span class="p">);</span>
<span class="lineno">2204 </span>    <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">);</span>
<span class="lineno">2205 </span>    <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">);</span>
<span class="lineno">2206 </span>    <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mat4</span><span class="p">),</span> <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">stat_scene</span><span class="o">-&gt;</span><span class="n">camera_world_matrix</span><span class="p">);</span>
<span class="lineno">2207 </span>
<span class="lineno">2208 </span>
<span class="lineno">2209 </span>    <span class="kt">size_t</span> <span class="n">global</span><span class="p">;</span>
<span class="lineno">2210 </span>
<span class="lineno">2211 </span>
<span class="lineno">2212 </span>    <span class="n">global</span> <span class="o">=</span>  <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">width</span><span class="o">*</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
<span class="lineno">2213 </span>    <span class="n">err</span> <span class="o">=</span> <span class="n">clEnqueueNDRangeKernel</span><span class="p">(</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">rcl</span><span class="o">-&gt;</span><span class="n">commands</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">global</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="lineno">2214 </span>    <span class="n">ASRT_CL</span><span class="p">(</span><span class="s">"Failed to execute kernel"</span><span class="p">);</span>
<span class="lineno">2215 </span>
<span class="lineno">2216 </span>
<span class="lineno">2217 </span>    <span class="c1">//Wait for completion</span>
<span class="lineno">2218 </span>    <span class="n">err</span> <span class="o">=</span> <span class="n">clFinish</span><span class="p">(</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">rcl</span><span class="o">-&gt;</span><span class="n">commands</span><span class="p">);</span>
<span class="lineno">2219 </span>    <span class="n">ASRT_CL</span><span class="p">(</span><span class="s">"Something happened while waiting for kernel raybuf to finish"</span><span class="p">);</span>
<span class="lineno">2220 </span>
<span class="lineno">2221 </span>
<span class="lineno">2222 </span><span class="p">}</span>
<span class="lineno">2223 </span><span class="kt">void</span> <span class="nf">_raytracer_average_buffers</span><span class="p">(</span><span class="n">raytracer_context</span><span class="o">*</span> <span class="n">rctx</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sample_num</span><span class="p">)</span>
<span class="lineno">2224 </span><span class="p">{</span>
<span class="lineno">2225 </span>    <span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
<span class="lineno">2226 </span>
<span class="lineno">2227 </span>    <span class="n">cl_kernel</span> <span class="n">kernel</span> <span class="o">=</span> <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">program</span><span class="o">-&gt;</span><span class="n">raw_kernels</span><span class="p">[</span><span class="n">F_BUFFER_AVG_KRNL_INDX</span><span class="p">];</span>
<span class="lineno">2228 </span>    <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cl_mem</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">cl_path_output_buffer</span><span class="p">);</span>
<span class="lineno">2229 </span>    <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cl_mem</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">cl_path_fresh_frame_buffer</span><span class="p">);</span>
<span class="lineno">2230 </span>    <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">);</span>
<span class="lineno">2231 </span>    <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">);</span>
<span class="lineno">2232 </span>    <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">num_samples</span><span class="p">);</span>
<span class="lineno">2233 </span>    <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">sample_num</span><span class="p">);</span>
<span class="lineno">2234 </span>
<span class="lineno">2235 </span>    <span class="kt">size_t</span> <span class="n">global</span><span class="p">;</span>
<span class="lineno">2236 </span>    <span class="kt">size_t</span> <span class="n">local</span> <span class="o">=</span> <span class="n">get_workgroup_size</span><span class="p">(</span><span class="n">rctx</span><span class="p">,</span> <span class="n">kernel</span><span class="p">);</span>
<span class="lineno">2237 </span>
<span class="lineno">2238 </span>    <span class="c1">// Execute the kernel over the entire range of our 1d input data set</span>
<span class="lineno">2239 </span>    <span class="c1">// using the maximum number of work group items for this device</span>
<span class="lineno">2240 </span>    <span class="c1">//</span>
<span class="lineno">2241 </span>    <span class="n">global</span> <span class="o">=</span>  <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">width</span><span class="o">*</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
<span class="lineno">2242 </span>    <span class="n">err</span> <span class="o">=</span> <span class="n">clEnqueueNDRangeKernel</span><span class="p">(</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">rcl</span><span class="o">-&gt;</span><span class="n">commands</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">global</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="lineno">2243 </span>    <span class="n">ASRT_CL</span><span class="p">(</span><span class="s">"Failed to execute kernel"</span><span class="p">)</span>
<span class="lineno">2244 </span>    <span class="n">err</span> <span class="o">=</span> <span class="n">clFinish</span><span class="p">(</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">rcl</span><span class="o">-&gt;</span><span class="n">commands</span><span class="p">);</span>
<span class="lineno">2245 </span>    <span class="n">ASRT_CL</span><span class="p">(</span><span class="s">"Something happened while waiting for kernel to finish"</span><span class="p">);</span>
<span class="lineno">2246 </span>
<span class="lineno">2247 </span>
<span class="lineno">2248 </span>
<span class="lineno">2249 </span><span class="p">}</span>
<span class="lineno">2250 </span>
<span class="lineno">2251 </span><span class="kt">void</span> <span class="nf">_raytracer_push_path</span><span class="p">(</span><span class="n">raytracer_context</span><span class="o">*</span> <span class="n">rctx</span><span class="p">)</span>
<span class="lineno">2252 </span><span class="p">{</span>
<span class="lineno">2253 </span>    <span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
<span class="lineno">2254 </span>
<span class="lineno">2255 </span>    <span class="n">cl_kernel</span> <span class="n">kernel</span> <span class="o">=</span> <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">program</span><span class="o">-&gt;</span><span class="n">raw_kernels</span><span class="p">[</span><span class="n">F_BUF_TO_BYTE_BUF_KRNL_INDX</span><span class="p">];</span>
<span class="lineno">2256 </span>    <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cl_mem</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">cl_output_buffer</span><span class="p">);</span>
<span class="lineno">2257 </span>    <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cl_mem</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">cl_path_output_buffer</span><span class="p">);</span>
<span class="lineno">2258 </span>    <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">);</span>
<span class="lineno">2259 </span>    <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">);</span>
<span class="lineno">2260 </span>
<span class="lineno">2261 </span>
<span class="lineno">2262 </span>
<span class="lineno">2263 </span>    <span class="kt">size_t</span> <span class="n">global</span><span class="p">;</span>
<span class="lineno">2264 </span>    <span class="kt">size_t</span> <span class="n">local</span> <span class="o">=</span> <span class="n">get_workgroup_size</span><span class="p">(</span><span class="n">rctx</span><span class="p">,</span> <span class="n">kernel</span><span class="p">);</span>
<span class="lineno">2265 </span>
<span class="lineno">2266 </span>    <span class="c1">// Execute the kernel over the entire range of our 1d input data set</span>
<span class="lineno">2267 </span>    <span class="c1">// using the maximum number of work group items for this device</span>
<span class="lineno">2268 </span>    <span class="c1">//</span>
<span class="lineno">2269 </span>    <span class="n">global</span> <span class="o">=</span>  <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">width</span><span class="o">*</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
<span class="lineno">2270 </span>    <span class="n">err</span> <span class="o">=</span> <span class="n">clEnqueueNDRangeKernel</span><span class="p">(</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">rcl</span><span class="o">-&gt;</span><span class="n">commands</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">global</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="lineno">2271 </span>    <span class="n">ASRT_CL</span><span class="p">(</span><span class="s">"Failed to execute kernel"</span><span class="p">);</span>
<span class="lineno">2272 </span>
<span class="lineno">2273 </span>
<span class="lineno">2274 </span>    <span class="n">err</span> <span class="o">=</span> <span class="n">clFinish</span><span class="p">(</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">rcl</span><span class="o">-&gt;</span><span class="n">commands</span><span class="p">);</span>
<span class="lineno">2275 </span>    <span class="n">ASRT_CL</span><span class="p">(</span><span class="s">"Something happened while waiting for kernel to finish"</span><span class="p">);</span>
<span class="lineno">2276 </span>
<span class="lineno">2277 </span>    <span class="n">err</span> <span class="o">=</span> <span class="n">clEnqueueReadBuffer</span><span class="p">(</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">rcl</span><span class="o">-&gt;</span><span class="n">commands</span><span class="p">,</span> <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">cl_output_buffer</span><span class="p">,</span> <span class="n">CL_TRUE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
<span class="lineno">2278 </span>                              <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">width</span><span class="o">*</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">height</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span> <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">output_buffer</span><span class="p">,</span>
<span class="lineno">2279 </span>                              <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">);</span>
<span class="lineno">2280 </span>    <span class="n">ASRT_CL</span><span class="p">(</span><span class="s">"Failed to read output array"</span><span class="p">);</span>
<span class="lineno">2281 </span>
<span class="lineno">2282 </span><span class="p">}</span>
<span class="lineno">2283 </span>
<span class="lineno">2284 </span><span class="c1">//NOTE: the more divisions the slower.</span>
<span class="lineno">2285 </span><span class="cp">#define WATCHDOG_DIVISIONS_X 2</span>
<span class="lineno">2286 </span><span class="cp">#define WATCHDOG_DIVISIONS_Y 2</span>
<span class="lineno">2287 </span><span class="kt">void</span> <span class="nf">_raytracer_path_trace</span><span class="p">(</span><span class="n">raytracer_context</span><span class="o">*</span> <span class="n">rctx</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sample_num</span><span class="p">)</span>
<span class="lineno">2288 </span><span class="p">{</span>
<span class="lineno">2289 </span>    <span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
<span class="lineno">2290 </span>
<span class="lineno">2291 </span>    <span class="k">const</span> <span class="kt">unsigned</span> <span class="n">x_div</span> <span class="o">=</span> <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">width</span><span class="o">/</span><span class="n">WATCHDOG_DIVISIONS_X</span><span class="p">;</span>
<span class="lineno">2292 </span>    <span class="k">const</span> <span class="kt">unsigned</span> <span class="n">y_div</span> <span class="o">=</span> <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">height</span><span class="o">/</span><span class="n">WATCHDOG_DIVISIONS_Y</span><span class="p">;</span>
<span class="lineno">2293 </span>
<span class="lineno">2294 </span>    <span class="c1">//scene_resource_push(rctx); //Update Scene buffers if necessary.</span>
<span class="lineno">2295 </span>
<span class="lineno">2296 </span>    <span class="n">cl_kernel</span> <span class="n">kernel</span> <span class="o">=</span> <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">program</span><span class="o">-&gt;</span><span class="n">raw_kernels</span><span class="p">[</span><span class="n">PATH_TRACE_KRNL_INDX</span><span class="p">];</span> <span class="c1">//just use the first one</span>
<span class="lineno">2297 </span>
<span class="lineno">2298 </span>    <span class="kt">float</span> <span class="n">zeroed</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">};</span>
<span class="lineno">2299 </span>    <span class="kt">float</span><span class="o">*</span> <span class="n">result</span> <span class="o">=</span> <span class="n">matvec_mul</span><span class="p">(</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">stat_scene</span><span class="o">-&gt;</span><span class="n">camera_world_matrix</span><span class="p">,</span> <span class="n">zeroed</span><span class="p">);</span>
<span class="lineno">2300 </span>
<span class="lineno">2301 </span>    <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cl_mem</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">cl_path_fresh_frame_buffer</span><span class="p">);</span>
<span class="lineno">2302 </span>    <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cl_mem</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">cl_ray_buffer</span><span class="p">);</span>
<span class="lineno">2303 </span>    <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cl_mem</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">stat_scene</span><span class="o">-&gt;</span><span class="n">cl_material_buffer</span><span class="p">);</span>
<span class="lineno">2304 </span>    <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cl_mem</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">stat_scene</span><span class="o">-&gt;</span><span class="n">cl_sphere_buffer</span><span class="p">);</span>
<span class="lineno">2305 </span>    <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cl_mem</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">stat_scene</span><span class="o">-&gt;</span><span class="n">cl_plane_buffer</span><span class="p">);</span>
<span class="lineno">2306 </span>    <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cl_mem</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">stat_scene</span><span class="o">-&gt;</span><span class="n">cl_mesh_buffer</span><span class="p">);</span>
<span class="lineno">2307 </span>    <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cl_mem</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">stat_scene</span><span class="o">-&gt;</span><span class="n">cl_mesh_index_buffer</span><span class="p">);</span>
<span class="lineno">2308 </span>    <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cl_mem</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">stat_scene</span><span class="o">-&gt;</span><span class="n">cl_mesh_vert_buffer</span><span class="p">);</span>
<span class="lineno">2309 </span>    <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cl_mem</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">stat_scene</span><span class="o">-&gt;</span><span class="n">cl_mesh_nrml_buffer</span><span class="p">);</span>
<span class="lineno">2310 </span>
<span class="lineno">2311 </span>    <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span>  <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span>     <span class="o">&amp;</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">);</span>
<span class="lineno">2312 </span>    <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">vec4</span><span class="p">),</span>    <span class="n">result</span><span class="p">);</span>
<span class="lineno">2313 </span>    <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span>     <span class="o">&amp;</span><span class="n">sample_num</span><span class="p">);</span> <span class="c1">//NOTE: I don't think this is used</span>
<span class="lineno">2314 </span>
<span class="lineno">2315 </span>    <span class="kt">size_t</span> <span class="n">global</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">x_div</span><span class="p">,</span> <span class="n">y_div</span><span class="p">};</span>
<span class="lineno">2316 </span>
<span class="lineno">2317 </span>    <span class="c1">//NOTE: tripping watchdog timer</span>
<span class="lineno">2318 </span>    <span class="k">if</span><span class="p">(</span><span class="n">global</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">WATCHDOG_DIVISIONS_X</span><span class="o">*</span><span class="n">global</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">WATCHDOG_DIVISIONS_Y</span><span class="o">!=</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">width</span><span class="o">*</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">)</span>
<span class="lineno">2319 </span>    <span class="p">{</span>
<span class="lineno">2320 </span>        <span class="n">printf</span><span class="p">(</span><span class="s">"Watchdog divisions are incorrect!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="lineno">2321 </span>        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="lineno">2322 </span>    <span class="p">}</span>
<span class="lineno">2323 </span>
<span class="lineno">2324 </span>    <span class="kt">size_t</span> <span class="n">offset</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="lineno">2325 </span>
<span class="lineno">2326 </span>    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">WATCHDOG_DIVISIONS_X</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span>
<span class="lineno">2327 </span>    <span class="p">{</span>
<span class="lineno">2328 </span>        <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">WATCHDOG_DIVISIONS_Y</span><span class="p">;</span> <span class="n">y</span><span class="o">++</span><span class="p">)</span>
<span class="lineno">2329 </span>        <span class="p">{</span>
<span class="lineno">2330 </span>            <span class="n">offset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_div</span><span class="o">*</span><span class="n">x</span><span class="p">;</span>
<span class="lineno">2331 </span>            <span class="n">offset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_div</span><span class="o">*</span><span class="n">y</span><span class="p">;</span>
<span class="lineno">2332 </span>            <span class="n">err</span> <span class="o">=</span> <span class="n">clEnqueueNDRangeKernel</span><span class="p">(</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">rcl</span><span class="o">-&gt;</span><span class="n">commands</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
<span class="lineno">2333 </span>                                         <span class="n">offset</span><span class="p">,</span> <span class="n">global</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="lineno">2334 </span>            <span class="n">ASRT_CL</span><span class="p">(</span><span class="s">"Failed to execute path trace kernel"</span><span class="p">);</span>
<span class="lineno">2335 </span>        <span class="p">}</span>
<span class="lineno">2336 </span>    <span class="p">}</span>
<span class="lineno">2337 </span>
<span class="lineno">2338 </span>    <span class="n">err</span> <span class="o">=</span> <span class="n">clFinish</span><span class="p">(</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">rcl</span><span class="o">-&gt;</span><span class="n">commands</span><span class="p">);</span>
<span class="lineno">2339 </span>    <span class="n">ASRT_CL</span><span class="p">(</span><span class="s">"Something happened while executing path trace kernel"</span><span class="p">);</span>
<span class="lineno">2340 </span><span class="p">}</span>
<span class="lineno">2341 </span>
<span class="lineno">2342 </span>
<span class="lineno">2343 </span><span class="kt">void</span> <span class="nf">_raytracer_cast_rays</span><span class="p">(</span><span class="n">raytracer_context</span><span class="o">*</span> <span class="n">rctx</span><span class="p">)</span> <span class="c1">//TODO: do more path tracing stuff here</span>
<span class="lineno">2344 </span><span class="p">{</span>
<span class="lineno">2345 </span>    <span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
<span class="lineno">2346 </span>
<span class="lineno">2347 </span>
<span class="lineno">2348 </span>
<span class="lineno">2349 </span>    <span class="n">scene_resource_push</span><span class="p">(</span><span class="n">rctx</span><span class="p">);</span> <span class="c1">//Update Scene buffers if necessary.</span>
<span class="lineno">2350 </span>
<span class="lineno">2351 </span>
<span class="lineno">2352 </span>    <span class="n">cl_kernel</span> <span class="n">kernel</span> <span class="o">=</span> <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">program</span><span class="o">-&gt;</span><span class="n">raw_kernels</span><span class="p">[</span><span class="n">RAY_CAST_KRNL_INDX</span><span class="p">];</span> <span class="c1">//just use the first one</span>
<span class="lineno">2353 </span>
<span class="lineno">2354 </span>    <span class="kt">float</span> <span class="n">zeroed</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">};</span>
<span class="lineno">2355 </span>    <span class="kt">float</span><span class="o">*</span> <span class="n">result</span> <span class="o">=</span> <span class="n">matvec_mul</span><span class="p">(</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">stat_scene</span><span class="o">-&gt;</span><span class="n">camera_world_matrix</span><span class="p">,</span> <span class="n">zeroed</span><span class="p">);</span>
<span class="lineno">2356 </span>    <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cl_mem</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">cl_output_buffer</span><span class="p">);</span>
<span class="lineno">2357 </span>    <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cl_mem</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">cl_ray_buffer</span><span class="p">);</span>
<span class="lineno">2358 </span>    <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cl_mem</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">stat_scene</span><span class="o">-&gt;</span><span class="n">cl_material_buffer</span><span class="p">);</span>
<span class="lineno">2359 </span>    <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cl_mem</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">stat_scene</span><span class="o">-&gt;</span><span class="n">cl_sphere_buffer</span><span class="p">);</span>
<span class="lineno">2360 </span>    <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cl_mem</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">stat_scene</span><span class="o">-&gt;</span><span class="n">cl_plane_buffer</span><span class="p">);</span>
<span class="lineno">2361 </span>    <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cl_mem</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">stat_scene</span><span class="o">-&gt;</span><span class="n">cl_mesh_buffer</span><span class="p">);</span>
<span class="lineno">2362 </span>    <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cl_mem</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">stat_scene</span><span class="o">-&gt;</span><span class="n">cl_mesh_index_buffer</span><span class="p">);</span>
<span class="lineno">2363 </span>    <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cl_mem</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">stat_scene</span><span class="o">-&gt;</span><span class="n">cl_mesh_vert_buffer</span><span class="p">);</span>
<span class="lineno">2364 </span>    <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cl_mem</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">stat_scene</span><span class="o">-&gt;</span><span class="n">cl_mesh_nrml_buffer</span><span class="p">);</span>
<span class="lineno">2365 </span>
<span class="lineno">2366 </span>    <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">);</span>
<span class="lineno">2367 </span>    <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">);</span>
<span class="lineno">2368 </span>    <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span> <span class="c1">//we only need 3</span>
<span class="lineno">2369 </span>    <span class="c1">//free(result);</span>
<span class="lineno">2370 </span>
<span class="lineno">2371 </span>    <span class="kt">size_t</span> <span class="n">global</span><span class="p">;</span>
<span class="lineno">2372 </span>
<span class="lineno">2373 </span>    <span class="n">global</span> <span class="o">=</span>  <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">width</span><span class="o">*</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
<span class="lineno">2374 </span>    <span class="n">err</span> <span class="o">=</span> <span class="n">clEnqueueNDRangeKernel</span><span class="p">(</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">rcl</span><span class="o">-&gt;</span><span class="n">commands</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">global</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="lineno">2375 </span>    <span class="n">ASRT_CL</span><span class="p">(</span><span class="s">"Failed to Execute Kernel"</span><span class="p">);</span>
<span class="lineno">2376 </span>
<span class="lineno">2377 </span>    <span class="n">err</span> <span class="o">=</span> <span class="n">clFinish</span><span class="p">(</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">rcl</span><span class="o">-&gt;</span><span class="n">commands</span><span class="p">);</span>
<span class="lineno">2378 </span>    <span class="n">ASRT_CL</span><span class="p">(</span><span class="s">"Something happened during kernel execution"</span><span class="p">);</span>
<span class="lineno">2379 </span>
<span class="lineno">2380 </span>    <span class="n">err</span> <span class="o">=</span> <span class="n">clEnqueueReadBuffer</span><span class="p">(</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">rcl</span><span class="o">-&gt;</span><span class="n">commands</span><span class="p">,</span> <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">cl_output_buffer</span><span class="p">,</span> <span class="n">CL_TRUE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
<span class="lineno">2381 </span>                              <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">width</span><span class="o">*</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">height</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span> <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">output_buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">);</span>
<span class="lineno">2382 </span>    <span class="n">ASRT_CL</span><span class="p">(</span><span class="s">"Failed to read output array"</span><span class="p">);</span>
<span class="lineno">2383 </span>
<span class="lineno">2384 </span><span class="p">}</span>
<span class="lineno">2385 </span>
<span class="lineno">2386 </span>
<span class="lineno">2387 </span><span class="cm">/***********/</span>
<span class="lineno">2388 </span><span class="cm">/* scene.c */</span>
<span class="lineno">2389 </span><span class="cm">/***********/</span>
<span class="lineno">2390 </span>
<span class="lineno">2391 </span><span class="cp">#include</span> <span class="cpf">&lt;scene.h&gt;</span><span class="cp"></span>
<span class="lineno">2392 </span><span class="cp">#include</span> <span class="cpf">&lt;raytracer.h&gt;</span><span class="cp"></span>
<span class="lineno">2393 </span>
<span class="lineno">2394 </span><span class="cp">#include</span> <span class="cpf">&lt;geom.h&gt;</span><span class="cp"></span>
<span class="lineno">2395 </span><span class="cp">#include</span> <span class="cpf">&lt;CL/cl.h&gt;</span><span class="cp"></span>
<span class="lineno">2396 </span>
<span class="lineno">2397 </span><span class="kt">void</span> <span class="nf">scene_init_resources</span><span class="p">(</span><span class="n">raytracer_context</span><span class="o">*</span> <span class="n">rctx</span><span class="p">)</span>
<span class="lineno">2398 </span><span class="p">{</span>
<span class="lineno">2399 </span>    <span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
<span class="lineno">2400 </span>
<span class="lineno">2401 </span>    <span class="c1">//Scene Buffers</span>
<span class="lineno">2402 </span>    <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">stat_scene</span><span class="o">-&gt;</span><span class="n">cl_sphere_buffer</span> <span class="o">=</span> <span class="n">clCreateBuffer</span><span class="p">(</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">rcl</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">,</span>
<span class="lineno">2403 </span>                                                        <span class="n">CL_MEM_READ_ONLY</span> <span class="o">|</span> <span class="n">CL_MEM_COPY_HOST_PTR</span><span class="p">,</span>
<span class="lineno">2404 </span>                                                        <span class="k">sizeof</span><span class="p">(</span><span class="n">plane</span><span class="p">)</span><span class="o">*</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">stat_scene</span><span class="o">-&gt;</span><span class="n">num_spheres</span><span class="p">,</span>
<span class="lineno">2405 </span>                                                        <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">stat_scene</span><span class="o">-&gt;</span><span class="n">spheres</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
<span class="lineno">2406 </span>    <span class="n">ASRT_CL</span><span class="p">(</span><span class="s">"Error Creating OpenCL Scene Sphere Buffer."</span><span class="p">);</span>
<span class="lineno">2407 </span>
<span class="lineno">2408 </span>    <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">stat_scene</span><span class="o">-&gt;</span><span class="n">cl_plane_buffer</span> <span class="o">=</span> <span class="n">clCreateBuffer</span><span class="p">(</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">rcl</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">,</span>
<span class="lineno">2409 </span>                                                       <span class="n">CL_MEM_READ_ONLY</span> <span class="o">|</span> <span class="n">CL_MEM_COPY_HOST_PTR</span><span class="p">,</span>
<span class="lineno">2410 </span>                                                       <span class="k">sizeof</span><span class="p">(</span><span class="n">plane</span><span class="p">)</span><span class="o">*</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">stat_scene</span><span class="o">-&gt;</span><span class="n">num_planes</span><span class="p">,</span>
<span class="lineno">2411 </span>                                                       <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">stat_scene</span><span class="o">-&gt;</span><span class="n">planes</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
<span class="lineno">2412 </span>    <span class="n">ASRT_CL</span><span class="p">(</span><span class="s">"Error Creating OpenCL Scene Plane Buffer."</span><span class="p">);</span>
<span class="lineno">2413 </span>
<span class="lineno">2414 </span>
<span class="lineno">2415 </span>    <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">stat_scene</span><span class="o">-&gt;</span><span class="n">cl_material_buffer</span> <span class="o">=</span> <span class="n">clCreateBuffer</span><span class="p">(</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">rcl</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">,</span>
<span class="lineno">2416 </span>                                                          <span class="n">CL_MEM_READ_ONLY</span> <span class="o">|</span> <span class="n">CL_MEM_COPY_HOST_PTR</span><span class="p">,</span>
<span class="lineno">2417 </span>                                                          <span class="k">sizeof</span><span class="p">(</span><span class="n">material</span><span class="p">)</span><span class="o">*</span>
<span class="lineno">2418 </span>                                                          <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">stat_scene</span><span class="o">-&gt;</span><span class="n">num_materials</span><span class="p">,</span>
<span class="lineno">2419 </span>                                                          <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">stat_scene</span><span class="o">-&gt;</span><span class="n">materials</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
<span class="lineno">2420 </span>        <span class="n">ASRT_CL</span><span class="p">(</span><span class="s">"Error Creating OpenCL Scene Plane Buffer."</span><span class="p">);</span>
<span class="lineno">2421 </span>
<span class="lineno">2422 </span>
<span class="lineno">2423 </span>    <span class="c1">//Mesh</span>
<span class="lineno">2424 </span>    <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">stat_scene</span><span class="o">-&gt;</span><span class="n">cl_mesh_buffer</span> <span class="o">=</span> <span class="n">clCreateBuffer</span><span class="p">(</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">rcl</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">,</span>
<span class="lineno">2425 </span>                                                      <span class="n">CL_MEM_READ_ONLY</span> <span class="o">|</span> <span class="n">CL_MEM_COPY_HOST_PTR</span><span class="p">,</span>
<span class="lineno">2426 </span>                                                      <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">stat_scene</span><span class="o">-&gt;</span><span class="n">num_meshes</span><span class="o">==</span><span class="mi">0</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span>
<span class="lineno">2427 </span>                                                      <span class="k">sizeof</span><span class="p">(</span><span class="n">mesh</span><span class="p">)</span><span class="o">*</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">stat_scene</span><span class="o">-&gt;</span><span class="n">num_meshes</span><span class="p">,</span>
<span class="lineno">2428 </span>                                                      <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">stat_scene</span><span class="o">-&gt;</span><span class="n">meshes</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
<span class="lineno">2429 </span>    <span class="n">ASRT_CL</span><span class="p">(</span><span class="s">"Error Creating OpenCL Scene Mesh Buffer."</span><span class="p">);</span>
<span class="lineno">2430 </span>
<span class="lineno">2431 </span>    <span class="c1">//mesh data is stored as images for faster access</span>
<span class="lineno">2432 </span>    <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">stat_scene</span><span class="o">-&gt;</span><span class="n">cl_mesh_vert_buffer</span> <span class="o">=</span>
<span class="lineno">2433 </span>        <span class="n">gen_1d_image</span><span class="p">(</span><span class="n">rctx</span><span class="p">,</span> <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">stat_scene</span><span class="o">-&gt;</span><span class="n">num_mesh_verts</span><span class="o">==</span><span class="mi">0</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span>
<span class="lineno">2434 </span>                     <span class="k">sizeof</span><span class="p">(</span><span class="n">vec3</span><span class="p">)</span><span class="o">*</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">stat_scene</span><span class="o">-&gt;</span><span class="n">num_mesh_verts</span><span class="p">,</span>
<span class="lineno">2435 </span>                     <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">stat_scene</span><span class="o">-&gt;</span><span class="n">mesh_verts</span><span class="p">);</span>
<span class="lineno">2436 </span>
<span class="lineno">2437 </span>    <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">stat_scene</span><span class="o">-&gt;</span><span class="n">cl_mesh_nrml_buffer</span> <span class="o">=</span>
<span class="lineno">2438 </span>        <span class="n">gen_1d_image</span><span class="p">(</span><span class="n">rctx</span><span class="p">,</span> <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">stat_scene</span><span class="o">-&gt;</span><span class="n">num_mesh_nrmls</span><span class="o">==</span><span class="mi">0</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span>
<span class="lineno">2439 </span>                     <span class="k">sizeof</span><span class="p">(</span><span class="n">vec3</span><span class="p">)</span><span class="o">*</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">stat_scene</span><span class="o">-&gt;</span><span class="n">num_mesh_nrmls</span><span class="p">,</span>
<span class="lineno">2440 </span>                     <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">stat_scene</span><span class="o">-&gt;</span><span class="n">mesh_nrmls</span><span class="p">);</span>
<span class="lineno">2441 </span>
<span class="lineno">2442 </span>    <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">stat_scene</span><span class="o">-&gt;</span><span class="n">cl_mesh_index_buffer</span> <span class="o">=</span>
<span class="lineno">2443 </span>        <span class="n">gen_1d_image</span><span class="p">(</span><span class="n">rctx</span><span class="p">,</span> <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">stat_scene</span><span class="o">-&gt;</span><span class="n">num_mesh_indices</span><span class="o">==</span><span class="mi">0</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span>
<span class="lineno">2444 </span>                     <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="o">*</span>
<span class="lineno">2445 </span>                     <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">stat_scene</span><span class="o">-&gt;</span><span class="n">num_mesh_indices</span><span class="p">,</span><span class="c1">//maybe</span>
<span class="lineno">2446 </span>                     <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">stat_scene</span><span class="o">-&gt;</span><span class="n">mesh_indices</span><span class="p">);</span>
<span class="lineno">2447 </span><span class="p">}</span>
<span class="lineno">2448 </span>
<span class="lineno">2449 </span>
<span class="lineno">2450 </span><span class="kt">void</span> <span class="nf">scene_resource_push</span><span class="p">(</span><span class="n">raytracer_context</span><span class="o">*</span> <span class="n">rctx</span><span class="p">)</span>
<span class="lineno">2451 </span><span class="p">{</span>
<span class="lineno">2452 </span>    <span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
<span class="lineno">2453 </span>
<span class="lineno">2454 </span>    <span class="k">if</span><span class="p">(</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">stat_scene</span><span class="o">-&gt;</span><span class="n">meshes_changed</span><span class="p">)</span>
<span class="lineno">2455 </span>    <span class="p">{</span>
<span class="lineno">2456 </span>        <span class="n">clEnqueueWriteBuffer</span> <span class="p">(</span>    <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">rcl</span><span class="o">-&gt;</span><span class="n">commands</span><span class="p">,</span>
<span class="lineno">2457 </span>                                <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">stat_scene</span><span class="o">-&gt;</span><span class="n">cl_mesh_buffer</span><span class="p">,</span>
<span class="lineno">2458 </span>                                <span class="n">CL_TRUE</span><span class="p">,</span>
<span class="lineno">2459 </span>                                <span class="mi">0</span><span class="p">,</span>
<span class="lineno">2460 </span>                                <span class="k">sizeof</span><span class="p">(</span><span class="n">mesh</span><span class="p">)</span><span class="o">*</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">stat_scene</span><span class="o">-&gt;</span><span class="n">num_meshes</span><span class="p">,</span>
<span class="lineno">2461 </span>                                <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">stat_scene</span><span class="o">-&gt;</span><span class="n">meshes</span><span class="p">,</span>
<span class="lineno">2462 </span>                                <span class="mi">0</span><span class="p">,</span>
<span class="lineno">2463 </span>                                <span class="nb">NULL</span><span class="p">,</span>
<span class="lineno">2464 </span>                                <span class="nb">NULL</span><span class="p">);</span>
<span class="lineno">2465 </span>    <span class="p">}</span>
<span class="lineno">2466 </span>
<span class="lineno">2467 </span>    <span class="k">if</span><span class="p">(</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">stat_scene</span><span class="o">-&gt;</span><span class="n">spheres_changed</span><span class="p">)</span>
<span class="lineno">2468 </span>    <span class="p">{</span>
<span class="lineno">2469 </span>        <span class="n">clEnqueueWriteBuffer</span> <span class="p">(</span>    <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">rcl</span><span class="o">-&gt;</span><span class="n">commands</span><span class="p">,</span>
<span class="lineno">2470 </span>                                <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">stat_scene</span><span class="o">-&gt;</span><span class="n">cl_sphere_buffer</span><span class="p">,</span>
<span class="lineno">2471 </span>                                <span class="n">CL_TRUE</span><span class="p">,</span>
<span class="lineno">2472 </span>                                <span class="mi">0</span><span class="p">,</span>
<span class="lineno">2473 </span>                                <span class="k">sizeof</span><span class="p">(</span><span class="n">sphere</span><span class="p">)</span><span class="o">*</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">stat_scene</span><span class="o">-&gt;</span><span class="n">num_spheres</span><span class="p">,</span>
<span class="lineno">2474 </span>                                <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">stat_scene</span><span class="o">-&gt;</span><span class="n">spheres</span><span class="p">,</span>
<span class="lineno">2475 </span>                                <span class="mi">0</span><span class="p">,</span>
<span class="lineno">2476 </span>                                <span class="nb">NULL</span><span class="p">,</span>
<span class="lineno">2477 </span>                                <span class="nb">NULL</span><span class="p">);</span>
<span class="lineno">2478 </span>    <span class="p">}</span>
<span class="lineno">2479 </span>
<span class="lineno">2480 </span>    <span class="k">if</span><span class="p">(</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">stat_scene</span><span class="o">-&gt;</span><span class="n">planes_changed</span><span class="p">)</span>
<span class="lineno">2481 </span>    <span class="p">{</span>
<span class="lineno">2482 </span>        <span class="n">clEnqueueWriteBuffer</span> <span class="p">(</span>    <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">rcl</span><span class="o">-&gt;</span><span class="n">commands</span><span class="p">,</span>
<span class="lineno">2483 </span>                                <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">stat_scene</span><span class="o">-&gt;</span><span class="n">cl_plane_buffer</span><span class="p">,</span>
<span class="lineno">2484 </span>                                <span class="n">CL_TRUE</span><span class="p">,</span>
<span class="lineno">2485 </span>                                <span class="mi">0</span><span class="p">,</span>
<span class="lineno">2486 </span>                                <span class="k">sizeof</span><span class="p">(</span><span class="n">plane</span><span class="p">)</span><span class="o">*</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">stat_scene</span><span class="o">-&gt;</span><span class="n">num_planes</span><span class="p">,</span>
<span class="lineno">2487 </span>                                <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">stat_scene</span><span class="o">-&gt;</span><span class="n">planes</span><span class="p">,</span>
<span class="lineno">2488 </span>                                <span class="mi">0</span><span class="p">,</span>
<span class="lineno">2489 </span>                                <span class="nb">NULL</span><span class="p">,</span>
<span class="lineno">2490 </span>                                <span class="nb">NULL</span><span class="p">);</span>
<span class="lineno">2491 </span>    <span class="p">}</span>
<span class="lineno">2492 </span>
<span class="lineno">2493 </span>
<span class="lineno">2494 </span>    <span class="k">if</span><span class="p">(</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">stat_scene</span><span class="o">-&gt;</span><span class="n">materials_changed</span><span class="p">)</span>
<span class="lineno">2495 </span>    <span class="p">{</span>
<span class="lineno">2496 </span>        <span class="n">clEnqueueWriteBuffer</span> <span class="p">(</span>    <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">rcl</span><span class="o">-&gt;</span><span class="n">commands</span><span class="p">,</span>
<span class="lineno">2497 </span>                                <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">stat_scene</span><span class="o">-&gt;</span><span class="n">cl_material_buffer</span><span class="p">,</span>
<span class="lineno">2498 </span>                                <span class="n">CL_TRUE</span><span class="p">,</span>
<span class="lineno">2499 </span>                                <span class="mi">0</span><span class="p">,</span>
<span class="lineno">2500 </span>                                <span class="k">sizeof</span><span class="p">(</span><span class="n">material</span><span class="p">)</span><span class="o">*</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">stat_scene</span><span class="o">-&gt;</span><span class="n">num_materials</span><span class="p">,</span>
<span class="lineno">2501 </span>                                <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">stat_scene</span><span class="o">-&gt;</span><span class="n">materials</span><span class="p">,</span>
<span class="lineno">2502 </span>                                <span class="mi">0</span><span class="p">,</span>
<span class="lineno">2503 </span>                                <span class="nb">NULL</span><span class="p">,</span>
<span class="lineno">2504 </span>                                <span class="nb">NULL</span><span class="p">);</span>
<span class="lineno">2505 </span>    <span class="p">}</span>
<span class="lineno">2506 </span><span class="p">}</span>
<span class="lineno">2507 </span>
<span class="lineno">2508 </span><span class="cm">/*************/</span>
<span class="lineno">2509 </span><span class="cm">/* startup.c */</span>
<span class="lineno">2510 </span><span class="cm">/*************/</span>
<span class="lineno">2511 </span><span class="cp">#include</span> <span class="cpf">&lt;os_abs.h&gt;</span><span class="cp"></span>
<span class="lineno">2512 </span><span class="cp">#include</span> <span class="cpf">&lt;stdint.h&gt;</span><span class="cp"></span>
<span class="lineno">2513 </span><span class="cp">#include</span> <span class="cpf">&lt;startup.h&gt;</span><span class="cp"></span>
<span class="lineno">2514 </span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="lineno">2515 </span><span class="cp">#include</span> <span class="cpf">&lt;raytracer.h&gt;</span><span class="cp"></span>
<span class="lineno">2516 </span>
<span class="lineno">2517 </span>
<span class="lineno">2518 </span>
<span class="lineno">2519 </span>
<span class="lineno">2520 </span><span class="cp">#ifdef WIN32</span>
<span class="lineno">2521 </span><span class="cp">#include</span> <span class="cpf">&lt;win32.h&gt;</span><span class="cp"></span>
<span class="lineno">2522 </span><span class="cp">#endif</span>
<span class="lineno">2523 </span>
<span class="lineno">2524 </span><span class="c1">//#include &lt;time.h&gt;</span>
<span class="lineno">2525 </span><span class="cp">#define _USE_MATH_DEFINES</span>
<span class="lineno">2526 </span><span class="cp">#include</span> <span class="cpf">&lt;math.h&gt;</span><span class="cp"></span>
<span class="lineno">2527 </span><span class="cp">#include</span> <span class="cpf">&lt;geom.h&gt;</span><span class="cp"></span>
<span class="lineno">2528 </span><span class="cp">#include</span> <span class="cpf">&lt;parallel.h&gt;</span><span class="cp"></span>
<span class="lineno">2529 </span><span class="cp">#include</span> <span class="cpf">&lt;loader.h&gt;</span><span class="cp"></span>
<span class="lineno">2530 </span><span class="cp">#define NUM_SPHERES 5</span>
<span class="lineno">2531 </span><span class="cp">#define NUM_PLANES  1</span>
<span class="lineno">2532 </span>
<span class="lineno">2533 </span><span class="cp">#define STRFY(x) #x</span>
<span class="lineno">2534 </span><span class="cp">#define DBL_STRFY(x) STRFY(x)</span>
<span class="lineno">2535 </span>
<span class="lineno">2536 </span>
<span class="lineno">2537 </span>
<span class="lineno">2538 </span>
<span class="lineno">2539 </span>
<span class="lineno">2540 </span><span class="n">os_abs</span> <span class="n">abst</span><span class="p">;</span>
<span class="lineno">2541 </span>
<span class="lineno">2542 </span><span class="kt">void</span> <span class="nf">cast_rays</span><span class="p">(</span><span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="kt">int</span> <span class="n">height</span><span class="p">,</span> <span class="kt">uint32_t</span><span class="o">*</span> <span class="n">bmap</span><span class="p">)</span>
<span class="lineno">2543 </span><span class="p">{</span>
<span class="lineno">2544 </span>
<span class="lineno">2545 </span>
<span class="lineno">2546 </span>    <span class="c1">// unsigned width = 640, height = 480;</span>
<span class="lineno">2547 </span>    <span class="c1">// Vec3f *image = new Vec3f[width * height], *pixel = image;</span>
<span class="lineno">2548 </span>    <span class="c1">//float invWidth = 1 / (float)width, invHeight = 1 / (float)height;</span>
<span class="lineno">2549 </span>    <span class="c1">//float fov = 30, aspectratio = width / (float)height;</span>
<span class="lineno">2550 </span>    <span class="c1">//float angle = tan(M_PI * 0.5 * fov / 180.);</span>
<span class="lineno">2551 </span>
<span class="lineno">2552 </span>
<span class="lineno">2553 </span>    <span class="k">static</span> <span class="kt">float</span> <span class="n">dist</span> <span class="o">=</span> <span class="mf">5.0f</span><span class="p">;</span>
<span class="lineno">2554 </span>
<span class="lineno">2555 </span>    <span class="n">sphere</span> <span class="n">s</span><span class="p">;</span>
<span class="lineno">2556 </span>    <span class="n">xv_x</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">pos</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.0f</span><span class="p">;</span>
<span class="lineno">2557 </span>    <span class="n">xv_y</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">pos</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.0f</span><span class="p">;</span>
<span class="lineno">2558 </span>    <span class="n">xv_z</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">pos</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">dist</span><span class="p">;</span>
<span class="lineno">2559 </span>    <span class="n">s</span><span class="p">.</span><span class="n">radius</span> <span class="o">=</span> <span class="mf">1.0f</span><span class="p">;</span>
<span class="lineno">2560 </span>
<span class="lineno">2561 </span>    <span class="k">if</span><span class="p">(</span><span class="n">dist</span><span class="o">&lt;</span><span class="mf">2.0f</span><span class="p">)</span>
<span class="lineno">2562 </span>        <span class="n">dist</span> <span class="o">=</span> <span class="mf">10.0f</span><span class="p">;</span>
<span class="lineno">2563 </span>    <span class="n">dist</span> <span class="o">-=</span> <span class="mf">0.05f</span><span class="p">;</span>
<span class="lineno">2564 </span>
<span class="lineno">2565 </span>
<span class="lineno">2566 </span>    <span class="kt">int</span> <span class="n">last_time</span> <span class="o">=</span> <span class="n">os_get_time_mili</span><span class="p">(</span><span class="n">abst</span><span class="p">);</span>
<span class="lineno">2567 </span>
<span class="lineno">2568 </span>    <span class="k">const</span> <span class="n">pitch</span> <span class="o">=</span> <span class="n">width</span><span class="o">*</span><span class="mi">4</span><span class="p">;</span>
<span class="lineno">2569 </span>
<span class="lineno">2570 </span>    <span class="kt">int</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno">2571 </span>    <span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno">2572 </span>    <span class="k">for</span><span class="p">(</span><span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">height</span><span class="p">;</span> <span class="n">y</span><span class="o">++</span><span class="p">)</span>
<span class="lineno">2573 </span>    <span class="p">{</span>
<span class="lineno">2574 </span>        <span class="kt">uint32_t</span><span class="o">*</span> <span class="n">pixel</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="o">*</span><span class="p">)</span><span class="n">bmap</span><span class="p">;</span>
<span class="lineno">2575 </span>        <span class="k">for</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">width</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span>
<span class="lineno">2576 </span>        <span class="p">{</span>
<span class="lineno">2577 </span>            <span class="n">ray</span> <span class="n">out_ray</span> <span class="o">=</span> <span class="n">generate_ray</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="mi">90</span><span class="p">);</span>
<span class="lineno">2578 </span>            <span class="kt">float</span> <span class="n">dist</span> <span class="o">=</span>  <span class="n">does_collide_sphere</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">out_ray</span><span class="p">);</span>
<span class="lineno">2579 </span>            <span class="o">*</span><span class="n">pixel</span> <span class="o">=</span> <span class="n">dist</span> <span class="o">!=</span> <span class="o">-</span><span class="mf">1.0f</span> <span class="o">?</span> <span class="mh">0x00ffffff</span> <span class="o">&amp;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">dist</span><span class="o">*</span><span class="mi">100</span> <span class="o">:</span> <span class="mh">0x00000000</span><span class="p">;</span>
<span class="lineno">2580 </span>            <span class="c1">//*pixel = 0x000000ff | ((uint32_t)((uint8_t)(y)))&lt;&lt;16;</span>
<span class="lineno">2581 </span>            <span class="n">pixel</span><span class="o">++</span><span class="p">;</span>
<span class="lineno">2582 </span>        <span class="p">}</span>
<span class="lineno">2583 </span>        <span class="n">bmap</span> <span class="o">+=</span> <span class="n">width</span><span class="p">;</span>
<span class="lineno">2584 </span>    <span class="p">}</span>
<span class="lineno">2585 </span>    <span class="cm">/* float stest = 0.0f; */</span>
<span class="lineno">2586 </span>
<span class="lineno">2587 </span>    <span class="cm">/* // compute 1e8 times either Sqrt(x) or its emulation as Pow(x, 0.5) */</span>
<span class="lineno">2588 </span>    <span class="cm">/* for (float d = 0; d &lt; width*height*2; d += 1) */</span>
<span class="lineno">2589 </span>    <span class="cm">/*     // s += Math.Sqrt(d);  // &lt;- uncomment it to test Sqrt */</span>
<span class="lineno">2590 </span>    <span class="cm">/*     stest += sqrt(d*d); // &lt;- uncomment it to test Pow */</span>
<span class="lineno">2591 </span>
<span class="lineno">2592 </span>
<span class="lineno">2593 </span>    <span class="n">printf</span><span class="p">(</span><span class="s">"frame took: %i ms</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">os_get_time_mili</span><span class="p">(</span><span class="n">abst</span><span class="p">)</span><span class="o">-</span><span class="n">last_time</span><span class="p">);</span>
<span class="lineno">2594 </span>
<span class="lineno">2595 </span><span class="p">}</span>
<span class="lineno">2596 </span>
<span class="lineno">2597 </span><span class="kt">bool</span> <span class="n">should_run</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="lineno">2598 </span><span class="kt">bool</span> <span class="n">should_pause</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="lineno">2599 </span><span class="kt">void</span> <span class="nf">loop_exit</span><span class="p">()</span>
<span class="lineno">2600 </span><span class="p">{</span>
<span class="lineno">2601 </span>    <span class="n">should_run</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="lineno">2602 </span><span class="p">}</span>
<span class="lineno">2603 </span><span class="kt">void</span> <span class="nf">loop_pause</span><span class="p">()</span>
<span class="lineno">2604 </span><span class="p">{</span>
<span class="lineno">2605 </span>    <span class="n">should_pause</span> <span class="o">=</span> <span class="o">!</span><span class="n">should_pause</span><span class="p">;</span>
<span class="lineno">2606 </span><span class="p">}</span>
<span class="lineno">2607 </span>
<span class="lineno">2608 </span><span class="kt">void</span> <span class="nf">run</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">unnused_rn</span><span class="p">)</span>
<span class="lineno">2609 </span><span class="p">{</span>
<span class="lineno">2610 </span>
<span class="lineno">2611 </span>    <span class="kt">char</span> <span class="n">isMeme</span> <span class="o">=</span> <span class="sc">'y'</span><span class="p">;</span>
<span class="lineno">2612 </span>    <span class="c1">//scanf("%c", &amp;isMeme);</span>
<span class="lineno">2613 </span>
<span class="lineno">2614 </span>    <span class="k">if</span><span class="p">(</span><span class="n">isMeme</span><span class="o">==</span><span class="sc">'y'</span><span class="p">)</span>
<span class="lineno">2615 </span>    <span class="p">{</span>
<span class="lineno">2616 </span>        <span class="k">const</span> <span class="kt">int</span> <span class="n">width</span> <span class="o">=</span> <span class="n">os_get_width</span><span class="p">(</span><span class="n">abst</span><span class="p">);</span>
<span class="lineno">2617 </span>        <span class="k">const</span> <span class="kt">int</span> <span class="n">height</span> <span class="o">=</span> <span class="n">os_get_height</span><span class="p">(</span><span class="n">abst</span><span class="p">);</span>
<span class="lineno">2618 </span>
<span class="lineno">2619 </span>        <span class="k">const</span> <span class="kt">int</span> <span class="n">pitch</span> <span class="o">=</span> <span class="n">width</span> <span class="o">*</span><span class="mi">4</span><span class="p">;</span>
<span class="lineno">2620 </span>        <span class="kt">uint32_t</span><span class="o">*</span> <span class="n">row</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="o">*</span><span class="p">)</span><span class="n">os_get_bitmap_memory</span><span class="p">(</span><span class="n">abst</span><span class="p">);</span>
<span class="lineno">2621 </span>
<span class="lineno">2622 </span>        <span class="n">cl_info</span><span class="p">();</span>
<span class="lineno">2623 </span>
<span class="lineno">2624 </span>        <span class="n">rcl_ctx</span><span class="o">*</span> <span class="n">rcl</span> <span class="o">=</span> <span class="p">(</span><span class="n">rcl_ctx</span><span class="o">*</span><span class="p">)</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">rcl_ctx</span><span class="p">));</span>
<span class="lineno">2625 </span>        <span class="n">create_context</span><span class="p">(</span><span class="n">rcl</span><span class="p">);</span>
<span class="lineno">2626 </span>
<span class="lineno">2627 </span>        <span class="n">raytracer_context</span><span class="o">*</span> <span class="n">rctx</span> <span class="o">=</span> <span class="n">raytracer_init</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">width</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">height</span><span class="p">,</span>
<span class="lineno">2628 </span>                                                 <span class="n">row</span><span class="p">,</span> <span class="n">rcl</span><span class="p">);</span>
<span class="lineno">2629 </span>        <span class="c1">//scene* rscene = (scene*) malloc(sizeof(scene));</span>
<span class="lineno">2630 </span>        <span class="n">scene</span><span class="o">*</span> <span class="n">rscene</span> <span class="o">=</span> <span class="n">load_scene_json_url</span><span class="p">(</span><span class="s">"scenes/path_test.rsc"</span><span class="p">);</span>
<span class="lineno">2631 </span>
<span class="lineno">2632 </span>        <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">stat_scene</span> <span class="o">=</span> <span class="n">rscene</span><span class="p">;</span>
<span class="lineno">2633 </span>        <span class="n">rctx</span><span class="o">-&gt;</span><span class="n">num_samples</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
<span class="lineno">2634 </span>
<span class="lineno">2635 </span>        <span class="n">raytracer_prepass</span><span class="p">(</span><span class="n">rctx</span><span class="p">);</span>
<span class="lineno">2636 </span>
<span class="lineno">2637 </span>        <span class="n">xm4_identity</span><span class="p">(</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">stat_scene</span><span class="o">-&gt;</span><span class="n">camera_world_matrix</span><span class="p">);</span>
<span class="lineno">2638 </span>
<span class="lineno">2639 </span>        <span class="kt">float</span> <span class="n">dist</span> <span class="o">=</span> <span class="mf">0.f</span><span class="p">;</span>
<span class="lineno">2640 </span>
<span class="lineno">2641 </span>
<span class="lineno">2642 </span>        <span class="kt">int</span> <span class="n">_timer_store</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno">2643 </span>        <span class="kt">int</span> <span class="n">_timer_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno">2644 </span>        <span class="kt">float</span> <span class="n">_timer_average</span> <span class="o">=</span> <span class="mf">0.0f</span><span class="p">;</span>
<span class="lineno">2645 </span>        <span class="n">printf</span><span class="p">(</span><span class="s">"Rendering:</span><span class="se">\n\n</span><span class="s">"</span><span class="p">);</span>
<span class="lineno">2646 </span>
<span class="lineno">2647 </span>        <span class="cm">/* static float t = 0.0f; */</span>
<span class="lineno">2648 </span>        <span class="cm">/* t += 0.0005f; */</span>
<span class="lineno">2649 </span>        <span class="cm">/* dist = sin(t)+1; */</span>
<span class="lineno">2650 </span>        <span class="cm">/* //mat4 temp; */</span>
<span class="lineno">2651 </span>        <span class="cm">/* xm4_translatev(rctx-&gt;stat_scene-&gt;camera_world_matrix, 0, dist, 0); */</span>
<span class="lineno">2652 </span>        <span class="kt">int</span> <span class="n">real_start</span> <span class="o">=</span> <span class="n">os_get_time_mili</span><span class="p">(</span><span class="n">abst</span><span class="p">);</span>
<span class="lineno">2653 </span>        <span class="k">while</span><span class="p">(</span><span class="n">should_run</span><span class="p">)</span>
<span class="lineno">2654 </span>        <span class="p">{</span>
<span class="lineno">2655 </span>
<span class="lineno">2656 </span>            <span class="k">if</span><span class="p">(</span><span class="n">should_pause</span><span class="p">)</span>
<span class="lineno">2657 </span>                <span class="k">continue</span><span class="p">;</span>
<span class="lineno">2658 </span>            <span class="kt">int</span> <span class="n">last_time</span> <span class="o">=</span> <span class="n">os_get_time_mili</span><span class="p">(</span><span class="n">abst</span><span class="p">);</span>
<span class="lineno">2659 </span>
<span class="lineno">2660 </span>            <span class="k">if</span><span class="p">(</span><span class="n">kbhit</span><span class="p">())</span>
<span class="lineno">2661 </span>            <span class="p">{</span>
<span class="lineno">2662 </span>                <span class="k">switch</span> <span class="p">(</span><span class="n">getch</span><span class="p">())</span>
<span class="lineno">2663 </span>                <span class="p">{</span>
<span class="lineno">2664 </span>                <span class="k">case</span> <span class="sc">'c'</span><span class="o">:</span>
<span class="lineno">2665 </span>                    <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="lineno">2666 </span>                    <span class="k">break</span><span class="p">;</span>
<span class="lineno">2667 </span>                <span class="k">case</span> <span class="mi">27</span><span class="o">:</span> <span class="c1">//ESCAPE</span>
<span class="lineno">2668 </span>                    <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="lineno">2669 </span>                    <span class="k">break</span><span class="p">;</span>
<span class="lineno">2670 </span>                <span class="k">default</span><span class="o">:</span>
<span class="lineno">2671 </span>                    <span class="k">break</span><span class="p">;</span>
<span class="lineno">2672 </span>                <span class="p">}</span>
<span class="lineno">2673 </span>            <span class="p">}</span>
<span class="lineno">2674 </span>
<span class="lineno">2675 </span>            <span class="n">raytracer_refined_render</span><span class="p">(</span><span class="n">rctx</span><span class="p">);</span>
<span class="lineno">2676 </span>            <span class="k">if</span><span class="p">(</span><span class="n">rctx</span><span class="o">-&gt;</span><span class="n">render_complete</span><span class="p">)</span>
<span class="lineno">2677 </span>            <span class="p">{</span>
<span class="lineno">2678 </span>                <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n\n</span><span class="s">Render took: %02i ms</span><span class="se">\n\n</span><span class="s">"</span><span class="p">,</span> <span class="n">os_get_time_mili</span><span class="p">(</span><span class="n">abst</span><span class="p">)</span><span class="o">-</span><span class="n">real_start</span><span class="p">);</span>
<span class="lineno">2679 </span>                <span class="k">break</span><span class="p">;</span>
<span class="lineno">2680 </span>            <span class="p">}</span>
<span class="lineno">2681 </span>
<span class="lineno">2682 </span>
<span class="lineno">2683 </span>            <span class="kt">int</span> <span class="n">mili</span> <span class="o">=</span> <span class="n">os_get_time_mili</span><span class="p">(</span><span class="n">abst</span><span class="p">)</span><span class="o">-</span><span class="n">last_time</span><span class="p">;</span>
<span class="lineno">2684 </span>            <span class="n">_timer_store</span> <span class="o">+=</span> <span class="n">mili</span><span class="p">;</span>
<span class="lineno">2685 </span>            <span class="n">_timer_counter</span><span class="o">++</span><span class="p">;</span>
<span class="lineno">2686 </span>            <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\r</span><span class="s">Frame took: %02i ms, average per 20 frames: %0.2f, avg fps: %03.2f    "</span><span class="p">,</span> <span class="n">mili</span><span class="p">,</span> <span class="n">_timer_average</span><span class="p">,</span> <span class="mf">1000.0f</span><span class="o">/</span><span class="n">_timer_average</span><span class="p">);</span>
<span class="lineno">2687 </span>
<span class="lineno">2688 </span>            <span class="k">if</span><span class="p">(</span><span class="n">_timer_counter</span><span class="o">&gt;</span><span class="mi">20</span><span class="p">)</span>
<span class="lineno">2689 </span>            <span class="p">{</span>
<span class="lineno">2690 </span>                <span class="n">_timer_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno">2691 </span>                <span class="n">_timer_average</span> <span class="o">=</span> <span class="p">(</span><span class="kt">float</span><span class="p">)(</span><span class="n">_timer_store</span><span class="p">)</span><span class="o">/</span><span class="mf">20.f</span><span class="p">;</span>
<span class="lineno">2692 </span>                <span class="n">_timer_store</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno">2693 </span>            <span class="p">}</span>
<span class="lineno">2694 </span>            <span class="n">os_update</span><span class="p">(</span><span class="n">abst</span><span class="p">);</span>
<span class="lineno">2695 </span>        <span class="p">}</span>
<span class="lineno">2696 </span>
<span class="lineno">2697 </span>    <span class="p">}</span>
<span class="lineno">2698 </span>
<span class="lineno">2699 </span>
<span class="lineno">2700 </span><span class="p">}</span>
<span class="lineno">2701 </span>
<span class="lineno">2702 </span>
<span class="lineno">2703 </span><span class="kt">int</span> <span class="nf">startup</span><span class="p">()</span> <span class="c1">//main function called from win32 abstraction</span>
<span class="lineno">2704 </span><span class="p">{</span>
<span class="lineno">2705 </span><span class="cp">#ifdef WIN32</span>
<span class="lineno">2706 </span>    <span class="n">abst</span> <span class="o">=</span> <span class="n">init_win32_abs</span><span class="p">();</span>
<span class="lineno">2707 </span><span class="cp">#endif</span>
<span class="lineno">2708 </span>    <span class="n">os_start</span><span class="p">(</span><span class="n">abst</span><span class="p">);</span>
<span class="lineno">2709 </span>    <span class="n">os_start_thread</span><span class="p">(</span><span class="n">abst</span><span class="p">,</span> <span class="n">run</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="lineno">2710 </span>    <span class="c1">//win32_start_thread(run, NULL);</span>
<span class="lineno">2711 </span>
<span class="lineno">2712 </span>    <span class="n">os_loop_start</span><span class="p">(</span><span class="n">abst</span><span class="p">);</span>
<span class="lineno">2713 </span>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno">2714 </span>    <span class="cm">/*</span>
<span class="lineno">2715 </span><span class="cm">    printf("Hello World\n");</span>
<span class="lineno">2716 </span><span class="cm">    testWin32();</span>
<span class="lineno">2717 </span><span class="cm">    return 0;*/</span>
<span class="lineno">2718 </span><span class="p">}</span>
<span class="lineno">2719 </span>
<span class="lineno">2720 </span><span class="cm">/***********/</span>
<span class="lineno">2721 </span><span class="cm">/* win32.c */</span>
<span class="lineno">2722 </span><span class="cm">/***********/</span>
<span class="lineno">2723 </span>
<span class="lineno">2724 </span><span class="cp">#include</span> <span class="cpf">&lt;win32.h&gt;</span><span class="cp"></span>
<span class="lineno">2725 </span><span class="cp">#include</span> <span class="cpf">&lt;startup.h&gt;</span><span class="cp"></span>
<span class="lineno">2726 </span><span class="cp">#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp"></span>
<span class="lineno">2727 </span><span class="cp">#include</span> <span class="cpf">&lt;math.h&gt;</span><span class="cp"></span>
<span class="lineno">2728 </span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="lineno">2729 </span><span class="cp">#include</span> <span class="cpf">&lt;stdint.h&gt;</span><span class="cp"></span>
<span class="lineno">2730 </span><span class="cp">#include</span> <span class="cpf">&lt;assert.h&gt;</span><span class="cp"></span>
<span class="lineno">2731 </span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="lineno">2732 </span><span class="cp">#include</span> <span class="cpf">&lt;io.h&gt;</span><span class="cp"></span>
<span class="lineno">2733 </span><span class="cp">#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp"></span>
<span class="lineno">2734 </span><span class="k">const</span> <span class="kt">char</span> <span class="n">CLASS_NAME</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"Raytracer"</span><span class="p">;</span>
<span class="lineno">2735 </span>
<span class="lineno">2736 </span>
<span class="lineno">2737 </span><span class="k">static</span> <span class="n">win32_context</span><span class="o">*</span> <span class="n">ctx</span><span class="p">;</span>
<span class="lineno">2738 </span>
<span class="lineno">2739 </span>
<span class="lineno">2740 </span><span class="n">os_abs</span> <span class="nf">init_win32_abs</span><span class="p">()</span>
<span class="lineno">2741 </span><span class="p">{</span>
<span class="lineno">2742 </span>    <span class="n">os_abs</span> <span class="n">abstraction</span><span class="p">;</span>
<span class="lineno">2743 </span>    <span class="n">abstraction</span><span class="p">.</span><span class="n">start_func</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">win32_start</span><span class="p">;</span>
<span class="lineno">2744 </span>    <span class="n">abstraction</span><span class="p">.</span><span class="n">loop_start_func</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">win32_loop</span><span class="p">;</span>
<span class="lineno">2745 </span>    <span class="n">abstraction</span><span class="p">.</span><span class="n">update_func</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">win32_update</span><span class="p">;</span>
<span class="lineno">2746 </span>    <span class="n">abstraction</span><span class="p">.</span><span class="n">sleep_func</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">win32_sleep</span><span class="p">;</span>
<span class="lineno">2747 </span>    <span class="n">abstraction</span><span class="p">.</span><span class="n">get_bitmap_memory_func</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">win32_get_bitmap_memory</span><span class="p">;</span>
<span class="lineno">2748 </span>    <span class="n">abstraction</span><span class="p">.</span><span class="n">get_time_mili_func</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">win32_get_time_mili</span><span class="p">;</span>
<span class="lineno">2749 </span>    <span class="n">abstraction</span><span class="p">.</span><span class="n">get_width_func</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">win32_get_width</span><span class="p">;</span>
<span class="lineno">2750 </span>    <span class="n">abstraction</span><span class="p">.</span><span class="n">get_height_func</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">win32_get_height</span><span class="p">;</span>
<span class="lineno">2751 </span>    <span class="n">abstraction</span><span class="p">.</span><span class="n">start_thread_func</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">win32_start_thread</span><span class="p">;</span>
<span class="lineno">2752 </span>    <span class="k">return</span> <span class="n">abstraction</span><span class="p">;</span>
<span class="lineno">2753 </span><span class="p">}</span>
<span class="lineno">2754 </span>
<span class="lineno">2755 </span><span class="kt">void</span><span class="o">*</span> <span class="nf">get_bitmap_memory</span><span class="p">()</span>
<span class="lineno">2756 </span><span class="p">{</span>
<span class="lineno">2757 </span>    <span class="k">return</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bitmap_memory</span><span class="p">;</span>
<span class="lineno">2758 </span><span class="p">}</span>
<span class="lineno">2759 </span>
<span class="lineno">2760 </span><span class="kt">void</span> <span class="nf">win32_draw_meme</span><span class="p">()</span>
<span class="lineno">2761 </span><span class="p">{</span>
<span class="lineno">2762 </span>    <span class="kt">int</span> <span class="n">width</span>  <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
<span class="lineno">2763 </span>    <span class="kt">int</span> <span class="n">height</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
<span class="lineno">2764 </span>
<span class="lineno">2765 </span>    <span class="kt">int</span> <span class="n">pitch</span> <span class="o">=</span> <span class="n">width</span><span class="o">*</span><span class="mi">4</span><span class="p">;</span>
<span class="lineno">2766 </span>    <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">row</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bitmap_memory</span><span class="p">;</span>
<span class="lineno">2767 </span>
<span class="lineno">2768 </span>    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">height</span><span class="p">;</span> <span class="n">y</span><span class="o">++</span><span class="p">)</span>
<span class="lineno">2769 </span>    <span class="p">{</span>
<span class="lineno">2770 </span>        <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">pixel</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span><span class="n">row</span><span class="p">;</span>
<span class="lineno">2771 </span>        <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">width</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span>
<span class="lineno">2772 </span>        <span class="p">{</span>
<span class="lineno">2773 </span>            <span class="o">*</span><span class="n">pixel</span> <span class="o">=</span> <span class="n">sin</span><span class="p">(((</span><span class="kt">float</span><span class="p">)</span><span class="n">x</span><span class="p">)</span><span class="o">/</span><span class="mi">150</span><span class="p">)</span><span class="o">*</span><span class="mi">255</span><span class="p">;</span>
<span class="lineno">2774 </span>            <span class="o">++</span><span class="n">pixel</span><span class="p">;</span>
<span class="lineno">2775 </span>
<span class="lineno">2776 </span>            <span class="o">*</span><span class="n">pixel</span> <span class="o">=</span> <span class="n">cos</span><span class="p">(((</span><span class="kt">float</span><span class="p">)</span><span class="n">x</span><span class="p">)</span><span class="o">/</span><span class="mi">10</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">;</span>
<span class="lineno">2777 </span>            <span class="o">++</span><span class="n">pixel</span><span class="p">;</span>
<span class="lineno">2778 </span>
<span class="lineno">2779 </span>            <span class="o">*</span><span class="n">pixel</span> <span class="o">=</span> <span class="n">cos</span><span class="p">(((</span><span class="kt">float</span><span class="p">)</span><span class="n">y</span><span class="p">)</span><span class="o">/</span><span class="mi">50</span><span class="p">)</span><span class="o">*</span><span class="mi">255</span><span class="p">;</span>
<span class="lineno">2780 </span>            <span class="o">++</span><span class="n">pixel</span><span class="p">;</span>
<span class="lineno">2781 </span>
<span class="lineno">2782 </span>            <span class="o">*</span><span class="n">pixel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno">2783 </span>            <span class="o">++</span><span class="n">pixel</span><span class="p">;</span>
<span class="lineno">2784 </span>            <span class="cm">/* ((char*)ctx-&gt;bitmap_memory)[(x+y*width)*4]   =  (y%2) ? 0xff : 0x00; */</span>
<span class="lineno">2785 </span>            <span class="cm">/* ((char*)ctx-&gt;bitmap_memory)[(x*4+y*width)+1] =  0x00; */</span>
<span class="lineno">2786 </span>            <span class="cm">/* ((char*)ctx-&gt;bitmap_memory)[(x*4+y*width)+2] =  (y%2) ? 0xff : 0x00; */</span>
<span class="lineno">2787 </span>            <span class="cm">/* ((char*)ctx-&gt;bitmap_memory)[(x*4+y*width)+3] =  0x00; */</span>
<span class="lineno">2788 </span>        <span class="p">}</span>
<span class="lineno">2789 </span>        <span class="n">row</span> <span class="o">+=</span> <span class="n">pitch</span><span class="p">;</span>
<span class="lineno">2790 </span>    <span class="p">}</span>
<span class="lineno">2791 </span><span class="p">}</span>
<span class="lineno">2792 </span>
<span class="lineno">2793 </span><span class="kt">void</span> <span class="nf">win32_sleep</span><span class="p">(</span><span class="kt">int</span> <span class="n">mili</span><span class="p">)</span>
<span class="lineno">2794 </span><span class="p">{</span>
<span class="lineno">2795 </span>    <span class="n">Sleep</span><span class="p">(</span><span class="n">mili</span><span class="p">);</span>
<span class="lineno">2796 </span><span class="p">}</span>
<span class="lineno">2797 </span>
<span class="lineno">2798 </span><span class="kt">void</span> <span class="nf">win32_resize_dib_section</span><span class="p">(</span><span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="kt">int</span> <span class="n">height</span><span class="p">)</span>
<span class="lineno">2799 </span><span class="p">{</span>
<span class="lineno">2800 </span>    <span class="k">if</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bitmap_memory</span><span class="p">)</span>
<span class="lineno">2801 </span>        <span class="n">VirtualFree</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bitmap_memory</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MEM_RELEASE</span><span class="p">);</span>
<span class="lineno">2802 </span>
<span class="lineno">2803 </span>    <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">width</span><span class="p">;</span>
<span class="lineno">2804 </span>    <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">height</span><span class="p">;</span>
<span class="lineno">2805 </span>
<span class="lineno">2806 </span>    <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">bmiHeader</span><span class="p">.</span><span class="n">biSize</span>          <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">bmiHeader</span><span class="p">);</span>
<span class="lineno">2807 </span>    <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">bmiHeader</span><span class="p">.</span><span class="n">biWidth</span>         <span class="o">=</span> <span class="n">width</span><span class="p">;</span>
<span class="lineno">2808 </span>    <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">bmiHeader</span><span class="p">.</span><span class="n">biHeight</span>        <span class="o">=</span> <span class="o">-</span><span class="n">height</span><span class="p">;</span>
<span class="lineno">2809 </span>    <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">bmiHeader</span><span class="p">.</span><span class="n">biPlanes</span>        <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="lineno">2810 </span>    <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">bmiHeader</span><span class="p">.</span><span class="n">biBitCount</span>      <span class="o">=</span> <span class="mi">32</span><span class="p">;</span> <span class="c1">//8 bits of paddingll</span>
<span class="lineno">2811 </span>    <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">bmiHeader</span><span class="p">.</span><span class="n">biCompression</span>   <span class="o">=</span> <span class="n">BI_RGB</span><span class="p">;</span>
<span class="lineno">2812 </span>    <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">bmiHeader</span><span class="p">.</span><span class="n">biSizeImage</span>     <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno">2813 </span>    <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">bmiHeader</span><span class="p">.</span><span class="n">biXPelsPerMeter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno">2814 </span>    <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">bmiHeader</span><span class="p">.</span><span class="n">biYPelsPerMeter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno">2815 </span>    <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">bmiHeader</span><span class="p">.</span><span class="n">biClrUsed</span>       <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno">2816 </span>    <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">.</span><span class="n">bmiHeader</span><span class="p">.</span><span class="n">biClrImportant</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno">2817 </span>
<span class="lineno">2818 </span>    <span class="c1">//I could use BitBlit if it would increase spead.</span>
<span class="lineno">2819 </span>    <span class="kt">int</span> <span class="n">bytes_per_pixel</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
<span class="lineno">2820 </span>    <span class="kt">int</span> <span class="n">bitmap_memory_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">width</span><span class="o">*</span><span class="n">height</span><span class="p">)</span><span class="o">*</span><span class="n">bytes_per_pixel</span><span class="p">;</span>
<span class="lineno">2821 </span>    <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bitmap_memory</span> <span class="o">=</span> <span class="n">VirtualAlloc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">bitmap_memory_size</span><span class="p">,</span> <span class="n">MEM_COMMIT</span><span class="p">,</span> <span class="n">PAGE_READWRITE</span><span class="p">);</span>
<span class="lineno">2822 </span>
<span class="lineno">2823 </span><span class="p">}</span>
<span class="lineno">2824 </span>
<span class="lineno">2825 </span><span class="kt">void</span> <span class="nf">win32_update_window</span><span class="p">(</span><span class="n">HDC</span> <span class="n">device_context</span><span class="p">,</span> <span class="n">HWND</span> <span class="n">win</span><span class="p">,</span> <span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="kt">int</span> <span class="n">height</span><span class="p">)</span>
<span class="lineno">2826 </span><span class="p">{</span>
<span class="lineno">2827 </span>
<span class="lineno">2828 </span>    <span class="kt">int</span> <span class="n">window_height</span> <span class="o">=</span> <span class="n">height</span><span class="p">;</span><span class="c1">//window_rect.bottom - window_rect.top;</span>
<span class="lineno">2829 </span>    <span class="kt">int</span> <span class="n">window_width</span>  <span class="o">=</span> <span class="n">width</span><span class="p">;</span><span class="c1">//window_rect.right - window_rect.left;</span>
<span class="lineno">2830 </span>
<span class="lineno">2831 </span>
<span class="lineno">2832 </span>    <span class="c1">//TODO: Replace with BitBlt this is way too slow... (we don't even need the scaling);</span>
<span class="lineno">2833 </span>    <span class="n">StretchDIBits</span><span class="p">(</span><span class="n">device_context</span><span class="p">,</span>
<span class="lineno">2834 </span>                  <span class="cm">/* x, y, width, height, */</span>
<span class="lineno">2835 </span>                  <span class="cm">/* x, y, width, height, */</span>
<span class="lineno">2836 </span>                  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span>
<span class="lineno">2837 </span>                  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">window_width</span><span class="p">,</span> <span class="n">window_height</span><span class="p">,</span>
<span class="lineno">2838 </span>
<span class="lineno">2839 </span>                  <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bitmap_memory</span><span class="p">,</span>
<span class="lineno">2840 </span>                  <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bitmap_info</span><span class="p">,</span>
<span class="lineno">2841 </span>                  <span class="n">DIB_RGB_COLORS</span><span class="p">,</span> <span class="n">SRCCOPY</span><span class="p">);</span>
<span class="lineno">2842 </span><span class="p">}</span>
<span class="lineno">2843 </span>
<span class="lineno">2844 </span>
<span class="lineno">2845 </span><span class="n">LRESULT</span> <span class="n">CALLBACK</span> <span class="nf">WndProc</span><span class="p">(</span><span class="n">HWND</span> <span class="n">win</span><span class="p">,</span> <span class="n">UINT</span> <span class="n">msg</span><span class="p">,</span> <span class="n">WPARAM</span> <span class="n">wParam</span><span class="p">,</span> <span class="n">LPARAM</span> <span class="n">lParam</span><span class="p">)</span>
<span class="lineno">2846 </span><span class="p">{</span>
<span class="lineno">2847 </span>    <span class="k">switch</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<span class="lineno">2848 </span>    <span class="p">{</span>
<span class="lineno">2849 </span>    <span class="k">case</span> <span class="nl">WM_KEYDOWN</span><span class="p">:</span>
<span class="lineno">2850 </span>        <span class="k">switch</span> <span class="p">(</span><span class="n">wParam</span><span class="p">)</span>
<span class="lineno">2851 </span>        <span class="p">{</span>
<span class="lineno">2852 </span>        <span class="k">case</span> <span class="nl">VK_ESCAPE</span><span class="p">:</span>
<span class="lineno">2853 </span>            <span class="n">loop_exit</span><span class="p">();</span>
<span class="lineno">2854 </span>            <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">shouldRun</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="lineno">2855 </span>            <span class="k">break</span><span class="p">;</span>
<span class="lineno">2856 </span>
<span class="lineno">2857 </span>        <span class="k">case</span> <span class="nl">VK_SPACE</span><span class="p">:</span>
<span class="lineno">2858 </span>            <span class="n">loop_pause</span><span class="p">();</span>
<span class="lineno">2859 </span>            <span class="k">break</span><span class="p">;</span>
<span class="lineno">2860 </span>        <span class="k">default</span><span class="o">:</span>
<span class="lineno">2861 </span>            <span class="k">break</span><span class="p">;</span>
<span class="lineno">2862 </span>        <span class="p">}</span>
<span class="lineno">2863 </span>        <span class="k">break</span><span class="p">;</span>
<span class="lineno">2864 </span>    <span class="k">case</span> <span class="nl">WM_SIZE</span><span class="p">:</span>
<span class="lineno">2865 </span>    <span class="p">{</span>
<span class="lineno">2866 </span>        <span class="n">RECT</span> <span class="n">drawable_rect</span><span class="p">;</span>
<span class="lineno">2867 </span>        <span class="n">GetClientRect</span><span class="p">(</span><span class="n">win</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">drawable_rect</span><span class="p">);</span>
<span class="lineno">2868 </span>
<span class="lineno">2869 </span>        <span class="kt">int</span> <span class="n">height</span> <span class="o">=</span> <span class="n">drawable_rect</span><span class="p">.</span><span class="n">bottom</span> <span class="o">-</span> <span class="n">drawable_rect</span><span class="p">.</span><span class="n">top</span><span class="p">;</span>
<span class="lineno">2870 </span>        <span class="kt">int</span> <span class="n">width</span>  <span class="o">=</span> <span class="n">drawable_rect</span><span class="p">.</span><span class="n">right</span> <span class="o">-</span> <span class="n">drawable_rect</span><span class="p">.</span><span class="n">left</span><span class="p">;</span>
<span class="lineno">2871 </span>        <span class="n">win32_resize_dib_section</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">);</span>
<span class="lineno">2872 </span>
<span class="lineno">2873 </span>        <span class="n">win32_draw_meme</span><span class="p">();</span>
<span class="lineno">2874 </span>    <span class="p">}</span> <span class="k">break</span><span class="p">;</span>
<span class="lineno">2875 </span>    <span class="k">case</span> <span class="nl">WM_CLOSE</span><span class="p">:</span>
<span class="lineno">2876 </span>        <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">shouldRun</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="lineno">2877 </span>        <span class="k">break</span><span class="p">;</span>
<span class="lineno">2878 </span>    <span class="k">case</span> <span class="nl">WM_DESTROY</span><span class="p">:</span>
<span class="lineno">2879 </span>        <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">shouldRun</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="lineno">2880 </span>        <span class="k">break</span><span class="p">;</span>
<span class="lineno">2881 </span>    <span class="k">case</span> <span class="nl">WM_ACTIVATEAPP</span><span class="p">:</span>
<span class="lineno">2882 </span>        <span class="n">OutputDebugStringA</span><span class="p">(</span><span class="s">"WM_ACTIVATEAPP</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="lineno">2883 </span>        <span class="k">break</span><span class="p">;</span>
<span class="lineno">2884 </span>    <span class="k">case</span> <span class="nl">WM_PAINT</span><span class="p">:</span>
<span class="lineno">2885 </span>    <span class="p">{</span>
<span class="lineno">2886 </span>        <span class="n">PAINTSTRUCT</span> <span class="n">paint</span><span class="p">;</span>
<span class="lineno">2887 </span>        <span class="n">HDC</span> <span class="n">device_context</span> <span class="o">=</span> <span class="n">BeginPaint</span><span class="p">(</span><span class="n">win</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">paint</span><span class="p">);</span>
<span class="lineno">2888 </span>        <span class="n">EndPaint</span><span class="p">(</span><span class="n">win</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">paint</span><span class="p">);</span>
<span class="lineno">2889 </span>
<span class="lineno">2890 </span>        <span class="cm">/*int x = paint.rcPaint.left;</span>
<span class="lineno">2891 </span><span class="cm">        int y = paint.rcPaint.top;</span>
<span class="lineno">2892 </span><span class="cm">        int height = paint.rcPaint.bottom - paint.rcPaint.top;</span>
<span class="lineno">2893 </span><span class="cm">        int width  = paint.rcPaint.right - paint.rcPaint.left;*/</span>
<span class="lineno">2894 </span>        <span class="c1">//PatBlt(device_context, x, y, width, height, BLACKNESS);</span>
<span class="lineno">2895 </span>
<span class="lineno">2896 </span>        <span class="n">RECT</span> <span class="n">drawable_rect</span><span class="p">;</span>
<span class="lineno">2897 </span>        <span class="n">GetClientRect</span><span class="p">(</span><span class="n">win</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">drawable_rect</span><span class="p">);</span>
<span class="lineno">2898 </span>
<span class="lineno">2899 </span>        <span class="kt">int</span> <span class="n">height</span> <span class="o">=</span> <span class="n">drawable_rect</span><span class="p">.</span><span class="n">bottom</span> <span class="o">-</span> <span class="n">drawable_rect</span><span class="p">.</span><span class="n">top</span><span class="p">;</span>
<span class="lineno">2900 </span>        <span class="kt">int</span> <span class="n">width</span>  <span class="o">=</span> <span class="n">drawable_rect</span><span class="p">.</span><span class="n">right</span> <span class="o">-</span> <span class="n">drawable_rect</span><span class="p">.</span><span class="n">left</span><span class="p">;</span>
<span class="lineno">2901 </span>
<span class="lineno">2902 </span>        <span class="n">GetClientRect</span><span class="p">(</span><span class="n">win</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">drawable_rect</span><span class="p">);</span>
<span class="lineno">2903 </span>        <span class="n">win32_update_window</span><span class="p">(</span><span class="n">device_context</span><span class="p">,</span>
<span class="lineno">2904 </span>                            <span class="n">win</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">);</span>
<span class="lineno">2905 </span>
<span class="lineno">2906 </span>    <span class="p">}</span> <span class="k">break</span><span class="p">;</span>
<span class="lineno">2907 </span>    <span class="k">default</span><span class="o">:</span>
<span class="lineno">2908 </span>        <span class="k">return</span> <span class="n">DefWindowProc</span><span class="p">(</span><span class="n">win</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">wParam</span><span class="p">,</span> <span class="n">lParam</span><span class="p">);</span>
<span class="lineno">2909 </span>    <span class="p">}</span>
<span class="lineno">2910 </span>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno">2911 </span><span class="p">}</span>
<span class="lineno">2912 </span>
<span class="lineno">2913 </span>
<span class="lineno">2914 </span>
<span class="lineno">2915 </span><span class="kt">int</span> <span class="nf">_WinMain</span><span class="p">(</span><span class="n">HINSTANCE</span> <span class="n">hInstance</span><span class="p">,</span> <span class="n">HINSTANCE</span> <span class="n">hPrevInstance</span><span class="p">,</span>
<span class="lineno">2916 </span>                   <span class="n">LPSTR</span> <span class="n">lpCmdLine</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nCmdShow</span><span class="p">)</span>
<span class="lineno">2917 </span><span class="p">{</span>
<span class="lineno">2918 </span>
<span class="lineno">2919 </span>    <span class="n">ctx</span> <span class="o">=</span> <span class="p">(</span><span class="n">win32_context</span><span class="o">*</span><span class="p">)</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">win32_context</span><span class="p">));</span>
<span class="lineno">2920 </span>
<span class="lineno">2921 </span>    <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">instance</span> <span class="o">=</span> <span class="n">hInstance</span><span class="p">;</span>
<span class="lineno">2922 </span>    <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">nCmdShow</span> <span class="o">=</span> <span class="n">nCmdShow</span><span class="p">;</span>
<span class="lineno">2923 </span>    <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">wc</span><span class="p">.</span><span class="n">cbSize</span>        <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">WNDCLASSEX</span><span class="p">);</span>
<span class="lineno">2924 </span>    <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">wc</span><span class="p">.</span><span class="n">style</span>         <span class="o">=</span> <span class="n">CS_OWNDC</span><span class="o">|</span><span class="n">CS_HREDRAW</span><span class="o">|</span><span class="n">CS_VREDRAW</span><span class="p">;</span>
<span class="lineno">2925 </span>    <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">wc</span><span class="p">.</span><span class="n">lpfnWndProc</span>   <span class="o">=</span> <span class="n">WndProc</span><span class="p">;</span>
<span class="lineno">2926 </span>    <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">wc</span><span class="p">.</span><span class="n">cbClsExtra</span>    <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno">2927 </span>    <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">wc</span><span class="p">.</span><span class="n">cbWndExtra</span>    <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno">2928 </span>    <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">wc</span><span class="p">.</span><span class="n">hInstance</span>     <span class="o">=</span> <span class="n">hInstance</span><span class="p">;</span>
<span class="lineno">2929 </span>    <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">wc</span><span class="p">.</span><span class="n">hIcon</span>         <span class="o">=</span> <span class="n">LoadIcon</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">IDI_APPLICATION</span><span class="p">);</span>
<span class="lineno">2930 </span>    <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">wc</span><span class="p">.</span><span class="n">hCursor</span>       <span class="o">=</span> <span class="n">LoadCursor</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">IDC_ARROW</span><span class="p">);</span>
<span class="lineno">2931 </span>    <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">wc</span><span class="p">.</span><span class="n">hbrBackground</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="c1">//(HBRUSH)(COLOR_WINDOW+1);</span>
<span class="lineno">2932 </span>    <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">wc</span><span class="p">.</span><span class="n">lpszMenuName</span>  <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="lineno">2933 </span>    <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">wc</span><span class="p">.</span><span class="n">lpszClassName</span> <span class="o">=</span> <span class="n">CLASS_NAME</span><span class="p">;</span>
<span class="lineno">2934 </span>    <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">wc</span><span class="p">.</span><span class="n">hIconSm</span>       <span class="o">=</span> <span class="n">LoadIcon</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">IDI_APPLICATION</span><span class="p">);</span>
<span class="lineno">2935 </span>
<span class="lineno">2936 </span>    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">SetPriorityClass</span><span class="p">(</span>
<span class="lineno">2937 </span>           <span class="n">GetCurrentProcess</span><span class="p">(),</span>
<span class="lineno">2938 </span>           <span class="n">HIGH_PRIORITY_CLASS</span>
<span class="lineno">2939 </span>           <span class="p">))</span>
<span class="lineno">2940 </span>    <span class="p">{</span>
<span class="lineno">2941 </span>        <span class="n">printf</span><span class="p">(</span><span class="s">"FUCKKKK!!!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="lineno">2942 </span>    <span class="p">}</span>
<span class="lineno">2943 </span>
<span class="lineno">2944 </span>    <span class="n">startup</span><span class="p">();</span>
<span class="lineno">2945 </span>
<span class="lineno">2946 </span>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno">2947 </span><span class="p">}</span>
<span class="lineno">2948 </span>
<span class="lineno">2949 </span><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="lineno">2950 </span><span class="p">{</span>
<span class="lineno">2951 </span>    <span class="c1">//printf("JANKY WINMAIN OVERRIDE\n");</span>
<span class="lineno">2952 </span>    <span class="k">return</span> <span class="n">_WinMain</span><span class="p">(</span><span class="n">GetModuleHandle</span><span class="p">(</span><span class="nb">NULL</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">GetCommandLineA</span><span class="p">(),</span> <span class="n">SW_SHOWNORMAL</span><span class="p">);</span>
<span class="lineno">2953 </span><span class="p">}</span>
<span class="lineno">2954 </span>
<span class="lineno">2955 </span><span class="c1">//Should Block the Win32 Update Loop.</span>
<span class="lineno">2956 </span><span class="cp">#define WIN32_SHOULD_BLOCK_LOOP</span>
<span class="lineno">2957 </span>
<span class="lineno">2958 </span><span class="kt">void</span> <span class="nf">win32_loop</span><span class="p">()</span>
<span class="lineno">2959 </span><span class="p">{</span>
<span class="lineno">2960 </span>    <span class="n">printf</span><span class="p">(</span><span class="s">"Starting WIN32 Window Loop</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="lineno">2961 </span>    <span class="n">MSG</span> <span class="n">msg</span><span class="p">;</span>
<span class="lineno">2962 </span>    <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">shouldRun</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="lineno">2963 </span>    <span class="k">while</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">shouldRun</span><span class="p">)</span>
<span class="lineno">2964 </span>    <span class="p">{</span>
<span class="lineno">2965 </span><span class="cp">#ifdef WIN32_SHOULD_BLOCK_LOOP</span>
<span class="lineno">2966 </span>
<span class="lineno">2967 </span>
<span class="lineno">2968 </span>        <span class="k">if</span><span class="p">(</span><span class="n">GetMessage</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
<span class="lineno">2969 </span>        <span class="p">{</span>
<span class="lineno">2970 </span>            <span class="n">TranslateMessage</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">);</span>
<span class="lineno">2971 </span>            <span class="n">DispatchMessage</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">);</span>
<span class="lineno">2972 </span>        <span class="p">}</span>
<span class="lineno">2973 </span>
<span class="lineno">2974 </span><span class="cp">#else</span>
<span class="lineno">2975 </span>        <span class="k">while</span><span class="p">(</span><span class="n">PeekMessage</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PM_REMOVE</span><span class="p">))</span>
<span class="lineno">2976 </span>        <span class="p">{</span>
<span class="lineno">2977 </span>            <span class="k">if</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">message</span> <span class="o">==</span> <span class="n">WM_QUIT</span><span class="p">)</span>
<span class="lineno">2978 </span>            <span class="p">{</span>
<span class="lineno">2979 </span>                <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">shouldRun</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="lineno">2980 </span>            <span class="p">}</span>
<span class="lineno">2981 </span>            <span class="n">TranslateMessage</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">);</span>
<span class="lineno">2982 </span>            <span class="n">DispatchMessage</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">);</span>
<span class="lineno">2983 </span>        <span class="p">}</span>
<span class="lineno">2984 </span><span class="cp">#endif</span>
<span class="lineno">2985 </span>        <span class="c1">//win32_draw_meme();</span>
<span class="lineno">2986 </span>        <span class="c1">//win32_update_window();</span>
<span class="lineno">2987 </span>    <span class="p">}</span>
<span class="lineno">2988 </span><span class="p">}</span>
<span class="lineno">2989 </span>
<span class="lineno">2990 </span>
<span class="lineno">2991 </span><span class="kt">void</span> <span class="nf">create_win32_window</span><span class="p">()</span>
<span class="lineno">2992 </span><span class="p">{</span>
<span class="lineno">2993 </span>    <span class="n">printf</span><span class="p">(</span><span class="s">"Creating WIN32 Window</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="lineno">2994 </span>
<span class="lineno">2995 </span>    <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">win</span> <span class="o">=</span> <span class="n">CreateWindowEx</span><span class="p">(</span>
<span class="lineno">2996 </span>        <span class="mi">0</span><span class="p">,</span>
<span class="lineno">2997 </span>        <span class="n">CLASS_NAME</span><span class="p">,</span>
<span class="lineno">2998 </span>        <span class="n">CLASS_NAME</span><span class="p">,</span>
<span class="lineno">2999 </span>        <span class="cm">/* WS_OVERLAPPEDWINDOW, */</span>
<span class="lineno">3000 </span>        <span class="p">(</span><span class="n">WS_POPUP</span><span class="o">|</span> <span class="n">WS_SYSMENU</span> <span class="o">|</span> <span class="n">WS_MAXIMIZEBOX</span> <span class="o">|</span> <span class="n">WS_MINIMIZEBOX</span><span class="p">),</span>
<span class="lineno">3001 </span>        <span class="n">CW_USEDEFAULT</span><span class="p">,</span> <span class="n">CW_USEDEFAULT</span><span class="p">,</span> <span class="mi">1920</span><span class="p">,</span> <span class="mi">1080</span><span class="p">,</span>
<span class="lineno">3002 </span>        <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">instance</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="lineno">3003 </span>
<span class="lineno">3004 </span>    <span class="k">if</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">win</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
<span class="lineno">3005 </span>    <span class="p">{</span>
<span class="lineno">3006 </span>        <span class="n">MessageBox</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">"Window Creation Failed!"</span><span class="p">,</span> <span class="s">"Error!"</span><span class="p">,</span>
<span class="lineno">3007 </span>                   <span class="n">MB_ICONEXCLAMATION</span> <span class="o">|</span> <span class="n">MB_OK</span><span class="p">);</span>
<span class="lineno">3008 </span>        <span class="k">return</span><span class="p">;</span>
<span class="lineno">3009 </span>    <span class="p">}</span>
<span class="lineno">3010 </span>
<span class="lineno">3011 </span>    <span class="n">ShowWindow</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">win</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">nCmdShow</span><span class="p">);</span>
<span class="lineno">3012 </span>    <span class="n">UpdateWindow</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">win</span><span class="p">);</span>
<span class="lineno">3013 </span>
<span class="lineno">3014 </span><span class="p">}</span>
<span class="lineno">3015 </span>
<span class="lineno">3016 </span>
<span class="lineno">3017 </span><span class="c1">//NOTE: Should the start func start the loop</span>
<span class="lineno">3018 </span><span class="c1">//#define WIN32_SHOULD_START_LOOP_ON_START</span>
<span class="lineno">3019 </span><span class="kt">void</span> <span class="nf">win32_start</span><span class="p">()</span>
<span class="lineno">3020 </span><span class="p">{</span>
<span class="lineno">3021 </span>    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">RegisterClassEx</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">wc</span><span class="p">))</span>
<span class="lineno">3022 </span>    <span class="p">{</span>
<span class="lineno">3023 </span>        <span class="n">MessageBox</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">"Window Registration Failed!"</span><span class="p">,</span> <span class="s">"Error!"</span><span class="p">,</span>
<span class="lineno">3024 </span>                   <span class="n">MB_ICONEXCLAMATION</span> <span class="o">|</span> <span class="n">MB_OK</span><span class="p">);</span>
<span class="lineno">3025 </span>        <span class="k">return</span><span class="p">;</span>
<span class="lineno">3026 </span>    <span class="p">}</span>
<span class="lineno">3027 </span>    <span class="n">create_win32_window</span><span class="p">();</span>
<span class="lineno">3028 </span><span class="cp">#ifdef WIN32_SHOULD_START_LOOP_ON_START</span>
<span class="lineno">3029 </span>    <span class="n">win32_loop</span><span class="p">();</span>
<span class="lineno">3030 </span><span class="cp">#endif</span>
<span class="lineno">3031 </span>
<span class="lineno">3032 </span><span class="p">}</span>
<span class="lineno">3033 </span>
<span class="lineno">3034 </span><span class="kt">int</span> <span class="nf">win32_get_time_mili</span><span class="p">()</span>
<span class="lineno">3035 </span><span class="p">{</span>
<span class="lineno">3036 </span>    <span class="n">SYSTEMTIME</span> <span class="n">st</span><span class="p">;</span>
<span class="lineno">3037 </span>    <span class="n">GetSystemTime</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="p">);</span>
<span class="lineno">3038 </span>    <span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">st</span><span class="p">.</span><span class="n">wMilliseconds</span><span class="o">+</span><span class="p">(</span><span class="n">st</span><span class="p">.</span><span class="n">wSecond</span><span class="o">*</span><span class="mi">1000</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">st</span><span class="p">.</span><span class="n">wMinute</span><span class="o">*</span><span class="mi">1000</span><span class="o">*</span><span class="mi">60</span><span class="p">);</span>
<span class="lineno">3039 </span><span class="p">}</span>
<span class="lineno">3040 </span>
<span class="lineno">3041 </span><span class="kt">void</span> <span class="nf">win32_update</span><span class="p">()</span>
<span class="lineno">3042 </span><span class="p">{</span>
<span class="lineno">3043 </span>    <span class="c1">//RECT win_rect;</span>
<span class="lineno">3044 </span>    <span class="c1">//GetClientRect(ctx-&gt;win, &amp;win_rect);</span>
<span class="lineno">3045 </span>    <span class="n">HDC</span> <span class="n">dc</span> <span class="o">=</span> <span class="n">GetDC</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">win</span><span class="p">);</span>
<span class="lineno">3046 </span>    <span class="n">win32_update_window</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">win</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">);</span>
<span class="lineno">3047 </span>    <span class="n">ReleaseDC</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">win</span><span class="p">,</span> <span class="n">dc</span><span class="p">);</span>
<span class="lineno">3048 </span>
<span class="lineno">3049 </span><span class="p">}</span>
<span class="lineno">3050 </span>
<span class="lineno">3051 </span>
<span class="lineno">3052 </span><span class="kt">int</span> <span class="nf">win32_get_width</span><span class="p">()</span>
<span class="lineno">3053 </span><span class="p">{</span>
<span class="lineno">3054 </span>    <span class="k">return</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
<span class="lineno">3055 </span><span class="p">}</span>
<span class="lineno">3056 </span>
<span class="lineno">3057 </span><span class="kt">int</span> <span class="nf">win32_get_height</span><span class="p">()</span>
<span class="lineno">3058 </span><span class="p">{</span>
<span class="lineno">3059 </span>    <span class="k">return</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
<span class="lineno">3060 </span><span class="p">}</span>
<span class="lineno">3061 </span>
<span class="lineno">3062 </span><span class="kt">void</span><span class="o">*</span> <span class="nf">win32_get_bitmap_memory</span><span class="p">()</span>
<span class="lineno">3063 </span><span class="p">{</span>
<span class="lineno">3064 </span>    <span class="k">return</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bitmap_memory</span><span class="p">;</span>
<span class="lineno">3065 </span><span class="p">}</span>
<span class="lineno">3066 </span>
<span class="lineno">3067 </span>
<span class="lineno">3068 </span><span class="k">typedef</span> <span class="k">struct</span>
<span class="lineno">3069 </span><span class="p">{</span>
<span class="lineno">3070 </span>    <span class="kt">void</span><span class="o">*</span> <span class="n">data</span><span class="p">;</span>
<span class="lineno">3071 </span>    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">func</span><span class="p">)(</span><span class="kt">void</span><span class="o">*</span><span class="p">);</span>
<span class="lineno">3072 </span><span class="p">}</span> <span class="n">thread_func_meta</span><span class="p">;</span>
<span class="lineno">3073 </span>
<span class="lineno">3074 </span><span class="n">DWORD</span> <span class="n">WINAPI</span> <span class="nf">thread_func</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">data</span><span class="p">)</span>
<span class="lineno">3075 </span><span class="p">{</span>
<span class="lineno">3076 </span>    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">SetThreadPriority</span><span class="p">(</span><span class="n">GetCurrentThread</span><span class="p">(),</span> <span class="n">THREAD_PRIORITY_HIGHEST</span><span class="p">))</span>
<span class="lineno">3077 </span>    <span class="p">{</span>
<span class="lineno">3078 </span>        <span class="n">DWORD</span> <span class="n">dwError</span><span class="p">;</span>
<span class="lineno">3079 </span>        <span class="n">dwError</span> <span class="o">=</span> <span class="n">GetLastError</span><span class="p">();</span>
<span class="lineno">3080 </span>        <span class="n">printf</span><span class="p">(</span><span class="n">TEXT</span><span class="p">(</span><span class="s">"Failed to change thread priority (%d)</span><span class="se">\n</span><span class="s">"</span><span class="p">),</span> <span class="n">dwError</span><span class="p">);</span>
<span class="lineno">3081 </span>    <span class="p">}</span>
<span class="lineno">3082 </span>
<span class="lineno">3083 </span>    <span class="n">thread_func_meta</span><span class="o">*</span> <span class="n">meta</span> <span class="o">=</span> <span class="p">(</span><span class="n">thread_func_meta</span><span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
<span class="lineno">3084 </span>    <span class="p">(</span><span class="n">meta</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">)(</span><span class="n">meta</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span> <span class="c1">//confusing syntax: call the passed function with the passed data</span>
<span class="lineno">3085 </span>    <span class="n">free</span><span class="p">(</span><span class="n">meta</span><span class="p">);</span>
<span class="lineno">3086 </span>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno">3087 </span><span class="p">}</span>
<span class="lineno">3088 </span>
<span class="lineno">3089 </span><span class="kt">void</span> <span class="nf">win32_start_thread</span><span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">func</span><span class="p">)(</span><span class="kt">void</span><span class="o">*</span><span class="p">),</span> <span class="kt">void</span><span class="o">*</span> <span class="n">data</span><span class="p">)</span>
<span class="lineno">3090 </span><span class="p">{</span>
<span class="lineno">3091 </span>    <span class="n">thread_func_meta</span><span class="o">*</span> <span class="n">meta</span> <span class="o">=</span> <span class="p">(</span><span class="n">thread_func_meta</span><span class="o">*</span><span class="p">)</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">thread_func_meta</span><span class="p">));</span>
<span class="lineno">3092 </span>    <span class="n">meta</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
<span class="lineno">3093 </span>    <span class="n">meta</span><span class="o">-&gt;</span><span class="n">func</span> <span class="o">=</span> <span class="n">func</span><span class="p">;</span>
<span class="lineno">3094 </span>    <span class="n">HANDLE</span> <span class="n">t</span> <span class="o">=</span> <span class="n">CreateThread</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">thread_func</span><span class="p">,</span> <span class="n">meta</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="lineno">3095 </span>    <span class="c1">//if(SetThreadPriority(t, THREAD_PRIORITY_HIGHEST)==0)</span>
<span class="lineno">3096 </span>    <span class="c1">//    assert(false);</span>
<span class="lineno">3097 </span>
<span class="lineno">3098 </span><span class="p">}</span>
<span class="lineno">3099 </span>
<span class="lineno">3100 </span><span class="cm">/***********************/</span>
<span class="lineno">3101 </span><span class="cm">/* _compiler_sources.c */</span>
<span class="lineno">3102 </span><span class="cm">/***********************/</span>
<span class="lineno">3103 </span><span class="cp">#include</span> <span class="cpf">&lt;math.h&gt;</span><span class="cp"></span>
<span class="lineno">3104 </span><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="lineno">3105 </span>
<span class="lineno">3106 </span><span class="cp">#define MMX_IMPLEMENTATION</span>
<span class="lineno">3107 </span><span class="cp">#include</span> <span class="cpf">&lt;vec.h&gt;</span><span class="cp"></span>
<span class="lineno">3108 </span><span class="cp">#undef  MMX_IMPLEMENTATION</span>
<span class="lineno">3109 </span><span class="cp">#define TINYOBJ_LOADER_C_IMPLEMENTATION</span>
<span class="lineno">3110 </span><span class="cp">#include</span> <span class="cpf">&lt;tinyobj_loader_c.h&gt;</span><span class="cp"></span>
<span class="lineno">3111 </span><span class="cp">#undef TINYOBJ_LOADER_C_IMPLEMENTATION</span>
<span class="lineno">3112 </span>
<span class="lineno">3113 </span>
<span class="lineno">3114 </span>
<span class="lineno">3115 </span><span class="cp">#include</span> <span class="cpf">&lt;parson.c&gt;</span><span class="cp"></span>
<span class="lineno">3116 </span>
<span class="lineno">3117 </span><span class="cp">#ifdef _WIN32</span>
<span class="lineno">3118 </span><span class="cp">#define WIN32 </span><span class="c1">// I guess CL doesn't add this macro by default...</span>
<span class="lineno">3119 </span><span class="cp">#endif</span>
<span class="lineno">3120 </span>
<span class="lineno">3121 </span><span class="cp">#ifdef WIN32</span>
<span class="lineno">3122 </span><span class="cp">#include</span> <span class="cpf">&lt;win32.c&gt;</span><span class="cp"></span>
<span class="lineno">3123 </span><span class="cp">#endif</span>
<span class="lineno">3124 </span>
<span class="lineno">3125 </span><span class="c1">//TODO: should put in a header</span>
<span class="lineno">3126 </span><span class="cp">#ifdef WIN32</span>
<span class="lineno">3127 </span><span class="cp">#define W_ALIGN(x) __declspec( align (x) )</span>
<span class="lineno">3128 </span><span class="cp">#define U_ALIGN(x) </span><span class="cm">/*nothing*/</span><span class="cp"></span>
<span class="lineno">3129 </span><span class="cp">#else</span>
<span class="lineno">3130 </span><span class="cp">#define W_ALIGN(x) </span><span class="cm">/*nothing*/</span><span class="cp"></span>
<span class="lineno">3131 </span><span class="cp">#define U_ALIGN(x) __attribute__ ((aligned (x)));</span>
<span class="lineno">3132 </span><span class="cp">#endif</span>
<span class="lineno">3133 </span>
<span class="lineno">3134 </span><span class="c1">//#define _MEM_DEBUG //Enable verbose memory allocation, movement and freeing</span>
<span class="lineno">3135 </span><span class="cp">#include</span> <span class="cpf">&lt;debug.c&gt;</span><span class="cp"></span>
<span class="lineno">3136 </span>
<span class="lineno">3137 </span><span class="cp">#include</span> <span class="cpf">&lt;os_abs.c&gt;</span><span class="cp"></span>
<span class="lineno">3138 </span><span class="cp">#include</span> <span class="cpf">&lt;startup.c&gt;</span><span class="cp"></span>
<span class="lineno">3139 </span><span class="cp">#include</span> <span class="cpf">&lt;scene.c&gt;</span><span class="cp"></span>
<span class="lineno">3140 </span><span class="cp">#include</span> <span class="cpf">&lt;geom.c&gt;</span><span class="cp"></span>
<span class="lineno">3141 </span><span class="cp">#include</span> <span class="cpf">&lt;loader.c&gt;</span><span class="cp"></span>
<span class="lineno">3142 </span><span class="cp">#include</span> <span class="cpf">&lt;parallel.c&gt;</span><span class="cp"></span>
<span class="lineno">3143 </span><span class="cp">#include</span> <span class="cpf">&lt;irradiance_cache.c&gt;</span><span class="cp"></span>
<span class="lineno">3144 </span><span class="cp">#include</span> <span class="cpf">&lt;raytracer.c&gt;</span><span class="cp"></span>
<span class="lineno">3145 </span>
<span class="lineno">3146 </span>
<span class="lineno">3147 </span><span class="cm">/****************/</span>
<span class="lineno">3148 </span><span class="cm">/* collision.cl */</span>
<span class="lineno">3149 </span><span class="cm">/****************/</span>
<span class="lineno">3150 </span>
<span class="lineno">3151 </span><span class="cm">/*********/</span>
<span class="lineno">3152 </span><span class="cm">/* Types */</span>
<span class="lineno">3153 </span><span class="cm">/*********/</span>
<span class="lineno">3154 </span>
<span class="lineno">3155 </span><span class="cp">#define MESH_SCENE_DATA_PARAM image1d_t indices, image1d_t vertices, image1d_t normals</span>
<span class="lineno">3156 </span><span class="cp">#define MESH_SCENE_DATA       indices, vertices, normals</span>
<span class="lineno">3157 </span>
<span class="lineno">3158 </span><span class="k">typedef</span> <span class="k">struct</span> <span class="c1">//16 bytes</span>
<span class="lineno">3159 </span><span class="p">{</span>
<span class="lineno">3160 </span>    <span class="n">vec3</span> <span class="n">colour</span><span class="p">;</span>
<span class="lineno">3161 </span>
<span class="lineno">3162 </span>    <span class="kt">float</span> <span class="n">reflectivity</span><span class="p">;</span>
<span class="lineno">3163 </span><span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">aligned</span> <span class="p">(</span><span class="mi">16</span><span class="p">)))</span> <span class="n">material</span><span class="p">;</span>
<span class="lineno">3164 </span>
<span class="lineno">3165 </span><span class="k">typedef</span> <span class="k">struct</span>
<span class="lineno">3166 </span><span class="p">{</span>
<span class="lineno">3167 </span>    <span class="n">vec3</span> <span class="n">orig</span><span class="p">;</span>
<span class="lineno">3168 </span>    <span class="n">vec3</span> <span class="n">dir</span><span class="p">;</span>
<span class="lineno">3169 </span><span class="p">}</span> <span class="n">ray</span><span class="p">;</span>
<span class="lineno">3170 </span>
<span class="lineno">3171 </span><span class="k">typedef</span> <span class="k">struct</span>
<span class="lineno">3172 </span><span class="p">{</span>
<span class="lineno">3173 </span>    <span class="kt">bool</span> <span class="n">did_hit</span><span class="p">;</span>
<span class="lineno">3174 </span>    <span class="n">vec3</span> <span class="n">normal</span><span class="p">;</span>
<span class="lineno">3175 </span>    <span class="n">vec3</span> <span class="n">point</span><span class="p">;</span>
<span class="lineno">3176 </span>    <span class="kt">float</span> <span class="n">dist</span><span class="p">;</span>
<span class="lineno">3177 </span>    <span class="n">material</span> <span class="n">mat</span><span class="p">;</span>
<span class="lineno">3178 </span><span class="p">}</span> <span class="n">collision_result</span><span class="p">;</span>
<span class="lineno">3179 </span>
<span class="lineno">3180 </span><span class="k">typedef</span> <span class="k">struct</span> <span class="c1">//32 bytes (one word)</span>
<span class="lineno">3181 </span><span class="p">{</span>
<span class="lineno">3182 </span>    <span class="n">vec3</span> <span class="n">pos</span><span class="p">;</span>
<span class="lineno">3183 </span>    <span class="c1">//4 bytes padding</span>
<span class="lineno">3184 </span>    <span class="kt">float</span> <span class="n">radius</span><span class="p">;</span>
<span class="lineno">3185 </span>    <span class="kt">int</span> <span class="n">material_index</span><span class="p">;</span>
<span class="lineno">3186 </span>    <span class="c1">//8 bytes padding</span>
<span class="lineno">3187 </span><span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">aligned</span> <span class="p">(</span><span class="mi">16</span><span class="p">)))</span> <span class="n">sphere</span><span class="p">;</span>
<span class="lineno">3188 </span>
<span class="lineno">3189 </span><span class="k">typedef</span> <span class="k">struct</span> <span class="n">plane</span>
<span class="lineno">3190 </span><span class="p">{</span>
<span class="lineno">3191 </span>    <span class="n">vec3</span> <span class="n">pos</span><span class="p">;</span>
<span class="lineno">3192 </span>    <span class="n">vec3</span> <span class="n">normal</span><span class="p">;</span>
<span class="lineno">3193 </span>
<span class="lineno">3194 </span>    <span class="kt">int</span> <span class="n">material_index</span><span class="p">;</span>
<span class="lineno">3195 </span><span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">aligned</span> <span class="p">(</span><span class="mi">16</span><span class="p">)))</span> <span class="n">plane</span><span class="p">;</span>
<span class="lineno">3196 </span>
<span class="lineno">3197 </span><span class="k">typedef</span> <span class="k">struct</span>
<span class="lineno">3198 </span><span class="p">{</span>
<span class="lineno">3199 </span>
<span class="lineno">3200 </span>    <span class="n">mat4</span> <span class="n">model</span><span class="p">;</span>
<span class="lineno">3201 </span>
<span class="lineno">3202 </span>    <span class="n">vec3</span> <span class="n">max</span><span class="p">;</span>
<span class="lineno">3203 </span>    <span class="n">vec3</span> <span class="n">min</span><span class="p">;</span>
<span class="lineno">3204 </span>
<span class="lineno">3205 </span>    <span class="kt">int</span> <span class="n">index_offset</span><span class="p">;</span>
<span class="lineno">3206 </span>    <span class="kt">int</span> <span class="n">num_indices</span><span class="p">;</span>
<span class="lineno">3207 </span>
<span class="lineno">3208 </span>
<span class="lineno">3209 </span>    <span class="kt">int</span> <span class="n">material_index</span><span class="p">;</span>
<span class="lineno">3210 </span><span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">aligned</span> <span class="p">(</span><span class="mi">32</span><span class="p">)))</span> <span class="n">mesh</span><span class="p">;</span> <span class="c1">//TODO: align with cpu NOTE: I don't think we need 32</span>
<span class="lineno">3211 </span>
<span class="lineno">3212 </span><span class="k">typedef</span> <span class="k">struct</span>
<span class="lineno">3213 </span><span class="p">{</span>
<span class="lineno">3214 </span>    <span class="k">const</span> <span class="n">__global</span> <span class="n">material</span><span class="o">*</span> <span class="n">material_buffer</span><span class="p">;</span>
<span class="lineno">3215 </span>    <span class="k">const</span> <span class="n">__global</span> <span class="n">sphere</span><span class="o">*</span> <span class="n">spheres</span><span class="p">;</span>
<span class="lineno">3216 </span>    <span class="k">const</span> <span class="n">__global</span> <span class="n">plane</span><span class="o">*</span> <span class="n">planes</span><span class="p">;</span>
<span class="lineno">3217 </span>    <span class="c1">//Mesh</span>
<span class="lineno">3218 </span>    <span class="k">const</span> <span class="n">__global</span> <span class="n">mesh</span><span class="o">*</span> <span class="n">meshes</span><span class="p">;</span>
<span class="lineno">3219 </span><span class="p">}</span> <span class="n">scene</span><span class="p">;</span>
<span class="lineno">3220 </span>
<span class="lineno">3221 </span>
<span class="lineno">3222 </span>
<span class="lineno">3223 </span><span class="kt">bool</span> <span class="nf">hitBoundingBox</span><span class="p">(</span><span class="n">vec3</span> <span class="n">vmin</span><span class="p">,</span> <span class="n">vec3</span> <span class="n">vmax</span><span class="p">,</span>
<span class="lineno">3224 </span>                    <span class="n">ray</span> <span class="n">r</span><span class="p">)</span>
<span class="lineno">3225 </span><span class="p">{</span>
<span class="lineno">3226 </span>    <span class="n">vec3</span> <span class="n">tmin</span> <span class="o">=</span> <span class="p">(</span><span class="n">vmin</span> <span class="o">-</span> <span class="n">r</span><span class="p">.</span><span class="n">orig</span><span class="p">)</span> <span class="o">/</span> <span class="n">r</span><span class="p">.</span><span class="n">dir</span><span class="p">;</span>
<span class="lineno">3227 </span>    <span class="n">vec3</span> <span class="n">tmax</span> <span class="o">=</span> <span class="p">(</span><span class="n">vmax</span> <span class="o">-</span> <span class="n">r</span><span class="p">.</span><span class="n">orig</span><span class="p">)</span> <span class="o">/</span> <span class="n">r</span><span class="p">.</span><span class="n">dir</span><span class="p">;</span>
<span class="lineno">3228 </span>
<span class="lineno">3229 </span>    <span class="n">vec3</span> <span class="n">real_min</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span><span class="p">);</span>
<span class="lineno">3230 </span>    <span class="n">vec3</span> <span class="n">real_max</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span><span class="p">);</span>
<span class="lineno">3231 </span>
<span class="lineno">3232 </span>    <span class="n">vec3</span> <span class="n">minmax</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">min</span><span class="p">(</span><span class="n">real_max</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">real_max</span><span class="p">.</span><span class="n">y</span><span class="p">),</span> <span class="n">real_max</span><span class="p">.</span><span class="n">z</span><span class="p">);</span>
<span class="lineno">3233 </span>    <span class="n">vec3</span> <span class="n">maxmin</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">max</span><span class="p">(</span><span class="n">real_min</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">real_min</span><span class="p">.</span><span class="n">y</span><span class="p">),</span> <span class="n">real_min</span><span class="p">.</span><span class="n">z</span><span class="p">);</span>
<span class="lineno">3234 </span>
<span class="lineno">3235 </span>    <span class="k">if</span> <span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">minmax</span><span class="p">,</span><span class="n">minmax</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">dot</span><span class="p">(</span><span class="n">maxmin</span><span class="p">,</span> <span class="n">maxmin</span><span class="p">))</span>
<span class="lineno">3236 </span>    <span class="p">{</span> <span class="k">return</span> <span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">maxmin</span><span class="p">,</span> <span class="n">maxmin</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.001f</span> <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">);</span> <span class="p">}</span>
<span class="lineno">3237 </span>    <span class="k">else</span> <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="lineno">3238 </span><span class="p">}</span>
<span class="lineno">3239 </span>
<span class="lineno">3240 </span>
<span class="lineno">3241 </span>
<span class="lineno">3242 </span><span class="cm">/**********************/</span>
<span class="lineno">3243 </span><span class="cm">/*                    */</span>
<span class="lineno">3244 </span><span class="cm">/*     Primitives     */</span>
<span class="lineno">3245 </span><span class="cm">/*                    */</span>
<span class="lineno">3246 </span><span class="cm">/**********************/</span>
<span class="lineno">3247 </span>
<span class="lineno">3248 </span><span class="cm">/************/</span>
<span class="lineno">3249 </span><span class="cm">/* Triangle */</span>
<span class="lineno">3250 </span><span class="cm">/************/</span>
<span class="lineno">3251 </span>
<span class="lineno">3252 </span><span class="c1">//Moller-Trumbore</span>
<span class="lineno">3253 </span><span class="c1">//t u v = x y z</span>
<span class="lineno">3254 </span><span class="kt">bool</span> <span class="nf">does_collide_triangle</span><span class="p">(</span><span class="n">vec3</span> <span class="n">tri</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">vec3</span><span class="o">*</span> <span class="n">hit_coords</span><span class="p">,</span> <span class="n">ray</span> <span class="n">r</span><span class="p">)</span> <span class="c1">//tri has extra for padding</span>
<span class="lineno">3255 </span><span class="p">{</span>
<span class="lineno">3256 </span>    <span class="n">vec3</span> <span class="n">ab</span> <span class="o">=</span> <span class="n">tri</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">tri</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="lineno">3257 </span>    <span class="n">vec3</span> <span class="n">ac</span> <span class="o">=</span> <span class="n">tri</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">tri</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="lineno">3258 </span>
<span class="lineno">3259 </span>    <span class="n">vec3</span> <span class="n">pvec</span> <span class="o">=</span> <span class="n">cross</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">dir</span><span class="p">,</span> <span class="n">ac</span><span class="p">);</span> <span class="c1">//Triple product</span>
<span class="lineno">3260 </span>    <span class="kt">float</span> <span class="n">det</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="n">pvec</span><span class="p">);</span>
<span class="lineno">3261 </span>
<span class="lineno">3262 </span>    <span class="k">if</span> <span class="p">(</span><span class="n">det</span> <span class="o">&lt;</span> <span class="n">EPSILON</span><span class="p">)</span> <span class="c1">// Behind or close to parallel.</span>
<span class="lineno">3263 </span>        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="lineno">3264 </span>
<span class="lineno">3265 </span>    <span class="kt">float</span> <span class="n">invDet</span> <span class="o">=</span> <span class="mf">1.f</span> <span class="o">/</span> <span class="n">det</span><span class="p">;</span>
<span class="lineno">3266 </span>    <span class="n">vec3</span> <span class="n">tvec</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">orig</span> <span class="o">-</span> <span class="n">tri</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="lineno">3267 </span>
<span class="lineno">3268 </span>    <span class="c1">//u</span>
<span class="lineno">3269 </span>    <span class="n">hit_coords</span><span class="o">-&gt;</span><span class="n">y</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">tvec</span><span class="p">,</span> <span class="n">pvec</span><span class="p">)</span> <span class="o">*</span> <span class="n">invDet</span><span class="p">;</span>
<span class="lineno">3270 </span>    <span class="k">if</span><span class="p">(</span><span class="n">hit_coords</span><span class="o">-&gt;</span><span class="n">y</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">hit_coords</span><span class="o">-&gt;</span><span class="n">y</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
<span class="lineno">3271 </span>        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="lineno">3272 </span>
<span class="lineno">3273 </span>    <span class="c1">//v</span>
<span class="lineno">3274 </span>    <span class="n">vec3</span> <span class="n">qvec</span> <span class="o">=</span> <span class="n">cross</span><span class="p">(</span><span class="n">tvec</span><span class="p">,</span> <span class="n">ab</span><span class="p">);</span>
<span class="lineno">3275 </span>    <span class="n">hit_coords</span><span class="o">-&gt;</span><span class="n">z</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">dir</span><span class="p">,</span> <span class="n">qvec</span><span class="p">)</span> <span class="o">*</span> <span class="n">invDet</span><span class="p">;</span>
<span class="lineno">3276 </span>    <span class="k">if</span> <span class="p">(</span><span class="n">hit_coords</span><span class="o">-&gt;</span><span class="n">z</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">hit_coords</span><span class="o">-&gt;</span><span class="n">y</span> <span class="o">+</span> <span class="n">hit_coords</span><span class="o">-&gt;</span><span class="n">z</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
<span class="lineno">3277 </span>        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="lineno">3278 </span>
<span class="lineno">3279 </span>    <span class="c1">//t</span>
<span class="lineno">3280 </span>    <span class="n">hit_coords</span><span class="o">-&gt;</span><span class="n">x</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">ac</span><span class="p">,</span> <span class="n">qvec</span><span class="p">)</span> <span class="o">*</span> <span class="n">invDet</span><span class="p">;</span>
<span class="lineno">3281 </span>
<span class="lineno">3282 </span>    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span> <span class="c1">//goose</span>
<span class="lineno">3283 </span><span class="p">}</span>
<span class="lineno">3284 </span>
<span class="lineno">3285 </span>
<span class="lineno">3286 </span><span class="cm">/**********/</span>
<span class="lineno">3287 </span><span class="cm">/* Sphere */</span>
<span class="lineno">3288 </span><span class="cm">/**********/</span>
<span class="lineno">3289 </span>
<span class="lineno">3290 </span><span class="kt">bool</span> <span class="nf">does_collide_sphere</span><span class="p">(</span><span class="n">sphere</span> <span class="n">s</span><span class="p">,</span> <span class="n">ray</span> <span class="n">r</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="n">dist</span><span class="p">)</span>
<span class="lineno">3291 </span><span class="p">{</span>
<span class="lineno">3292 </span>    <span class="kt">float</span> <span class="n">t0</span><span class="p">,</span> <span class="n">t1</span><span class="p">;</span> <span class="c1">// solutions for t if the ray intersects</span>
<span class="lineno">3293 </span>
<span class="lineno">3294 </span>    <span class="c1">// analytic solution</span>
<span class="lineno">3295 </span>    <span class="n">vec3</span> <span class="n">L</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">pos</span><span class="o">-</span> <span class="n">r</span><span class="p">.</span><span class="n">orig</span><span class="p">;</span>
<span class="lineno">3296 </span>    <span class="kt">float</span> <span class="n">b</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">dir</span><span class="p">,</span> <span class="n">L</span><span class="p">)</span> <span class="p">;</span><span class="c1">//* 2.0f;</span>
<span class="lineno">3297 </span>    <span class="kt">float</span> <span class="n">c</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">L</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">radius</span><span class="o">*</span><span class="n">s</span><span class="p">.</span><span class="n">radius</span><span class="p">);</span> <span class="c1">//NOTE: you can optimize out the square.</span>
<span class="lineno">3298 </span>
<span class="lineno">3299 </span>    <span class="kt">float</span> <span class="n">disc</span> <span class="o">=</span> <span class="n">b</span> <span class="o">*</span> <span class="n">b</span> <span class="o">-</span> <span class="n">c</span><span class="cm">/**a*/</span><span class="p">;</span> <span class="cm">/* discriminant of quadratic formula */</span>
<span class="lineno">3300 </span>
<span class="lineno">3301 </span>    <span class="cm">/* solve for t (distance to hitpoint along ray) */</span>
<span class="lineno">3302 </span>    <span class="kt">float</span> <span class="n">t</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="lineno">3303 </span>
<span class="lineno">3304 </span>    <span class="k">if</span> <span class="p">(</span><span class="n">disc</span> <span class="o">&lt;</span> <span class="mf">0.0f</span><span class="p">)</span> <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="lineno">3305 </span>    <span class="k">else</span> <span class="n">t</span> <span class="o">=</span> <span class="n">b</span> <span class="o">-</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">disc</span><span class="p">);</span>
<span class="lineno">3306 </span>
<span class="lineno">3307 </span>    <span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">&lt;</span> <span class="mf">0.0f</span><span class="p">)</span>
<span class="lineno">3308 </span>    <span class="p">{</span>
<span class="lineno">3309 </span>        <span class="n">t</span> <span class="o">=</span> <span class="n">b</span> <span class="o">+</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">disc</span><span class="p">);</span>
<span class="lineno">3310 </span>        <span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">&lt;</span> <span class="mf">0.0f</span><span class="p">)</span> <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="lineno">3311 </span>    <span class="p">}</span>
<span class="lineno">3312 </span>    <span class="o">*</span><span class="n">dist</span> <span class="o">=</span> <span class="n">t</span><span class="p">;</span>
<span class="lineno">3313 </span>    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="lineno">3314 </span><span class="p">}</span>
<span class="lineno">3315 </span>
<span class="lineno">3316 </span>
<span class="lineno">3317 </span>
<span class="lineno">3318 </span><span class="cm">/*********/</span>
<span class="lineno">3319 </span><span class="cm">/* Plane */</span>
<span class="lineno">3320 </span><span class="cm">/*********/</span>
<span class="lineno">3321 </span>
<span class="lineno">3322 </span><span class="kt">bool</span> <span class="nf">does_collide_plane</span><span class="p">(</span><span class="n">plane</span> <span class="n">p</span><span class="p">,</span> <span class="n">ray</span> <span class="n">r</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="n">dist</span><span class="p">)</span>
<span class="lineno">3323 </span><span class="p">{</span>
<span class="lineno">3324 </span>    <span class="kt">float</span> <span class="n">denom</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">dir</span><span class="p">,</span> <span class="n">p</span><span class="p">.</span><span class="n">normal</span><span class="p">);</span>
<span class="lineno">3325 </span>    <span class="k">if</span> <span class="p">(</span><span class="n">denom</span> <span class="o">&lt;</span> <span class="n">EPSILON</span><span class="p">)</span> <span class="c1">//Counter intuitive.</span>
<span class="lineno">3326 </span>    <span class="p">{</span>
<span class="lineno">3327 </span>        <span class="n">vec3</span> <span class="n">l</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">pos</span> <span class="o">-</span> <span class="n">r</span><span class="p">.</span><span class="n">orig</span><span class="p">;</span>
<span class="lineno">3328 </span>        <span class="kt">float</span> <span class="n">t</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">p</span><span class="p">.</span><span class="n">normal</span><span class="p">)</span> <span class="o">/</span> <span class="n">denom</span><span class="p">;</span>
<span class="lineno">3329 </span>        <span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
<span class="lineno">3330 </span>        <span class="p">{</span>
<span class="lineno">3331 </span>            <span class="o">*</span><span class="n">dist</span> <span class="o">=</span> <span class="n">t</span><span class="p">;</span>
<span class="lineno">3332 </span>            <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="lineno">3333 </span>        <span class="p">}</span>
<span class="lineno">3334 </span>
<span class="lineno">3335 </span>    <span class="p">}</span>
<span class="lineno">3336 </span>    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="lineno">3337 </span><span class="p">}</span>
<span class="lineno">3338 </span>
<span class="lineno">3339 </span>
<span class="lineno">3340 </span><span class="cm">/********************/</span>
<span class="lineno">3341 </span><span class="cm">/*                  */</span>
<span class="lineno">3342 </span><span class="cm">/*      Meshes      */</span>
<span class="lineno">3343 </span><span class="cm">/*                  */</span>
<span class="lineno">3344 </span><span class="cm">/********************/</span>
<span class="lineno">3345 </span>
<span class="lineno">3346 </span>
<span class="lineno">3347 </span><span class="kt">bool</span> <span class="nf">does_collide_with_mesh</span><span class="p">(</span><span class="n">mesh</span> <span class="n">collider</span><span class="p">,</span> <span class="n">ray</span> <span class="n">r</span><span class="p">,</span> <span class="n">vec3</span><span class="o">*</span> <span class="n">normal</span><span class="p">,</span> <span class="kt">float</span><span class="o">*</span> <span class="n">dist</span><span class="p">,</span> <span class="n">scene</span> <span class="n">s</span><span class="p">,</span>
<span class="lineno">3348 </span>                            <span class="n">MESH_SCENE_DATA_PARAM</span><span class="p">)</span>
<span class="lineno">3349 </span><span class="p">{</span>
<span class="lineno">3350 </span>    <span class="c1">//TODO: k-d trees</span>
<span class="lineno">3351 </span>    <span class="o">*</span><span class="n">dist</span> <span class="o">=</span> <span class="n">FAR_PLANE</span><span class="p">;</span>
<span class="lineno">3352 </span>    <span class="kt">float</span> <span class="n">min_t</span> <span class="o">=</span> <span class="n">FAR_PLANE</span><span class="p">;</span>
<span class="lineno">3353 </span>    <span class="n">vec3</span> <span class="n">hit_coord</span><span class="p">;</span> <span class="c1">//NOTE: currently unused</span>
<span class="lineno">3354 </span>    <span class="n">ray</span> <span class="n">r2</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
<span class="lineno">3355 </span>    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">hitBoundingBox</span><span class="p">(</span><span class="n">collider</span><span class="p">.</span><span class="n">min</span><span class="p">,</span> <span class="n">collider</span><span class="p">.</span><span class="n">max</span><span class="p">,</span> <span class="n">r</span><span class="p">))</span>
<span class="lineno">3356 </span>    <span class="p">{</span>
<span class="lineno">3357 </span>        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="lineno">3358 </span>    <span class="p">}</span>
<span class="lineno">3359 </span>
<span class="lineno">3360 </span>    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">collider</span><span class="p">.</span><span class="n">num_indices</span><span class="o">/</span><span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="c1">// each ivec3</span>
<span class="lineno">3361 </span>    <span class="p">{</span>
<span class="lineno">3362 </span>        <span class="n">vec3</span> <span class="n">tri</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
<span class="lineno">3363 </span>
<span class="lineno">3364 </span>        <span class="c1">//get vertex (first element of each index)</span>
<span class="lineno">3365 </span>
<span class="lineno">3366 </span>        <span class="n">int4</span> <span class="n">idx_0</span> <span class="o">=</span> <span class="n">read_imagei</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">i</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="n">collider</span><span class="p">.</span><span class="n">index_offset</span><span class="o">+</span><span class="mi">0</span><span class="p">);</span>
<span class="lineno">3367 </span>        <span class="n">int4</span> <span class="n">idx_1</span> <span class="o">=</span> <span class="n">read_imagei</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">i</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="n">collider</span><span class="p">.</span><span class="n">index_offset</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
<span class="lineno">3368 </span>        <span class="n">int4</span> <span class="n">idx_2</span> <span class="o">=</span> <span class="n">read_imagei</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">i</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="n">collider</span><span class="p">.</span><span class="n">index_offset</span><span class="o">+</span><span class="mi">2</span><span class="p">);</span>
<span class="lineno">3369 </span>
<span class="lineno">3370 </span>        <span class="n">tri</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">read_imagef</span><span class="p">(</span><span class="n">vertices</span><span class="p">,</span> <span class="n">idx_0</span><span class="p">.</span><span class="n">x</span><span class="p">).</span><span class="n">xyz</span><span class="p">;</span>
<span class="lineno">3371 </span>        <span class="n">tri</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">read_imagef</span><span class="p">(</span><span class="n">vertices</span><span class="p">,</span> <span class="n">idx_1</span><span class="p">.</span><span class="n">x</span><span class="p">).</span><span class="n">xyz</span><span class="p">;</span>
<span class="lineno">3372 </span>        <span class="n">tri</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">read_imagef</span><span class="p">(</span><span class="n">vertices</span><span class="p">,</span> <span class="n">idx_2</span><span class="p">.</span><span class="n">x</span><span class="p">).</span><span class="n">xyz</span><span class="p">;</span>
<span class="lineno">3373 </span>
<span class="lineno">3374 </span>
<span class="lineno">3375 </span>
<span class="lineno">3376 </span>        <span class="n">vec3</span> <span class="n">bc_hit_coords</span> <span class="o">=</span> <span class="p">(</span><span class="n">vec3</span><span class="p">)(</span><span class="mf">0.f</span><span class="p">);</span> <span class="c1">//t u v = x y z</span>
<span class="lineno">3377 </span>        <span class="k">if</span><span class="p">(</span><span class="n">does_collide_triangle</span><span class="p">(</span><span class="n">tri</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bc_hit_coords</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
<span class="lineno">3378 </span>           <span class="n">bc_hit_coords</span><span class="p">.</span><span class="n">x</span><span class="o">&lt;</span><span class="n">min_t</span> <span class="o">&amp;&amp;</span> <span class="n">bc_hit_coords</span><span class="p">.</span><span class="n">x</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
<span class="lineno">3379 </span>        <span class="p">{</span>
<span class="lineno">3380 </span>            <span class="n">min_t</span> <span class="o">=</span> <span class="n">bc_hit_coords</span><span class="p">.</span><span class="n">x</span><span class="p">;</span> <span class="c1">//t (distance along direction)</span>
<span class="lineno">3381 </span>            <span class="o">*</span><span class="n">normal</span> <span class="o">=</span>
<span class="lineno">3382 </span>                <span class="n">read_imagef</span><span class="p">(</span><span class="n">normals</span><span class="p">,</span> <span class="n">idx_0</span><span class="p">.</span><span class="n">y</span><span class="p">).</span><span class="n">xyz</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">bc_hit_coords</span><span class="p">.</span><span class="n">y</span><span class="o">-</span><span class="n">bc_hit_coords</span><span class="p">.</span><span class="n">z</span><span class="p">)</span><span class="o">+</span>
<span class="lineno">3383 </span>                <span class="n">read_imagef</span><span class="p">(</span><span class="n">normals</span><span class="p">,</span> <span class="n">idx_1</span><span class="p">.</span><span class="n">y</span><span class="p">).</span><span class="n">xyz</span><span class="o">*</span><span class="n">bc_hit_coords</span><span class="p">.</span><span class="n">y</span><span class="o">+</span>
<span class="lineno">3384 </span>                <span class="n">read_imagef</span><span class="p">(</span><span class="n">normals</span><span class="p">,</span> <span class="n">idx_2</span><span class="p">.</span><span class="n">y</span><span class="p">).</span><span class="n">xyz</span><span class="o">*</span><span class="n">bc_hit_coords</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
<span class="lineno">3385 </span>                <span class="c1">//break; //convex optimization</span>
<span class="lineno">3386 </span>        <span class="p">}</span>
<span class="lineno">3387 </span>
<span class="lineno">3388 </span>    <span class="p">}</span>
<span class="lineno">3389 </span>
<span class="lineno">3390 </span>
<span class="lineno">3391 </span>    <span class="o">*</span><span class="n">dist</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">;</span>
<span class="lineno">3392 </span>    <span class="k">return</span> <span class="n">min_t</span> <span class="o">!=</span> <span class="n">FAR_PLANE</span><span class="p">;</span>
<span class="lineno">3393 </span>
<span class="lineno">3394 </span><span class="p">}</span>
<span class="lineno">3395 </span>
<span class="lineno">3396 </span><span class="kt">bool</span> <span class="nf">does_collide_with_mesh_alt</span><span class="p">(</span><span class="n">mesh</span> <span class="n">collider</span><span class="p">,</span> <span class="n">ray</span> <span class="n">r</span><span class="p">,</span> <span class="n">vec3</span><span class="o">*</span> <span class="n">normal</span><span class="p">,</span> <span class="kt">float</span><span class="o">*</span> <span class="n">dist</span><span class="p">,</span> <span class="n">scene</span> <span class="n">s</span><span class="p">,</span>
<span class="lineno">3397 </span>                            <span class="n">MESH_SCENE_DATA_PARAM</span><span class="p">)</span>
<span class="lineno">3398 </span><span class="p">{</span>
<span class="lineno">3399 </span>    <span class="o">*</span><span class="n">dist</span> <span class="o">=</span> <span class="n">FAR_PLANE</span><span class="p">;</span>
<span class="lineno">3400 </span>    <span class="kt">float</span> <span class="n">min_t</span> <span class="o">=</span> <span class="n">FAR_PLANE</span><span class="p">;</span>
<span class="lineno">3401 </span>    <span class="n">vec3</span> <span class="n">hit_coord</span><span class="p">;</span> <span class="c1">//NOTE: currently unused</span>
<span class="lineno">3402 </span>    <span class="n">ray</span> <span class="n">r2</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
<span class="lineno">3403 </span>
<span class="lineno">3404 </span>    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SCENE_NUM_INDICES</span><span class="o">/</span><span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="lineno">3405 </span>    <span class="p">{</span>
<span class="lineno">3406 </span>        <span class="n">vec3</span> <span class="n">tri</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
<span class="lineno">3407 </span>
<span class="lineno">3408 </span>        <span class="c1">//get vertex (first element of each index)</span>
<span class="lineno">3409 </span>
<span class="lineno">3410 </span>        <span class="n">int4</span> <span class="n">idx_0</span> <span class="o">=</span> <span class="n">read_imagei</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">i</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="n">collider</span><span class="p">.</span><span class="n">index_offset</span><span class="o">+</span><span class="mi">0</span><span class="p">);</span>
<span class="lineno">3411 </span>        <span class="n">int4</span> <span class="n">idx_1</span> <span class="o">=</span> <span class="n">read_imagei</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">i</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="n">collider</span><span class="p">.</span><span class="n">index_offset</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
<span class="lineno">3412 </span>        <span class="n">int4</span> <span class="n">idx_2</span> <span class="o">=</span> <span class="n">read_imagei</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">i</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="n">collider</span><span class="p">.</span><span class="n">index_offset</span><span class="o">+</span><span class="mi">2</span><span class="p">);</span>
<span class="lineno">3413 </span>
<span class="lineno">3414 </span>        <span class="n">tri</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">read_imagef</span><span class="p">(</span><span class="n">vertices</span><span class="p">,</span> <span class="n">idx_0</span><span class="p">.</span><span class="n">x</span><span class="p">).</span><span class="n">xyz</span><span class="p">;</span>
<span class="lineno">3415 </span>        <span class="n">tri</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">read_imagef</span><span class="p">(</span><span class="n">vertices</span><span class="p">,</span> <span class="n">idx_1</span><span class="p">.</span><span class="n">x</span><span class="p">).</span><span class="n">xyz</span><span class="p">;</span>
<span class="lineno">3416 </span>        <span class="n">tri</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">read_imagef</span><span class="p">(</span><span class="n">vertices</span><span class="p">,</span> <span class="n">idx_2</span><span class="p">.</span><span class="n">x</span><span class="p">).</span><span class="n">xyz</span><span class="p">;</span>
<span class="lineno">3417 </span>
<span class="lineno">3418 </span>
<span class="lineno">3419 </span>        <span class="n">vec3</span> <span class="n">bc_hit_coords</span> <span class="o">=</span> <span class="p">(</span><span class="n">vec3</span><span class="p">)(</span><span class="mf">0.f</span><span class="p">);</span> <span class="c1">//t u v = x y z</span>
<span class="lineno">3420 </span>        <span class="k">if</span><span class="p">(</span><span class="n">does_collide_triangle</span><span class="p">(</span><span class="n">tri</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bc_hit_coords</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
<span class="lineno">3421 </span>           <span class="n">bc_hit_coords</span><span class="p">.</span><span class="n">x</span><span class="o">&lt;</span><span class="n">min_t</span> <span class="o">&amp;&amp;</span> <span class="n">bc_hit_coords</span><span class="p">.</span><span class="n">x</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
<span class="lineno">3422 </span>        <span class="p">{</span>
<span class="lineno">3423 </span>                <span class="n">min_t</span> <span class="o">=</span> <span class="n">bc_hit_coords</span><span class="p">.</span><span class="n">x</span><span class="p">;</span> <span class="c1">//t (distance along direction)</span>
<span class="lineno">3424 </span>                <span class="o">*</span><span class="n">normal</span> <span class="o">=</span>
<span class="lineno">3425 </span>                    <span class="n">read_imagef</span><span class="p">(</span><span class="n">normals</span><span class="p">,</span> <span class="n">idx_0</span><span class="p">.</span><span class="n">y</span><span class="p">).</span><span class="n">xyz</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">bc_hit_coords</span><span class="p">.</span><span class="n">y</span><span class="o">-</span><span class="n">bc_hit_coords</span><span class="p">.</span><span class="n">z</span><span class="p">)</span><span class="o">+</span>
<span class="lineno">3426 </span>                    <span class="n">read_imagef</span><span class="p">(</span><span class="n">normals</span><span class="p">,</span> <span class="n">idx_1</span><span class="p">.</span><span class="n">y</span><span class="p">).</span><span class="n">xyz</span><span class="o">*</span><span class="n">bc_hit_coords</span><span class="p">.</span><span class="n">y</span><span class="o">+</span>
<span class="lineno">3427 </span>                    <span class="n">read_imagef</span><span class="p">(</span><span class="n">normals</span><span class="p">,</span> <span class="n">idx_2</span><span class="p">.</span><span class="n">y</span><span class="p">).</span><span class="n">xyz</span><span class="o">*</span><span class="n">bc_hit_coords</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
<span class="lineno">3428 </span>        <span class="p">}</span>
<span class="lineno">3429 </span>
<span class="lineno">3430 </span>    <span class="p">}</span>
<span class="lineno">3431 </span>
<span class="lineno">3432 </span>
<span class="lineno">3433 </span>    <span class="o">*</span><span class="n">dist</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">;</span>
<span class="lineno">3434 </span>    <span class="k">return</span> <span class="n">min_t</span> <span class="o">!=</span> <span class="n">FAR_PLANE</span><span class="p">;</span>
<span class="lineno">3435 </span>
<span class="lineno">3436 </span><span class="p">}</span>
<span class="lineno">3437 </span>
<span class="lineno">3438 </span>
<span class="lineno">3439 </span>
<span class="lineno">3440 </span><span class="cm">/************************/</span>
<span class="lineno">3441 </span><span class="cm">/* High Level Collision */</span>
<span class="lineno">3442 </span><span class="cm">/************************/</span>
<span class="lineno">3443 </span>
<span class="lineno">3444 </span>
<span class="lineno">3445 </span><span class="kt">bool</span> <span class="nf">collide_meshes</span><span class="p">(</span><span class="n">ray</span> <span class="n">r</span><span class="p">,</span> <span class="n">collision_result</span><span class="o">*</span> <span class="n">result</span><span class="p">,</span> <span class="n">scene</span> <span class="n">s</span><span class="p">,</span> <span class="n">MESH_SCENE_DATA_PARAM</span><span class="p">)</span>
<span class="lineno">3446 </span><span class="p">{</span>
<span class="lineno">3447 </span>
<span class="lineno">3448 </span>    <span class="kt">float</span> <span class="n">dist</span> <span class="o">=</span> <span class="n">FAR_PLANE</span><span class="p">;</span>
<span class="lineno">3449 </span>    <span class="n">result</span><span class="o">-&gt;</span><span class="n">did_hit</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="lineno">3450 </span>    <span class="n">result</span><span class="o">-&gt;</span><span class="n">dist</span> <span class="o">=</span> <span class="n">FAR_PLANE</span><span class="p">;</span>
<span class="lineno">3451 </span>
<span class="lineno">3452 </span>    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SCENE_NUM_MESHES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="lineno">3453 </span>    <span class="p">{</span>
<span class="lineno">3454 </span>        <span class="n">mesh</span> <span class="n">current_mesh</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">meshes</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="lineno">3455 </span>        <span class="kt">float</span> <span class="n">local_dist</span> <span class="o">=</span> <span class="n">FAR_PLANE</span><span class="p">;</span>
<span class="lineno">3456 </span>        <span class="n">vec3</span> <span class="n">normal</span><span class="p">;</span>
<span class="lineno">3457 </span>        <span class="k">if</span><span class="p">(</span><span class="n">does_collide_with_mesh</span><span class="p">(</span><span class="n">current_mesh</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">normal</span><span class="p">,</span>  <span class="o">&amp;</span><span class="n">local_dist</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">MESH_SCENE_DATA</span><span class="p">))</span>
<span class="lineno">3458 </span>        <span class="p">{</span>
<span class="lineno">3459 </span>
<span class="lineno">3460 </span>            <span class="k">if</span><span class="p">(</span><span class="n">local_dist</span><span class="o">&lt;</span><span class="n">dist</span><span class="p">)</span>
<span class="lineno">3461 </span>            <span class="p">{</span>
<span class="lineno">3462 </span>                <span class="n">dist</span> <span class="o">=</span> <span class="n">local_dist</span><span class="p">;</span>
<span class="lineno">3463 </span>                <span class="n">result</span><span class="o">-&gt;</span><span class="n">dist</span> <span class="o">=</span> <span class="n">dist</span><span class="p">;</span>
<span class="lineno">3464 </span>                <span class="n">result</span><span class="o">-&gt;</span><span class="n">normal</span> <span class="o">=</span> <span class="n">normal</span><span class="p">;</span>
<span class="lineno">3465 </span>                <span class="n">result</span><span class="o">-&gt;</span><span class="n">point</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">dir</span><span class="o">*</span><span class="n">dist</span><span class="p">)</span><span class="o">+</span><span class="n">r</span><span class="p">.</span><span class="n">orig</span><span class="p">;</span>
<span class="lineno">3466 </span>                <span class="n">result</span><span class="o">-&gt;</span><span class="n">mat</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">material_buffer</span><span class="p">[</span><span class="n">current_mesh</span><span class="p">.</span><span class="n">material_index</span><span class="p">];</span>
<span class="lineno">3467 </span>                <span class="n">result</span><span class="o">-&gt;</span><span class="n">did_hit</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="lineno">3468 </span>            <span class="p">}</span>
<span class="lineno">3469 </span>        <span class="p">}</span>
<span class="lineno">3470 </span>    <span class="p">}</span>
<span class="lineno">3471 </span>    <span class="k">return</span> <span class="n">result</span><span class="o">-&gt;</span><span class="n">did_hit</span><span class="p">;</span>
<span class="lineno">3472 </span><span class="p">}</span>
<span class="lineno">3473 </span>
<span class="lineno">3474 </span><span class="kt">bool</span> <span class="nf">collide_primitives</span><span class="p">(</span><span class="n">ray</span> <span class="n">r</span><span class="p">,</span> <span class="n">collision_result</span><span class="o">*</span> <span class="n">result</span><span class="p">,</span> <span class="n">scene</span> <span class="n">s</span><span class="p">)</span>
<span class="lineno">3475 </span><span class="p">{</span>
<span class="lineno">3476 </span>
<span class="lineno">3477 </span>    <span class="kt">float</span> <span class="n">dist</span> <span class="o">=</span> <span class="n">FAR_PLANE</span><span class="p">;</span>
<span class="lineno">3478 </span>    <span class="n">result</span><span class="o">-&gt;</span><span class="n">did_hit</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="lineno">3479 </span>    <span class="n">result</span><span class="o">-&gt;</span><span class="n">dist</span> <span class="o">=</span> <span class="n">FAR_PLANE</span><span class="p">;</span>
<span class="lineno">3480 </span>    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SCENE_NUM_SPHERES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="lineno">3481 </span>    <span class="p">{</span>
<span class="lineno">3482 </span>        <span class="n">sphere</span> <span class="n">current_sphere</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">spheres</span><span class="p">[</span><span class="n">i</span><span class="p">];</span><span class="c1">//get_sphere(spheres, i);</span>
<span class="lineno">3483 </span>        <span class="kt">float</span> <span class="n">local_dist</span> <span class="o">=</span> <span class="n">FAR_PLANE</span><span class="p">;</span>
<span class="lineno">3484 </span>        <span class="k">if</span><span class="p">(</span><span class="n">does_collide_sphere</span><span class="p">(</span><span class="n">current_sphere</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local_dist</span><span class="p">))</span>
<span class="lineno">3485 </span>        <span class="p">{</span>
<span class="lineno">3486 </span>            <span class="k">if</span><span class="p">(</span><span class="n">local_dist</span><span class="o">&lt;</span><span class="n">dist</span><span class="p">)</span>
<span class="lineno">3487 </span>            <span class="p">{</span>
<span class="lineno">3488 </span>                <span class="n">dist</span> <span class="o">=</span> <span class="n">local_dist</span><span class="p">;</span>
<span class="lineno">3489 </span>                <span class="n">result</span><span class="o">-&gt;</span><span class="n">did_hit</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="lineno">3490 </span>                <span class="n">result</span><span class="o">-&gt;</span><span class="n">dist</span>    <span class="o">=</span> <span class="n">dist</span><span class="p">;</span>
<span class="lineno">3491 </span>                <span class="n">result</span><span class="o">-&gt;</span><span class="n">point</span>   <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">dir</span><span class="o">*</span><span class="n">dist</span><span class="o">+</span><span class="n">r</span><span class="p">.</span><span class="n">orig</span><span class="p">;</span>
<span class="lineno">3492 </span>                <span class="n">result</span><span class="o">-&gt;</span><span class="n">normal</span>  <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">result</span><span class="o">-&gt;</span><span class="n">point</span> <span class="o">-</span> <span class="n">current_sphere</span><span class="p">.</span><span class="n">pos</span><span class="p">);</span>
<span class="lineno">3493 </span>                <span class="n">result</span><span class="o">-&gt;</span><span class="n">mat</span>     <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">material_buffer</span><span class="p">[</span><span class="n">current_sphere</span><span class="p">.</span><span class="n">material_index</span><span class="p">];</span>
<span class="lineno">3494 </span>            <span class="p">}</span>
<span class="lineno">3495 </span>        <span class="p">}</span>
<span class="lineno">3496 </span>    <span class="p">}</span>
<span class="lineno">3497 </span>
<span class="lineno">3498 </span>    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SCENE_NUM_PLANES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="lineno">3499 </span>    <span class="p">{</span>
<span class="lineno">3500 </span>        <span class="n">plane</span> <span class="n">current_plane</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">planes</span><span class="p">[</span><span class="n">i</span><span class="p">];</span><span class="c1">//get_plane(planes, i);</span>
<span class="lineno">3501 </span>        <span class="kt">float</span> <span class="n">local_dist</span> <span class="o">=</span>  <span class="n">FAR_PLANE</span><span class="p">;</span>
<span class="lineno">3502 </span>        <span class="k">if</span><span class="p">(</span><span class="n">does_collide_plane</span><span class="p">(</span><span class="n">current_plane</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local_dist</span><span class="p">))</span>
<span class="lineno">3503 </span>        <span class="p">{</span>
<span class="lineno">3504 </span>            <span class="k">if</span><span class="p">(</span><span class="n">local_dist</span><span class="o">&lt;</span><span class="n">dist</span><span class="p">)</span>
<span class="lineno">3505 </span>            <span class="p">{</span>
<span class="lineno">3506 </span>                <span class="n">dist</span> <span class="o">=</span> <span class="n">local_dist</span><span class="p">;</span>
<span class="lineno">3507 </span>                <span class="n">result</span><span class="o">-&gt;</span><span class="n">did_hit</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="lineno">3508 </span>                <span class="n">result</span><span class="o">-&gt;</span><span class="n">dist</span>    <span class="o">=</span> <span class="n">dist</span><span class="p">;</span>
<span class="lineno">3509 </span>                <span class="n">result</span><span class="o">-&gt;</span><span class="n">point</span>   <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">dir</span><span class="o">*</span><span class="n">dist</span><span class="o">+</span><span class="n">r</span><span class="p">.</span><span class="n">orig</span><span class="p">;</span>
<span class="lineno">3510 </span>                <span class="n">result</span><span class="o">-&gt;</span><span class="n">normal</span>  <span class="o">=</span> <span class="n">current_plane</span><span class="p">.</span><span class="n">normal</span><span class="p">;</span>
<span class="lineno">3511 </span>                <span class="n">result</span><span class="o">-&gt;</span><span class="n">mat</span>     <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">material_buffer</span><span class="p">[</span><span class="n">current_plane</span><span class="p">.</span><span class="n">material_index</span><span class="p">];</span>
<span class="lineno">3512 </span>            <span class="p">}</span>
<span class="lineno">3513 </span>        <span class="p">}</span>
<span class="lineno">3514 </span>    <span class="p">}</span>
<span class="lineno">3515 </span>
<span class="lineno">3516 </span>    <span class="k">return</span> <span class="n">dist</span> <span class="o">!=</span> <span class="n">FAR_PLANE</span><span class="p">;</span>
<span class="lineno">3517 </span><span class="p">}</span>
<span class="lineno">3518 </span>
<span class="lineno">3519 </span><span class="kt">bool</span> <span class="nf">collide_all</span><span class="p">(</span><span class="n">ray</span> <span class="n">r</span><span class="p">,</span> <span class="n">collision_result</span><span class="o">*</span> <span class="n">result</span><span class="p">,</span> <span class="n">scene</span> <span class="n">s</span><span class="p">,</span> <span class="n">MESH_SCENE_DATA_PARAM</span><span class="p">)</span>
<span class="lineno">3520 </span><span class="p">{</span>
<span class="lineno">3521 </span>    <span class="kt">float</span> <span class="n">dist</span> <span class="o">=</span> <span class="n">FAR_PLANE</span><span class="p">;</span>
<span class="lineno">3522 </span>    <span class="k">if</span><span class="p">(</span><span class="n">collide_primitives</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">s</span><span class="p">))</span>
<span class="lineno">3523 </span>        <span class="n">dist</span> <span class="o">=</span> <span class="n">result</span><span class="o">-&gt;</span><span class="n">dist</span><span class="p">;</span>
<span class="lineno">3524 </span>
<span class="lineno">3525 </span>    <span class="n">collision_result</span> <span class="n">m_result</span><span class="p">;</span>
<span class="lineno">3526 </span>    <span class="k">if</span><span class="p">(</span><span class="n">collide_meshes</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m_result</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">MESH_SCENE_DATA</span><span class="p">))</span>
<span class="lineno">3527 </span>        <span class="k">if</span><span class="p">(</span><span class="n">m_result</span><span class="p">.</span><span class="n">dist</span> <span class="o">&lt;</span> <span class="n">dist</span><span class="p">)</span>
<span class="lineno">3528 </span>            <span class="o">*</span><span class="n">result</span> <span class="o">=</span> <span class="n">m_result</span><span class="p">;</span>
<span class="lineno">3529 </span>
<span class="lineno">3530 </span>    <span class="k">return</span> <span class="n">result</span><span class="o">-&gt;</span><span class="n">did_hit</span><span class="p">;</span>
<span class="lineno">3531 </span><span class="p">}</span>
<span class="lineno">3532 </span>
<span class="lineno">3533 </span>
<span class="lineno">3534 </span>
<span class="lineno">3535 </span><span class="cm">/***********************/</span>
<span class="lineno">3536 </span><span class="cm">/* irradiance_cache.cl */</span>
<span class="lineno">3537 </span><span class="cm">/***********************/</span>
<span class="lineno">3538 </span><span class="cm">/******************************************/</span>
<span class="lineno">3539 </span><span class="cm">/* NOTE: Irradiance Caching is Incomplete */</span>
<span class="lineno">3540 </span><span class="cm">/******************************************/</span>
<span class="lineno">3541 </span>
<span class="lineno">3542 </span><span class="cm">/**********************/</span>
<span class="lineno">3543 </span><span class="cm">/* Irradiance Caching */</span>
<span class="lineno">3544 </span><span class="cm">/**********************/</span>
<span class="lineno">3545 </span>
<span class="lineno">3546 </span><span class="n">__kernel</span> <span class="kt">void</span> <span class="nf">ic_hemisphere_sample</span><span class="p">(</span>
<span class="lineno">3547 </span>
<span class="lineno">3548 </span>    <span class="p">)</span>
<span class="lineno">3549 </span><span class="p">{</span>
<span class="lineno">3550 </span>
<span class="lineno">3551 </span>
<span class="lineno">3552 </span>
<span class="lineno">3553 </span><span class="p">}</span>
<span class="lineno">3554 </span>
<span class="lineno">3555 </span><span class="n">__kernel</span> <span class="kt">void</span> <span class="nf">ic_screen_textures</span><span class="p">(</span>
<span class="lineno">3556 </span>    <span class="n">__write_only</span> <span class="n">image2d_t</span> <span class="n">pos_tex</span><span class="p">,</span>
<span class="lineno">3557 </span>    <span class="n">__write_only</span> <span class="n">image2d_t</span> <span class="n">nrm_tex</span><span class="p">,</span>
<span class="lineno">3558 </span>    <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">width</span><span class="p">,</span>
<span class="lineno">3559 </span>    <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">height</span><span class="p">,</span>
<span class="lineno">3560 </span>    <span class="k">const</span> <span class="n">__global</span> <span class="kt">float</span><span class="o">*</span> <span class="n">ray_buffer</span><span class="p">,</span>
<span class="lineno">3561 </span>    <span class="k">const</span> <span class="n">vec4</span> <span class="n">pos</span><span class="p">,</span>
<span class="lineno">3562 </span>    <span class="k">const</span> <span class="n">__global</span> <span class="n">material</span><span class="o">*</span> <span class="n">material_buffer</span><span class="p">,</span>
<span class="lineno">3563 </span>    <span class="k">const</span> <span class="n">__global</span> <span class="n">sphere</span><span class="o">*</span> <span class="n">spheres</span><span class="p">,</span>
<span class="lineno">3564 </span>    <span class="k">const</span> <span class="n">__global</span> <span class="n">plane</span><span class="o">*</span> <span class="n">planes</span><span class="p">,</span>
<span class="lineno">3565 </span>    <span class="k">const</span> <span class="n">__global</span> <span class="n">mesh</span><span class="o">*</span> <span class="n">meshes</span><span class="p">,</span>
<span class="lineno">3566 </span>    <span class="n">image1d_t</span> <span class="n">indices</span><span class="p">,</span>
<span class="lineno">3567 </span>    <span class="n">image1d_t</span> <span class="n">vertices</span><span class="p">,</span>
<span class="lineno">3568 </span>    <span class="n">image1d_t</span> <span class="n">normals</span><span class="p">)</span>
<span class="lineno">3569 </span><span class="p">{</span>
<span class="lineno">3570 </span>    <span class="n">scene</span> <span class="n">s</span><span class="p">;</span>
<span class="lineno">3571 </span>    <span class="n">s</span><span class="p">.</span><span class="n">material_buffer</span> <span class="o">=</span> <span class="n">material_buffer</span><span class="p">;</span>
<span class="lineno">3572 </span>    <span class="n">s</span><span class="p">.</span><span class="n">spheres</span>         <span class="o">=</span> <span class="n">spheres</span><span class="p">;</span>
<span class="lineno">3573 </span>    <span class="n">s</span><span class="p">.</span><span class="n">planes</span>          <span class="o">=</span> <span class="n">planes</span><span class="p">;</span>
<span class="lineno">3574 </span>    <span class="n">s</span><span class="p">.</span><span class="n">meshes</span>          <span class="o">=</span> <span class="n">meshes</span><span class="p">;</span>
<span class="lineno">3575 </span>
<span class="lineno">3576 </span>
<span class="lineno">3577 </span>    <span class="kt">int</span> <span class="n">id</span> <span class="o">=</span> <span class="n">get_global_id</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="lineno">3578 </span>    <span class="kt">int</span> <span class="n">x</span>  <span class="o">=</span> <span class="n">id</span><span class="o">%</span><span class="n">width</span><span class="p">;</span>
<span class="lineno">3579 </span>    <span class="kt">int</span> <span class="n">y</span>  <span class="o">=</span> <span class="n">id</span><span class="o">/</span><span class="n">width</span><span class="p">;</span>
<span class="lineno">3580 </span>    <span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">x</span><span class="o">+</span><span class="n">y</span><span class="o">*</span><span class="n">width</span><span class="p">;</span>
<span class="lineno">3581 </span>    <span class="kt">int</span> <span class="n">ray_offset</span> <span class="o">=</span> <span class="n">offset</span><span class="o">*</span><span class="mi">3</span><span class="p">;</span>
<span class="lineno">3582 </span>
<span class="lineno">3583 </span>    <span class="n">ray</span> <span class="n">r</span><span class="p">;</span>
<span class="lineno">3584 </span>    <span class="n">r</span><span class="p">.</span><span class="n">orig</span> <span class="o">=</span> <span class="n">pos</span><span class="p">.</span><span class="n">xyz</span><span class="p">;</span> <span class="c1">//NOTE: slow unaligned memory access.</span>
<span class="lineno">3585 </span>    <span class="n">r</span><span class="p">.</span><span class="n">dir</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">ray_buffer</span><span class="p">[</span><span class="n">ray_offset</span><span class="p">];</span>
<span class="lineno">3586 </span>    <span class="n">r</span><span class="p">.</span><span class="n">dir</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">ray_buffer</span><span class="p">[</span><span class="n">ray_offset</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
<span class="lineno">3587 </span>    <span class="n">r</span><span class="p">.</span><span class="n">dir</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">ray_buffer</span><span class="p">[</span><span class="n">ray_offset</span><span class="o">+</span><span class="mi">2</span><span class="p">];</span>
<span class="lineno">3588 </span>
<span class="lineno">3589 </span>    <span class="n">collision_result</span> <span class="n">result</span><span class="p">;</span>
<span class="lineno">3590 </span>    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">collide_all</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">MESH_SCENE_DATA</span><span class="p">))</span>
<span class="lineno">3591 </span>    <span class="p">{</span>
<span class="lineno">3592 </span>        <span class="n">write_imagef</span><span class="p">(</span><span class="n">pos_tex</span><span class="p">,</span> <span class="p">(</span><span class="n">int2</span><span class="p">)(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">),</span> <span class="p">(</span><span class="n">vec4</span><span class="p">)(</span><span class="mi">0</span><span class="p">));</span>
<span class="lineno">3593 </span>        <span class="n">write_imagef</span><span class="p">(</span><span class="n">nrm_tex</span><span class="p">,</span> <span class="p">(</span><span class="n">int2</span><span class="p">)(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">),</span> <span class="p">(</span><span class="n">vec4</span><span class="p">)(</span><span class="mi">0</span><span class="p">));</span>
<span class="lineno">3594 </span>        <span class="k">return</span><span class="p">;</span>
<span class="lineno">3595 </span>    <span class="p">}</span>
<span class="lineno">3596 </span>
<span class="lineno">3597 </span>    <span class="n">write_imagef</span><span class="p">(</span><span class="n">pos_tex</span><span class="p">,</span> <span class="p">(</span><span class="n">int2</span><span class="p">)(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">),</span> <span class="p">(</span><span class="n">vec4</span><span class="p">)(</span><span class="n">result</span><span class="p">.</span><span class="n">point</span><span class="p">,</span><span class="mi">0</span><span class="p">));</span> <span class="c1">//Maybe ???</span>
<span class="lineno">3598 </span>    <span class="n">write_imagef</span><span class="p">(</span><span class="n">nrm_tex</span><span class="p">,</span> <span class="p">(</span><span class="n">int2</span><span class="p">)(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">),</span> <span class="p">(</span><span class="n">vec4</span><span class="p">)(</span><span class="n">result</span><span class="p">.</span><span class="n">normal</span><span class="p">,</span><span class="mi">0</span><span class="p">));</span>
<span class="lineno">3599 </span>
<span class="lineno">3600 </span>    <span class="cm">/* pos_tex[offset] = (vec4)(result.point,0); */</span>
<span class="lineno">3601 </span>    <span class="cm">/* nrm_tex[offset] = (vec4)(result.normal,0); */</span>
<span class="lineno">3602 </span><span class="p">}</span>
<span class="lineno">3603 </span>
<span class="lineno">3604 </span>
<span class="lineno">3605 </span>
<span class="lineno">3606 </span><span class="n">__kernel</span> <span class="kt">void</span> <span class="nf">generate_discontinuity</span><span class="p">(</span>
<span class="lineno">3607 </span>    <span class="n">image2d_t</span> <span class="n">pos_tex</span><span class="p">,</span>
<span class="lineno">3608 </span>    <span class="n">image2d_t</span> <span class="n">nrm_tex</span><span class="p">,</span>
<span class="lineno">3609 </span>    <span class="n">__global</span> <span class="kt">float</span><span class="o">*</span> <span class="n">out_tex</span><span class="p">,</span>
<span class="lineno">3610 </span>    <span class="k">const</span> <span class="kt">float</span> <span class="n">k</span><span class="p">,</span>
<span class="lineno">3611 </span>    <span class="k">const</span> <span class="kt">float</span> <span class="n">intensity</span><span class="p">,</span>
<span class="lineno">3612 </span>    <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">width</span><span class="p">,</span>
<span class="lineno">3613 </span>    <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">height</span><span class="p">)</span>
<span class="lineno">3614 </span><span class="p">{</span>
<span class="lineno">3615 </span>    <span class="kt">int</span> <span class="n">id</span> <span class="o">=</span> <span class="n">get_global_id</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="lineno">3616 </span>    <span class="kt">int</span> <span class="n">x</span>  <span class="o">=</span> <span class="n">id</span><span class="o">%</span><span class="n">width</span><span class="p">;</span>
<span class="lineno">3617 </span>    <span class="kt">int</span> <span class="n">y</span>  <span class="o">=</span> <span class="n">id</span><span class="o">/</span><span class="n">width</span><span class="p">;</span>
<span class="lineno">3618 </span>    <span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">x</span><span class="o">+</span><span class="n">y</span><span class="o">*</span><span class="n">width</span><span class="p">;</span>
<span class="lineno">3619 </span>
<span class="lineno">3620 </span>    <span class="c1">//NOTE: this is fine for edges because the sampler is clamped</span>
<span class="lineno">3621 </span>
<span class="lineno">3622 </span>    <span class="c1">//Positions</span>
<span class="lineno">3623 </span>    <span class="n">vec4</span> <span class="n">pm</span> <span class="o">=</span> <span class="n">read_imagef</span><span class="p">(</span><span class="n">pos_tex</span><span class="p">,</span> <span class="n">sampler</span><span class="p">,</span> <span class="p">(</span><span class="n">int2</span><span class="p">)(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">));</span>
<span class="lineno">3624 </span>    <span class="n">vec4</span> <span class="n">pu</span> <span class="o">=</span> <span class="n">read_imagef</span><span class="p">(</span><span class="n">pos_tex</span><span class="p">,</span> <span class="n">sampler</span><span class="p">,</span> <span class="p">(</span><span class="n">int2</span><span class="p">)(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="o">+</span><span class="mi">1</span><span class="p">));</span>
<span class="lineno">3625 </span>    <span class="n">vec4</span> <span class="n">pd</span> <span class="o">=</span> <span class="n">read_imagef</span><span class="p">(</span><span class="n">pos_tex</span><span class="p">,</span> <span class="n">sampler</span><span class="p">,</span> <span class="p">(</span><span class="n">int2</span><span class="p">)(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="o">-</span><span class="mi">1</span><span class="p">));</span>
<span class="lineno">3626 </span>    <span class="n">vec4</span> <span class="n">pr</span> <span class="o">=</span> <span class="n">read_imagef</span><span class="p">(</span><span class="n">pos_tex</span><span class="p">,</span> <span class="n">sampler</span><span class="p">,</span> <span class="p">(</span><span class="n">int2</span><span class="p">)(</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">y</span><span class="p">));</span>
<span class="lineno">3627 </span>    <span class="n">vec4</span> <span class="n">pl</span> <span class="o">=</span> <span class="n">read_imagef</span><span class="p">(</span><span class="n">pos_tex</span><span class="p">,</span> <span class="n">sampler</span><span class="p">,</span> <span class="p">(</span><span class="n">int2</span><span class="p">)(</span><span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">y</span><span class="p">));</span>
<span class="lineno">3628 </span>
<span class="lineno">3629 </span>    <span class="c1">//NOTE: slow doing this many distance calculations</span>
<span class="lineno">3630 </span>    <span class="kt">float</span> <span class="n">posDiff</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">distance</span><span class="p">(</span><span class="n">pu</span><span class="p">,</span><span class="n">pm</span><span class="p">),</span>
<span class="lineno">3631 </span>                        <span class="n">max</span><span class="p">(</span><span class="n">distance</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span><span class="n">pm</span><span class="p">),</span>
<span class="lineno">3632 </span>                            <span class="n">max</span><span class="p">(</span><span class="n">distance</span><span class="p">(</span><span class="n">pr</span><span class="p">,</span><span class="n">pm</span><span class="p">),</span>
<span class="lineno">3633 </span>                                <span class="n">distance</span><span class="p">(</span><span class="n">pl</span><span class="p">,</span><span class="n">pm</span><span class="p">))));</span>
<span class="lineno">3634 </span>    <span class="n">posDiff</span> <span class="o">=</span> <span class="n">clamp</span><span class="p">(</span><span class="n">posDiff</span><span class="p">,</span> <span class="mf">0.f</span><span class="p">,</span> <span class="mf">1.f</span><span class="p">);</span>
<span class="lineno">3635 </span>    <span class="n">posDiff</span> <span class="o">*=</span> <span class="n">intensity</span><span class="p">;</span>
<span class="lineno">3636 </span>
<span class="lineno">3637 </span>    <span class="c1">//Normals</span>
<span class="lineno">3638 </span>    <span class="n">vec4</span> <span class="n">nm</span> <span class="o">=</span> <span class="n">read_imagef</span><span class="p">(</span><span class="n">nrm_tex</span><span class="p">,</span> <span class="n">sampler</span><span class="p">,</span> <span class="p">(</span><span class="n">int2</span><span class="p">)(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">));</span>
<span class="lineno">3639 </span>
<span class="lineno">3640 </span>    <span class="n">vec4</span> <span class="n">nu</span> <span class="o">=</span> <span class="n">read_imagef</span><span class="p">(</span><span class="n">nrm_tex</span><span class="p">,</span> <span class="n">sampler</span><span class="p">,</span> <span class="p">(</span><span class="n">int2</span><span class="p">)(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="o">+</span><span class="mi">1</span><span class="p">));</span>
<span class="lineno">3641 </span>    <span class="n">vec4</span> <span class="n">nd</span> <span class="o">=</span> <span class="n">read_imagef</span><span class="p">(</span><span class="n">nrm_tex</span><span class="p">,</span> <span class="n">sampler</span><span class="p">,</span> <span class="p">(</span><span class="n">int2</span><span class="p">)(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="o">-</span><span class="mi">1</span><span class="p">));</span>
<span class="lineno">3642 </span>    <span class="n">vec4</span> <span class="n">nr</span> <span class="o">=</span> <span class="n">read_imagef</span><span class="p">(</span><span class="n">nrm_tex</span><span class="p">,</span> <span class="n">sampler</span><span class="p">,</span> <span class="p">(</span><span class="n">int2</span><span class="p">)(</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">y</span><span class="p">));</span>
<span class="lineno">3643 </span>    <span class="n">vec4</span> <span class="n">nl</span> <span class="o">=</span> <span class="n">read_imagef</span><span class="p">(</span><span class="n">nrm_tex</span><span class="p">,</span> <span class="n">sampler</span><span class="p">,</span> <span class="p">(</span><span class="n">int2</span><span class="p">)(</span><span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">y</span><span class="p">));</span>
<span class="lineno">3644 </span>    <span class="c1">//NOTE: slow doing this many distance calculations</span>
<span class="lineno">3645 </span>    <span class="kt">float</span> <span class="n">nrmDiff</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">distance</span><span class="p">(</span><span class="n">nu</span><span class="p">,</span><span class="n">nm</span><span class="p">),</span>
<span class="lineno">3646 </span>                        <span class="n">max</span><span class="p">(</span><span class="n">distance</span><span class="p">(</span><span class="n">nd</span><span class="p">,</span><span class="n">nm</span><span class="p">),</span>
<span class="lineno">3647 </span>                            <span class="n">max</span><span class="p">(</span><span class="n">distance</span><span class="p">(</span><span class="n">nr</span><span class="p">,</span><span class="n">nm</span><span class="p">),</span>
<span class="lineno">3648 </span>                                <span class="n">distance</span><span class="p">(</span><span class="n">nl</span><span class="p">,</span><span class="n">nm</span><span class="p">))));</span>
<span class="lineno">3649 </span>    <span class="n">nrmDiff</span> <span class="o">=</span> <span class="n">clamp</span><span class="p">(</span><span class="n">nrmDiff</span><span class="p">,</span> <span class="mf">0.f</span><span class="p">,</span> <span class="mf">1.f</span><span class="p">);</span>
<span class="lineno">3650 </span>    <span class="n">nrmDiff</span> <span class="o">*=</span> <span class="n">intensity</span><span class="p">;</span>
<span class="lineno">3651 </span>
<span class="lineno">3652 </span>    <span class="n">out_tex</span><span class="p">[</span><span class="n">offset</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span><span class="o">*</span><span class="n">nrmDiff</span><span class="o">+</span><span class="n">posDiff</span><span class="p">;</span>
<span class="lineno">3653 </span><span class="p">}</span>
<span class="lineno">3654 </span>
<span class="lineno">3655 </span><span class="n">__kernel</span> <span class="kt">void</span> <span class="nf">float_average</span><span class="p">(</span>
<span class="lineno">3656 </span>    <span class="n">__global</span> <span class="kt">float</span><span class="o">*</span> <span class="n">in_tex</span><span class="p">,</span>
<span class="lineno">3657 </span>    <span class="n">__global</span> <span class="kt">float</span><span class="o">*</span> <span class="n">out_tex</span><span class="p">,</span>
<span class="lineno">3658 </span>    <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">width</span><span class="p">,</span>
<span class="lineno">3659 </span>    <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">height</span><span class="p">,</span>
<span class="lineno">3660 </span>    <span class="k">const</span> <span class="kt">int</span> <span class="n">total</span><span class="p">)</span>
<span class="lineno">3661 </span><span class="p">{</span>
<span class="lineno">3662 </span>    <span class="kt">int</span> <span class="n">id</span> <span class="o">=</span> <span class="n">get_global_id</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="lineno">3663 </span>    <span class="kt">int</span> <span class="n">x</span>  <span class="o">=</span> <span class="n">id</span><span class="o">%</span><span class="n">width</span><span class="p">;</span>
<span class="lineno">3664 </span>    <span class="kt">int</span> <span class="n">y</span>  <span class="o">=</span> <span class="n">id</span><span class="o">/</span><span class="n">width</span><span class="p">;</span>
<span class="lineno">3665 </span>    <span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">x</span><span class="o">+</span><span class="n">y</span><span class="o">*</span><span class="n">width</span><span class="p">;</span>
<span class="lineno">3666 </span>
<span class="lineno">3667 </span>    <span class="n">out_tex</span><span class="p">[</span><span class="n">offset</span><span class="p">]</span> <span class="o">+=</span> <span class="n">in_tex</span><span class="p">[</span><span class="n">offset</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">total</span><span class="p">;</span>
<span class="lineno">3668 </span>
<span class="lineno">3669 </span><span class="p">}</span>
<span class="lineno">3670 </span>
<span class="lineno">3671 </span>
<span class="lineno">3672 </span><span class="n">__kernel</span> <span class="kt">void</span> <span class="nf">mip_single_upsample</span><span class="p">(</span> <span class="c1">//nearest neighbour upsample.</span>
<span class="lineno">3673 </span>    <span class="n">__global</span> <span class="kt">float</span><span class="o">*</span> <span class="n">in_tex</span><span class="p">,</span>
<span class="lineno">3674 </span>    <span class="n">__global</span> <span class="kt">float</span><span class="o">*</span> <span class="n">out_tex</span><span class="p">,</span>
<span class="lineno">3675 </span>    <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="c1">//Of upsampled</span>
<span class="lineno">3676 </span>    <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">height</span><span class="p">)</span><span class="c1">//Of upsampled</span>
<span class="lineno">3677 </span><span class="p">{</span>
<span class="lineno">3678 </span>    <span class="kt">int</span> <span class="n">id</span> <span class="o">=</span> <span class="n">get_global_id</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="lineno">3679 </span>    <span class="kt">int</span> <span class="n">x</span>  <span class="o">=</span> <span class="n">id</span><span class="o">%</span><span class="n">width</span><span class="p">;</span>
<span class="lineno">3680 </span>    <span class="kt">int</span> <span class="n">y</span>  <span class="o">=</span> <span class="n">id</span><span class="o">/</span><span class="n">width</span><span class="p">;</span>
<span class="lineno">3681 </span>    <span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">x</span><span class="o">+</span><span class="n">y</span><span class="o">*</span><span class="n">width</span><span class="p">;</span>
<span class="lineno">3682 </span>
<span class="lineno">3683 </span>    <span class="n">out_tex</span><span class="p">[</span><span class="n">offset</span><span class="p">]</span> <span class="o">=</span> <span class="n">in_tex</span><span class="p">[(</span><span class="n">x</span><span class="o">+</span><span class="n">y</span><span class="o">*</span><span class="n">width</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">];</span> <span class="c1">//truncated</span>
<span class="lineno">3684 </span><span class="p">}</span>
<span class="lineno">3685 </span>
<span class="lineno">3686 </span><span class="n">__kernel</span> <span class="kt">void</span> <span class="nf">mip_upsample</span><span class="p">(</span> <span class="c1">//nearest neighbour upsample.</span>
<span class="lineno">3687 </span>    <span class="n">image2d_t</span> <span class="n">in_tex</span><span class="p">,</span>
<span class="lineno">3688 </span>    <span class="n">__write_only</span> <span class="n">image2d_t</span> <span class="n">out_tex</span><span class="p">,</span> <span class="c1">//NOTE: not having __write_only caused it to crash without err</span>
<span class="lineno">3689 </span>    <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="c1">//Of upsampled</span>
<span class="lineno">3690 </span>    <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">height</span><span class="p">)</span><span class="c1">//Of upsampled</span>
<span class="lineno">3691 </span><span class="p">{</span>
<span class="lineno">3692 </span>    <span class="kt">int</span> <span class="n">id</span> <span class="o">=</span> <span class="n">get_global_id</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="lineno">3693 </span>    <span class="kt">int</span> <span class="n">x</span>  <span class="o">=</span> <span class="n">id</span><span class="o">%</span><span class="n">width</span><span class="p">;</span>
<span class="lineno">3694 </span>    <span class="kt">int</span> <span class="n">y</span>  <span class="o">=</span> <span class="n">id</span><span class="o">/</span><span class="n">width</span><span class="p">;</span>
<span class="lineno">3695 </span>
<span class="lineno">3696 </span>    <span class="n">write_imagef</span><span class="p">(</span><span class="n">out_tex</span><span class="p">,</span> <span class="p">(</span><span class="n">int2</span><span class="p">)(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">),</span>
<span class="lineno">3697 </span>                 <span class="n">read_imagef</span><span class="p">(</span><span class="n">in_tex</span><span class="p">,</span> <span class="n">sampler</span><span class="p">,</span> <span class="p">(</span><span class="n">float2</span><span class="p">)((</span><span class="kt">float</span><span class="p">)</span><span class="n">x</span><span class="o">/</span><span class="mf">2.f</span><span class="p">,</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">y</span><span class="o">/</span><span class="mf">2.f</span><span class="p">)));</span>
<span class="lineno">3698 </span><span class="p">}</span>
<span class="lineno">3699 </span>
<span class="lineno">3700 </span><span class="n">__kernel</span> <span class="kt">void</span> <span class="nf">mip_upsample_scaled</span><span class="p">(</span> <span class="c1">//nearest neighbour upsample.</span>
<span class="lineno">3701 </span>    <span class="n">image2d_t</span> <span class="n">in_tex</span><span class="p">,</span>
<span class="lineno">3702 </span>    <span class="n">__write_only</span> <span class="n">image2d_t</span> <span class="n">out_tex</span><span class="p">,</span>
<span class="lineno">3703 </span>    <span class="k">const</span> <span class="kt">int</span> <span class="n">s</span><span class="p">,</span>
<span class="lineno">3704 </span>    <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="c1">//Of upsampled</span>
<span class="lineno">3705 </span>    <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">height</span><span class="p">)</span><span class="c1">//Of upsampled</span>
<span class="lineno">3706 </span><span class="p">{</span>
<span class="lineno">3707 </span>    <span class="kt">int</span> <span class="n">id</span> <span class="o">=</span> <span class="n">get_global_id</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="lineno">3708 </span>    <span class="kt">int</span> <span class="n">x</span>  <span class="o">=</span> <span class="n">id</span><span class="o">%</span><span class="n">width</span><span class="p">;</span>
<span class="lineno">3709 </span>    <span class="kt">int</span> <span class="n">y</span>  <span class="o">=</span> <span class="n">id</span><span class="o">/</span><span class="n">width</span><span class="p">;</span>
<span class="lineno">3710 </span>    <span class="kt">float</span> <span class="n">factor</span> <span class="o">=</span> <span class="n">pow</span><span class="p">(</span><span class="mf">2.f</span><span class="p">,</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">s</span><span class="p">);</span>
<span class="lineno">3711 </span>    <span class="n">write_imagef</span><span class="p">(</span><span class="n">out_tex</span><span class="p">,</span> <span class="p">(</span><span class="n">int2</span><span class="p">)(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">),</span>
<span class="lineno">3712 </span>                 <span class="n">read_imagef</span><span class="p">(</span><span class="n">in_tex</span><span class="p">,</span> <span class="n">sampler</span><span class="p">,</span> <span class="p">(</span><span class="n">float2</span><span class="p">)((</span><span class="kt">float</span><span class="p">)</span><span class="n">x</span><span class="o">/</span><span class="n">factor</span><span class="p">,</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">y</span><span class="o">/</span><span class="n">factor</span><span class="p">)));</span>
<span class="lineno">3713 </span><span class="p">}</span>
<span class="lineno">3714 </span><span class="n">__kernel</span> <span class="kt">void</span> <span class="nf">mip_single_upsample_scaled</span><span class="p">(</span> <span class="c1">//nearest neighbour upsample.</span>
<span class="lineno">3715 </span>    <span class="n">__global</span> <span class="kt">float</span><span class="o">*</span> <span class="n">in_tex</span><span class="p">,</span>
<span class="lineno">3716 </span>    <span class="n">__global</span> <span class="kt">float</span><span class="o">*</span> <span class="n">out_tex</span><span class="p">,</span>
<span class="lineno">3717 </span>    <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">s</span><span class="p">,</span>
<span class="lineno">3718 </span>    <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="c1">//Of upsampled</span>
<span class="lineno">3719 </span>    <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">height</span><span class="p">)</span><span class="c1">//Of upsampled</span>
<span class="lineno">3720 </span><span class="p">{</span>
<span class="lineno">3721 </span>    <span class="kt">int</span> <span class="n">id</span> <span class="o">=</span> <span class="n">get_global_id</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="lineno">3722 </span>    <span class="kt">int</span> <span class="n">x</span>  <span class="o">=</span> <span class="n">id</span><span class="o">%</span><span class="n">width</span><span class="p">;</span>
<span class="lineno">3723 </span>    <span class="kt">int</span> <span class="n">y</span>  <span class="o">=</span> <span class="n">id</span><span class="o">/</span><span class="n">width</span><span class="p">;</span>
<span class="lineno">3724 </span>    <span class="kt">int</span> <span class="n">factor</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">pow</span><span class="p">(</span><span class="mf">2.f</span><span class="p">,</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">s</span><span class="p">);</span>
<span class="lineno">3725 </span>    <span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">x</span><span class="o">+</span><span class="n">y</span><span class="o">*</span><span class="n">width</span><span class="p">;</span>
<span class="lineno">3726 </span>    <span class="kt">int</span> <span class="n">fwidth</span> <span class="o">=</span> <span class="n">width</span><span class="o">/</span><span class="n">factor</span><span class="p">;</span>
<span class="lineno">3727 </span>    <span class="kt">int</span> <span class="n">fheight</span> <span class="o">=</span> <span class="n">height</span><span class="o">/</span><span class="n">factor</span><span class="p">;</span>
<span class="lineno">3728 </span>
<span class="lineno">3729 </span>    <span class="n">out_tex</span><span class="p">[</span><span class="n">offset</span><span class="p">]</span> <span class="o">=</span> <span class="n">in_tex</span><span class="p">[(</span><span class="n">x</span><span class="o">/</span><span class="n">factor</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">y</span><span class="o">/</span><span class="n">factor</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">width</span><span class="o">/</span><span class="n">factor</span><span class="p">)];</span> <span class="c1">//truncated</span>
<span class="lineno">3730 </span><span class="p">}</span>
<span class="lineno">3731 </span>
<span class="lineno">3732 </span><span class="c1">//NOTE: not used</span>
<span class="lineno">3733 </span><span class="n">__kernel</span> <span class="kt">void</span> <span class="nf">mip_reduce</span><span class="p">(</span> <span class="c1">//not the best</span>
<span class="lineno">3734 </span>    <span class="n">image2d_t</span> <span class="n">in_tex</span><span class="p">,</span>
<span class="lineno">3735 </span>    <span class="n">__write_only</span> <span class="n">image2d_t</span> <span class="n">out_tex</span><span class="p">,</span>
<span class="lineno">3736 </span>    <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="c1">//Of reduced</span>
<span class="lineno">3737 </span>    <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">height</span><span class="p">)</span><span class="c1">//Of reduced</span>
<span class="lineno">3738 </span><span class="p">{</span>
<span class="lineno">3739 </span>    <span class="kt">int</span> <span class="n">id</span> <span class="o">=</span> <span class="n">get_global_id</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="lineno">3740 </span>    <span class="kt">int</span> <span class="n">x</span>  <span class="o">=</span> <span class="n">id</span><span class="o">%</span><span class="n">width</span><span class="p">;</span>
<span class="lineno">3741 </span>    <span class="kt">int</span> <span class="n">y</span>  <span class="o">=</span> <span class="n">id</span><span class="o">/</span><span class="n">width</span><span class="p">;</span>
<span class="lineno">3742 </span>
<span class="lineno">3743 </span>
<span class="lineno">3744 </span>
<span class="lineno">3745 </span>    <span class="n">vec4</span> <span class="n">p00</span> <span class="o">=</span> <span class="n">read_imagef</span><span class="p">(</span><span class="n">in_tex</span><span class="p">,</span> <span class="n">sampler</span><span class="p">,</span> <span class="p">(</span><span class="n">int2</span><span class="p">)(</span><span class="n">x</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span>   <span class="n">y</span><span class="o">*</span><span class="mi">2</span>  <span class="p">));</span>
<span class="lineno">3746 </span>
<span class="lineno">3747 </span>    <span class="n">vec4</span> <span class="n">p01</span> <span class="o">=</span> <span class="n">read_imagef</span><span class="p">(</span><span class="n">in_tex</span><span class="p">,</span> <span class="n">sampler</span><span class="p">,</span> <span class="p">(</span><span class="n">int2</span><span class="p">)(</span><span class="n">x</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">y</span><span class="o">*</span><span class="mi">2</span>  <span class="p">));</span>
<span class="lineno">3748 </span>
<span class="lineno">3749 </span>    <span class="n">vec4</span> <span class="n">p10</span> <span class="o">=</span> <span class="n">read_imagef</span><span class="p">(</span><span class="n">in_tex</span><span class="p">,</span> <span class="n">sampler</span><span class="p">,</span> <span class="p">(</span><span class="n">int2</span><span class="p">)(</span><span class="n">x</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span>   <span class="n">y</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">));</span>
<span class="lineno">3750 </span>
<span class="lineno">3751 </span>    <span class="n">vec4</span> <span class="n">p11</span> <span class="o">=</span> <span class="n">read_imagef</span><span class="p">(</span><span class="n">in_tex</span><span class="p">,</span> <span class="n">sampler</span><span class="p">,</span> <span class="p">(</span><span class="n">int2</span><span class="p">)(</span><span class="n">x</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">y</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">));</span>
<span class="lineno">3752 </span>
<span class="lineno">3753 </span>    <span class="n">write_imagef</span><span class="p">(</span><span class="n">out_tex</span><span class="p">,</span> <span class="p">(</span><span class="n">int2</span><span class="p">)(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">),</span> <span class="n">p00</span><span class="o">+</span><span class="n">p01</span><span class="o">+</span><span class="n">p10</span><span class="o">+</span><span class="n">p11</span><span class="o">/</span><span class="mf">4.f</span><span class="p">);</span>
<span class="lineno">3754 </span><span class="p">}</span>
<span class="lineno">3755 </span>
<span class="lineno">3756 </span>
<span class="lineno">3757 </span><span class="cm">/***********/</span>
<span class="lineno">3758 </span><span class="cm">/* path.cl */</span>
<span class="lineno">3759 </span><span class="cm">/***********/</span>
<span class="lineno">3760 </span>
<span class="lineno">3761 </span><span class="n">vec3</span> <span class="nf">uniformSampleHemisphere</span><span class="p">(</span><span class="k">const</span> <span class="kt">float</span> <span class="n">r1</span><span class="p">,</span> <span class="k">const</span> <span class="kt">float</span> <span class="n">r2</span><span class="p">)</span>
<span class="lineno">3762 </span><span class="p">{</span>
<span class="lineno">3763 </span>    <span class="kt">float</span> <span class="n">sinTheta</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">r1</span> <span class="o">*</span> <span class="n">r1</span><span class="p">);</span>
<span class="lineno">3764 </span>    <span class="kt">float</span> <span class="n">phi</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">M_PI</span> <span class="o">*</span> <span class="n">r2</span><span class="p">;</span>
<span class="lineno">3765 </span>    <span class="kt">float</span> <span class="n">x</span> <span class="o">=</span> <span class="n">sinTheta</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">);</span>
<span class="lineno">3766 </span>    <span class="kt">float</span> <span class="n">z</span> <span class="o">=</span> <span class="n">sinTheta</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">);</span>
<span class="lineno">3767 </span>    <span class="k">return</span> <span class="p">(</span><span class="n">vec3</span><span class="p">)(</span><span class="n">x</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">z</span><span class="p">);</span>
<span class="lineno">3768 </span><span class="p">}</span>
<span class="lineno">3769 </span><span class="n">vec3</span> <span class="nf">cosineSampleHemisphere</span><span class="p">(</span><span class="kt">float</span> <span class="n">u1</span><span class="p">,</span> <span class="kt">float</span> <span class="n">u2</span><span class="p">,</span> <span class="n">vec3</span> <span class="n">normal</span><span class="p">)</span>
<span class="lineno">3770 </span><span class="p">{</span>
<span class="lineno">3771 </span>    <span class="k">const</span> <span class="kt">float</span> <span class="n">r</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">u1</span><span class="p">);</span>
<span class="lineno">3772 </span>    <span class="k">const</span> <span class="kt">float</span> <span class="n">theta</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">M_PI</span> <span class="o">*</span> <span class="n">u2</span><span class="p">;</span>
<span class="lineno">3773 </span>
<span class="lineno">3774 </span>    <span class="n">vec3</span> <span class="n">w</span> <span class="o">=</span> <span class="n">normal</span><span class="p">;</span>
<span class="lineno">3775 </span>    <span class="n">vec3</span> <span class="n">axis</span> <span class="o">=</span> <span class="n">fabs</span><span class="p">(</span><span class="n">w</span><span class="p">.</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.1f</span> <span class="o">?</span> <span class="p">(</span><span class="n">vec3</span><span class="p">)(</span><span class="mf">0.0f</span><span class="p">,</span> <span class="mf">1.0f</span><span class="p">,</span> <span class="mf">0.0f</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="n">vec3</span><span class="p">)(</span><span class="mf">1.0f</span><span class="p">,</span> <span class="mf">0.0f</span><span class="p">,</span> <span class="mf">0.0f</span><span class="p">);</span>
<span class="lineno">3776 </span>    <span class="n">vec3</span> <span class="n">u</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">cross</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">w</span><span class="p">));</span>
<span class="lineno">3777 </span>    <span class="n">vec3</span> <span class="n">v</span> <span class="o">=</span> <span class="n">cross</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">u</span><span class="p">);</span>
<span class="lineno">3778 </span>
<span class="lineno">3779 </span>    <span class="cm">/* use the coordinte frame and random numbers to compute the next ray direction */</span>
<span class="lineno">3780 </span>    <span class="k">return</span> <span class="n">normalize</span><span class="p">(</span><span class="n">u</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span><span class="o">*</span><span class="n">r</span> <span class="o">+</span> <span class="n">v</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span><span class="o">*</span><span class="n">r</span> <span class="o">+</span> <span class="n">w</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.0f</span> <span class="o">-</span> <span class="n">u1</span><span class="p">));</span>
<span class="lineno">3781 </span><span class="p">}</span>
<span class="lineno">3782 </span>
<span class="lineno">3783 </span>
<span class="lineno">3784 </span><span class="cp">#define NUM_BOUNCES 8</span>
<span class="lineno">3785 </span><span class="cp">#define NUM_SAMPLES 64</span>
<span class="lineno">3786 </span><span class="n">__kernel</span> <span class="kt">void</span> <span class="nf">path_trace</span><span class="p">(</span>
<span class="lineno">3787 </span>    <span class="n">__global</span> <span class="n">vec4</span><span class="o">*</span> <span class="n">out_tex</span><span class="p">,</span>
<span class="lineno">3788 </span>    <span class="k">const</span> <span class="n">__global</span> <span class="kt">float</span><span class="o">*</span> <span class="n">ray_buffer</span><span class="p">,</span>
<span class="lineno">3789 </span>    <span class="k">const</span> <span class="n">__global</span> <span class="n">material</span><span class="o">*</span> <span class="n">material_buffer</span><span class="p">,</span>
<span class="lineno">3790 </span>    <span class="k">const</span> <span class="n">__global</span> <span class="n">sphere</span><span class="o">*</span> <span class="n">spheres</span><span class="p">,</span>
<span class="lineno">3791 </span>    <span class="k">const</span> <span class="n">__global</span> <span class="n">plane</span><span class="o">*</span> <span class="n">planes</span><span class="p">,</span>
<span class="lineno">3792 </span><span class="c1">//Mesh</span>
<span class="lineno">3793 </span>    <span class="k">const</span> <span class="n">__global</span> <span class="n">mesh</span><span class="o">*</span> <span class="n">meshes</span><span class="p">,</span>
<span class="lineno">3794 </span>    <span class="n">image1d_t</span> <span class="n">indices</span><span class="p">,</span>
<span class="lineno">3795 </span>    <span class="n">image1d_t</span> <span class="n">vertices</span><span class="p">,</span>
<span class="lineno">3796 </span>    <span class="n">image1d_t</span> <span class="n">normals</span><span class="p">,</span>
<span class="lineno">3797 </span>    <span class="cm">/* const __global vec2* texcoords, */</span>
<span class="lineno">3798 </span>    <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">width</span><span class="p">,</span>
<span class="lineno">3799 </span>    <span class="k">const</span> <span class="n">vec4</span> <span class="n">pos</span><span class="p">,</span>
<span class="lineno">3800 </span>    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">magic</span><span class="p">)</span>
<span class="lineno">3801 </span><span class="p">{</span>
<span class="lineno">3802 </span>    <span class="n">scene</span> <span class="n">s</span><span class="p">;</span>
<span class="lineno">3803 </span>    <span class="n">s</span><span class="p">.</span><span class="n">material_buffer</span> <span class="o">=</span> <span class="n">material_buffer</span><span class="p">;</span>
<span class="lineno">3804 </span>    <span class="n">s</span><span class="p">.</span><span class="n">spheres</span>         <span class="o">=</span> <span class="n">spheres</span><span class="p">;</span>
<span class="lineno">3805 </span>    <span class="n">s</span><span class="p">.</span><span class="n">planes</span>          <span class="o">=</span> <span class="n">planes</span><span class="p">;</span>
<span class="lineno">3806 </span>    <span class="n">s</span><span class="p">.</span><span class="n">meshes</span>          <span class="o">=</span> <span class="n">meshes</span><span class="p">;</span>
<span class="lineno">3807 </span>
<span class="lineno">3808 </span>
<span class="lineno">3809 </span>    <span class="k">const</span> <span class="n">vec4</span> <span class="n">sky</span> <span class="o">=</span> <span class="p">(</span><span class="n">vec4</span><span class="p">)</span> <span class="p">(</span><span class="mf">0.16</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="lineno">3810 </span>    <span class="c1">//return;</span>
<span class="lineno">3811 </span>    <span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="n">get_global_id</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="lineno">3812 </span>    <span class="kt">int</span> <span class="n">y</span> <span class="o">=</span> <span class="n">get_global_id</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="lineno">3813 </span>    <span class="c1">//int x  = id%width+ get_global_offset(0)%total_width;</span>
<span class="lineno">3814 </span>    <span class="c1">//int y  = id/width/* + get_global_offset(0)/total_width*/;</span>
<span class="lineno">3815 </span>    <span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="n">y</span><span class="o">*</span><span class="n">width</span><span class="p">);</span>
<span class="lineno">3816 </span>    <span class="kt">int</span> <span class="n">ray_offset</span> <span class="o">=</span> <span class="n">offset</span><span class="o">*</span><span class="mi">3</span><span class="p">;</span>
<span class="lineno">3817 </span>
<span class="lineno">3818 </span>    <span class="n">ray</span> <span class="n">r</span><span class="p">;</span>
<span class="lineno">3819 </span>    <span class="n">r</span><span class="p">.</span><span class="n">orig</span> <span class="o">=</span> <span class="n">pos</span><span class="p">.</span><span class="n">xyz</span><span class="p">;</span>
<span class="lineno">3820 </span>    <span class="n">r</span><span class="p">.</span><span class="n">dir</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">ray_buffer</span><span class="p">[</span><span class="n">ray_offset</span><span class="p">];</span> <span class="c1">//NOTE: unoptimized memory access.</span>
<span class="lineno">3821 </span>    <span class="n">r</span><span class="p">.</span><span class="n">dir</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">ray_buffer</span><span class="p">[</span><span class="n">ray_offset</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
<span class="lineno">3822 </span>    <span class="n">r</span><span class="p">.</span><span class="n">dir</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">ray_buffer</span><span class="p">[</span><span class="n">ray_offset</span><span class="o">+</span><span class="mi">2</span><span class="p">];</span>
<span class="lineno">3823 </span>
<span class="lineno">3824 </span>
<span class="lineno">3825 </span>
<span class="lineno">3826 </span>    <span class="k">union</span> <span class="p">{</span>
<span class="lineno">3827 </span>        <span class="kt">float</span> <span class="n">f</span><span class="p">;</span>
<span class="lineno">3828 </span>        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ui</span><span class="p">;</span>
<span class="lineno">3829 </span>    <span class="p">}</span> <span class="n">res</span><span class="p">;</span>
<span class="lineno">3830 </span>
<span class="lineno">3831 </span>    <span class="n">res</span><span class="p">.</span><span class="n">f</span> <span class="o">=</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">magic</span><span class="o">*</span><span class="n">M_PI</span><span class="o">+</span><span class="n">x</span><span class="p">;</span><span class="c1">//fill up the mantissa.</span>
<span class="lineno">3832 </span>    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">seed1</span> <span class="o">=</span> <span class="n">res</span><span class="p">.</span><span class="n">ui</span> <span class="o">+</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">sin</span><span class="p">((</span><span class="kt">float</span><span class="p">)</span><span class="n">x</span><span class="p">)</span><span class="o">*</span><span class="mf">7.f</span><span class="p">);</span>
<span class="lineno">3833 </span>
<span class="lineno">3834 </span>    <span class="n">res</span><span class="p">.</span><span class="n">f</span> <span class="o">=</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">magic</span><span class="o">*</span><span class="n">M_PI</span><span class="o">+</span><span class="n">y</span><span class="p">;</span>
<span class="lineno">3835 </span>    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">seed2</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">sin</span><span class="p">((</span><span class="kt">float</span><span class="p">)</span><span class="n">res</span><span class="p">.</span><span class="n">ui</span><span class="p">)</span><span class="o">*</span><span class="mf">7.f</span><span class="p">);</span>
<span class="lineno">3836 </span>
<span class="lineno">3837 </span>    <span class="n">collision_result</span> <span class="n">initial_result</span><span class="p">;</span>
<span class="lineno">3838 </span>    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">collide_all</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">initial_result</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">MESH_SCENE_DATA</span><span class="p">))</span>
<span class="lineno">3839 </span>    <span class="p">{</span>
<span class="lineno">3840 </span>        <span class="n">out_tex</span><span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="n">y</span><span class="o">*</span><span class="n">width</span><span class="p">]</span> <span class="o">=</span> <span class="n">sky</span><span class="p">;</span>
<span class="lineno">3841 </span>        <span class="k">return</span><span class="p">;</span>
<span class="lineno">3842 </span>    <span class="p">}</span>
<span class="lineno">3843 </span>
<span class="lineno">3844 </span>    <span class="n">vec3</span> <span class="n">fin_colour</span> <span class="o">=</span> <span class="p">(</span><span class="n">vec3</span><span class="p">)(</span><span class="mf">0.0f</span><span class="p">,</span> <span class="mf">0.0f</span><span class="p">,</span> <span class="mf">0.0f</span><span class="p">);</span>
<span class="lineno">3845 </span>    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_SAMPLES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="lineno">3846 </span>    <span class="p">{</span>
<span class="lineno">3847 </span>        <span class="n">vec3</span> <span class="n">accum_color</span> <span class="o">=</span> <span class="p">(</span><span class="n">vec3</span><span class="p">)(</span><span class="mf">0.0f</span><span class="p">,</span> <span class="mf">0.0f</span><span class="p">,</span> <span class="mf">0.0f</span><span class="p">);</span>
<span class="lineno">3848 </span>        <span class="n">vec3</span> <span class="n">mask</span>        <span class="o">=</span> <span class="p">(</span><span class="n">vec3</span><span class="p">)(</span><span class="mf">1.0f</span><span class="p">,</span> <span class="mf">1.0f</span><span class="p">,</span> <span class="mf">1.0f</span><span class="p">);</span>
<span class="lineno">3849 </span>        <span class="n">ray</span> <span class="n">sr</span><span class="p">;</span>
<span class="lineno">3850 </span>        <span class="kt">float</span> <span class="n">rand1</span> <span class="o">=</span> <span class="n">get_random</span><span class="p">(</span><span class="o">&amp;</span><span class="n">seed1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">seed2</span><span class="p">);</span>
<span class="lineno">3851 </span>        <span class="kt">float</span> <span class="n">rand2</span> <span class="o">=</span> <span class="n">get_random</span><span class="p">(</span><span class="o">&amp;</span><span class="n">seed1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">seed2</span><span class="p">);</span>
<span class="lineno">3852 </span>
<span class="lineno">3853 </span>        <span class="n">vec3</span> <span class="n">sample_dir</span> <span class="o">=</span>  <span class="n">cosineSampleHemisphere</span><span class="p">(</span><span class="n">rand1</span><span class="p">,</span> <span class="n">rand2</span><span class="p">,</span> <span class="n">initial_result</span><span class="p">.</span><span class="n">normal</span><span class="p">);</span>
<span class="lineno">3854 </span>        <span class="n">sr</span><span class="p">.</span><span class="n">orig</span> <span class="o">=</span> <span class="n">initial_result</span><span class="p">.</span><span class="n">point</span> <span class="o">+</span> <span class="n">initial_result</span><span class="p">.</span><span class="n">normal</span> <span class="o">*</span> <span class="mf">0.0001f</span><span class="p">;</span> <span class="c1">//sweet spot for epsilon</span>
<span class="lineno">3855 </span>        <span class="n">sr</span><span class="p">.</span><span class="n">dir</span> <span class="o">=</span> <span class="n">sample_dir</span><span class="p">;</span>
<span class="lineno">3856 </span>        <span class="n">mask</span> <span class="o">*=</span> <span class="n">initial_result</span><span class="p">.</span><span class="n">mat</span><span class="p">.</span><span class="n">colour</span><span class="p">;</span>
<span class="lineno">3857 </span>        <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">bounces</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bounces</span> <span class="o">&lt;</span> <span class="n">NUM_BOUNCES</span><span class="p">;</span> <span class="n">bounces</span><span class="o">++</span><span class="p">)</span>
<span class="lineno">3858 </span>        <span class="p">{</span>
<span class="lineno">3859 </span>            <span class="n">collision_result</span> <span class="n">result</span><span class="p">;</span>
<span class="lineno">3860 </span>            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">collide_all</span><span class="p">(</span><span class="n">sr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">MESH_SCENE_DATA</span><span class="p">))</span>
<span class="lineno">3861 </span>            <span class="p">{</span>
<span class="lineno">3862 </span>                <span class="n">accum_color</span> <span class="o">+=</span> <span class="n">mask</span> <span class="o">*</span> <span class="n">sky</span><span class="p">.</span><span class="n">xyz</span><span class="p">;</span>
<span class="lineno">3863 </span>                <span class="k">break</span><span class="p">;</span>
<span class="lineno">3864 </span>            <span class="p">}</span>
<span class="lineno">3865 </span>
<span class="lineno">3866 </span>
<span class="lineno">3867 </span>            <span class="n">rand1</span> <span class="o">=</span> <span class="n">get_random</span><span class="p">(</span><span class="o">&amp;</span><span class="n">seed1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">seed2</span><span class="p">);</span>
<span class="lineno">3868 </span>            <span class="n">rand2</span> <span class="o">=</span> <span class="n">get_random</span><span class="p">(</span><span class="o">&amp;</span><span class="n">seed1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">seed2</span><span class="p">);</span>
<span class="lineno">3869 </span>
<span class="lineno">3870 </span>            <span class="n">sample_dir</span> <span class="o">=</span>  <span class="n">cosineSampleHemisphere</span><span class="p">(</span><span class="n">rand1</span><span class="p">,</span> <span class="n">rand2</span><span class="p">,</span> <span class="n">result</span><span class="p">.</span><span class="n">normal</span><span class="p">);</span>
<span class="lineno">3871 </span>
<span class="lineno">3872 </span>            <span class="n">sr</span><span class="p">.</span><span class="n">orig</span> <span class="o">=</span> <span class="n">result</span><span class="p">.</span><span class="n">point</span> <span class="o">+</span> <span class="n">result</span><span class="p">.</span><span class="n">normal</span> <span class="o">*</span> <span class="mf">0.0001f</span><span class="p">;</span> <span class="c1">//sweet spot for epsilon</span>
<span class="lineno">3873 </span>            <span class="n">sr</span><span class="p">.</span><span class="n">dir</span> <span class="o">=</span> <span class="n">sample_dir</span><span class="p">;</span>
<span class="lineno">3874 </span>
<span class="lineno">3875 </span>            <span class="c1">//NOTE: janky emission, if reflectivity is 1 emission is 2 (only for tests)</span>
<span class="lineno">3876 </span>            <span class="n">accum_color</span> <span class="o">+=</span> <span class="n">mask</span> <span class="o">*</span> <span class="p">(</span><span class="kt">float</span><span class="p">)(</span><span class="n">result</span><span class="p">.</span><span class="n">mat</span><span class="p">.</span><span class="n">reflectivity</span><span class="o">==</span><span class="mf">1.</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">;</span> <span class="c1">//NOTE: EMMISION</span>
<span class="lineno">3877 </span>
<span class="lineno">3878 </span>
<span class="lineno">3879 </span>            <span class="n">mask</span> <span class="o">*=</span> <span class="n">result</span><span class="p">.</span><span class="n">mat</span><span class="p">.</span><span class="n">colour</span><span class="p">;</span>
<span class="lineno">3880 </span>
<span class="lineno">3881 </span>            <span class="n">mask</span> <span class="o">*=</span> <span class="n">dot</span><span class="p">(</span><span class="n">sample_dir</span><span class="p">,</span> <span class="n">result</span><span class="p">.</span><span class="n">normal</span><span class="p">);</span>
<span class="lineno">3882 </span>        <span class="p">}</span>
<span class="lineno">3883 </span>        <span class="n">accum_color</span> <span class="o">=</span> <span class="n">clamp</span><span class="p">(</span><span class="n">accum_color</span><span class="p">,</span> <span class="mf">0.f</span><span class="p">,</span> <span class="mf">1.f</span><span class="p">);</span>
<span class="lineno">3884 </span>
<span class="lineno">3885 </span>        <span class="n">fin_colour</span> <span class="o">+=</span> <span class="n">accum_color</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.f</span><span class="o">/</span><span class="n">NUM_SAMPLES</span><span class="p">);</span>
<span class="lineno">3886 </span>    <span class="p">}</span>
<span class="lineno">3887 </span>
<span class="lineno">3888 </span>    <span class="n">out_tex</span><span class="p">[</span><span class="n">offset</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">vec4</span><span class="p">)(</span><span class="n">fin_colour</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="lineno">3889 </span>
<span class="lineno">3890 </span><span class="p">}</span>
<span class="lineno">3891 </span>
<span class="lineno">3892 </span>
<span class="lineno">3893 </span><span class="n">__kernel</span> <span class="kt">void</span> <span class="nf">buffer_average</span><span class="p">(</span>
<span class="lineno">3894 </span>    <span class="n">__global</span> <span class="n">uchar4</span><span class="o">*</span> <span class="n">out_tex</span><span class="p">,</span>
<span class="lineno">3895 </span>    <span class="n">__global</span> <span class="n">uchar4</span><span class="o">*</span> <span class="n">fresh_frame_tex</span><span class="p">,</span>
<span class="lineno">3896 </span>    <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">width</span><span class="p">,</span>
<span class="lineno">3897 </span>    <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">height</span><span class="p">,</span>
<span class="lineno">3898 </span>    <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sample</span>
<span class="lineno">3899 </span>    <span class="cm">/*const unsigned int num_samples*/</span><span class="p">)</span>
<span class="lineno">3900 </span><span class="p">{</span>
<span class="lineno">3901 </span>    <span class="kt">int</span> <span class="n">id</span> <span class="o">=</span> <span class="n">get_global_id</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="lineno">3902 </span>    <span class="kt">int</span> <span class="n">x</span>  <span class="o">=</span> <span class="n">id</span><span class="o">%</span><span class="n">width</span><span class="p">;</span>
<span class="lineno">3903 </span>    <span class="kt">int</span> <span class="n">y</span>  <span class="o">=</span> <span class="n">id</span><span class="o">/</span><span class="n">width</span><span class="p">;</span>
<span class="lineno">3904 </span>    <span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">y</span> <span class="o">*</span> <span class="n">width</span><span class="p">);</span>
<span class="lineno">3905 </span>
<span class="lineno">3906 </span>
<span class="lineno">3907 </span>    <span class="n">float4</span> <span class="n">temp</span> <span class="o">=</span> <span class="n">mix</span><span class="p">((</span><span class="n">float4</span><span class="p">)(</span>
<span class="lineno">3908 </span>                          <span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">fresh_frame_tex</span><span class="p">[</span><span class="n">offset</span><span class="p">].</span><span class="n">x</span><span class="p">,</span>
<span class="lineno">3909 </span>                          <span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">fresh_frame_tex</span><span class="p">[</span><span class="n">offset</span><span class="p">].</span><span class="n">y</span><span class="p">,</span>
<span class="lineno">3910 </span>                          <span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">fresh_frame_tex</span><span class="p">[</span><span class="n">offset</span><span class="p">].</span><span class="n">z</span><span class="p">,</span>
<span class="lineno">3911 </span>                          <span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">fresh_frame_tex</span><span class="p">[</span><span class="n">offset</span><span class="p">].</span><span class="n">w</span><span class="p">),</span>
<span class="lineno">3912 </span>                      <span class="p">(</span><span class="n">float4</span><span class="p">)(</span>
<span class="lineno">3913 </span>                          <span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">out_tex</span><span class="p">[</span><span class="n">offset</span><span class="p">].</span><span class="n">x</span><span class="p">,</span>
<span class="lineno">3914 </span>                          <span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">out_tex</span><span class="p">[</span><span class="n">offset</span><span class="p">].</span><span class="n">y</span><span class="p">,</span>
<span class="lineno">3915 </span>                          <span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">out_tex</span><span class="p">[</span><span class="n">offset</span><span class="p">].</span><span class="n">z</span><span class="p">,</span>
<span class="lineno">3916 </span>                          <span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">out_tex</span><span class="p">[</span><span class="n">offset</span><span class="p">].</span><span class="n">w</span><span class="p">),</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">sample</span><span class="o">/</span><span class="mf">24.f</span><span class="p">);</span>
<span class="lineno">3917 </span>    <span class="cm">/*vec4 temp =  (float)(</span>
<span class="lineno">3918 </span><span class="cm">        (float)fresh_frame_tex[offset].x,</span>
<span class="lineno">3919 </span><span class="cm">        (float)fresh_frame_tex[offset].y,</span>
<span class="lineno">3920 </span><span class="cm">        (float)fresh_frame_tex[offset].z,</span>
<span class="lineno">3921 </span><span class="cm">        (float)fresh_frame_tex[offset].w)/12.f;*/</span>
<span class="lineno">3922 </span>    <span class="n">out_tex</span><span class="p">[</span><span class="n">offset</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">uchar4</span><span class="p">)</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">temp</span><span class="p">.</span><span class="n">x</span><span class="p">,</span>
<span class="lineno">3923 </span>                                <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">temp</span><span class="p">.</span><span class="n">y</span><span class="p">,</span>
<span class="lineno">3924 </span>                                <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">temp</span><span class="p">.</span><span class="n">z</span><span class="p">,</span>
<span class="lineno">3925 </span>                                <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">temp</span><span class="p">.</span><span class="n">w</span><span class="p">);</span>
<span class="lineno">3926 </span><span class="cm">/*</span>
<span class="lineno">3927 </span><span class="cm">        fresh_frame_tex[offset]/(unsigned char)(1.f/(1-(float)sample/255))</span>
<span class="lineno">3928 </span><span class="cm">        + out_tex[offset]/(unsigned char)(1.f/((float)sample/255));*/</span>
<span class="lineno">3929 </span><span class="p">}</span>
<span class="lineno">3930 </span>
<span class="lineno">3931 </span><span class="n">__kernel</span> <span class="kt">void</span> <span class="nf">f_buffer_average</span><span class="p">(</span>
<span class="lineno">3932 </span>    <span class="n">__global</span> <span class="n">vec4</span><span class="o">*</span> <span class="n">out_tex</span><span class="p">,</span>
<span class="lineno">3933 </span>    <span class="n">__global</span> <span class="n">vec4</span><span class="o">*</span> <span class="n">fresh_frame_tex</span><span class="p">,</span>
<span class="lineno">3934 </span>    <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">width</span><span class="p">,</span>
<span class="lineno">3935 </span>    <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">height</span><span class="p">,</span>
<span class="lineno">3936 </span>    <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_samples</span><span class="p">,</span>
<span class="lineno">3937 </span>    <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sample</span><span class="p">)</span>
<span class="lineno">3938 </span><span class="p">{</span>
<span class="lineno">3939 </span>    <span class="kt">int</span> <span class="n">id</span> <span class="o">=</span> <span class="n">get_global_id</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="lineno">3940 </span>    <span class="kt">int</span> <span class="n">x</span>  <span class="o">=</span> <span class="n">id</span><span class="o">%</span><span class="n">width</span><span class="p">;</span>
<span class="lineno">3941 </span>    <span class="kt">int</span> <span class="n">y</span>  <span class="o">=</span> <span class="n">id</span><span class="o">/</span><span class="n">width</span><span class="p">;</span>
<span class="lineno">3942 </span>    <span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">y</span> <span class="o">*</span> <span class="n">width</span><span class="p">);</span>
<span class="lineno">3943 </span>    <span class="n">out_tex</span><span class="p">[</span><span class="n">offset</span><span class="p">]</span> <span class="o">=</span> <span class="n">mix</span><span class="p">(</span><span class="n">fresh_frame_tex</span><span class="p">[</span><span class="n">offset</span><span class="p">],</span> <span class="n">out_tex</span><span class="p">[</span><span class="n">offset</span><span class="p">],</span>
<span class="lineno">3944 </span>                          <span class="p">((</span><span class="kt">float</span><span class="p">)</span><span class="n">sample</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">num_samples</span><span class="p">);</span>
<span class="lineno">3945 </span><span class="p">}</span>
<span class="lineno">3946 </span>
<span class="lineno">3947 </span><span class="n">__kernel</span> <span class="kt">void</span> <span class="nf">f_buffer_to_byte_buffer</span><span class="p">(</span>
<span class="lineno">3948 </span>    <span class="n">__global</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="o">*</span> <span class="n">out_tex</span><span class="p">,</span>
<span class="lineno">3949 </span>    <span class="n">__global</span> <span class="n">vec4</span><span class="o">*</span> <span class="n">fresh_frame_tex</span><span class="p">,</span>
<span class="lineno">3950 </span>    <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">width</span><span class="p">,</span>
<span class="lineno">3951 </span>    <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">height</span><span class="p">)</span>
<span class="lineno">3952 </span><span class="p">{</span>
<span class="lineno">3953 </span>    <span class="kt">int</span> <span class="n">id</span> <span class="o">=</span> <span class="n">get_global_id</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="lineno">3954 </span>    <span class="kt">int</span> <span class="n">x</span>  <span class="o">=</span> <span class="n">id</span><span class="o">%</span><span class="n">width</span><span class="p">;</span>
<span class="lineno">3955 </span>    <span class="kt">int</span> <span class="n">y</span>  <span class="o">=</span> <span class="n">id</span><span class="o">/</span><span class="n">width</span><span class="p">;</span>
<span class="lineno">3956 </span>    <span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">y</span> <span class="o">*</span> <span class="n">width</span><span class="p">);</span>
<span class="lineno">3957 </span>    <span class="n">out_tex</span><span class="p">[</span><span class="n">offset</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_colour</span><span class="p">(</span><span class="n">fresh_frame_tex</span><span class="p">[</span><span class="n">offset</span><span class="p">]);</span>
<span class="lineno">3958 </span><span class="p">}</span>
<span class="lineno">3959 </span>
<span class="lineno">3960 </span>
<span class="lineno">3961 </span><span class="cm">/******************/</span>
<span class="lineno">3962 </span><span class="cm">/* general_ray.cl */</span>
<span class="lineno">3963 </span><span class="cm">/******************/</span>
<span class="lineno">3964 </span>
<span class="lineno">3965 </span><span class="n">vec4</span> <span class="nf">shade</span><span class="p">(</span><span class="n">collision_result</span> <span class="n">result</span><span class="p">,</span> <span class="n">scene</span> <span class="n">s</span><span class="p">,</span> <span class="n">MESH_SCENE_DATA_PARAM</span><span class="p">)</span>
<span class="lineno">3966 </span><span class="p">{</span>
<span class="lineno">3967 </span>    <span class="k">const</span> <span class="n">vec3</span> <span class="n">light_pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">vec3</span><span class="p">)(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="lineno">3968 </span>    <span class="n">vec3</span> <span class="n">nspace_light_dir</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">light_pos</span><span class="o">-</span><span class="n">result</span><span class="p">.</span><span class="n">point</span><span class="p">);</span>
<span class="lineno">3969 </span>    <span class="n">vec4</span> <span class="n">test_lighting</span> <span class="o">=</span> <span class="p">(</span><span class="n">vec4</span><span class="p">)</span> <span class="p">(</span><span class="n">clamp</span><span class="p">((</span><span class="kt">float</span><span class="p">)</span><span class="n">dot</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">normal</span><span class="p">,</span> <span class="n">nspace_light_dir</span><span class="p">),</span> <span class="mf">0.0f</span><span class="p">,</span> <span class="mf">1.0f</span><span class="p">));</span>
<span class="lineno">3970 </span>    <span class="n">ray</span> <span class="n">r</span><span class="p">;</span>
<span class="lineno">3971 </span>    <span class="n">r</span><span class="p">.</span><span class="n">dir</span>  <span class="o">=</span> <span class="n">nspace_light_dir</span><span class="p">;</span>
<span class="lineno">3972 </span>    <span class="n">r</span><span class="p">.</span><span class="n">orig</span> <span class="o">=</span> <span class="n">result</span><span class="p">.</span><span class="n">point</span> <span class="o">+</span> <span class="n">nspace_light_dir</span><span class="o">*</span><span class="mf">0.01f</span><span class="p">;</span>
<span class="lineno">3973 </span>    <span class="n">collision_result</span> <span class="n">_cr</span><span class="p">;</span>
<span class="lineno">3974 </span>    <span class="kt">bool</span> <span class="n">visible</span> <span class="o">=</span> <span class="o">!</span><span class="n">collide_all</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">_cr</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">MESH_SCENE_DATA</span><span class="p">);</span>
<span class="lineno">3975 </span>    <span class="c1">//test_lighting *= (vec4)(result.mat.colour, 1.0f);</span>
<span class="lineno">3976 </span>    <span class="k">return</span> <span class="n">visible</span><span class="o">*</span><span class="n">test_lighting</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>
<span class="lineno">3977 </span><span class="p">}</span>
<span class="lineno">3978 </span>
<span class="lineno">3979 </span>
<span class="lineno">3980 </span><span class="n">__kernel</span> <span class="kt">void</span> <span class="nf">cast_ray_test</span><span class="p">(</span>
<span class="lineno">3981 </span>    <span class="n">__global</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="o">*</span> <span class="n">out_tex</span><span class="p">,</span>
<span class="lineno">3982 </span>    <span class="k">const</span> <span class="n">__global</span> <span class="kt">float</span><span class="o">*</span> <span class="n">ray_buffer</span><span class="p">,</span>
<span class="lineno">3983 </span>    <span class="k">const</span> <span class="n">__global</span> <span class="n">material</span><span class="o">*</span> <span class="n">material_buffer</span><span class="p">,</span>
<span class="lineno">3984 </span>    <span class="k">const</span> <span class="n">__global</span> <span class="n">sphere</span><span class="o">*</span> <span class="n">spheres</span><span class="p">,</span>
<span class="lineno">3985 </span>    <span class="k">const</span> <span class="n">__global</span> <span class="n">plane</span><span class="o">*</span> <span class="n">planes</span><span class="p">,</span>
<span class="lineno">3986 </span><span class="c1">//Mesh</span>
<span class="lineno">3987 </span>    <span class="k">const</span> <span class="n">__global</span> <span class="n">mesh</span><span class="o">*</span> <span class="n">meshes</span><span class="p">,</span>
<span class="lineno">3988 </span>    <span class="n">image1d_t</span> <span class="n">indices</span><span class="p">,</span>
<span class="lineno">3989 </span>    <span class="n">image1d_t</span> <span class="n">vertices</span><span class="p">,</span>
<span class="lineno">3990 </span>    <span class="n">image1d_t</span> <span class="n">normals</span><span class="p">,</span>
<span class="lineno">3991 </span>    <span class="cm">/* const __global vec2* texcoords, */</span>
<span class="lineno">3992 </span>    <span class="cm">/* , */</span>
<span class="lineno">3993 </span>
<span class="lineno">3994 </span>
<span class="lineno">3995 </span>    <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">width</span><span class="p">,</span>
<span class="lineno">3996 </span>    <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">height</span><span class="p">,</span>
<span class="lineno">3997 </span>    <span class="k">const</span> <span class="n">vec4</span> <span class="n">pos</span><span class="p">)</span>
<span class="lineno">3998 </span><span class="p">{</span>
<span class="lineno">3999 </span>    <span class="n">scene</span> <span class="n">s</span><span class="p">;</span>
<span class="lineno">4000 </span>    <span class="n">s</span><span class="p">.</span><span class="n">material_buffer</span> <span class="o">=</span> <span class="n">material_buffer</span><span class="p">;</span>
<span class="lineno">4001 </span>    <span class="n">s</span><span class="p">.</span><span class="n">spheres</span>         <span class="o">=</span> <span class="n">spheres</span><span class="p">;</span>
<span class="lineno">4002 </span>    <span class="n">s</span><span class="p">.</span><span class="n">planes</span>          <span class="o">=</span> <span class="n">planes</span><span class="p">;</span>
<span class="lineno">4003 </span>    <span class="n">s</span><span class="p">.</span><span class="n">meshes</span>          <span class="o">=</span> <span class="n">meshes</span><span class="p">;</span>
<span class="lineno">4004 </span>
<span class="lineno">4005 </span>    <span class="k">const</span> <span class="n">vec4</span> <span class="n">sky</span> <span class="o">=</span> <span class="p">(</span><span class="n">vec4</span><span class="p">)</span> <span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="lineno">4006 </span>    <span class="c1">//return;</span>
<span class="lineno">4007 </span>    <span class="kt">int</span> <span class="n">id</span> <span class="o">=</span> <span class="n">get_global_id</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="lineno">4008 </span>    <span class="kt">int</span> <span class="n">x</span>  <span class="o">=</span> <span class="n">id</span><span class="o">%</span><span class="n">width</span><span class="p">;</span>
<span class="lineno">4009 </span>    <span class="kt">int</span> <span class="n">y</span>  <span class="o">=</span> <span class="n">id</span><span class="o">/</span><span class="n">width</span><span class="p">;</span>
<span class="lineno">4010 </span>    <span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">x</span><span class="o">+</span><span class="n">y</span><span class="o">*</span><span class="n">width</span><span class="p">;</span>
<span class="lineno">4011 </span>    <span class="kt">int</span> <span class="n">ray_offset</span> <span class="o">=</span> <span class="n">offset</span><span class="o">*</span><span class="mi">3</span><span class="p">;</span>
<span class="lineno">4012 </span>
<span class="lineno">4013 </span>
<span class="lineno">4014 </span>    <span class="n">ray</span> <span class="n">r</span><span class="p">;</span>
<span class="lineno">4015 </span>    <span class="n">r</span><span class="p">.</span><span class="n">orig</span> <span class="o">=</span> <span class="n">pos</span><span class="p">.</span><span class="n">xyz</span><span class="p">;</span> <span class="c1">//NOTE: unoptimized unaligned memory access.</span>
<span class="lineno">4016 </span>    <span class="n">r</span><span class="p">.</span><span class="n">dir</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">ray_buffer</span><span class="p">[</span><span class="n">ray_offset</span><span class="p">];</span>
<span class="lineno">4017 </span>    <span class="n">r</span><span class="p">.</span><span class="n">dir</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">ray_buffer</span><span class="p">[</span><span class="n">ray_offset</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
<span class="lineno">4018 </span>    <span class="n">r</span><span class="p">.</span><span class="n">dir</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">ray_buffer</span><span class="p">[</span><span class="n">ray_offset</span><span class="o">+</span><span class="mi">2</span><span class="p">];</span>
<span class="lineno">4019 </span>
<span class="lineno">4020 </span>    <span class="c1">//r.dir  = (vec3)(0,0,-1);</span>
<span class="lineno">4021 </span>
<span class="lineno">4022 </span>    <span class="c1">//out_tex[x+y*width] = get_colour_signed((vec4)(r.dir,0));</span>
<span class="lineno">4023 </span>    <span class="c1">//out_tex[x+y*width] = get_colour_signed((vec4)(1,1,0,0));</span>
<span class="lineno">4024 </span>    <span class="n">collision_result</span> <span class="n">result</span><span class="p">;</span>
<span class="lineno">4025 </span>    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">collide_all</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">MESH_SCENE_DATA</span><span class="p">))</span>
<span class="lineno">4026 </span>    <span class="p">{</span>
<span class="lineno">4027 </span>        <span class="n">out_tex</span><span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="n">y</span><span class="o">*</span><span class="n">width</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_colour</span><span class="p">(</span> <span class="n">sky</span> <span class="p">);</span>
<span class="lineno">4028 </span>        <span class="k">return</span><span class="p">;</span>
<span class="lineno">4029 </span>    <span class="p">}</span>
<span class="lineno">4030 </span>    <span class="n">vec4</span> <span class="n">colour</span> <span class="o">=</span> <span class="n">shade</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">MESH_SCENE_DATA</span><span class="p">);</span>
<span class="lineno">4031 </span>
<span class="lineno">4032 </span>
<span class="lineno">4033 </span>    <span class="cp">#define NUM_REFLECTIONS 2</span>
<span class="lineno">4034 </span>    <span class="n">ray</span> <span class="n">rays</span><span class="p">[</span><span class="n">NUM_REFLECTIONS</span><span class="p">];</span>
<span class="lineno">4035 </span>    <span class="n">collision_result</span> <span class="n">results</span><span class="p">[</span><span class="n">NUM_REFLECTIONS</span><span class="p">];</span>
<span class="lineno">4036 </span>    <span class="n">vec4</span> <span class="n">colours</span><span class="p">[</span><span class="n">NUM_REFLECTIONS</span><span class="p">];</span>
<span class="lineno">4037 </span>    <span class="kt">int</span> <span class="n">early_exit_num</span> <span class="o">=</span> <span class="n">NUM_REFLECTIONS</span><span class="p">;</span>
<span class="lineno">4038 </span>    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_REFLECTIONS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="lineno">4039 </span>    <span class="p">{</span>
<span class="lineno">4040 </span>        <span class="k">if</span><span class="p">(</span><span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
<span class="lineno">4041 </span>        <span class="p">{</span>
<span class="lineno">4042 </span>            <span class="n">rays</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">orig</span> <span class="o">=</span> <span class="n">result</span><span class="p">.</span><span class="n">point</span> <span class="o">+</span> <span class="n">result</span><span class="p">.</span><span class="n">normal</span> <span class="o">*</span> <span class="mf">0.0001f</span><span class="p">;</span> <span class="c1">//NOTE: BIAS</span>
<span class="lineno">4043 </span>            <span class="n">rays</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dir</span>  <span class="o">=</span> <span class="n">reflect</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">dir</span><span class="p">,</span> <span class="n">result</span><span class="p">.</span><span class="n">normal</span><span class="p">);</span>
<span class="lineno">4044 </span>        <span class="p">}</span>
<span class="lineno">4045 </span>        <span class="k">else</span>
<span class="lineno">4046 </span>        <span class="p">{</span>
<span class="lineno">4047 </span>            <span class="n">rays</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">orig</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">point</span> <span class="o">+</span> <span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">normal</span> <span class="o">*</span> <span class="mf">0.0001f</span><span class="p">;</span> <span class="c1">//NOTE: BIAS</span>
<span class="lineno">4048 </span>            <span class="n">rays</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dir</span>  <span class="o">=</span> <span class="n">reflect</span><span class="p">(</span><span class="n">rays</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">dir</span><span class="p">,</span> <span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">normal</span><span class="p">);</span>
<span class="lineno">4049 </span>        <span class="p">}</span>
<span class="lineno">4050 </span>        <span class="k">if</span><span class="p">(</span><span class="n">collide_all</span><span class="p">(</span><span class="n">rays</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">results</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">MESH_SCENE_DATA</span><span class="p">))</span>
<span class="lineno">4051 </span>        <span class="p">{</span>
<span class="lineno">4052 </span>            <span class="n">colours</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">shade</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">s</span><span class="p">,</span> <span class="n">MESH_SCENE_DATA</span><span class="p">);</span>
<span class="lineno">4053 </span>        <span class="p">}</span>
<span class="lineno">4054 </span>        <span class="k">else</span>
<span class="lineno">4055 </span>        <span class="p">{</span>
<span class="lineno">4056 </span>            <span class="n">colours</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sky</span><span class="p">;</span>
<span class="lineno">4057 </span>            <span class="n">early_exit_num</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
<span class="lineno">4058 </span>            <span class="k">break</span><span class="p">;</span>
<span class="lineno">4059 </span>        <span class="p">}</span>
<span class="lineno">4060 </span>    <span class="p">}</span>
<span class="lineno">4061 </span>    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">early_exit_num</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span>
<span class="lineno">4062 </span>    <span class="p">{</span>
<span class="lineno">4063 </span>        <span class="k">if</span><span class="p">(</span><span class="n">i</span><span class="o">==</span><span class="n">NUM_REFLECTIONS</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="lineno">4064 </span>            <span class="n">colours</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">mix</span><span class="p">(</span><span class="n">colours</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">sky</span><span class="p">,</span> <span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mat</span><span class="p">.</span><span class="n">reflectivity</span><span class="p">);</span>
<span class="lineno">4065 </span>
<span class="lineno">4066 </span>        <span class="k">else</span>
<span class="lineno">4067 </span>            <span class="n">colours</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">mix</span><span class="p">(</span><span class="n">colours</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">colours</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mat</span><span class="p">.</span><span class="n">reflectivity</span><span class="p">);</span>
<span class="lineno">4068 </span>
<span class="lineno">4069 </span>    <span class="p">}</span>
<span class="lineno">4070 </span>
<span class="lineno">4071 </span>    <span class="n">colour</span> <span class="o">=</span> <span class="n">mix</span><span class="p">(</span><span class="n">colour</span><span class="p">,</span> <span class="n">colours</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>  <span class="n">result</span><span class="p">.</span><span class="n">mat</span><span class="p">.</span><span class="n">reflectivity</span><span class="p">);</span>
<span class="lineno">4072 </span>
<span class="lineno">4073 </span>    <span class="n">out_tex</span><span class="p">[</span><span class="n">offset</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_colour</span><span class="p">(</span> <span class="n">colour</span> <span class="p">);</span>
<span class="lineno">4074 </span><span class="p">}</span>
<span class="lineno">4075 </span>
<span class="lineno">4076 </span>
<span class="lineno">4077 </span><span class="c1">//NOTE: it might be faster to make the ray buffer a multiple of 4 just to align with words...</span>
<span class="lineno">4078 </span><span class="n">__kernel</span> <span class="kt">void</span> <span class="nf">generate_rays</span><span class="p">(</span>
<span class="lineno">4079 </span>    <span class="n">__global</span> <span class="kt">float</span><span class="o">*</span> <span class="n">out_tex</span><span class="p">,</span>
<span class="lineno">4080 </span>    <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">width</span><span class="p">,</span>
<span class="lineno">4081 </span>    <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">height</span><span class="p">,</span>
<span class="lineno">4082 </span>    <span class="k">const</span> <span class="n">t_mat4</span> <span class="n">wcm</span><span class="p">)</span>
<span class="lineno">4083 </span><span class="p">{</span>
<span class="lineno">4084 </span>    <span class="kt">int</span> <span class="n">id</span> <span class="o">=</span> <span class="n">get_global_id</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="lineno">4085 </span>    <span class="kt">int</span> <span class="n">x</span>  <span class="o">=</span> <span class="n">id</span><span class="o">%</span><span class="n">width</span><span class="p">;</span>
<span class="lineno">4086 </span>    <span class="kt">int</span> <span class="n">y</span>  <span class="o">=</span> <span class="n">id</span><span class="o">/</span><span class="n">width</span><span class="p">;</span>
<span class="lineno">4087 </span>    <span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">y</span> <span class="o">*</span> <span class="n">width</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span><span class="p">;</span>
<span class="lineno">4088 </span>
<span class="lineno">4089 </span>    <span class="n">ray</span> <span class="n">r</span><span class="p">;</span>
<span class="lineno">4090 </span>
<span class="lineno">4091 </span>    <span class="kt">float</span> <span class="n">aspect_ratio</span> <span class="o">=</span> <span class="n">width</span> <span class="o">/</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">height</span><span class="p">;</span> <span class="c1">// assuming width &gt; height</span>
<span class="lineno">4092 </span>    <span class="kt">float</span> <span class="n">cam_x</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(((</span><span class="kt">float</span><span class="p">)</span><span class="n">x</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">/</span> <span class="n">width</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">tan</span><span class="p">(</span><span class="n">FOV</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">M_PI</span> <span class="o">/</span> <span class="mi">180</span><span class="p">)</span> <span class="o">*</span> <span class="n">aspect_ratio</span><span class="p">;</span>
<span class="lineno">4093 </span>    <span class="kt">float</span> <span class="n">cam_y</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(((</span><span class="kt">float</span><span class="p">)</span><span class="n">y</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">/</span> <span class="n">height</span><span class="p">))</span> <span class="o">*</span> <span class="n">tan</span><span class="p">(</span><span class="n">FOV</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">M_PI</span> <span class="o">/</span> <span class="mi">180</span><span class="p">);</span>
<span class="lineno">4094 </span>
<span class="lineno">4095 </span>    <span class="c1">//r.orig = matvec((float*)&amp;wcm, (vec4)(0.0, 0.0, 0.0, 1.0)).xyz;</span>
<span class="lineno">4096 </span>    <span class="c1">//r.dir  = matvec((float*)&amp;wcm, (vec4)(cam_x, cam_y, -1.0f, 1)).xyz - r.orig;</span>
<span class="lineno">4097 </span>
<span class="lineno">4098 </span>    <span class="n">r</span><span class="p">.</span><span class="n">orig</span> <span class="o">=</span> <span class="p">(</span><span class="n">vec3</span><span class="p">)(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="lineno">4099 </span>    <span class="n">r</span><span class="p">.</span><span class="n">dir</span>  <span class="o">=</span> <span class="p">(</span><span class="n">vec3</span><span class="p">)(</span><span class="n">cam_x</span><span class="p">,</span> <span class="n">cam_y</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0f</span><span class="p">)</span> <span class="o">-</span> <span class="n">r</span><span class="p">.</span><span class="n">orig</span><span class="p">;</span>
<span class="lineno">4100 </span>
<span class="lineno">4101 </span>    <span class="n">r</span><span class="p">.</span><span class="n">dir</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">dir</span><span class="p">);</span>
<span class="lineno">4102 </span>
<span class="lineno">4103 </span>    <span class="n">out_tex</span><span class="p">[</span><span class="n">offset</span><span class="p">]</span>   <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">dir</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="lineno">4104 </span>    <span class="n">out_tex</span><span class="p">[</span><span class="n">offset</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">dir</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
<span class="lineno">4105 </span>    <span class="n">out_tex</span><span class="p">[</span><span class="n">offset</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">dir</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
<span class="lineno">4106 </span><span class="p">}</span>
<span class="lineno">4107 </span>
<span class="lineno">4108 </span><span class="cm">/***********/</span>
<span class="lineno">4109 </span><span class="cm">/* util.cl */</span>
<span class="lineno">4110 </span><span class="cm">/***********/</span>
<span class="lineno">4111 </span><span class="cp">#define FOV 80.0f</span>
<span class="lineno">4112 </span>
<span class="lineno">4113 </span><span class="cp">#define vec3 float3</span>
<span class="lineno">4114 </span><span class="cp">#define vec4 float4</span>
<span class="lineno">4115 </span>
<span class="lineno">4116 </span><span class="cp">#define EPSILON 0.0000001f</span>
<span class="lineno">4117 </span><span class="cp">#define FAR_PLANE 100000000</span>
<span class="lineno">4118 </span>
<span class="lineno">4119 </span><span class="k">typedef</span> <span class="kt">float</span> <span class="n">mat4</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
<span class="lineno">4120 </span>
<span class="lineno">4121 </span>
<span class="lineno">4122 </span>
<span class="lineno">4123 </span><span class="cm">/********/</span>
<span class="lineno">4124 </span><span class="cm">/* Util */</span>
<span class="lineno">4125 </span><span class="cm">/********/</span>
<span class="lineno">4126 </span>
<span class="lineno">4127 </span>
<span class="lineno">4128 </span><span class="n">__constant</span> <span class="n">sampler_t</span> <span class="n">sampler</span> <span class="o">=</span> <span class="n">CLK_NORMALIZED_COORDS_FALSE</span> <span class="o">|</span>
<span class="lineno">4129 </span>    <span class="n">CLK_ADDRESS_CLAMP_TO_EDGE</span>   <span class="o">|</span>
<span class="lineno">4130 </span>    <span class="n">CLK_FILTER_NEAREST</span><span class="p">;</span>
<span class="lineno">4131 </span>
<span class="lineno">4132 </span><span class="k">typedef</span> <span class="k">struct</span>
<span class="lineno">4133 </span><span class="p">{</span>
<span class="lineno">4134 </span>    <span class="n">vec4</span> <span class="n">x</span><span class="p">;</span>
<span class="lineno">4135 </span>    <span class="n">vec4</span> <span class="n">y</span><span class="p">;</span>
<span class="lineno">4136 </span>    <span class="n">vec4</span> <span class="n">z</span><span class="p">;</span>
<span class="lineno">4137 </span>    <span class="n">vec4</span> <span class="n">w</span><span class="p">;</span>
<span class="lineno">4138 </span><span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">aligned</span> <span class="p">(</span><span class="mi">16</span><span class="p">)))</span> <span class="n">t_mat4</span><span class="p">;</span>
<span class="lineno">4139 </span>
<span class="lineno">4140 </span><span class="kt">void</span> <span class="nf">swap_float</span><span class="p">(</span><span class="kt">float</span> <span class="o">*</span><span class="n">f1</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="n">f2</span><span class="p">)</span>
<span class="lineno">4141 </span><span class="p">{</span>
<span class="lineno">4142 </span>    <span class="kt">float</span> <span class="n">temp</span> <span class="o">=</span> <span class="o">*</span><span class="n">f2</span><span class="p">;</span>
<span class="lineno">4143 </span>    <span class="o">*</span><span class="n">f2</span> <span class="o">=</span> <span class="o">*</span><span class="n">f1</span><span class="p">;</span>
<span class="lineno">4144 </span>    <span class="o">*</span><span class="n">f1</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>
<span class="lineno">4145 </span><span class="p">}</span>
<span class="lineno">4146 </span>
<span class="lineno">4147 </span><span class="n">vec4</span> <span class="nf">matvec</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span> <span class="n">m</span><span class="p">,</span> <span class="n">vec4</span> <span class="n">v</span><span class="p">)</span>
<span class="lineno">4148 </span><span class="p">{</span>
<span class="lineno">4149 </span>    <span class="k">return</span> <span class="p">(</span><span class="n">vec4</span><span class="p">)</span> <span class="p">(</span>
<span class="lineno">4150 </span>        <span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="o">+</span><span class="mi">0</span><span class="o">*</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">v</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="o">+</span><span class="mi">0</span><span class="o">*</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">v</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">m</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="mi">0</span><span class="o">*</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">v</span><span class="p">.</span><span class="n">z</span> <span class="o">+</span> <span class="n">m</span><span class="p">[</span><span class="mi">3</span><span class="o">+</span><span class="mi">0</span><span class="o">*</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">v</span><span class="p">.</span><span class="n">w</span><span class="p">,</span>
<span class="lineno">4151 </span>        <span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="o">+</span><span class="mi">1</span><span class="o">*</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">v</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="o">+</span><span class="mi">1</span><span class="o">*</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">v</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">m</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="o">*</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">v</span><span class="p">.</span><span class="n">z</span> <span class="o">+</span> <span class="n">m</span><span class="p">[</span><span class="mi">3</span><span class="o">+</span><span class="mi">1</span><span class="o">*</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">v</span><span class="p">.</span><span class="n">w</span><span class="p">,</span>
<span class="lineno">4152 </span>        <span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">v</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">v</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">m</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">v</span><span class="p">.</span><span class="n">z</span> <span class="o">+</span> <span class="n">m</span><span class="p">[</span><span class="mi">3</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">v</span><span class="p">.</span><span class="n">w</span><span class="p">,</span>
<span class="lineno">4153 </span>        <span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">v</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">v</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">m</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">v</span><span class="p">.</span><span class="n">z</span> <span class="o">+</span> <span class="n">m</span><span class="p">[</span><span class="mi">3</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">v</span><span class="p">.</span><span class="n">w</span> <span class="p">);</span>
<span class="lineno">4154 </span><span class="p">}</span>
<span class="lineno">4155 </span>
<span class="lineno">4156 </span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">get_colour</span><span class="p">(</span><span class="n">vec4</span> <span class="n">col</span><span class="p">)</span>
<span class="lineno">4157 </span><span class="p">{</span>
<span class="lineno">4158 </span>    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">outCol</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno">4159 </span>
<span class="lineno">4160 </span>    <span class="n">col</span> <span class="o">=</span> <span class="n">clamp</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="mf">0.0f</span><span class="p">,</span> <span class="mf">1.0f</span><span class="p">);</span>
<span class="lineno">4161 </span>
<span class="lineno">4162 </span>    <span class="n">outCol</span> <span class="o">|=</span> <span class="mh">0xff000000</span> <span class="o">&amp;</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)(</span><span class="n">col</span><span class="p">.</span><span class="n">w</span><span class="o">*</span><span class="mi">255</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">24</span><span class="p">;</span>
<span class="lineno">4163 </span>    <span class="n">outCol</span> <span class="o">|=</span> <span class="mh">0x00ff0000</span> <span class="o">&amp;</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)(</span><span class="n">col</span><span class="p">.</span><span class="n">x</span><span class="o">*</span><span class="mi">255</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">;</span>
<span class="lineno">4164 </span>    <span class="n">outCol</span> <span class="o">|=</span> <span class="mh">0x0000ff00</span> <span class="o">&amp;</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)(</span><span class="n">col</span><span class="p">.</span><span class="n">y</span><span class="o">*</span><span class="mi">255</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">;</span>
<span class="lineno">4165 </span>    <span class="n">outCol</span> <span class="o">|=</span> <span class="mh">0x000000ff</span> <span class="o">&amp;</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)(</span><span class="n">col</span><span class="p">.</span><span class="n">z</span><span class="o">*</span><span class="mi">255</span><span class="p">);</span>
<span class="lineno">4166 </span>
<span class="lineno">4167 </span>
<span class="lineno">4168 </span>    <span class="cm">/* outCol |= 0xff000000 &amp; min((unsigned int)(col.w*255), (unsigned int)255)&lt;&lt;24; */</span>
<span class="lineno">4169 </span>    <span class="cm">/* outCol |= 0x00ff0000 &amp; min((unsigned int)(col.x*255), (unsigned int)255)&lt;&lt;16; */</span>
<span class="lineno">4170 </span>    <span class="cm">/* outCol |= 0x0000ff00 &amp; min((unsigned int)(col.y*255), (unsigned int)255)&lt;&lt;8; */</span>
<span class="lineno">4171 </span>    <span class="cm">/* outCol |= 0x000000ff &amp; min((unsigned int)(col.z*255), (unsigned int)255); */</span>
<span class="lineno">4172 </span>    <span class="k">return</span> <span class="n">outCol</span><span class="p">;</span>
<span class="lineno">4173 </span><span class="p">}</span>
<span class="lineno">4174 </span>
<span class="lineno">4175 </span><span class="k">static</span> <span class="kt">float</span> <span class="nf">get_random</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">seed0</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">seed1</span><span class="p">)</span>
<span class="lineno">4176 </span><span class="p">{</span>
<span class="lineno">4177 </span>    <span class="cm">/* hash the seeds using bitwise AND operations and bitshifts */</span>
<span class="lineno">4178 </span>    <span class="o">*</span><span class="n">seed0</span> <span class="o">=</span> <span class="mi">36969</span> <span class="o">*</span> <span class="p">((</span><span class="o">*</span><span class="n">seed0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">65535</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="o">*</span><span class="n">seed0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
<span class="lineno">4179 </span>    <span class="o">*</span><span class="n">seed1</span> <span class="o">=</span> <span class="mi">18000</span> <span class="o">*</span> <span class="p">((</span><span class="o">*</span><span class="n">seed1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">65535</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="o">*</span><span class="n">seed1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
<span class="lineno">4180 </span>    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ires</span> <span class="o">=</span> <span class="p">((</span><span class="o">*</span><span class="n">seed0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="o">*</span><span class="n">seed1</span><span class="p">);</span>
<span class="lineno">4181 </span>    <span class="cm">/* use union struct to convert int to float */</span>
<span class="lineno">4182 </span>    <span class="k">union</span> <span class="p">{</span>
<span class="lineno">4183 </span>        <span class="kt">float</span> <span class="n">f</span><span class="p">;</span>
<span class="lineno">4184 </span>        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ui</span><span class="p">;</span>
<span class="lineno">4185 </span>    <span class="p">}</span> <span class="n">res</span><span class="p">;</span>
<span class="lineno">4186 </span>
<span class="lineno">4187 </span>    <span class="n">res</span><span class="p">.</span><span class="n">ui</span> <span class="o">=</span> <span class="p">(</span><span class="n">ires</span> <span class="o">&amp;</span> <span class="mh">0x007fffff</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x40000000</span><span class="p">;</span>  <span class="cm">/* bitwise AND, bitwise OR */</span>
<span class="lineno">4188 </span>    <span class="k">return</span> <span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">f</span> <span class="o">-</span> <span class="mf">2.0f</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0f</span><span class="p">;</span>
<span class="lineno">4189 </span><span class="p">}</span>
<span class="lineno">4190 </span>
<span class="lineno">4191 </span><span class="n">vec3</span> <span class="nf">reflect</span><span class="p">(</span><span class="n">vec3</span> <span class="n">incidentVec</span><span class="p">,</span> <span class="n">vec3</span> <span class="n">normal</span><span class="p">)</span>
<span class="lineno">4192 </span><span class="p">{</span>
<span class="lineno">4193 </span>    <span class="k">return</span> <span class="n">incidentVec</span> <span class="o">-</span> <span class="mf">2.f</span> <span class="o">*</span> <span class="n">dot</span><span class="p">(</span><span class="n">incidentVec</span><span class="p">,</span> <span class="n">normal</span><span class="p">)</span> <span class="o">*</span> <span class="n">normal</span><span class="p">;</span>
<span class="lineno">4194 </span><span class="p">}</span>
<span class="lineno">4195 </span>
<span class="lineno">4196 </span><span class="n">__kernel</span> <span class="kt">void</span> <span class="nf">blit_float_to_output</span><span class="p">(</span>
<span class="lineno">4197 </span>    <span class="n">__global</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="o">*</span> <span class="n">out_tex</span><span class="p">,</span>
<span class="lineno">4198 </span>    <span class="n">__global</span> <span class="kt">float</span><span class="o">*</span> <span class="n">in_flts</span><span class="p">,</span>
<span class="lineno">4199 </span>    <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">width</span><span class="p">,</span>
<span class="lineno">4200 </span>    <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">height</span><span class="p">)</span>
<span class="lineno">4201 </span><span class="p">{</span>
<span class="lineno">4202 </span>    <span class="kt">int</span> <span class="n">id</span> <span class="o">=</span> <span class="n">get_global_id</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="lineno">4203 </span>    <span class="kt">int</span> <span class="n">x</span>  <span class="o">=</span> <span class="n">id</span><span class="o">%</span><span class="n">width</span><span class="p">;</span>
<span class="lineno">4204 </span>    <span class="kt">int</span> <span class="n">y</span>  <span class="o">=</span> <span class="n">id</span><span class="o">/</span><span class="n">width</span><span class="p">;</span>
<span class="lineno">4205 </span>    <span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">x</span><span class="o">+</span><span class="n">y</span><span class="o">*</span><span class="n">width</span><span class="p">;</span>
<span class="lineno">4206 </span>    <span class="n">out_tex</span><span class="p">[</span><span class="n">offset</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_colour</span><span class="p">((</span><span class="n">vec4</span><span class="p">)(</span><span class="n">in_flts</span><span class="p">[</span><span class="n">offset</span><span class="p">]));</span>
<span class="lineno">4207 </span><span class="p">}</span>
<span class="lineno">4208 </span>
<span class="lineno">4209 </span><span class="n">__kernel</span> <span class="kt">void</span> <span class="nf">blit_float3_to_output</span><span class="p">(</span>
<span class="lineno">4210 </span>    <span class="n">__global</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="o">*</span> <span class="n">out_tex</span><span class="p">,</span>
<span class="lineno">4211 </span>    <span class="n">image2d_t</span> <span class="n">in_flts</span><span class="p">,</span>
<span class="lineno">4212 </span>    <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">width</span><span class="p">,</span>
<span class="lineno">4213 </span>    <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">height</span><span class="p">)</span>
<span class="lineno">4214 </span><span class="p">{</span>
<span class="lineno">4215 </span>    <span class="kt">int</span> <span class="n">id</span> <span class="o">=</span> <span class="n">get_global_id</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="lineno">4216 </span>    <span class="kt">int</span> <span class="n">x</span>  <span class="o">=</span> <span class="n">id</span><span class="o">%</span><span class="n">width</span><span class="p">;</span>
<span class="lineno">4217 </span>    <span class="kt">int</span> <span class="n">y</span>  <span class="o">=</span> <span class="n">id</span><span class="o">/</span><span class="n">width</span><span class="p">;</span>
<span class="lineno">4218 </span>    <span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">x</span><span class="o">+</span><span class="n">y</span><span class="o">*</span><span class="n">width</span><span class="p">;</span>
<span class="lineno">4219 </span>    <span class="n">out_tex</span><span class="p">[</span><span class="n">offset</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_colour</span><span class="p">(</span><span class="n">read_imagef</span><span class="p">(</span><span class="n">in_flts</span><span class="p">,</span> <span class="n">sampler</span><span class="p">,</span> <span class="p">(</span><span class="n">float2</span><span class="p">)(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)));</span>
<span class="lineno">4220 </span><span class="p">}</span>
</pre></div>


</body></html>